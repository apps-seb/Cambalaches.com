<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CanjeApp - Marketplace de Equivalencia</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'brand': {
                            'light': '#E8F0FE',
                            'DEFAULT': '#4285F4', // Google Blue
                            'dark': '#1A73E8',
                        },
                        'brand-yellow': '#FFE600', // Color solicitado
                        'gray': {
                            50: '#F9FAFB',
                            100: '#F3F4F6',
                            200: '#E5E7EB',
                            300: '#D1D5DB',
                            400: '#9CA3AF',
                            500: '#6B7280',
                            600: '#4B5563',
                            700: '#374151',
                            800: '#1F2937',
                            900: '#111827',
                        }
                    }
                }
            }
        }
    </div>

    </script>
    
    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F9FA;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .page {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Barra lateral */
        #desktop-sidebar { transition: width 0.3s ease-in-out; }
        #desktop-sidebar.collapsed { width: 80px; }
        #desktop-sidebar.collapsed .sidebar-text { display: none; }
        #desktop-sidebar.collapsed .sidebar-title { justify-content: center; }
        #desktop-sidebar.collapsed .sidebar-title .sidebar-text { display: none; }
        #main-content-wrapper.sidebar-collapsed {
            margin-left: 80px;
            transition: margin-left 0.3s ease-in-out;
        }

        /* Input de búsqueda */
        .search-input { transition: all 0.2s ease-in-out; }
        .search-input:focus-within {
            box-shadow: 0 1px 6px 0 rgba(32,33,36,0.28);
            border-color: rgba(223,225,229,0);
        }

        /* Nav activo */
        .nav-link-mobile.active { color: #4285F4; }
        .nav-link-desktop.active {
            background-color: #E8F0FE;
            color: #1A73E8;
            font-weight: 600;
        }
        .nav-link-desktop.active svg { color: #1A73E8; }
        
        /* Modal */
        .modal-backdrop { transition: opacity 0.3s ease-in-out; }
        .modal-content {
            transition: all 0.3s ease-in-out;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
        }
        .modal.open .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        
        /* Carrusel */
        .carousel-slide {
            transition: transform 0.5s ease-in-out;
        }

        /* --- NUEVOS ESTILOS --- */

        /* Preloader */
        #preloader {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        #preloader.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .preloader-spinner {
            width: 3rem;
            height: 3rem;
            border-radius: 9999px;
            border: 4px solid rgba(255, 230, 0, 0.35);
            border-top-color: #fbbf24;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Skeleton loading */
        .skeleton {
            position: relative;
            overflow: hidden;
            background-color: #e5e7eb;
        }

        .skeleton::after {
            content: '';
            position: absolute;
            inset: 0;
            transform: translateX(-100%);
            background: linear-gradient(90deg, rgba(229, 231, 235, 0), rgba(255, 255, 255, 0.8), rgba(229, 231, 235, 0));
            animation: shimmer 1.4s infinite;
        }

        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }

        /* Temporizador compacto */
        .promo-timer {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.35rem 0.65rem;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.92);
            border: 1px solid rgba(252, 211, 77, 0.8);
            box-shadow: 0 10px 25px rgba(17, 24, 39, 0.12);
            color: #111827;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            line-height: 1;
        }

        .promo-timer .timer-stack {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
        }

        .promo-timer .timer-chip {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.1rem;
            min-width: 2rem;
        }

        .promo-timer .timer-value {
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            font-weight: 700;
            letter-spacing: 0.04em;
            color: #111827;
        }

        .promo-timer .timer-label {
            font-size: 0.625rem;
            font-weight: 600;
            letter-spacing: 0.12em;
            color: #6b7280;
        }

        .promo-timer .timer-finished {
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.08em;
        }

        .promo-timer--expired {
            background: rgba(254, 242, 242, 0.9);
            border-color: rgba(248, 113, 113, 0.7);
            color: #b91c1c;
        }
        
        /* Menú Móvil */
        #mobile-menu-panel {
            transition: transform 0.3s ease-in-out;
        }
        
        /* Icono Premium de Categoría */
        .category-item-icon {
            position: relative;
        }
        .premium-icon {
            position: absolute;
            top: -4px; /* Ajuste fino */
            right: -4px; /* Ajuste fino */
            filter: drop-shadow(0 0 3px rgba(255, 223, 0, 0.8));
            animation: pulse-premium 2.5s infinite ease-in-out;
        }
        @keyframes pulse-premium {
            0%, 100% {
                opacity: 0.9;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.25);
            }
        }

        /* --- ESTILOS PARA SUBIDA DE FOTOS --- */
        /* Contenedor de vista previa de imagen */
        .photo-preview-item {
            position: relative;
            width: 100%;
            padding-top: 100%; /* 1:1 Aspect Ratio */
            background-color: #F3F4F6;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .photo-preview-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .btn-remove-photo {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            padding: 0.25rem;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border-radius: 9999px;
            transition: background-color 0.2s;
        }
        .btn-remove-photo:hover {
            background-color: rgba(0, 0, 0, 0.75);
        }

        /* --- ESTILOS CANJE PROFESIONAL --- */
        /* Checkbox personalizado para selección de item */
        .modal-item-checkbox:checked + img + div {
            opacity: 1;
        }
        .modal-item-checkbox:checked + img {
             border: 2px solid #4285F4;
        }
        .modal-item-checkbox-label {
             transition: all 0.2s ease-in-out;
             border: 2px solid transparent;
        }
         .modal-item-checkbox-label:has(.modal-item-checkbox:checked) {
             border-color: #4285F4;
             background-color: #E8F0FE;
         }
    </style>
</head>
<body class="text-gray-800">

    <div id="preloader">
        <div class="preloader-spinner"></div>
        <span class="mt-4 text-sm font-semibold text-gray-700">Cargando experiencia...</span>
    </div>

    <div id="app-root" class="opacity-0 pointer-events-none transition-opacity duration-500">

    <div id="mobile-menu-backdrop" class="fixed inset-0 z-30 hidden bg-black bg-opacity-50 lg:hidden"></div>
    <aside id="mobile-menu-panel" class="fixed top-0 left-0 z-40 flex flex-col w-64 h-screen max-w-[80vw] bg-white border-r border-gray-200 transition-transform duration-300 ease-in-out -translate-x-full lg:hidden">
        <div class="flex items-center h-16 px-6 border-b border-gray-200">
            <i data-lucide="arrow-right-left" class="text-brand"></i>
            <span class="ml-3 text-lg font-semibold">CanjeApp</span>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <a href="#" class="nav-link-mobile-menu nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100" data-page="page-explorar">
                <i data-lucide="compass" class="w-5 h-5 text-gray-500"></i>
                <span class="ml-4">Explorar</span>
            </a>
            <a href="#" class="nav-link-mobile-menu nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100" data-page="page-canjes">
                <i data-lucide="repeat" class="w-5 h-5 text-gray-500"></i>
                <span class="ml-4">Mis Canjes</span>
            </a>
            <a href="#" class="nav-link-mobile-menu nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100" data-page="page-vender">
                <i data-lucide="tag" class="w-5 h-5 text-gray-500"></i>
                <span class="ml-4">Vender</span>
            </a>
            <a href="#" class="nav-link-mobile-menu nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100" data-page="page-perfil">
                <i data-lucide="user" class="w-5 h-5 text-gray-500"></i>
                <span class="ml-4">Perfil</span>
            </a>
        </nav>
    </aside>

    <aside id="desktop-sidebar" class="hidden lg:flex flex-col w-64 h-screen bg-white border-r border-gray-200 fixed top-0 left-0 z-20">
        <div class="flex items-center h-16 px-6 border-b border-gray-200 sidebar-title">
            <i data-lucide="arrow-right-left" class="text-brand"></i>
            <span class="ml-3 text-lg font-semibold sidebar-text">CanjeApp</span>
        </div>
        
        <nav class="flex-1 p-4 space-y-2">
            <a href="#" class="nav-link nav-link-desktop flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 active" data-page="page-explorar">
                <i data-lucide="compass" class="w-5 h-5 text-gray-500"></i>
                <span class="ml-4 sidebar-text">Explorar</span>
            </a>
            <a href="#" class="nav-link nav-link-desktop flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100" data-page="page-canjes">
                <i data-lucide="repeat" class="w-5 h-5 text-gray-500"></i>
                <span class="ml-4 sidebar-text">Mis Canjes</span>
            </a>
            <a href="#" class="nav-link nav-link-desktop flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100" data-page="page-vender">
                <i data-lucide="tag" class="w-5 h-5 text-gray-500"></i>
                <span class="ml-4 sidebar-text">Vender</span>
            </a>
            <a href="#" class="nav-link nav-link-desktop flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100" data-page="page-perfil">
                <i data-lucide="user" class="w-5 h-5 text-gray-500"></i>
                <span class="ml-4 sidebar-text">Perfil</span>
            </a>
        </nav>
    </aside>

    <div id="main-content-wrapper" class="lg:ml-64 transition-all duration-300 pb-20 lg:pb-0">
        
        <header class="sticky top-0 z-10 flex items-center justify-between h-16 px-4 bg-brand-yellow md:px-6">
            <div class="flex items-center">
                <button id="sidebar-toggle-btn" class="hidden p-2 text-gray-800 rounded-full lg:block hover:bg-black/10">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <button id="mobile-menu-btn" class="p-2 text-gray-800 rounded-full lg:hidden hover:bg-black/10">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <span id="admin-badge" class="hidden ml-2 px-3 py-1 text-xs font-semibold text-white bg-red-600 rounded-full">ADMIN</span>
            </div>
            
            <div class="flex-1 max-w-lg mx-4">
                <div class="relative flex items-center w-full bg-white border border-transparent rounded-full shadow-sm search-input focus-within:bg-white">
                    <i data-lucide="search" class="absolute w-5 h-5 text-gray-500 left-4"></i>
                    <input type="text" placeholder="Buscar artículos, servicios y más..." class="w-full h-10 py-2 pl-12 pr-4 bg-transparent border-none rounded-full focus:outline-none focus:ring-0">
                </div>
            </div>
            
            <div class="items-center hidden lg:flex">
                <button class="p-2 text-gray-800 rounded-full hover:bg-black/10">
                    <i data-lucide="bell" class="w-6 h-6"></i>
                </button>
                <button class="ml-2 nav-link" data-page="page-perfil">
                    <img id="header-profile-img" src="https://placehold.co/40x40/E8F0FE/4285F4?text=U" alt="Perfil" class="w-10 h-10 rounded-full">
                </button>
            </div>
        </header>

        <main class="p-4 md:p-6">

            <section id="page-explorar" class="page">
                
                <div id="promo-carousel" class="relative w-full h-48 mb-6 overflow-hidden bg-gray-200 rounded-lg md:h-64">
                    <div id="carousel-slider" class="flex h-full transition-transform duration-500 ease-in-out">
                        </div>
                    
                    <button id="carousel-prev" class="absolute top-1/2 left-2 md:left-4 p-2 -translate-y-1/2 text-white bg-black rounded-full bg-opacity-40 hover:bg-opacity-70">
                        <i data-lucide="chevron-left" class="w-5 h-5 md:w-6 md:h-6"></i>
                    </button>
                    <button id="carousel-next" class="absolute top-1/2 right-2 md:right-4 p-2 -translate-y-1/2 text-white bg-black rounded-full bg-opacity-40 hover:bg-opacity-70">
                        <i data-lucide="chevron-right" class="w-5 h-5 md:w-6 md:h-6"></i>
                    </button>

                    <input type="file" id="cover-file-input" class="hidden" accept="image/*">
                    <button id="upload-cover-btn" data-icon-name="upload-cloud" class="absolute bottom-2 left-2 md:bottom-4 md:left-4 p-2 text-white bg-black rounded-full bg-opacity-40 hover:bg-opacity-70 admin-only hidden" title="Subir nueva portada (Admin)">
                        <i data-lucide="upload-cloud" class="w-5 h-5 md:w-6 md:h-6"></i>
                    </button>
                </div>

                <h3 class="mb-4 text-xl font-semibold text-gray-900">Categorías Premium</h3>
                <div id="category-list-container" class="flex pb-4 mb-6 space-x-4 overflow-x-auto no-scrollbar">
                    <div class="flex flex-col items-center flex-shrink-0 w-24 space-y-2">
                        <div class="w-16 h-16 rounded-full skeleton"></div>
                        <div class="w-16 h-3 rounded-full skeleton"></div>
                    </div>
                    <div class="flex flex-col items-center flex-shrink-0 w-24 space-y-2">
                        <div class="w-16 h-16 rounded-full skeleton"></div>
                        <div class="w-20 h-3 rounded-full skeleton"></div>
                    </div>
                    <div class="flex flex-col items-center flex-shrink-0 w-24 space-y-2">
                        <div class="w-16 h-16 rounded-full skeleton"></div>
                        <div class="w-12 h-3 rounded-full skeleton"></div>
                    </div>
                    <div class="flex flex-col items-center flex-shrink-0 w-24 space-y-2">
                        <div class="w-16 h-16 rounded-full skeleton"></div>
                        <div class="w-20 h-3 rounded-full skeleton"></div>
                    </div>
                    <div class="flex flex-col items-center flex-shrink-0 w-24 space-y-2">
                        <div class="w-16 h-16 rounded-full skeleton"></div>
                        <div class="w-16 h-3 rounded-full skeleton"></div>
                    </div>
                </div>

                <h3 class="mb-4 text-xl font-semibold text-gray-900">Populares</h3>
                <div id="most-viewed-container" class="flex pb-4 mb-6 space-x-4 overflow-x-auto no-scrollbar">
                    <div class="flex flex-col flex-shrink-0 w-48 p-4 bg-white rounded-2xl shadow-sm">
                        <div class="w-full h-24 rounded-xl skeleton"></div>
                        <div class="w-3/4 h-3 mt-4 rounded skeleton"></div>
                        <div class="w-2/3 h-3 mt-2 rounded skeleton"></div>
                    </div>
                    <div class="flex flex-col flex-shrink-0 w-48 p-4 bg-white rounded-2xl shadow-sm">
                        <div class="w-full h-24 rounded-xl skeleton"></div>
                        <div class="w-2/3 h-3 mt-4 rounded skeleton"></div>
                        <div class="w-1/2 h-3 mt-2 rounded skeleton"></div>
                    </div>
                    <div class="flex flex-col flex-shrink-0 w-48 p-4 bg-white rounded-2xl shadow-sm">
                        <div class="w-full h-24 rounded-xl skeleton"></div>
                        <div class="w-5/6 h-3 mt-4 rounded skeleton"></div>
                        <div class="w-2/3 h-3 mt-2 rounded skeleton"></div>
                    </div>
                </div>
                <h3 class="mb-4 text-xl font-semibold text-gray-900">Artículos Recientes</h3>
                <div id="explorar-product-grid" class="grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5">
                    <div class="p-4 bg-white rounded-2xl shadow-sm">
                        <div class="w-full h-32 mb-4 rounded-xl skeleton"></div>
                        <div class="w-3/4 h-3 mb-2 rounded skeleton"></div>
                        <div class="w-1/2 h-3 rounded skeleton"></div>
                    </div>
                    <div class="p-4 bg-white rounded-2xl shadow-sm">
                        <div class="w-full h-32 mb-4 rounded-xl skeleton"></div>
                        <div class="w-2/3 h-3 mb-2 rounded skeleton"></div>
                        <div class="w-1/2 h-3 rounded skeleton"></div>
                    </div>
                    <div class="p-4 bg-white rounded-2xl shadow-sm">
                        <div class="w-full h-32 mb-4 rounded-xl skeleton"></div>
                        <div class="w-5/6 h-3 mb-2 rounded skeleton"></div>
                        <div class="w-2/3 h-3 rounded skeleton"></div>
                    </div>
                    <div class="p-4 bg-white rounded-2xl shadow-sm">
                        <div class="w-full h-32 mb-4 rounded-xl skeleton"></div>
                        <div class="w-4/5 h-3 mb-2 rounded skeleton"></div>
                        <div class="w-1/2 h-3 rounded skeleton"></div>
                    </div>
                    <div class="hidden p-4 bg-white rounded-2xl shadow-sm md:block">
                        <div class="w-full h-32 mb-4 rounded-xl skeleton"></div>
                        <div class="w-3/4 h-3 mb-2 rounded skeleton"></div>
                        <div class="w-1/2 h-3 rounded skeleton"></div>
                    </div>
                    <div class="hidden p-4 bg-white rounded-2xl shadow-sm lg:block">
                        <div class="w-full h-32 mb-4 rounded-xl skeleton"></div>
                        <div class="w-2/3 h-3 mb-2 rounded skeleton"></div>
                        <div class="w-1/2 h-3 rounded skeleton"></div>
                    </div>
                    <div class="hidden p-4 bg-white rounded-2xl shadow-sm xl:block">
                        <div class="w-full h-32 mb-4 rounded-xl skeleton"></div>
                        <div class="w-5/6 h-3 mb-2 rounded skeleton"></div>
                        <div class="w-2/3 h-3 rounded skeleton"></div>
                    </div>
                </div>
            </section>

            <section id="page-canjes" class="page hidden max-w-4xl mx-auto">
                <div id="canjes-auth-required" class="hidden">
                    <div class="flex flex-col items-center justify-center p-10 text-center bg-white border border-gray-200 rounded-lg shadow-sm">
                        <i data-lucide="lock" class="w-16 h-16 text-gray-400"></i>
                        <h2 class="mt-4 text-2xl font-semibold">Acceso Restringido</h2>
                        <p class="mt-2 text-gray-600">Debes iniciar sesión para ver tus canjes y ofertas.</p>
                        <button class="nav-link px-6 py-2 mt-6 text-white bg-brand rounded-lg hover:bg-brand-dark" data-page="page-perfil">
                            Iniciar Sesión
                        </button>
                    </div>
                </div>

                <div id="canjes-content" class="">
                    <h2 class="mb-6 text-2xl font-semibold text-gray-900">Mis Canjes</h2>
                    <div class="border-b border-gray-200">
                        <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                            <button class="px-1 py-3 text-sm font-medium text-brand border-b-2 border-brand whitespace-nowrap canje-tab-btn" data-tab="tab-ofertas">
                                Ofertas Recibidas (<span id="ofertas-count">0</span>)
                            </button>
                            <button class="px-1 py-3 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 whitespace-nowrap canje-tab-btn" data-tab="tab-mis-articulos">
                                Mis Artículos (<span id="mis-articulos-count">0</span>)
                            </button>
                            <button class="px-1 py-3 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 whitespace-nowrap canje-tab-btn" data-tab="tab-activos">
                                Canjes Activos (0)
                            </button>
                        </nav>
                    </div>
                    
                    <div class="mt-6">
                        <div id="tab-ofertas" class="canje-tab-content space-y-4">
                            <p class="text-gray-500">No tienes ofertas recibidas.</p>
                        </div>
                        
                        <div id="tab-mis-articulos" class="canje-tab-content hidden space-y-4">
                            <p class="text-gray-500">No has publicado ningún artículo.</p>
                        </div>
                        
                        <div id="tab-activos" class="canje-tab-content hidden">
                            <p class="text-gray-500">No tienes canjes activos.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="page-vender" class="page hidden max-w-2xl mx-auto">
                <div id="vender-auth-required" class="hidden">
                         <div class="flex flex-col items-center justify-center p-10 text-center bg-white border border-gray-200 rounded-lg shadow-sm">
                               <i data-lucide="lock" class="w-16 h-16 text-gray-400"></i>
                               <h2 class="mt-4 text-2xl font-semibold">Acceso Restringido</h2>
                               <p class="mt-2 text-gray-600">Debes iniciar sesión para publicar un artículo.</p>
                               <button class="nav-link px-6 py-2 mt-6 text-white bg-brand rounded-lg hover:bg-brand-dark" data-page="page-perfil">
                                   Iniciar Sesión
                               </button>
                         </div>
                </div>

                <div id="vender-content" class="p-6 bg-white border border-gray-200 rounded-lg shadow-sm">
                    <h2 class="mb-6 text-2xl font-semibold text-gray-900">Publicar un artículo para canje</h2>
                    <form id="form-vender" class="space-y-6">
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Fotos del artículo (Mín 2, Máx 10)</label>
                            
                            <label id="photo-upload-label" for="product-photo-upload" class="flex flex-col items-center justify-center w-full h-32 px-6 mt-1 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer transition-colors hover:border-brand hover:bg-brand-light">
                                <div id="photo-upload-text" class="text-center">
                                    <i data-lucide="upload-cloud" class="w-10 h-10 mx-auto text-gray-400"></i>
                                    <p class="mt-1 text-sm text-gray-600">Arrastra o <span class="font-medium text-brand">selecciona</span> tus archivos</p>
                                    <p class="text-xs text-gray-500">Hasta 10 imágenes</p>
                                </div>
                                <div id="photo-upload-summary" class="hidden text-center">
                                    <i data-lucide="check-circle" class="w-10 h-10 mx-auto text-green-500"></i>
                                    <p class="mt-1 text-sm font-medium text-gray-700"><span id="photo-count">0</span> fotos seleccionadas</p>
                                    <p class="mt-1 text-xs text-brand hover:underline">Añadir más fotos</p>
                                </div>
                            </label>
                            <input type="file" id="product-photo-upload" class="sr-only" multiple accept="image/*">
                            
                            <div id="photo-preview-container" class="grid grid-cols-3 gap-4 mt-4 sm:grid-cols-4 md:grid-cols-5">
                                 </div>
                            
                            <p id="photo-error-msg" class="hidden mt-2 text-sm text-red-600"></p>
                        </div>

                        
                        <div>
                            <label for="titulo" class="block text-sm font-medium text-gray-700">Título</label>
                            <input type="text" id="titulo" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" placeholder="Ej: Smartwatch en buen estado" required>
                        </div>

                        <div>
                            <label for="categoria" class="block text-sm font-medium text-gray-700">Categoría</label>
                            <select id="categoria" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" required>
                                <option value="">Cargando categorías...</option>
                                </select>
                        </div>
                        
                        <div>
                            <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripción</label>
                            <textarea id="descripcion" rows="4" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" placeholder="Describe tu artículo, estado, tiempo de uso, etc."></textarea>
                        </div>

                        <div>
                            <label for="busco" class="block text-sm font-medium text-gray-700">¿Qué buscas a cambio?</label>
                            <input type="text" id="busco" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" placeholder="Ej: iPhone, bicicleta, monitor" required>
                        </div>
                        
                        <div>
                            <label for="valor-cop" class="block text-sm font-medium text-gray-700">Valor de equivalencia (COP)</label>
                            <p class="text-xs text-gray-500">Establece un valor en pesos colombianos para calcular la equivalencia.</p>
                            <div class="relative mt-1">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">COP $</span>
                                <input type="number" id="valor-cop" class="w-full pl-12 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" placeholder="Ej: 750000" required>
                            </div>
                        </div>

                        <div class="pt-4 border-t border-gray-200">
                            <button type="submit" id="btn-publicar-articulo" class="w-full px-6 py-3 font-semibold text-white bg-brand rounded-lg shadow-sm transition-colors hover:bg-brand-dark">
                                Publicar Artículo
                            </button>
                            <p id="publicar-error-msg" class="hidden mt-2 text-sm text-center text-red-600"></p>
                        </div>
                    </form>
                </div>
            </section>

            <section id="page-perfil" class="page hidden max-w-md mx-auto">
                
                <div id="perfil-auth-form" class="p-6 bg-white border border-gray-200 rounded-lg shadow-sm">
                    <div class="border-b border-gray-200">
                        <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                            <button class="px-1 py-3 text-sm font-medium text-brand border-b-2 border-brand whitespace-nowrap auth-tab-btn" data-auth-tab="auth-login">
                                Iniciar Sesión
                            </button>
                            <button class="px-1 py-3 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 whitespace-nowrap auth-tab-btn" data-auth-tab="auth-register">
                                Registrarse
                            </button>
                        </nav>
                    </div>

                    <form id="auth-login" class="mt-6 space-y-4 auth-tab-content">
                        <div>
                            <label for="email-login" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="email-login" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" placeholder="Usa admin@canje.app para modo admin" required>
                        </div>
                        <div>
                            <label for="pass-login" class="block text-sm font-medium text-gray-700">Contraseña</label>
                            <input type="password" id="pass-login" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" required>
                        </div>
                        <button type="submit" class="w-full px-4 py-2 font-medium text-white bg-brand rounded-lg hover:bg-brand-dark">
                            Entrar
                        </button>
                        <p id="login-error-msg" class="hidden text-sm text-center text-red-600"></p>
                    </form>

                    <form id="auth-register" class="hidden mt-6 space-y-4 auth-tab-content">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Foto de Perfil</label>
                            <div class="flex items-center mt-1 space-x-4">
                                <img id="profile-pic-preview" src="https://placehold.co/80x80/E8F0FE/4285F4?text=U" class="w-16 h-16 rounded-full" alt="Vista previa">
                                <label for="profile-pic-upload" class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50">
                                    <span>Subir foto</span>
                                    <input id="profile-pic-upload" name="profile-pic" type="file" class="sr-only" accept="image/*">
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label for="nombre-reg" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                            <input type="text" id="nombre-reg" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" required>
                        </div>
                        <div>
                            <label for="doc-reg" class="block text-sm font-medium text-gray-700">Documento de Identidad (C.C.)</label>
                            <input type="text" id="doc-reg" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" placeholder="Ej: 1061..." required>
                        </div>
                        <div>
                            <label for="dir-reg" class="block text-sm font-medium text-gray-700">Dirección de Residencia</label>
                            <input type="text" id="dir-reg" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" placeholder="Ej: Cra 5 # 10-20, Bogotá" required>
                        </div>
                        <div>
                            <label for="email-reg" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="email-reg" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" required>
                        </div>
                        <div>
                            <label for="pass-reg" class="block text-sm font-medium text-gray-700">Contraseña</dlabel>
                            <input type="password" id="pass-reg" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" required>
                        </div>
                        <button type="submit" class="w-full px-4 py-2 font-medium text-white bg-brand rounded-lg hover:bg-brand-dark">
                            Crear Cuenta
                        </button>
                        <p id="register-error-msg" class="hidden text-sm text-center text-red-600"></p>
                    </form>
                </div>

                <div id="perfil-logged-in" class="hidden p-6 space-y-6">
                    <div class="flex flex-col items-center">
                        <img id="main-profile-img" src="https://placehold.co/100x100/E8F0FE/4285F4?text=U" alt="Foto de Perfil" class="w-24 h-24 rounded-full">
                        <h2 id="user-name" class="mt-4 text-2xl font-semibold">Usuario de Prueba</h2>
                        <p id="user-email" class="text-gray-600">usuario@canje.app</p>
                    </div>
                    
                    <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-500">Dirección</span>
                            <a href="#" class="text-sm font-medium text-brand hover:underline">Editar</a>
                        </div>
                        <p id="user-address" class="mt-1 font-medium text-gray-900">Cra 5 # 10-20, Bogotá</p>
                    </div>
                    <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-500">Documento</span>
                            <a href="#" class="text-sm font-medium text-brand hover:underline">Editar</a>
                        </div>
                        <p id="user-doc" class="mt-1 font-medium text-gray-900">CC 1061******</p>
                    </div>

                    <div class="space-y-3">
                        <a href="#" class="flex items-center justify-between w-full p-4 bg-white border border-gray-200 rounded-lg shadow-sm hover:bg-gray-50">
                            <span class="font-medium">Notificaciones</span>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                        </a>
                        <a href="#" class="flex items-center justify-between w-full p-4 bg-white border border-gray-200 rounded-lg shadow-sm hover:bg-gray-50">
                            <span class="font-medium">Ayuda y Soporte</span>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                        </a>
                    </div>

                    <button id="btn-logout" class="w-full px-4 py-2 font-medium text-red-700 bg-red-100 rounded-lg hover:bg-red-200">
                        Cerrar Sesión
                    </button>
                </div>
            </section>
        </main>

        <footer class="p-6 mt-10 bg-white border-t border-gray-200 md:p-10">
            <div class="grid max-w-6xl grid-cols-2 gap-8 mx-auto md:grid-cols-4 lg:grid-cols-5">
                <div class="col-span-2 md:col-span-4 lg:col-span-1">
                    <div class="flex items-center">
                        <i data-lucide="arrow-right-left" class="text-brand"></i>
                        <span class="ml-2 text-lg font-semibold">CanjeApp</span>
                    </div>
                    <p class="mt-2 text-sm text-gray-500">© 2025 CanjeApp Inc.</p>
                </div>
                <div>
                    <h5 class="font-semibold text-gray-800">Explorar</h5>
                    <ul class="mt-2 space-y-1">
                        <li><a href="#" class="text-sm text-gray-600 hover:text-brand">Categorías</a></li>
                        <li><a href="#" class="text-sm text-gray-600 hover:text-brand">Novedades</a></li>
                        <li><a href="#" class="text-sm text-gray-600 hover:text-brand">Populares</a></li>
                    </ul>
                </div>
                <div>
                    <h5 class="font-semibold text-gray-800">Nosotros</h5>
                    <ul class="mt-2 space-y-1">
                        <li><a href="#" class="text-sm text-gray-600 hover:text-brand">Acerca de</a></li>
                        <li><a href="#" class="text-sm text-gray-600 hover:text-brand">Carreras</a></li>
                        <li><a href="#" class="text-sm text-gray-600 hover:text-brand">Prensa</a></li>
                    </ul>
                </div>
                <div>
                    <h5 class="font-semibold text-gray-800">Soporte</h5>
                    <ul class="mt-2 space-y-1">
                        <li><a href="#" class="text-sm text-gray-600 hover:text-brand">Ayuda</a></li>
                        <li><a href="#" class="text-sm text-gray-600 hover:text-brand">Términos</a></li>
                        <li><a href="#" class="text-sm text-gray-600 hover:text-brand">Privacidad</a></li>
                    </ul>
                </div>
                <div class="col-span-2 md:col-span-1">
                    <h5 class="font-semibold text-gray-800">Síguenos</h5>
                    <div class="flex mt-2 space-x-3">
                        <a href="#" class="text-gray-500 hover:text-brand"><i data-lucide="facebook"></i></a>
                        <a href="#" class="text-gray-500 hover:text-brand"><i data-lucide="instagram"></i></a>
                        <a href="#" class="text-gray-500 hover:text-brand"><i data-lucide="twitter"></i></a>
                    </div>
                </div>
            </div>
        </footer>

    </div> <nav class="fixed bottom-0 left-0 z-20 w-full h-16 bg-white border-t border-gray-200 shadow-inner lg:hidden">
        <div class="flex items-center justify-around w-full h-full max-w-md px-4 mx-auto">
            <a href="#" class="flex flex-col items-center justify-center text-center text-brand nav-link nav-link-mobile active" data-page="page-explorar">
                <i data-lucide="compass" class="w-6 h-6"></i>
                <span class="text-xs font-medium">Explorar</span>
            </a>
            <a href="#" class="flex flex-col items-center justify-center text-center text-gray-600 nav-link nav-link-mobile" data-page="page-canjes">
                <i data-lucide="repeat" class="w-6 h-6"></i>
                <span class="text-xs font-medium">Canjes</span>
            </a>
            <a href="#" class="flex flex-col items-center justify-center text-center text-gray-600 nav-link nav-link-mobile" data-page="page-vender">
                <i data-lucide="plus-square" class="w-6 h-6"></i>
                <span class="text-xs font-medium">Vender</span>
            </a>
            <a href="#" class="flex flex-col items-center justify-center text-center text-gray-600 nav-link nav-link-mobile" data-page="page-perfil">
                <i data-lucide="user" class="w-6 h-6"></i>
                <span class="text-xs font-medium">Perfil</span>
            </a>
        </div>
    </nav>
    
    <div id="modal-proponer-canje" class="modal hidden fixed inset-0 z-30 flex items-center justify-center p-4">
        <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-50"></div>
        
        <div class="modal-content relative w-full max-w-lg p-6 bg-white rounded-lg shadow-xl">
            <button class="modal-close-btn absolute top-4 right-4 p-1 text-gray-500 rounded-full hover:bg-gray-100">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <h3 class="text-xl font-semibold text-gray-900">Proponer un Canje</h3>
            <p class="mt-1 text-sm text-gray-600">
                Estás proponiendo un canje por: <span id="modal-item-name" class="font-medium"></span>
            </p>
            <p class="text-sm text-gray-600">
                Valor estimado: <span id="modal-item-value" class="font-medium text-green-600"></span>
            </p>
            <form id="form-proponer-canje" class="mt-6 space-y-4">
                <div>
                    <label for="tu-articulo" class="block text-sm font-medium text-gray-700">Selecciona tu(s) artículo(s) a ofrecer:</label>
                    
                    <div id="modal-user-items-list" class="mt-2 space-y-2 max-h-48 overflow-y-auto p-2 bg-gray-50 rounded-lg border">
                        <p class="text-sm text-gray-500 p-2">Cargando mis artículos...</p>
                    </div>
                </div>
                
                <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                    <h4 class="font-medium">Cálculo de Equivalencia</h4>
                    <div class="mt-2 space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Valor de tu(s) artículo(s):</span>
                            <span id="tu-valor" class="font-medium text-gray-800">$0 COP</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Valor del artículo deseado:</span>
                            <span id="deseado-valor" class="font-medium text-gray-800">$0 COP</span>
                        </div>
                        <div class="flex justify-between pt-2 mt-2 border-t">
                            <span class="font-semibold">Diferencia:</span>
                            <span id="diferencia-valor" class="font-semibold text-brand-dark">$0 COP</span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label for="agregar-dinero" class="block text-sm font-medium text-gray-700">Agregar diferencia en dinero (Opcional):</label>
                    <div class="relative mt-1">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">COP $</span>
                        <input type="number" id="agregar-dinero" class="w-full pl-12 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" placeholder="0">
                    </div>
                </div>

                <p id="modal-error-msg" class="hidden text-sm text-center text-red-600"></p>

                <div class="pt-4">
                    <button type="submit" class="w-full px-6 py-3 font-semibold text-white bg-brand rounded-lg shadow-sm hover:bg-brand-dark">
                        Enviar Propuesta de Canje
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-edit-timer" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-50"></div>
        <div class="modal-content relative w-full max-w-sm p-6 bg-white rounded-lg shadow-xl">
            <button class="modal-close-btn absolute top-4 right-4 p-1 text-gray-500 rounded-full hover:bg-gray-100">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <h3 class="text-xl font-semibold text-gray-900">Editar Temporizador</h3>
            <p class="mt-1 text-sm text-gray-600">Introduce la nueva fecha y hora de finalización.</p>
            <form id="form-edit-timer" class="mt-4 space-y-4">
                <div>
                    <label for="timer-datetime" class="block text-sm font-medium text-gray-700">Fecha y Hora (YYYY-MM-DDTHH:MM)</label>
                    <input type="datetime-local" id="timer-datetime" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" required>
                </div>
                <button type="submit" class="w-full px-4 py-2 font-medium text-white bg-brand rounded-lg hover:bg-brand-dark">
                    Guardar
                </button>
            </form>
        </div>
    </div>


    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAnalytics, isSupported as isAnalyticsSupported } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, deleteUser } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, query, where, serverTimestamp, deleteDoc, increment, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBG035jZHTgsqZKIYCHGAUshwRukSccrjU",
            authDomain: "mercadocanje-ffca0.firebaseapp.com",
            projectId: "mercadocanje-ffca0",
            storageBucket: "mercadocanje-ffca0.firebasestorage.app",
            messagingSenderId: "1069590620221",
            appId: "1:1069590620221:web:ea68de5b49395ce42be254",
            measurementId: "G-9KEBKJ84CR"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); 
        let analytics;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                if (await isAnalyticsSupported()) {
                    analytics = getAnalytics(app);
                    window.firebaseAnalytics = analytics;
                }
            } catch (analyticsError) {
                console.warn('Firebase Analytics no está disponible en este entorno:', analyticsError);
            }
            
            // --- CONSTANTES DE CATEGORÍAS (MODIFICADO) ---
            const categories = [
                { name: 'Hogar', icon: 'home', id: 'hogar' },
                { name: 'Automóviles', icon: 'car', id: 'automoviles' },
                { name: 'Inmuebles', icon: 'building', id: 'inmuebles' },
                { name: 'Salud', icon: 'heart-pulse', id: 'salud' },
                { name: 'Cosméticos', icon: 'sparkles', id: 'cosmeticos' },
                { name: 'Servicios', icon: 'wrench', id: 'servicios' },
                { name: 'Tecnología', icon: 'cpu', id: 'tecnologia' },
                { name: 'Moda', icon: 'shirt', id: 'moda' },
                { name: 'Celulares', icon: 'smartphone', id: 'celulares' },
                { name: 'Computación', icon: 'laptop', id: 'computacion' },
                { name: 'Libros', icon: 'book-open', id: 'libros' },
                { name: 'Juegos', icon: 'gamepad-2', id: 'juegos' },
                { name: 'Deportes', icon: 'bike', id: 'deportes' }, // NUEVO
                { name: 'Otros', icon: 'box', id: 'otros' }
            ];

            const DEFAULT_PROFILE_PIC = 'https://placehold.co/100x100/E8F0FE/4285F4?text=U';
            const DEFAULT_PRODUCT_IMAGE = 'https://placehold.co/300x200/D1D5DB/111827?text=Sin+Imagen';

            const preloader = document.getElementById('preloader');
            const appRoot = document.getElementById('app-root');

            function revealApp() {
                if (preloader && !preloader.classList.contains('hidden')) {
                    preloader.classList.add('hidden');
                }
                if (appRoot) {
                    appRoot.classList.remove('pointer-events-none', 'opacity-0');
                    appRoot.classList.add('opacity-100');
                }
            }

            // --- ESTADO DE LA APLICACIÓN ---
            const state = {
                isLoggedIn: false,
                isAdmin: false,
                currentUser: {
                    uid: null,
                    name: '',
                    email: '',
                    address: '',
                    doc: '',
                    profilePic: DEFAULT_PROFILE_PIC,
                    profilePicPath: '',
                    items: [],
                    role: 'user',
                    stats: {
                        listedCount: 0,
                        completedTrades: 0,
                    },
                },
                viewedCategoryHistory: {},
                allProducts: [],
                receivedOffers: [],
                itemToSwap: null,
                editingTimerSlide: null,
                productFiles: [],
                profilePicFile: null,
            };


            // --- SELECTORES ---
            const pages = document.querySelectorAll('.page');
            const navLinks = document.querySelectorAll('.nav-link');
            const authTabs = document.querySelectorAll('.auth-tab-btn');
            const authTabContents = document.querySelectorAll('.auth-tab-content');
            const canjeTabs = document.querySelectorAll('.canje-tab-btn');
            const canjeTabContents = document.querySelectorAll('.canje-tab-content');
            
            // Elementos de autenticación
            const perfilAuthForm = document.getElementById('perfil-auth-form');
            const perfilLoggedIn = document.getElementById('perfil-logged-in');
            const canjesAuthRequired = document.getElementById('canjes-auth-required');
            const canjesContent = document.getElementById('canjes-content');
            const venderAuthRequired = document.getElementById('vender-auth-required');
            const venderContent = document.getElementById('vender-content');
            const btnLogout = document.getElementById('btn-logout');
            const formLogin = document.getElementById('auth-login');
            const formRegister = document.getElementById('auth-register');
            const loginErrorMsg = document.getElementById('login-error-msg');
            const registerErrorMsg = document.getElementById('register-error-msg');
            const userNameEl = document.getElementById('user-name');
            const userEmailEl = document.getElementById('user-email');
            const userAddressEl = document.getElementById('user-address');
            const userDocEl = document.getElementById('user-doc');
            const mainProfileImg = document.getElementById('main-profile-img');
            const headerProfileImg = document.getElementById('header-profile-img');
            const profilePicUpload = document.getElementById('profile-pic-upload');
            const profilePicPreview = document.getElementById('profile-pic-preview');
            const defaultProfilePreviewSrc = profilePicPreview ? profilePicPreview.src : DEFAULT_PROFILE_PIC;

            // Barra lateral
            const sidebar = document.getElementById('desktop-sidebar');
            const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
            const mainContentWrapper = document.getElementById('main-content-wrapper');
            
            // Modal de Canje (MODIFICADO)
            const modalProponerCanje = document.getElementById('modal-proponer-canje');
            const selectTuArticulo = document.getElementById('modal-user-items-list'); // MODIFICADO
            const formProponerCanje = document.getElementById('form-proponer-canje');
            const modalErrorMsg = document.getElementById('modal-error-msg');

            // --- SELECTORES DEL CARRUSEL (ACTUALIZADOS) ---
            const promoCarousel = document.getElementById('promo-carousel');
            const carouselSlider = document.getElementById('carousel-slider');
            const carouselPrevBtn = document.getElementById('carousel-prev');
            const carouselNextBtn = document.getElementById('carousel-next');
            let currentSlide = 0;
            let totalSlides = 0; // Se actualizará dinámicamente
            let carouselInterval;

            
            // --- NUEVOS SELECTORES ---
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileMenuPanel = document.getElementById('mobile-menu-panel');
            const mobileMenuBackdrop = document.getElementById('mobile-menu-backdrop');
            const mobileMenuLinks = document.querySelectorAll('.nav-link-mobile-menu');
            const adminBadge = document.getElementById('admin-badge');
            
            const uploadCoverBtn = document.getElementById('upload-cover-btn');
            const coverFileInput = document.getElementById('cover-file-input');
            
            const categoryListContainer = document.getElementById('category-list-container');
            const categorySelect = document.getElementById('categoria');

            const modalEditTimer = document.getElementById('modal-edit-timer');
            const formEditTimer = document.getElementById('form-edit-timer');

            // --- NUEVOS SELECTORES (Vender Fotos) ---
            const formVender = document.getElementById('form-vender');
            const productPhotoInput = document.getElementById('product-photo-upload');
            const photoUploadLabel = document.getElementById('photo-upload-label');
            const photoPreviewContainer = document.getElementById('photo-preview-container');
            const photoUploadText = document.getElementById('photo-upload-text');
            const photoUploadSummary = document.getElementById('photo-upload-summary');
            const photoCount = document.getElementById('photo-count');
            const photoErrorMsg = document.getElementById('photo-error-msg');
            const publicarErrorMsg = document.getElementById('publicar-error-msg');

            // --- NUEVOS SELECTORES (Renderizado Dinámico) ---
            const explorarProductGrid = document.getElementById('explorar-product-grid');
            const tabOfertas = document.getElementById('tab-ofertas');
            const tabMisArticulos = document.getElementById('tab-mis-articulos');
            const ofertasCount = document.getElementById('ofertas-count');
            const misArticulosCount = document.getElementById('mis-articulos-count');
            const mostViewedContainer = document.getElementById('most-viewed-container'); // NUEVO

            // --- FUNCIONES ---

            /**
             * Muestra una página y oculta las demás.
             */
            function showPage(pageId) {
                pages.forEach(page => page.classList.add('hidden'));
                const activePage = document.getElementById(pageId);
                if (activePage) {
                    activePage.classList.remove('hidden');
                    window.scrollTo(0, 0);
                }
                updateActiveNav(pageId);
            }

            /**
             * Actualiza el estado visual "activo" en los enlaces de navegación.
             */
            function updateActiveNav(pageId) {
                navLinks.forEach(link => {
                    const isActive = link.dataset.page === pageId;
                    link.classList.toggle('active', isActive);
                    if (link.classList.contains('nav-link-mobile')) {
                        link.classList.toggle('text-brand', isActive);
                        link.classList.toggle('text-gray-600', !isActive);
                    }
                });
            }

            /**
             * Actualiza la UI basada en el estado de autenticación.
             */
            function updateAuthUI() {
                if (state.isLoggedIn) {
                    // Vista Perfil
                    perfilAuthForm.classList.add('hidden');
                    perfilLoggedIn.classList.remove('hidden');
                    const defaultPic = 'https://placehold.co/40x40/E8F0FE/4285F4?text=U';
                    const profilePic = state.currentUser.profilePic || defaultPic;
                    userNameEl.textContent = state.currentUser.name || 'Usuario';
                    userEmailEl.textContent = state.currentUser.email || '';
                    userAddressEl.textContent = state.currentUser.address || 'Sin dirección';
                    const docValue = state.currentUser.doc || '';
                    userDocEl.textContent = docValue ? docValue.replace(/(\d{4})\d+/, '$1******') : 'Sin documento';
                    mainProfileImg.src = profilePic;
                    headerProfileImg.src = profilePic;

                    // Vistas restringidas
                    canjesAuthRequired.classList.add('hidden');
                    canjesContent.classList.remove('hidden');
                    venderAuthRequired.classList.add('hidden');
                    venderContent.classList.remove('hidden');

                    // Lógica de Admin
                    if (state.isAdmin) {
                        adminBadge.classList.remove('hidden');
                        document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
                    } else {
                        adminBadge.classList.add('hidden');
                        document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
                    }

                    // Actualizar contadores
                    ofertasCount.textContent = state.receivedOffers.length;
                    misArticulosCount.textContent = (state.currentUser.items || []).length;
                    // Renderizar contenido dinámico del usuario
                    renderReceivedOffers();
                    renderMyItems();

                } else {
                    // Vista Perfil
                    perfilAuthForm.classList.remove('hidden');
                    perfilLoggedIn.classList.add('hidden');
                    const defaultPic = 'https://placehold.co/40x40/E8F0FE/4285F4?text=U';
                    mainProfileImg.src = defaultPic;
                    headerProfileImg.src = defaultPic;
                    if (profilePicPreview) {
                        profilePicPreview.src = defaultProfilePreviewSrc;
                    }

                    // Vistas restringidas
                    canjesAuthRequired.classList.remove('hidden');
                    canjesContent.classList.add('hidden');
                    venderAuthRequired.classList.remove('hidden');
                    venderContent.classList.add('hidden');

                    // Ocultar elementos de admin
                    adminBadge.classList.add('hidden');
                    document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));

                    // Limpiar contadores y contenido
                    ofertasCount.textContent = 0;
                    misArticulosCount.textContent = 0;
                    tabOfertas.innerHTML = '<p class="text-gray-500">Debes iniciar sesión para ver tus ofertas.</p>';
                    tabMisArticulos.innerHTML = '<p class="text-gray-500">Debes iniciar sesión para ver tus artículos.</p>';
                }
            }
            
            /**
             * Formatea un número como moneda COP.
             */
            function formatCOP(value) {
                return new Intl.NumberFormat('es-CO', {
                    style: 'currency',
                    currency: 'COP',
                    maximumFractionDigits: 0,
                    minimumFractionDigits: 0,
                }).format(value);
            }

            /**
             * Normaliza un documento de producto proveniente de Firestore.
             */
            function mapProductDoc(docSnap) {
                const data = docSnap.data();
                if (!data) return null;

                const createdAt = data.createdAt && typeof data.createdAt.toMillis === 'function' ? data.createdAt.toMillis() : 0;
                return {
                    id: docSnap.id,
                    name: data.name || 'Artículo sin título',
                    wants: data.wants || '',
                    value: Number(data.value) || 0,
                    description: data.description || '',
                    categoryId: data.categoryId || 'otros',
                    imageUrl: data.imageUrl || (Array.isArray(data.imageUrls) && data.imageUrls.length > 0 ? data.imageUrls[0] : DEFAULT_PRODUCT_IMAGE),
                    imageUrls: Array.isArray(data.imageUrls) ? data.imageUrls : (data.imageUrl ? [data.imageUrl] : []),
                    imagePaths: Array.isArray(data.imagePaths) ? data.imagePaths : [],
                    ownerId: data.ownerId || '',
                    ownerName: data.ownerName || '',
                    ownerEmail: data.ownerEmail || '',
                    createdAt,
                    updatedAt: data.updatedAt && typeof data.updatedAt.toMillis === 'function' ? data.updatedAt.toMillis() : createdAt,
                };
            }

            /**
             * Carga todos los productos publicados en Firestore.
             */
            async function loadAllProducts() {
                try {
                    const snapshot = await getDocs(collection(db, 'items'));
                    const products = [];
                    snapshot.forEach(docSnap => {
                        const mapped = mapProductDoc(docSnap);
                        if (mapped) {
                            products.push(mapped);
                        }
                    });
                    products.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    state.allProducts = products;
                    renderProducts();
                    renderMostViewedProducts();
                } catch (error) {
                    console.error('Error al cargar los productos:', error);
                }
            }

            /**
             * Carga los artículos pertenecientes al usuario actual.
             */
            async function loadUserItems(uid) {
                if (!uid) {
                    state.currentUser.items = [];
                    misArticulosCount.textContent = 0;
                    renderMyItems();
                    return;
                }

                try {
                    const itemsQuery = query(collection(db, 'items'), where('ownerId', '==', uid));
                    const snapshot = await getDocs(itemsQuery);
                    const items = [];
                    snapshot.forEach(docSnap => {
                        const mapped = mapProductDoc(docSnap);
                        if (mapped) {
                            items.push(mapped);
                        }
                    });
                    items.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    state.currentUser.items = items;
                    state.currentUser.stats = state.currentUser.stats || { listedCount: 0, completedTrades: 0 };
                    state.currentUser.stats.listedCount = items.length;
                    misArticulosCount.textContent = items.length;
                    renderMyItems();
                } catch (error) {
                    console.error('Error al cargar los artículos del usuario:', error);
                    misArticulosCount.textContent = (state.currentUser.items || []).length;
                }
            }

            /**
             * Carga las ofertas de canje recibidas por el usuario actual.
             */
            async function loadReceivedOffers(uid) {
                if (!uid) {
                    state.receivedOffers = [];
                    ofertasCount.textContent = 0;
                    renderReceivedOffers();
                    return;
                }

                try {
                    const offersQuery = query(
                        collection(db, 'offers'), 
                        where('targetOwnerId', '==', uid),
                        where('status', '==', 'pending')
                    );

                    const snapshot = await getDocs(offersQuery);
                    const offers = [];

                    snapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        
                        // Calculamos los valores para renderizar fácilmente
                        const totalOfferedValue = data.offeredItems.reduce((sum, item) => sum + item.value, 0) + data.additionalCop;
                        const yourValue = data.targetItem.value;

                        offers.push({
                            id: docSnap.id,
                            fromUser: {
                                name: data.proposerName,
                                profilePic: data.proposerProfilePic,
                            },
                            forYourItem: data.targetItem,
                            theirItems: data.offeredItems,
                            additionalCop: data.additionalCop,
                            totalOfferedValue: totalOfferedValue,
                            difference: totalOfferedValue - yourValue
                        });
                    });
                    
                    offers.sort((a, b) => b.createdAt - a.createdAt); // Ordenar por fecha si es necesario
                    state.receivedOffers = offers;
                    ofertasCount.textContent = offers.length;
                    renderReceivedOffers();
                    
                } catch (error) {
                    console.error("Error al cargar ofertas recibidas:", error);
                    state.receivedOffers = [];
                    ofertasCount.textContent = 0;
                    renderReceivedOffers();
                }
            }
            
            /**
             * Crea o actualiza el documento de perfil del usuario autenticado y devuelve los datos consolidados.
             */
            async function ensureUserProfile(user, overrides = {}) {
                if (!user || !user.uid) return null;

                const userDocRef = doc(db, 'users', user.uid);
                const snapshot = await getDoc(userDocRef);
                const existingData = snapshot.exists() ? snapshot.data() : {};
                const hasStats = existingData && typeof existingData.stats === 'object';

                const finalStats = overrides.stats || (hasStats ? existingData.stats : {
                    listedCount: 0,
                    completedTrades: 0,
                });

                const payload = {
                    name: overrides.name ?? existingData.name ?? user.displayName ?? 'Usuario',
                    email: overrides.email ?? existingData.email ?? user.email ?? '',
                    address: overrides.address ?? existingData.address ?? '',
                    doc: overrides.doc ?? existingData.doc ?? '',
                    profilePic: overrides.profilePic ?? existingData.profilePic ?? user.photoURL ?? DEFAULT_PROFILE_PIC,
                    profilePicPath: overrides.profilePicPath ?? existingData.profilePicPath ?? '',
                    role: overrides.role ?? existingData.role ?? 'user',
                    updatedAt: serverTimestamp(),
                };

                if (!snapshot.exists()) {
                    payload.createdAt = serverTimestamp();
                    payload.stats = finalStats;
                } else if (!hasStats || overrides.stats) {
                    payload.stats = finalStats;
                }

                await setDoc(userDocRef, payload, { merge: true });

                return {
                    uid: user.uid,
                    name: payload.name,
                    email: payload.email,
                    address: payload.address,
                    doc: payload.doc,
                    profilePic: payload.profilePic,
                    profilePicPath: payload.profilePicPath,
                    role: payload.role,
                    stats: finalStats,
                };
            }

            /**
             * Garantiza que exista un documento de perfil para el usuario autenticado.
             */
            async function hydrateCurrentUser(user) {
                if (!user) return;

                try {
                    const profile = await ensureUserProfile(user);
                    if (!profile) return;

                    state.currentUser = {
                        uid: user.uid,
                        name: profile.name || user.displayName || 'Usuario',
                        email: profile.email || user.email || '',
                        address: profile.address || '',
                        doc: profile.doc || '',
                        profilePic: profile.profilePic || user.photoURL || DEFAULT_PROFILE_PIC,
                        profilePicPath: profile.profilePicPath || '',
                        items: [],
                        role: profile.role || 'user',
                        stats: profile.stats || {
                            listedCount: 0,
                            completedTrades: 0,
                        },
                    };

                    state.isAdmin = (state.currentUser.role === 'admin') || ((state.currentUser.email || '').toLowerCase() === 'admin@canje.app');
                } catch (error) {
                    console.error('Error al obtener el perfil del usuario:', error);
                }
            }

            /**
             * Elimina un artículo del usuario actual, incluyendo sus archivos en Storage.
             */
            async function deleteUserItem(itemId) {
                if (!itemId) return;

                try {
                    const productRef = doc(db, 'items', itemId);
                    const productSnapshot = await getDoc(productRef);
                    if (productSnapshot.exists()) {
                        const productData = productSnapshot.data();
                        if (productData.ownerId && productData.ownerId !== state.currentUser.uid) {
                            console.warn('No puedes eliminar artículos de otros usuarios.');
                            return;
                        }

                        let statsDecremented = false;
                        await deleteDoc(productRef);

                        try {
                            await deleteDoc(doc(db, 'users', state.currentUser.uid, 'items', itemId));
                        } catch (userItemDeleteError) {
                            console.warn('No se pudo eliminar el artículo de la colección del usuario:', userItemDeleteError);
                        }

                        try {
                            await setDoc(doc(db, 'users', state.currentUser.uid), {
                                'stats.listedCount': increment(-1),
                                updatedAt: serverTimestamp(),
                            }, { merge: true });
                            statsDecremented = true;
                        } catch (statsError) {
                            console.warn('No se pudo actualizar el contador de publicaciones del usuario:', statsError);
                        }

                        const imagePaths = Array.isArray(productData.imagePaths) ? productData.imagePaths : [];
                        if (imagePaths.length > 0) {
                            await Promise.allSettled(imagePaths.map(path => {
                                try {
                                    const fileRef = storageRef(storage, path);
                                    return deleteObject(fileRef);
                                } catch (storageError) {
                                    console.error('Error al preparar la eliminación de una imagen:', storageError);
                                    return Promise.resolve();
                                }
                            }));
                        }

                        if (statsDecremented) {
                            state.currentUser.stats = state.currentUser.stats || { listedCount: 0, completedTrades: 0 };
                            state.currentUser.stats.listedCount = Math.max(0, (state.currentUser.stats.listedCount || 1) - 1);
                        }
                    }
                } catch (error) {
                    console.error('Error al eliminar el artículo:', error);
                }

                state.currentUser.items = (state.currentUser.items || []).filter(item => item.id !== itemId);
                state.allProducts = state.allProducts.filter(item => item.id !== itemId);
                renderMyItems();
                renderProducts();
                renderMostViewedProducts();
                misArticulosCount.textContent = (state.currentUser.items || []).length;
            }

            /**
             * Traduce códigos de error de Firebase Auth a mensajes legibles.
             */
            function getAuthErrorMessage(error) {
                if (!error) return 'Ocurrió un error inesperado. Intenta nuevamente.';
                const errorCode = error.code || '';
                const messages = {
                    'auth/invalid-email': 'El correo electrónico no es válido.',
                    'auth/user-disabled': 'La cuenta ha sido deshabilitada.',
                    'auth/user-not-found': 'No encontramos una cuenta con este correo.',
                    'auth/wrong-password': 'La contraseña es incorrecta.',
                    'auth/email-already-in-use': 'Este correo ya está registrado.',
                    'auth/weak-password': 'La contraseña debe tener al menos 6 caracteres.',
                    'auth/too-many-requests': 'Demasiados intentos. Intenta más tarde.',
                };
                return messages[errorCode] || error.message || 'Ocurrió un error inesperado. Intenta nuevamente.';
            }
            
            /**
             * Previsualiza la imagen de perfil al seleccionarla.
             */
            function handleProfilePicUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        profilePicPreview.src = e.target.result;
                        // state.currentUser.profilePic se actualiza al registrarse
                    };
                    reader.readAsDataURL(file);
                    state.profilePicFile = file;
                } else {
                    state.profilePicFile = null;
                }
            }

            // --- NUEVAS FUNCIONES ---

            /**
             * Abre el menú lateral móvil.
             */
            function openMobileMenu() {
                mobileMenuPanel.classList.remove('-translate-x-full');
                mobileMenuBackdrop.classList.remove('hidden');
            }

            /**
             * Cierra el menú lateral móvil.
             */
            function closeMobileMenu() {
                mobileMenuPanel.classList.add('-translate-x-full');
                mobileMenuBackdrop.classList.add('hidden');
            }
            
            /**
             * Carga la lista de categorías en la sección Explorar. (MODIFICADO)
             */
            function populateCategoryList() {
                if (!categoryListContainer) return;
                categoryListContainer.innerHTML = '';
                categories.forEach(cat => {
                    const catHtml = `
                        <a href="#" class="flex flex-col items-center flex-shrink-0 w-24 space-y-2 group category-link" data-category-id="${cat.id}">
                            <div class="flex items-center justify-center w-16 h-16 bg-white border border-gray-200 rounded-full shadow-sm group-hover:bg-brand-light group-hover:border-brand category-item-icon">
                                <i data-lucide="${cat.icon}" class="w-8 h-8 text-gray-600 group-hover:text-brand-dark"></i>
                                <i data-lucide="gem" class="w-5 h-5 text-yellow-500 premium-icon"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700">${cat.name}</span>
                        </a>
                    `;
                    categoryListContainer.insertAdjacentHTML('beforeend', catHtml);
                });

                // Añadir listeners para rastrear vistas
                categoryListContainer.querySelectorAll('.category-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        logCategoryView(e.currentTarget.dataset.categoryId);
                    });
                });

                lucide.createIcons(); // Renderizar nuevos iconos
            }

            /**
             * Carga las categorías en el <select> del formulario Vender.
             */
            function populateCategorySelect() {
                if (!categorySelect) return;
                categorySelect.innerHTML = '<option value="">Selecciona una categoría</option>';
                categories.forEach(cat => {
                    const optionHtml = `<option value="${cat.id}">${cat.name}</option>`;
                    categorySelect.insertAdjacentHTML('beforeend', optionHtml);
                });
            }

            
            /**
             * Abre el modal de edición de tiempo (Admin).
             */
            function openTimerModal(e) {
                e.stopPropagation(); // Evitar que el clic active otra cosa
                const slide = e.currentTarget.closest('.carousel-slide');
                if (!slide) return;
                
                state.editingTimerSlide = slide;
                const currentEndTime = slide.dataset.endTime;
                // Formatear para datetime-local input (requiere YYYY-MM-DDTHH:MM)
                try {
                    const inputDateTime = new Date(currentEndTime).toISOString().slice(0, 16);
                    document.getElementById('timer-datetime').value = inputDateTime;
                } catch (err) {
                    console.error("Fecha inválida:", currentEndTime);
                }
                
                modalEditTimer.classList.remove('hidden');
                modalEditTimer.classList.add('open');
            }

            /**
             * Cierra el modal de edición de tiempo.
             */
            function closeTimerModal() {
                modalEditTimer.classList.add('hidden');
                modalEditTimer.classList.remove('open');
                state.editingTimerSlide = null;
            }
            
            // --- NUEVAS FUNCIONES (Renderizado Dinámico) ---

            /**
             * Registra la vista de una categoría y actualiza el carrusel de "más vistos".
             */
            function logCategoryView(categoryId) {
                if (!categoryId) return;
                state.viewedCategoryHistory[categoryId] = (state.viewedCategoryHistory[categoryId] || 0) + 1;
                // console.log("Category views:", state.viewedCategoryHistory); // Para debugging
                
                // Actualizar la sección de "más vistos" en tiempo real
                renderMostViewedProducts(); 
            }

            /**
             * Renderiza el carrusel de "Productos más vistos".
             */
            function renderMostViewedProducts() {
                let productsToShow = [];
                let title = "Populares"; // Título por defecto

                // 1. Encontrar la categoría más vista
                const viewedCategories = Object.entries(state.viewedCategoryHistory); // [['juegos', 2], ['deportes', 1]]
                
                if (viewedCategories.length > 0) {
                    // Ordenar por vistas, descendente
                    viewedCategories.sort((a, b) => b[1] - a[1]);
                    const mostViewedCategoryId = viewedCategories[0][0];
                    const categoryObj = categories.find(c => c.id === mostViewedCategoryId);
                    
                    if (categoryObj) {
                        title = `Relacionados con ${categoryObj.name}`;
                    }

                    // 2. Filtrar productos por esa categoría
                    productsToShow = state.allProducts.filter(p => p.categoryId === mostViewedCategoryId);
                    
                    // 3. (Opcional) Si el filtro no da resultados, mostrar populares
                    if (productsToShow.length === 0) {
                        productsToShow = [...state.allProducts].sort(() => 0.5 - Math.random()).slice(0, 10); // 10 aleatorios
                        title = "Populares";
                    }

                } else {
                    // 4. Sin historial de vistas, mostrar "Populares" (p.ej. los 10 primeros)
                    productsToShow = state.allProducts.slice(0, 10);
                }

                // 5. Actualizar el título de la sección
                const titleElement = mostViewedContainer.previousElementSibling; // El H3
                if (titleElement && titleElement.tagName === 'H3') {
                    titleElement.textContent = title;
                }

                // 6. Renderizar las tarjetas del carrusel
                mostViewedContainer.innerHTML = ''; // Limpiar
                if (productsToShow.length === 0) {
                    mostViewedContainer.innerHTML = '<p class="text-gray-500 pl-2">No hay artículos en esta sección.</p>';
                    return;
                }

                productsToShow.forEach(product => {
                    const cardHtml = `
                        <div class="flex-shrink-0 w-64 overflow-hidden bg-white border border-gray-200 rounded-lg shadow-sm">
                            <img src="${product.imageUrl}" alt="${product.name}" class="object-cover w-full h-40">
                            <div class="p-4">
                                <h4 class="font-semibold text-gray-900 truncate">${product.name}</h4>
                                <p class="text-sm text-gray-500 truncate">Busca: ${product.wants}</p>
                                <p class="mt-2 text-sm font-medium text-gray-700">Equivalente a: <span class="text-green-600">${formatCOP(product.value)}</span></p>
                                <button class="btn-proponer-canje w-full px-4 py-2 mt-3 text-sm font-medium text-white transition-colors bg-brand rounded-lg hover:bg-brand-dark" data-item-id="${product.id}" data-item-name="${product.name}" data-item-value="${product.value}" data-category-id="${product.categoryId}">
                                    Proponer Canje
                                </button>
                            </div>
                        </div>
                    `;
                    mostViewedContainer.insertAdjacentHTML('beforeend', cardHtml);
                });

                // 7. Re-asignar listeners a los *nuevos* botones creados
                assignProponerCanjeListeners();
            }

            /**
             * Renderiza la grilla de productos en "Explorar".
             */
            function renderProducts() {
                explorarProductGrid.innerHTML = ''; // Limpiar grilla
                if (state.allProducts.length === 0) {
                     explorarProductGrid.innerHTML = '<p class="text-gray-500 col-span-full">No hay artículos publicados por el momento.</p>';
                         return;
                }
                
                state.allProducts.forEach(product => {
                    const productHtml = `
                        <div class="overflow-hidden bg-white border border-gray-200 rounded-lg shadow-sm">
                            <img src="${product.imageUrl}" alt="${product.name}" class="object-cover w-full h-40">
                            <div class="p-4">
                                <h4 class="font-semibold text-gray-900 truncate">${product.name}</h4>
                                <p class="text-sm text-gray-500 truncate">Busca: ${product.wants}</p>
                                <p class="mt-2 text-sm font-medium text-gray-700">Equivalente a: <span class="text-green-600">${formatCOP(product.value)}</span></p>
                                <button class="btn-proponer-canje w-full px-4 py-2 mt-3 text-sm font-medium text-white transition-colors bg-brand rounded-lg hover:bg-brand-dark" data-item-id="${product.id}" data-item-name="${product.name}" data-item-value="${product.value}" data-category-id="${product.categoryId}">
                                    Proponer Canje
                                </button>
                            </div>
                        </div>
                    `;
                    explorarProductGrid.insertAdjacentHTML('beforeend', productHtml);
                });

                // Volver a asignar listeners a los nuevos botones
                assignProponerCanjeListeners();
            }

            /**
             * Renderiza la lista de "Mis Artículos" en "Mis Canjes".
             */
            function renderMyItems() {
                tabMisArticulos.innerHTML = ''; // Limpiar
                if (!state.currentUser.items || state.currentUser.items.length === 0) {
                    tabMisArticulos.innerHTML = '<p class="text-gray-500">No has publicado ningún artículo.</p>';
                    return;
                }

                state.currentUser.items.forEach(item => {
                    const itemHtml = `
                        <div class="flex items-center p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                            <img src="${item.imageUrl}" alt="${item.name}" class="w-16 h-16 rounded-lg object-cover flex-shrink-0">
                            <div class="ml-4 flex-1 min-w-0">
                                <h4 class="font-semibold text-gray-900 truncate">${item.name}</h4>
                                <p class="text-sm text-gray-500">Valor: <span class="text-green-600">${formatCOP(item.value)}</span></p>
                                <p class="text-sm text-gray-500 truncate">Buscas: ${item.wants || 'No especificado'}</p>
                            </div>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 ml-2">
                                <button class="p-2 text-gray-500 rounded-lg hover:bg-gray-100 hover:text-brand" title="Editar">
                                    <i data-lucide="pencil" class="w-5 h-5"></i>
                                </button>
                                <button class="p-2 text-gray-500 rounded-lg hover:bg-gray-100 hover:text-red-600 btn-eliminar-item" data-item-id="${item.id}" title="Eliminar">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    tabMisArticulos.insertAdjacentHTML('beforeend', itemHtml);
                });
                lucide.createIcons();
            }

            /**
             * Renderiza las "Ofertas Recibidas" en "Mis Canjes".
             */
            function renderReceivedOffers() {
                tabOfertas.innerHTML = ''; // Limpiar
                if (!state.receivedOffers || state.receivedOffers.length === 0) {
                    tabOfertas.innerHTML = '<p class="text-gray-500">No tienes ofertas recibidas.</p>';
                    return;
                }
                
                state.receivedOffers.forEach(offer => {
                    const offerHtml = `
                        <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                            <div class="flex items-center justify-between pb-3 border-b border-gray-200">
                                <div>
                                    <p class="text-sm text-gray-500">Oferta de: <span class="font-medium text-gray-900">${offer.fromUser.name}</span></p>
                                    <p class="text-sm text-gray-500">Quiere tu: <span class="font-medium text-brand-dark">${offer.forYourItem.name}</span></p>
                                </div>
                                <img src="${offer.fromUser.profilePic}" alt="${offer.fromUser.name}" class="w-10 h-10 rounded-full">
                            </div>

                            <div class="flex flex-col md:flex-row items-center justify-between mt-4">
                                <div class="w-full md:w-2/5">
                                    <span class="text-sm font-semibold text-gray-700">Te ofrecen:</span>
                                    <div class="mt-2 space-y-2">
                                        ${offer.theirItems.map(item => `
                                            <div class="flex items-center p-2 bg-gray-50 rounded-md">
                                                <img src="${item.imageUrl}" alt="${item.name}" class="w-10 h-10 rounded-md object-cover flex-shrink-0">
                                                <div class="ml-2 flex-1 min-w-0">
                                                    <p class="text-sm font-medium truncate">${item.name}</p>
                                                    <p class="text-sm text-green-600">${formatCOP(item.value)}</p>
                                                </div>
                                            </div>
                                        `).join('')}
                                        
                                        ${offer.additionalCop > 0 ? `
                                            <div class="flex items-center p-2 bg-gray-50 rounded-md">
                                                <div class="w-10 h-10 rounded-md flex-shrink-0 bg-green-100 flex items-center justify-center">
                                                    <i data-lucide="banknote" class="w-6 h-6 text-green-600"></i>
                                                </div>
                                                <div class="ml-2 flex-1 min-w-0">
                                                    <p class="text-sm font-medium truncate">Dinero Adicional</p>
                                                    <p class="text-sm text-green-600">${formatCOP(offer.additionalCop)}</p>
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                
                                <div class="text-gray-400 my-4 md:my-0">
                                    <i data-lucide="arrow-right-left" class="w-6 h-6"></i>
                                </div>

                                <div class="w-full md:w-2/5">
                                    <span class="text-sm font-semibold text-gray-700">A cambio de:</span>
                                    <div class="mt-2 space-y-2">
                                        <div class="flex items-center p-2 bg-gray-50 rounded-md">
                                            <img src="${offer.forYourItem.imageUrl}" alt="${offer.forYourItem.name}" class="w-10 h-10 rounded-md object-cover flex-shrink-0">
                                            <div class="ml-2 flex-1 min-w-0">
                                                <p class="text-sm font-medium truncate">${offer.forYourItem.name}</p>
                                                <p class="text-sm text-gray-700">${formatCOP(offer.forYourItem.value)}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="p-4 mt-4 bg-gray-50 border border-gray-200 rounded-lg">
                                <h4 class="font-medium text-center text-gray-800">Resumen de la Oferta</h4>
                                <div class="mt-2 space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Valor total ofrecido:</span>
                                        <span class="font-medium text-green-600">${formatCOP(offer.totalOfferedValue)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Tu valor:</span>
                                        <span class="font-medium text-gray-800">${formatCOP(offer.forYourItem.value)}</span>
                                    </div>
                                    <div class="flex justify-between pt-2 mt-2 border-t">
                                        <span class="font-semibold">Diferencia (a tu favor):</span>
                                        <span class="font-semibold ${offer.difference >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCOP(offer.difference)}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="flex flex-col mt-4 space-y-2 md:flex-row md:space-y-0 md:space-x-3">
                                <button class="flex-1 px-4 py-2 text-sm font-medium text-white transition-colors bg-green-600 rounded-lg hover:bg-green-700">Aceptar Canje</button>
                                <button class="flex-1 btn-negociar px-4 py-2 text-sm font-medium text-white transition-colors bg-brand rounded-lg hover:bg-brand-dark">Negociar</button>
                                <button class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 transition-colors bg-gray-100 rounded-lg hover:bg-gray-200">Rechazar</button>
                            </div>

                            <div class="hidden p-4 mt-4 bg-gray-50 border border-gray-200 rounded-lg negotiation-form">
                                <h5 class="font-semibold">Negociar Canje</h5>
                                <p class="text-sm text-gray-600">Puedes proponer un artículo diferente o pedir una diferencia en dinero.</p>
                                <div class="mt-3">
                                    <label for="contra-oferta-cop-${offer.id}" class="block text-sm font-medium text-gray-700">Pedir diferencia (COP):</label>
                                    <input type="number" id="contra-oferta-cop-${offer.id}" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" placeholder="Ej: 50000">
                                </div>
                                <div class="mt-3">
                                    <button class="px-4 py-2 text-sm font-medium text-white bg-brand rounded-lg hover:bg-brand-dark">Enviar Contraoferta</button>
                                </div>
                            </div>
                        </div>
                    `;
                    tabOfertas.insertAdjacentHTML('beforeend', offerHtml);
                });
                lucide.createIcons();
            }


            // --- NUEVAS FUNCIONES (Vender Fotos) ---

            /**
             * Muestra un mensaje de error en el formulario de fotos.
             */
            function showPhotoError(message) {
                photoErrorMsg.textContent = message;
                photoErrorMsg.classList.remove('hidden');
                // Ocultar el error después de 3 segundos
                setTimeout(() => {
                    photoErrorMsg.classList.add('hidden');
                }, 3000);
            }

            /**
             * Muestra un mensaje de error en el formulario de publicación.
             */
            function showPublicarError(message, btn) {
                publicarErrorMsg.textContent = message;
                publicarErrorMsg.classList.remove('hidden');
                btn.textContent = 'Error al publicar';
                btn.classList.add('bg-red-600', 'hover:bg-red-700');

                setTimeout(() => {
                    publicarErrorMsg.classList.add('hidden');
                    btn.textContent = 'Publicar Artículo';
                    btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    btn.disabled = false;
                }, 3000);
            }

            /**
             * Maneja los archivos seleccionados (click o drop) y los añade al estado.
             */
            function handleFiles(files) {
                const newFiles = Array.from(files);
                let addedCount = 0;
                photoErrorMsg.classList.add('hidden'); // Limpiar errores antiguos

                if (state.productFiles.length + newFiles.length > 10) {
                    showPhotoError(`Límite de 10 fotos. Solo puedes añadir ${10 - state.productFiles.length} más.`);
                }

                for (const file of newFiles) {
                    if (state.productFiles.length >= 10) {
                        break; // Límite alcanzado
                    }
                    if (file.type.startsWith('image/')) {
                        // Evitar duplicados (simple check por nombre y tamaño)
                        const isDuplicate = state.productFiles.some(
                            f => f.file.name === file.name && f.file.size === file.size
                        );
                        if (!isDuplicate) {
                            // Leer el archivo para obtener DataURL para la vista previa
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                // Almacenar el objeto File Y su DataURL
                                state.productFiles.push({
                                    file: file,
                                    dataURL: e.target.result
                                });
                                addedCount++;
                                // Actualizar la vista previa *después* de que se carga el archivo
                                // Se llama aquí para asegurar que dataURL esté listo
                                updatePhotoPreview(); 
                            };
                            reader.readAsDataURL(file);
                        }
                    } else {
                        showPhotoError(`Archivo "${file.name}" no es una imagen y fue omitido.`);
                    }
                }
            }

            /**
             * Actualiza el DOM para mostrar las vistas previas de las fotos.
             */
            function updatePhotoPreview() {
                photoPreviewContainer.innerHTML = ''; // Limpiar vistas previas

                // Actualizar el cuadro de "subir"
                if (state.productFiles.length === 0) {
                    photoUploadText.classList.remove('hidden');
                    photoUploadSummary.classList.add('hidden');
                } else {
                    photoUploadText.classList.add('hidden');
                    photoUploadSummary.classList.remove('hidden');
                    photoCount.textContent = state.productFiles.length;
                }

                // Renderizar cada vista previa desde el estado
                state.productFiles.forEach((fileData, index) => {
                    const previewHtml = `
                        <div class="photo-preview-item">
                            <img src="${fileData.dataURL}" alt="${fileData.file.name}" class="absolute top-0 left-0 w-full h-full object-cover">
                            <button type="button" class="btn-remove-photo" data-index="${index}" title="Quitar imagen">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `;
                    photoPreviewContainer.insertAdjacentHTML('beforeend', previewHtml);
                });
                
                // Esta llamada es crucial después de añadir iconos dinámicamente
                lucide.createIcons();   
                
                // Limpiar el valor del input para permitir volver a subir el mismo archivo si se borra
                productPhotoInput.value = null;
            }


            // --- LÓGICA DE CARRUSEL Y TEMPORIZADOR (MODIFICADA PARA DINAMISMO) ---

            /**
             * Carga los banners desde Firestore y los renderiza en el carrusel.
             */
            async function loadAndRenderBanners() {
                try {
                    const bannersQuery = query(collection(db, "banners"), orderBy("createdAt", "desc"));
                    const snapshot = await getDocs(bannersQuery);
                    
                    carouselSlider.innerHTML = ''; // Vaciar el carrusel antes de llenarlo
                    
                    if (snapshot.empty) {
                        carouselSlider.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-100 text-gray-500">No hay banners para mostrar.</div>`;
                        totalSlides = 0;
                        return;
                    }

                        snapshot.forEach(docSnap => {
                            const banner = docSnap.data();
                            const endTime = banner.endTime && banner.endTime.toDate ? banner.endTime.toDate().toISOString() : new Date().toISOString();

                            const slideHtml = `
                                <div class="relative flex-shrink-0 w-full h-full overflow-hidden rounded-lg carousel-slide" data-end-time="${endTime}" data-banner-id="${docSnap.id}" data-image-path="${banner.imagePath || ''}">
                                    <img src="${banner.imageUrl}" alt="${banner.title}" class="object-cover w-full h-full" loading="lazy" decoding="async">
                                    <div class="sr-only">
                                        <h2>${banner.title || ''}</h2>
                                        <p>${banner.subtitle || ''}</p>
                                    </div>
                                    <div class="absolute top-3 right-3 md:top-4 md:right-4 flex items-center gap-2">
                                        <div class="promo-timer" role="timer" aria-live="polite"><span>Cargando...</span></div>
                                        <button class="p-1 text-gray-800 bg-white rounded-full shadow-sm admin-only hidden hover:bg-brand-light focus:outline-none focus:ring-2 focus:ring-brand-yellow admin-edit-timer-btn" title="Editar temporizador">
                                            <i data-lucide="pencil" class="w-4 h-4"></i>
                                        </button>
                                        <button class="p-1 text-white bg-red-600 rounded-full shadow-sm admin-only hidden hover:bg-red-500 focus:outline-none focus:ring-2 focus:ring-red-300 btn-delete-banner" title="Eliminar banner">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        carouselSlider.insertAdjacentHTML('beforeend', slideHtml);
                    });

                    // Reinicializar la lógica del carrusel con los nuevos slides
                    resetCarousel();

                } catch (error) {
                    console.error("Error cargando los banners:", error);
                    carouselSlider.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-100 text-red-500">Error al cargar banners.</div>`;
                }
            }

            /**
             * Reinicia el carrusel después de cargar contenido dinámico.
             */
            function resetCarousel() {
                const slides = document.querySelectorAll('.carousel-slide');
                totalSlides = slides.length;
                currentSlide = 0;
                updateCarousel();
                startCarouselAutoPlay();
                startTimers(); // Inicia los contadores de tiempo
                updateAuthUI(); // Asegura que los botones de admin se muestren/oculten
                lucide.createIcons(); // Vuelve a renderizar los iconos
            }


            function updateCarousel() {
                 if (totalSlides > 0) {
                    carouselSlider.style.transform = `translateX(-${currentSlide * 100}%)`;
                 }
            }

            function nextSlide() {
                if (totalSlides > 0) {
                    currentSlide = (currentSlide + 1) % totalSlides;
                    updateCarousel();
                }
            }

            function prevSlide() {
                if (totalSlides > 0) {
                    currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
                    updateCarousel();
                }
            }
            
            function startCarouselAutoPlay() {
                if (carouselInterval) clearInterval(carouselInterval);
                if (totalSlides > 1) { // Solo auto-play si hay más de un slide
                    carouselInterval = setInterval(nextSlide, 5000);
                }
            }

            function stopCarouselAutoPlay() {
                clearInterval(carouselInterval);
            }

            function startTimers() {
                document.querySelectorAll('.promo-timer').forEach(timerEl => {
                    const slide = timerEl.closest('.carousel-slide');
                    if (!slide) return;

                    const endTimeAttr = slide.dataset.endTime;
                    const endTime = new Date(endTimeAttr).getTime();

                    if (timerEl.dataset.intervalId) {
                        clearInterval(timerEl.dataset.intervalId);
                    }

                    timerEl.classList.remove('promo-timer--expired');
                    timerEl.setAttribute('aria-label', 'Tiempo restante de la promoción');

                    function updateTimer() {
                        const now = new Date().getTime();
                        const distance = endTime - now;

                        if (distance <= 0) {
                            clearInterval(timerEl.dataset.intervalId);
                            timerEl.classList.add('promo-timer--expired');
                            timerEl.innerHTML = `<span class="timer-finished">Expirado</span>`;
                            return;
                        }

                        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                        const f = (n) => n.toString().padStart(2, '0');
                        const segment = (value, label) => `
                            <div class="timer-chip">
                                <span class="timer-value">${f(value)}</span>
                                <span class="timer-label">${label}</span>
                            </div>
                        `;

                        timerEl.classList.remove('promo-timer--expired');
                        timerEl.innerHTML = `
                            <div class="timer-stack">
                                ${segment(days, 'd')}
                                ${segment(hours, 'h')}
                                ${segment(minutes, 'm')}
                                ${segment(seconds, 's')}
                            </div>
                        `;
                    }

                    const intervalId = setInterval(updateTimer, 1000);
                    timerEl.dataset.intervalId = intervalId;
                    updateTimer(); // Llamada inicial
                });
            }

            // --- EVENT LISTENERS ---

            // Navegación principal
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = e.currentTarget.dataset.page;
                    if ((pageId === 'page-canjes' || pageId === 'page-vender') && !state.isLoggedIn) {
                        showPage('page-perfil');
                    } else {
                        showPage(pageId);
                    }
                });
            });
            
            // Menú Móvil
            mobileMenuBtn.addEventListener('click', openMobileMenu);
            mobileMenuBackdrop.addEventListener('click', closeMobileMenu);
            mobileMenuLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = e.currentTarget.dataset.page;
                    if ((pageId === 'page-canjes' || pageId === 'page-vender') && !state.isLoggedIn) {
                        showPage('page-perfil');
                    } else {
                        showPage(pageId);
                    }
                    closeMobileMenu();
                });
            });

            // Modal Admin Timer
            formEditTimer.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!state.editingTimerSlide) return;

                const bannerId = state.editingTimerSlide.dataset.bannerId;
                const newDateTime = document.getElementById('timer-datetime').value;

                if (!bannerId || !newDateTime) return;
                
                try {
                    const bannerRef = doc(db, "banners", bannerId);
                    // Firestore espera un objeto Date de JS para los Timestamps
                    await setDoc(bannerRef, { endTime: new Date(newDateTime) }, { merge: true });
                    
                    // Actualizar el dataset localmente y reiniciar los timers
                    state.editingTimerSlide.dataset.endTime = new Date(newDateTime).toISOString();
                    startTimers(); 
                    closeTimerModal();

                } catch (error) {
                    console.error("Error actualizando el temporizador del banner:", error);
                    alert("No se pudo actualizar el temporizador.");
                }
            });

            modalEditTimer.querySelector('.modal-backdrop').addEventListener('click', closeTimerModal);
            modalEditTimer.querySelector('.modal-close-btn').addEventListener('click', closeTimerModal);


            // Tabs de Autenticación
            authTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.dataset.authTab;
                    authTabContents.forEach(content => content.classList.add('hidden'));
                    authTabs.forEach(t => {
                        t.classList.remove('text-brand', 'border-brand');
                        t.classList.add('text-gray-500', 'border-transparent');
                    });
                    document.getElementById(targetId).classList.remove('hidden');
                    e.currentTarget.classList.add('text-brand', 'border-brand');
                    e.currentTarget.classList.remove('text-gray-500', 'border-transparent');
                });
            });

            // Tabs de "Mis Canjes"
            canjeTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.dataset.tab;
                    canjeTabContents.forEach(content => content.classList.add('hidden'));
                    canjeTabs.forEach(t => {
                        t.classList.remove('text-brand', 'border-brand');
                        t.classList.add('text-gray-500', 'border-transparent');
                    });
                    document.getElementById(targetId).classList.remove('hidden');
                    e.currentTarget.classList.add('text-brand', 'border-brand');
                    e.currentTarget.classList.remove('text-gray-500', 'border-transparent');
                });
            });

            // Barra lateral
            sidebarToggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                mainContentWrapper.classList.toggle('sidebar-collapsed');
            });

            // Input de Foto de Perfil
            profilePicUpload.addEventListener('change', handleProfilePicUpload);


            // --- NUEVOS LISTENERS (Vender Fotos) ---

            // Input de Archivo (Click)
            productPhotoInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            // Drag & Drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                photoUploadLabel.addEventListener(eventName, e => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                photoUploadLabel.addEventListener(eventName, () => {
                    photoUploadLabel.classList.add('border-brand', 'bg-brand-light');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                photoUploadLabel.addEventListener(eventName, () => {
                    photoUploadLabel.classList.remove('border-brand', 'bg-brand-light');
                }, false);
            });

            photoUploadLabel.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            });

            // Delegación de eventos para borrar fotos
            photoPreviewContainer.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.btn-remove-photo');
                if (removeBtn) {
                    e.preventDefault();
                    const indexToRemove = parseInt(removeBtn.dataset.index, 10);
                    if (!isNaN(indexToRemove)) {
                        state.productFiles.splice(indexToRemove, 1);
                        updatePhotoPreview();
                    }
                }
            });



            // --- LÓGICA DE AUTENTICACIÓN (Firebase) ---

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    state.isLoggedIn = true;
                    await hydrateCurrentUser(user);
                    await loadUserItems(user.uid);
                    await loadReceivedOffers(user.uid); // <-- LÍNEA NUEVA
                    await loadAllProducts();
                    updateAuthUI();
                    showPage('page-perfil');
                } else {
                    state.isLoggedIn = false;
                    state.isAdmin = false;
                    state.currentUser = {
                        uid: null,
                        name: '',
                        email: '',
                        address: '',
                        doc: '',
                        profilePic: DEFAULT_PROFILE_PIC,
                        profilePicPath: '',
                        items: [],
                        role: 'user',
                        stats: {
                            listedCount: 0,
                            completedTrades: 0,
                        },
                    };
                    state.profilePicFile = null;
                    updateAuthUI();
                    showPage('page-perfil');
                }
            });

            formLogin.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = formLogin.querySelector('button[type="submit"]');
                const email = document.getElementById('email-login').value.trim().toLowerCase();
                const password = document.getElementById('pass-login').value;

                if (loginErrorMsg) {
                    loginErrorMsg.classList.add('hidden');
                }

                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Ingresando...';
                }

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    formLogin.reset();
                } catch (error) {
                    console.error('Error al iniciar sesión:', error);
                    if (loginErrorMsg) {
                        loginErrorMsg.textContent = getAuthErrorMessage(error);
                        loginErrorMsg.classList.remove('hidden');
                    }
                } finally {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Entrar';
                    }
                }
            });

            formRegister.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = formRegister.querySelector('button[type="submit"]');

                if (registerErrorMsg) {
                    registerErrorMsg.classList.add('hidden');
                }

                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Creando cuenta...';
                }

                const name = document.getElementById('nombre-reg').value.trim();
                const docNumber = document.getElementById('doc-reg').value.trim();
                const address = document.getElementById('dir-reg').value.trim();
                const email = document.getElementById('email-reg').value.trim().toLowerCase();
                const password = document.getElementById('pass-reg').value;

                let profilePicPath = '';
                let newUserUid = null;
                let newlyCreatedUser = null;

                try {
                    const credential = await createUserWithEmailAndPassword(auth, email, password);
                    const { user } = credential;
                    newUserUid = user.uid;
                    newlyCreatedUser = user;

                    let profilePicUrl = profilePicPreview ? profilePicPreview.src : DEFAULT_PROFILE_PIC;

                    if (state.profilePicFile) {
                        const file = state.profilePicFile;
                        const sanitizedName = file.name.replace(/\s+/g, '-');
                        const uniquePath = `profilePictures/${user.uid}/${Date.now()}-${sanitizedName}`;
                        const fileRef = storageRef(storage, uniquePath);
                        const uploadResult = await uploadBytes(fileRef, file);
                        profilePicUrl = await getDownloadURL(uploadResult.ref);
                        profilePicPath = uploadResult.metadata && uploadResult.metadata.fullPath ? uploadResult.metadata.fullPath : fileRef.fullPath;
                    }

                    try {
                        await updateProfile(user, {
                            displayName: name,
                            photoURL: profilePicUrl,
                        });
                    } catch (profileError) {
                        console.warn('No se pudo actualizar el perfil de Firebase Auth:', profileError);
                    }

                    const profileData = await ensureUserProfile(user, {
                        name,
                        email,
                        address,
                        doc: docNumber,
                        profilePic: profilePicUrl,
                        profilePicPath,
                    });

                    if (profileData) {
                        state.currentUser = {
                            ...state.currentUser,
                            ...profileData,
                            uid: user.uid,
                            items: [],
                        };
                        state.isAdmin = (state.currentUser.role === 'admin') || ((state.currentUser.email || '').toLowerCase() === 'admin@canje.app');
                        state.isLoggedIn = true;
                        updateAuthUI();
                        showPage('page-perfil');
                    }

                    formRegister.reset();
                    state.profilePicFile = null;
                    if (profilePicPreview) {
                        profilePicPreview.src = defaultProfilePreviewSrc;
                    }
                } catch (error) {
                    if (profilePicPath) {
                        try {
                            const fileRef = storageRef(storage, profilePicPath);
                            await deleteObject(fileRef);
                        } catch (storageError) {
                            console.warn('No se pudo limpiar la foto de perfil temporal:', storageError);
                        }
                    }
                    if (newUserUid && newlyCreatedUser) {
                        try {
                            await deleteUser(newlyCreatedUser);
                        } catch (deleteError) {
                            console.warn('No se pudo eliminar la cuenta creada tras un fallo de registro:', deleteError);
                        }
                    }
                    console.error('Error al registrar el usuario:', error);
                    if (registerErrorMsg) {
                        registerErrorMsg.textContent = getAuthErrorMessage(error);
                        registerErrorMsg.classList.remove('hidden');
                    }
                } finally {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Crear Cuenta';
                    }
                }
            });

            btnLogout.addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error('Error al cerrar sesión:', error);
                }
            });

            // --- LÓGICA DE PUBLICAR (Firebase Storage + Firestore) ---

            formVender.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = e.currentTarget.querySelector('button[type="submit"]');

                publicarErrorMsg.classList.add('hidden');
                submitBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-green-600', 'hover:bg-green-700');
                submitBtn.textContent = 'Publicar Artículo';
                submitBtn.disabled = false;

                if (!state.isLoggedIn || !state.currentUser.uid) {
                    showPublicarError('Debes iniciar sesión para publicar un artículo.', submitBtn);
                    return;
                }

                if (state.productFiles.length < 2) {
                    showPublicarError('Debes subir un mínimo de 2 fotos.', submitBtn);
                    return;
                }

                if (state.productFiles.length > 10) {
                    showPublicarError('Has excedido el límite de 10 fotos.', submitBtn);
                    return;
                }

                const categoryId = document.getElementById('categoria').value;
                if (!categoryId) {
                    showPublicarError('Debes seleccionar una categoría.', submitBtn);
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'Publicando...';

                const imageUrls = [];
                const imagePaths = [];
                let productDocRef = null;
                let userItemDocCreated = false;
                let statsIncremented = false;

                try {
                    const firebaseUser = auth.currentUser;
                    if (firebaseUser) {
                        try {
                            const ensuredProfile = await ensureUserProfile(firebaseUser, {
                                name: state.currentUser.name,
                                email: state.currentUser.email,
                                profilePic: state.currentUser.profilePic,
                            });
                            if (ensuredProfile) {
                                state.currentUser = {
                                    ...state.currentUser,
                                    ...ensuredProfile,
                                    items: state.currentUser.items || [],
                                };
                            }
                        } catch (profileError) {
                            console.warn('No se pudo sincronizar el perfil del usuario antes de publicar:', profileError);
                        }
                    }

                    let index = 0;
                    for (const fileData of state.productFiles) {
                        const file = fileData.file;
                        const sanitizedName = file.name.replace(/\s+/g, '-');
                        const uniquePath = `productImages/${state.currentUser.uid}/${Date.now()}-${index}-${sanitizedName}`;
                        const fileRef = storageRef(storage, uniquePath);
                        const uploadResult = await uploadBytes(fileRef, file);
                        const downloadURL = await getDownloadURL(uploadResult.ref);
                        imageUrls.push(downloadURL);
                        imagePaths.push(uploadResult.metadata && uploadResult.metadata.fullPath ? uploadResult.metadata.fullPath : fileRef.fullPath);
                        index += 1;
                    }

                    const productPayload = {
                        name: document.getElementById('titulo').value,
                        wants: document.getElementById('busco').value,
                        value: Number(document.getElementById('valor-cop').value) || 0,
                        description: document.getElementById('descripcion').value || '',
                        categoryId,
                        imageUrl: imageUrls[0] || DEFAULT_PRODUCT_IMAGE,
                        imageUrls,
                        imagePaths,
                        ownerId: state.currentUser.uid,
                        ownerName: state.currentUser.name || '',
                        ownerEmail: state.currentUser.email || '',
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp(),
                    };

                    productDocRef = await addDoc(collection(db, 'items'), productPayload);

                    await setDoc(doc(db, 'users', state.currentUser.uid, 'items', productDocRef.id), {
                        productId: productDocRef.id,
                        productName: productPayload.name,
                        imageUrl: productPayload.imageUrl,
                        categoryId: productPayload.categoryId,
                        value: productPayload.value,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp(),
                    });
                    userItemDocCreated = true;

                    await setDoc(doc(db, 'users', state.currentUser.uid), {
                        'stats.listedCount': increment(1),
                        updatedAt: serverTimestamp(),
                    }, { merge: true });
                    statsIncremented = true;

                    state.currentUser.stats = state.currentUser.stats || { listedCount: 0, completedTrades: 0 };
                    state.currentUser.stats.listedCount = Math.max(0, (state.currentUser.stats.listedCount || 0) + 1);

                    await loadAllProducts();
                    await loadUserItems(state.currentUser.uid);

                    submitBtn.textContent = '¡Publicado con Éxito!';
                    submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');

                    setTimeout(() => {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Publicar Artículo';
                        submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    }, 2000);

                    e.target.reset();
                    state.productFiles = [];
                    updatePhotoPreview();
                    showPage('page-explorar');
                } catch (error) {
                    console.error('Error al publicar el artículo:', error);
                    if (imagePaths.length > 0) {
                        await Promise.allSettled(imagePaths.map(path => {
                            try {
                                const fileRef = storageRef(storage, path);
                                return deleteObject(fileRef);
                            } catch (storageError) {
                                console.error('Error al preparar la eliminación de imagenes fallidas:', storageError);
                                return Promise.resolve();
                            }
                        }));
                    }
                    if (productDocRef) {
                        try {
                            await deleteDoc(productDocRef);
                        } catch (productCleanupError) {
                            console.warn('No se pudo eliminar el producto incompleto:', productCleanupError);
                        }
                    }
                    if (userItemDocCreated && productDocRef) {
                        try {
                            await deleteDoc(doc(db, 'users', state.currentUser.uid, 'items', productDocRef.id));
                        } catch (userItemCleanupError) {
                            console.warn('No se pudo limpiar el registro del artículo del usuario:', userItemCleanupError);
                        }
                    }
                    if (statsIncremented) {
                        try {
                            await setDoc(doc(db, 'users', state.currentUser.uid), {
                                'stats.listedCount': increment(-1),
                                updatedAt: serverTimestamp(),
                            }, { merge: true });
                            state.currentUser.stats = state.currentUser.stats || { listedCount: 0, completedTrades: 0 };
                            state.currentUser.stats.listedCount = Math.max(0, (state.currentUser.stats.listedCount || 1) - 1);
                        } catch (statsCleanupError) {
                            console.warn('No se pudo revertir el contador de publicaciones:', statsCleanupError);
                        }
                    }
                    showPublicarError('Ocurrió un error al publicar tu artículo. Intenta nuevamente.', submitBtn);
                }
            });


            // --- LÓGICA DE CANJE (MODAL PROFESIONAL) ---

            /**
             * Asigna listeners a los botones "Proponer Canje" (debe llamarse después de renderProducts)
             */
            function assignProponerCanjeListeners() {
                // Seleccionar TODOS los botones de proponer, tanto en la grilla como en el carrusel
                document.querySelectorAll('.btn-proponer-canje').forEach(btn => {
                    // Limpiar listeners antiguos para evitar duplicados
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);

                    // Añadir nuevo listener
                    newBtn.addEventListener('click', (e) => {
                        if (!state.isLoggedIn) {
                            showPage('page-perfil');
                            return;
                        }
                        
                        const itemData = e.currentTarget.dataset;

                        // --- NUEVO: Log category view ---
                        if (itemData.categoryId) {
                            logCategoryView(itemData.categoryId);
                        }
                        // --- FIN NUEVO ---

                        state.itemToSwap = {
                            id: itemData.itemId,
                            name: itemData.itemName,
                            value: parseFloat(itemData.itemValue)
                        };

                        const formattedValue = formatCOP(state.itemToSwap.value);
                        document.getElementById('modal-item-name').textContent = state.itemToSwap.name;
                        document.getElementById('modal-item-value').textContent = formattedValue;
                        document.getElementById('deseado-valor').textContent = formattedValue;

                        // --- NUEVO: Poblar lista de Checkboxes ---
                        const listContainer = document.getElementById('modal-user-items-list');
                        listContainer.innerHTML = ''; // Limpiar
                        
                        if (state.currentUser.items.length === 0) {
                             listContainer.innerHTML = '<p class="text-sm text-gray-500 p-2">No tienes artículos para canjear. Publica uno en la sección "Vender".</p>';
                        } else {
                            state.currentUser.items.forEach(item => {
                                const itemHtml = `
                                    <label class="flex items-center p-3 bg-white rounded-lg border border-gray-200 hover:bg-gray-100 cursor-pointer modal-item-checkbox-label">
                                        <input type="checkbox" class="modal-item-checkbox h-5 w-5 text-brand rounded focus:ring-brand" data-value="${item.value}" data-id="${item.id}">
                                        <img src="${item.imageUrl}" alt="${item.name}" class="w-10 h-10 rounded-md object-cover ml-3 border">
                                        <div class="ml-3 flex-1 min-w-0">
                                            <span class="font-medium text-gray-900 truncate">${item.name}</span>
                                            <span class="block text-sm text-green-600">${formatCOP(item.value)}</span>
                                        </div>
                                    </label>
                                `;
                                listContainer.insertAdjacentHTML('beforeend', itemHtml);
                            });
                        }
                        
                        // Resetear valores
                        updateCanjeCalculation();
                        modalErrorMsg.classList.add('hidden');
                        document.getElementById('agregar-dinero').value = '';

                        modalProponerCanje.classList.remove('hidden');
                        modalProponerCanje.classList.add('open');
                    });
                });
            }

            /**
             * Actualiza el cálculo en el modal de canje.
             */
            function updateCanjeCalculation() {
                let tuValorTotal = 0;
                const checkboxes = document.querySelectorAll('#modal-user-items-list .modal-item-checkbox:checked');
                
                checkboxes.forEach(cb => {
                    tuValorTotal += parseFloat(cb.dataset.value);
                });

                const deseadoValor = state.itemToSwap ? state.itemToSwap.value : 0;
                const diferencia = deseadoValor - tuValorTotal;
                
                document.getElementById('tu-valor').textContent = formatCOP(tuValorTotal);
                document.getElementById('diferencia-valor').textContent = formatCOP(diferencia);
                
                const inputDinero = document.getElementById('agregar-dinero');
                if (diferencia > 0) {
                    inputDinero.placeholder = `Sugerido: ${diferencia}`;
                } else {
                    inputDinero.placeholder = "0";
                }
            }

            // Listener para cambios en los checkboxes del modal
            modalProponerCanje.addEventListener('change', (e) => {
                if (e.target.classList.contains('modal-item-checkbox')) {
                    updateCanjeCalculation();
                }
            });


            function closeModal(modalElement) {
                modalElement.classList.add('hidden');
                modalElement.classList.remove('open');
            }
            
            // Asignar listeners para cerrar el modal de propuesta
            modalProponerCanje.querySelector('.modal-close-btn').addEventListener('click', () => closeModal(modalProponerCanje));
            modalProponerCanje.querySelector('.modal-backdrop').addEventListener('click', () => closeModal(modalProponerCanje));


            formProponerCanje.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = e.target.querySelector('button[type="submit"]');

                if (!state.isLoggedIn || !state.itemToSwap) {
                    modalErrorMsg.textContent = 'Error: No se ha seleccionado un artículo o no has iniciado sesión.';
                    modalErrorMsg.classList.remove('hidden');
                    return;
                }

                const selectedItemsCheckboxes = document.querySelectorAll('#modal-user-items-list .modal-item-checkbox:checked');

                if (selectedItemsCheckboxes.length === 0 && state.currentUser.items.length > 0) {
                    modalErrorMsg.textContent = 'Debes seleccionar al menos un artículo para ofrecer.';
                    modalErrorMsg.classList.remove('hidden');
                    setTimeout(() => modalErrorMsg.classList.add('hidden'), 3000);
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'Enviando...';
                modalErrorMsg.classList.add('hidden');

                try {
                    // 1. Obtener la información completa del artículo deseado y su dueño
                    const targetItemRef = doc(db, 'items', state.itemToSwap.id);
                    const targetItemSnap = await getDoc(targetItemRef);
                    if (!targetItemSnap.exists()) {
                        throw new Error("El artículo que deseas ya no está disponible.");
                    }
                    const targetItemData = targetItemSnap.data();

                    // 2. Preparar los datos de los artículos que ofreces
                    const offeredItemsData = [];
                    selectedItemsCheckboxes.forEach(cb => {
                        const itemId = cb.dataset.id;
                        const item = state.currentUser.items.find(i => i.id === itemId);
                        if (item) {
                            offeredItemsData.push({
                                id: item.id,
                                name: item.name,
                                value: item.value,
                                imageUrl: item.imageUrl
                            });
                        }
                    });

                    // 3. Crear el documento de la oferta
                    const offerPayload = {
                        proposerId: state.currentUser.uid,
                        proposerName: state.currentUser.name,
                        proposerProfilePic: state.currentUser.profilePic,
                        
                        targetOwnerId: targetItemData.ownerId, // ¡ID del dueño del artículo!
                        
                        targetItem: {
                            id: state.itemToSwap.id,
                            name: targetItemData.name,
                            value: targetItemData.value,
                            imageUrl: targetItemData.imageUrl
                        },
                        
                        offeredItems: offeredItemsData,
                        additionalCop: Number(document.getElementById('agregar-dinero').value) || 0,
                        
                        status: 'pending', // pending, accepted, rejected, negotiated
                        createdAt: serverTimestamp()
                    };

                    // 4. Guardar en una nueva colección "offers"
                    await addDoc(collection(db, 'offers'), offerPayload);

                    // 5. Mostrar éxito y cerrar
                    submitBtn.textContent = '¡Propuesta Enviada!';
                    submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');

                    setTimeout(() => {
                        closeModal(modalProponerCanje);
                        submitBtn.textContent = 'Enviar Propuesta de Canje';
                        submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        submitBtn.disabled = false;
                        state.itemToSwap = null;
                    }, 2000);

                } catch (error) {
                    console.error("Error al proponer canje:", error);
                    modalErrorMsg.textContent = `Error: ${error.message}`;
                    modalErrorMsg.classList.remove('hidden');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Enviar Propuesta de Canje';
                }
            });

            /**
             * Maneja la subida de un nuevo banner por parte del admin.
             */

async function handleAdminBannerUpload(event) {
    console.log('Verificando UID del usuario actual:', auth.currentUser.uid); // <-- AÑADE ESTA LÍNEA
    const file = event.target.files[0];
    if (!file || !state.isAdmin) return;

    // 1. Obtiene el nombre del ícono desde el ATRIBUTO del botón, no buscando la etiqueta <i>.
    //    Esta es la parte clave que evita el error.
    const originalIconName = uploadCoverBtn.dataset.iconName;

    // 2. Inicia el feedback visual: deshabilita el botón y lo VACÍA por completo,
    //    reemplazando su contenido con el código del spinner.
    uploadCoverBtn.disabled = true;
    uploadCoverBtn.innerHTML = `<svg class="animate-spin w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

    try {
        // --- El resto de esta sección (try/catch) es tu lógica original, que ya era correcta ---
        const uniquePath = `banners/${Date.now()}-${file.name.replace(/\s+/g, '-')}`;
        const fileRef = storageRef(storage, uniquePath);
        const uploadResult = await uploadBytes(fileRef, file);
        const downloadURL = await getDownloadURL(uploadResult.ref);

        const oneWeekFromNow = new Date();
        oneWeekFromNow.setDate(oneWeekFromNow.getDate() + 7);

        const newBanner = {
            title: "Nuevo Banner (Editar)",
            subtitle: "Haz clic en el lápiz para cambiar la fecha",
            imageUrl: downloadURL,
            imagePath: uploadResult.ref.fullPath,
            endTime: oneWeekFromNow,
            createdAt: serverTimestamp()
        };

        await addDoc(collection(db, 'banners'), newBanner);
        await loadAndRenderBanners();

    } catch (error) {
        console.error("Error al subir el nuevo banner:", error);
        alert(`❌ Error al subir la portada:\n\n${error.message}`);
    } finally {
        // 3. Este bloque 'finally' se ejecuta SIEMPRE, tanto si la subida fue exitosa como si falló.
        //    Es perfecto para restaurar el estado del botón.
        uploadCoverBtn.disabled = false;
        
        // 4. Reconstruimos el contenido del botón desde cero usando el nombre del ícono que guardamos.
        uploadCoverBtn.innerHTML = `<i data-lucide="${originalIconName}" class="w-5 h-5 md:w-6 md:h-6"></i>`;
        
        // 5. ¡CRÍTICO! Le decimos a la librería Lucide que busque nuevas etiquetas <i> para convertirlas en íconos.
        lucide.createIcons(); 
        
        coverFileInput.value = null; // Resetea el input para poder subir el mismo archivo otra vez
    }
}


            /**
             * Maneja la eliminación de un banner por parte del admin.
             */
            async function handleDeleteBanner(bannerId, imagePath) {
                if (!state.isAdmin) return;

                if (confirm("¿Estás seguro de que quieres eliminar este banner permanentemente?")) {
                    try {
                        // 1. Eliminar el documento de Firestore
                        await deleteDoc(doc(db, "banners", bannerId));
                        
                        // 2. Eliminar la imagen de Storage (si existe la ruta)
                        if (imagePath) {
                            const imageRef = storageRef(storage, imagePath);
                            await deleteObject(imageRef);
                        }
                        
                        // 3. Recargar los banners
                        await loadAndRenderBanners();

                    } catch (error) {
                        console.error("Error eliminando el banner:", error);
                        alert("No se pudo eliminar el banner. Revisa la consola.");
                    }
                }
            }


            /**
             * NUEVO: Listeners delegados para contenido dinámico
             */
            function setupDelegatedListeners() {
                // Listener para botones "Negociar" en "Mis Canjes"
                tabOfertas.addEventListener('click', (e) => {
                    const negociarBtn = e.target.closest('.btn-negociar');
                    if (negociarBtn) {
                        const form = negociarBtn.closest('.p-4').querySelector('.negotiation-form');
                        if (form) form.classList.toggle('hidden');
                    }
                });

                // Listener para botones "Eliminar" en "Mis Artículos"
                tabMisArticulos.addEventListener('click', async (e) => {
                    const eliminarBtn = e.target.closest('.btn-eliminar-item');
                    if (eliminarBtn) {
                        e.preventDefault();
                        const itemId = eliminarBtn.dataset.itemId;
                        if (confirm("¿Seguro que quieres eliminar este artículo?")) {
                           await deleteUserItem(itemId);
                        }
                    }
                });

                // Listener para botones de admin en el carrusel (editar timer, eliminar)
                promoCarousel.addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('.btn-delete-banner');
                    if (deleteBtn) {
                        e.stopPropagation();
                        const slide = deleteBtn.closest('.carousel-slide');
                        const bannerId = slide.dataset.bannerId;
                        const imagePath = slide.dataset.imagePath;
                        handleDeleteBanner(bannerId, imagePath);
                        return; // Evita que se abra el modal de editar
                    }

                    const editBtn = e.target.closest('.admin-edit-timer-btn');
                    if(editBtn){
                        openTimerModal(e);
                    }
                });
            }


            // --- INICIALIZACIÓN ---
            async function init() {
                try {
                    updateAuthUI();
                    showPage('page-explorar');

                    // Inicializar Carrusel
                    carouselPrevBtn.addEventListener('click', () => {
                        prevSlide();
                        stopCarouselAutoPlay();
                        startCarouselAutoPlay();
                    });
                    carouselNextBtn.addEventListener('click', () => {
                        nextSlide();
                        stopCarouselAutoPlay();
                        startCarouselAutoPlay();
                    });

                    // Listener para subir banner
                    uploadCoverBtn.addEventListener('click', () => coverFileInput.click());
                    coverFileInput.addEventListener('change', handleAdminBannerUpload);

                    // --- NUEVAS LLAMADAS DE INICIALIZACIÓN ---
                    populateCategoryList();
                    populateCategorySelect();

                    // Renderizar contenido dinámico
                    renderProducts(); // Renderiza los productos iniciales
                    renderMostViewedProducts(); // Renderiza el carrusel inicial

                    // Configurar listeners delegados para contenido dinámico
                    setupDelegatedListeners();

                    // Inicializar iconos (MOVIDO AL FINAL)
                    lucide.createIcons();

                    await loadAndRenderBanners(); // Carga banners desde Firebase
                    await loadAllProducts();
                } finally {
                    revealApp();
                }
            }

            // Arrancar la aplicación
            init().catch(error => console.error('Error al inicializar la aplicación:', error));
        });
    </script>

</body>
</html>
