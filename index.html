<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cambalaches Â· Marketplace de canjes inteligentes</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      referrerpolicy="no-referrer"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: light only;
        --primary-50: #eef2ff;
        --primary-100: #e0e7ff;
        --primary-500: #4c51ff;
        --primary-600: #3a3fe0;
        --primary-700: #2a2bbd;
        --accent: #00b894;
        --surface: rgba(255, 255, 255, 0.85);
        --surface-strong: rgba(255, 255, 255, 0.95);
        --border: rgba(99, 102, 241, 0.15);
        --border-strong: rgba(15, 23, 42, 0.08);
        --muted: #657195;
        --muted-dark: #1e2a4a;
        --success: #16a34a;
        --warning: #f59e0b;
        --danger: #ef4444;
        --shadow-lg: 0 35px 70px -40px rgba(15, 23, 42, 0.5);
        --shadow-sm: 0 18px 30px -25px rgba(15, 23, 42, 0.35);
        --radius-xl: 28px;
        --radius-lg: 22px;
        --radius-md: 16px;
        --radius-sm: 12px;
        --transition: 240ms cubic-bezier(0.23, 1, 0.32, 1);
        --header-height: 156px;
        --hero-gap: clamp(0.4rem, 1.4vw, 0.75rem);
        --sidebar-desktop-width: 320px;
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      html {
        overflow-x: hidden;
        width: 100%;
        scroll-behavior: smooth;
      }

      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background: #fff;
        color: #0f172a;
        min-height: 100vh;
        padding-top: calc(var(--header-height) - 48px);
        padding-bottom: 140px;
        overflow-x: hidden;
        max-width: 100vw;
      }

      body.detail-open {
        overflow: hidden;
      }

      img {
        max-width: 100%;
        display: block;
      }

      button {
        font-family: inherit;
      }

      header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 40;
        width: 100%;
        background: #ffe600;
        border-bottom: 1px solid rgba(15, 15, 15, 0.08);
        box-shadow: 0 22px 48px -30px rgba(0, 0, 0, 0.45);
        color: #111827;
      }

      .header-shell {
        width: min(1280px, 100%);
        margin: 0 auto;
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 0.85rem;
        padding: 0.75rem clamp(0.5rem, 2vw, 1rem) 1rem;
      }

      .header-top {
        display: grid;
        gap: 1rem;
        align-items: center;
        grid-template-columns: auto minmax(0, 1fr) auto;
        grid-template-areas: "brand search actions";
      }

      .header-search-area {
        grid-area: search;
        display: flex;
        align-items: center;
        gap: 0.9rem;
        min-width: 0;
      }

      .header-top .brand {
        grid-area: brand;
      }

      .header-top .header-search-area {
        grid-area: search;
      }

      .header-top .header-actions {
        grid-area: actions;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-family: "Plus Jakarta Sans", "Inter", sans-serif;
      }

      .brand-info {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      .brand-info span {
        color: rgba(17, 17, 17, 0.65);
        font-size: 0.85rem;
        font-weight: 500;
      }

      .brand-mark {
        width: 48px;
        height: 48px;
        border-radius: 16px;
        display: grid;
        place-items: center;
        background: #111;
        color: #ffd60a;
        font-weight: 700;
        letter-spacing: 0.02em;
        box-shadow: 0 16px 40px -18px rgba(0, 0, 0, 0.6);
      }

      .brand h1 {
        margin: 0;
        font-size: clamp(1.5rem, 2.6vw, 2.3rem);
        letter-spacing: -0.03em;
        color: #0b0f19;
      }

      nav {
        display: flex;
        align-items: center;
        gap: 0.65rem;
        flex: 1 1 auto;
        flex-wrap: wrap;
      }

      nav button {
        border: none;
        border-radius: 999px;
        background: transparent;
        padding: 0.65rem 1.1rem;
        font-weight: 600;
        color: rgba(17, 17, 17, 0.88);
        cursor: pointer;
        transition: background var(--transition), color var(--transition), transform var(--transition), box-shadow var(--transition);
      }

      .promo-banners {
        position: relative;
        background: linear-gradient(180deg, rgba(255, 230, 0, 0.15) 0%, rgba(255, 255, 255, 0.85) 75%, #ffffff 100%);
        border-bottom: 1px solid rgba(15, 23, 42, 0.05);
        padding: 0;
      }

      .promo-banners__shell {
        width: min(1280px, 100%);
        margin: 0 auto;
        padding: 0 clamp(0.5rem, 2vw, 1rem);
        display: grid;
        gap: 0;
      }

      .promo-banners__empty {
        border-radius: var(--radius-lg);
        border: 1px dashed rgba(99, 102, 241, 0.25);
        padding: 1.35rem 1.6rem;
        background: rgba(255, 255, 255, 0.9);
        color: var(--muted);
        font-weight: 500;
      }

      .promo-banners__list {
        display: grid;
        gap: 1rem;
        grid-auto-flow: column;
        grid-auto-columns: minmax(280px, 1fr);
        overflow-x: auto;
        padding-bottom: 0.1rem;
        scroll-snap-type: x mandatory;
        scrollbar-width: thin;
      }

      .promo-banners__list::-webkit-scrollbar {
        height: 6px;
      }

      .promo-banners__list::-webkit-scrollbar-thumb {
        background: rgba(15, 23, 42, 0.2);
        border-radius: 999px;
      }

      .promo-banners__list::-webkit-scrollbar-track {
        background: transparent;
      }

      .promo-banners__item {
        --banner-image: none;
        --banner-default-text-color: #f8fafc;
        --banner-default-button-color: rgba(255, 255, 255, 0.2);
        --banner-default-button-hover-color: rgba(255, 255, 255, 0.32);
        --banner-timer-background: rgba(15, 23, 42, 0.28);
        position: relative;
        border-radius: 5px;
        padding: clamp(1.4rem, 2vw, 2rem);
        display: grid;
        gap: 1.1rem;
        min-height: 180px;
        box-shadow: var(--shadow-sm);
        scroll-snap-align: start;
        overflow: hidden;
        isolation: isolate;
        color: var(--banner-text-color, var(--banner-default-text-color));
      }

      .promo-banners__item--add {
        position: relative;
        border: 1px dashed rgba(15, 23, 42, 0.14);
        background: rgba(15, 23, 42, 0.04);
        color: #0f172a;
        display: grid;
        place-items: center;
        cursor: pointer;
        transition: border-color var(--transition), background var(--transition), transform var(--transition), color var(--transition), box-shadow var(--transition);
      }

      .promo-banners__item--add::before,
      .promo-banners__item--add::after {
        display: none;
      }

      .promo-banners__item--add:hover,
      .promo-banners__item--add:focus-visible {
        background: rgba(15, 23, 42, 0.08);
        border-color: rgba(15, 23, 42, 0.3);
        transform: translateY(-2px);
        outline: none;
        box-shadow: 0 0 0 3px rgba(76, 81, 255, 0.2);
      }

      .promo-banners__add-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: clamp(2.5rem, 6vw, 3.75rem);
        height: clamp(2.5rem, 6vw, 3.75rem);
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.08);
        color: inherit;
        font-size: clamp(1.15rem, 3vw, 1.75rem);
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.1);
      }

      .promo-banners__item::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background-image: var(--banner-image);
        background-size: cover;
        background-position: center;
        filter: saturate(1.05);
        opacity: 0.85;
        transform: scale(1.02);
        transition: opacity var(--transition);
        z-index: -2;
      }

      .promo-banners__item::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: linear-gradient(160deg, rgba(255, 255, 255, 0) 30%, rgba(255, 255, 255, 0.18) 100%);
        pointer-events: none;
        mix-blend-mode: screen;
        z-index: -1;
      }

      .promo-banner__meta {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 0.75rem;
      }

      .promo-banner__meta-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .promo-banner__meta-right {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .promo-banner__tag {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
        background: rgba(15, 23, 42, 0.16);
        color: inherit;
      }

      .promo-banner__remove {
        border: none;
        border-radius: 999px;
        padding: 0.35rem;
        background: rgba(15, 23, 42, 0.18);
        color: inherit;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: transform var(--transition), background var(--transition);
      }

      .promo-banner__remove:hover,
      .promo-banner__remove:focus-visible {
        background: rgba(15, 23, 42, 0.28);
        transform: translateY(-1px);
      }

      .promo-banner__timer {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
        background: var(--banner-timer-background, rgba(15, 23, 42, 0.28));
        color: var(--banner-text-color, var(--banner-default-text-color));
        white-space: nowrap;
      }

      .promo-banner__timer i {
        font-size: 0.8em;
      }

      .promo-banner__timer.is-expired {
        background: rgba(239, 68, 68, 0.35);
        color: #fff;
      }

      .promo-banner__body {
        display: grid;
        gap: 0.4rem;
      }

      .promo-banner__body h3 {
        margin: 0;
        font-size: clamp(1.15rem, 2.2vw, 1.5rem);
        letter-spacing: -0.01em;
      }

      .promo-banner__body p {
        margin: 0;
        font-size: 0.95rem;
        color: inherit;
        opacity: 0.92;
      }

      .promo-banner__footer {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .promo-banner__cta {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        padding: 0.55rem 1.1rem;
        border-radius: 999px;
        font-weight: 600;
        text-decoration: none;
        background: var(--banner-button-color, var(--banner-default-button-color, rgba(255, 255, 255, 0.2)));
        color: var(--banner-button-text-color, var(--banner-text-color, inherit));
        transition: background var(--transition), transform var(--transition);
      }

      .promo-banner__cta:hover,
      .promo-banner__cta:focus-visible {
        background: var(--banner-button-hover-color, var(--banner-default-button-hover-color, rgba(255, 255, 255, 0.32)));
        transform: translateY(-1px);
      }

      .promo-banners__item[data-theme="midnight"] {
        background: linear-gradient(135deg, #111827 0%, #312e81 55%, #6366f1 110%);
        --banner-default-text-color: #f8fafc;
        --banner-default-button-color: #4338ca;
        --banner-default-button-hover-color: #4c51ff;
      }

      .promo-banners__item[data-theme="sunrise"] {
        background: linear-gradient(135deg, #fbbf24 -5%, #f97316 45%, #ec4899 105%);
        --banner-default-text-color: #111827;
        --banner-default-button-color: #111827;
        --banner-default-button-hover-color: #1f2937;
        --banner-timer-background: rgba(15, 23, 42, 0.45);
      }

      .promo-banners__item[data-theme="ocean"] {
        background: linear-gradient(140deg, #0f172a 0%, #0ea5e9 55%, #22d3ee 120%);
        --banner-default-text-color: #f8fafc;
        --banner-default-button-color: #0ea5e9;
        --banner-default-button-hover-color: #38bdf8;
      }

      .promo-banners__item[data-theme="forest"] {
        background: linear-gradient(140deg, #064e3b 0%, #059669 55%, #34d399 120%);
        --banner-default-text-color: #f0fdf4;
        --banner-default-button-color: #10b981;
        --banner-default-button-hover-color: #34d399;
      }

      .promo-banner-modal {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        padding: 1.5rem;
        background: rgba(15, 23, 42, 0.35);
        backdrop-filter: blur(6px);
        opacity: 0;
        pointer-events: none;
        transition: opacity var(--transition);
        z-index: 90;
      }

      .promo-banner-modal.is-visible {
        opacity: 1;
        pointer-events: auto;
      }

      .promo-banner-modal__dialog {
        width: min(680px, 100%);
        background: var(--surface-strong);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-lg);
        padding: clamp(1.5rem, 2vw, 2.2rem);
        display: grid;
        gap: 1.25rem;
        max-height: min(90vh, 820px);
        overflow-y: auto;
      }

      .promo-banner-modal__header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
      }

      .promo-banner-modal__title {
        margin: 0;
        font-size: clamp(1.3rem, 2vw, 1.55rem);
        letter-spacing: -0.01em;
      }

      .promo-banner-modal__description {
        margin: 0.35rem 0 0;
        color: var(--muted);
        font-size: 0.95rem;
      }

      .promo-banner-modal__close {
        border: none;
        background: rgba(15, 23, 42, 0.08);
        border-radius: 999px;
        padding: 0.45rem;
        cursor: pointer;
        color: inherit;
        transition: background var(--transition), transform var(--transition);
      }

      .promo-banner-modal__close:hover,
      .promo-banner-modal__close:focus-visible {
        background: rgba(15, 23, 42, 0.16);
        transform: translateY(-1px);
      }

      .promo-banner-modal__form {
        display: grid;
        gap: 1.25rem;
      }

      .promo-banner-field {
        display: grid;
        gap: 0.45rem;
      }

      .promo-banner-field label {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--muted-dark);
      }

      .promo-banner-field input,
      .promo-banner-field textarea {
        width: 100%;
        border-radius: 16px;
        border: 1px solid var(--border-strong);
        padding: 0.65rem 0.85rem;
        font-family: inherit;
        font-size: 0.95rem;
        transition: border-color var(--transition), box-shadow var(--transition);
        background: rgba(255, 255, 255, 0.92);
      }

      .promo-banner-field textarea {
        min-height: 110px;
        resize: vertical;
      }

      .promo-banner-field-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        align-items: end;
      }

      .promo-banner-field small {
        font-size: 0.78rem;
        color: var(--muted);
      }

      .promo-banner-field input[type="color"] {
        padding: 0;
        height: 42px;
        border-radius: 14px;
        border: 1px solid var(--border-strong);
        background: #fff;
        cursor: pointer;
      }

      .promo-banner-field input[type="color"]::-webkit-color-swatch {
        border-radius: 12px;
        border: none;
      }

      .promo-banner-field input[type="color"]::-moz-color-swatch {
        border-radius: 12px;
        border: none;
      }

      .promo-banner-field input:focus,
      .promo-banner-field textarea:focus {
        outline: none;
        border-color: rgba(79, 70, 229, 0.35);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
      }

      .promo-banner-modal__preview {
        border-radius: var(--radius-md);
        border: 1px dashed rgba(79, 70, 229, 0.2);
        padding: 0.75rem;
        display: grid;
        place-items: center;
        min-height: 160px;
        background: rgba(79, 70, 229, 0.04);
        position: relative;
        overflow: hidden;
      }

      .promo-banner-modal__preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: var(--radius-sm);
      }

      .promo-banner-modal__preview-placeholder {
        text-align: center;
        color: var(--muted);
        font-size: 0.9rem;
        display: grid;
        gap: 0.5rem;
        justify-items: center;
      }

      .promo-banner-modal__preview-placeholder i {
        font-size: 1.35rem;
        color: var(--primary-500);
      }

      .promo-banner-modal__footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .promo-banner-modal__timer-hint {
        font-size: 0.85rem;
        color: var(--muted);
        margin-top: -0.25rem;
      }

      @media (max-width: 1080px) {
        .promo-banners {
          padding: 0;
        }

        .promo-banners__shell {
          width: 100%;
          padding: 0;
        }

        .promo-banners__list {
          display: flex;
          gap: clamp(1.25rem, 4vw, 1.75rem);
          overflow-x: auto;
          padding: clamp(0.5rem, 2.4vw, 0.9rem) clamp(0.75rem, 2.5vw, 1.375rem);
          scroll-snap-type: x mandatory;
          scroll-padding: 0 clamp(0.75rem, 2.5vw, 1.375rem);
          -webkit-overflow-scrolling: touch;
        }

        .promo-banners__item {
          border-radius: 5px;
          min-height: unset;
          flex: 0 0 calc(100vw - 2 * clamp(0.75rem, 2.5vw, 1.375rem));
          max-width: calc(100vw - 2 * clamp(0.75rem, 2.5vw, 1.375rem));
          aspect-ratio: 2160 / 1080;
          display: flex;
          flex-direction: column;
          justify-content: space-between;
          gap: clamp(1rem, 3vw, 1.5rem);
          box-shadow: var(--shadow-lg);
          padding: clamp(1.5rem, 4vw, 2.25rem);
          scroll-snap-align: center;
        }

        .promo-banners__item + .promo-banners__item {
          border-top: none;
        }

        .promo-banner__meta {
          gap: clamp(0.5rem, 2vw, 0.75rem);
        }

        .promo-banner-modal {
          padding: 1rem;
        }

        .promo-banner-modal__dialog {
          width: 100%;
          border-radius: var(--radius-lg);
        }
      }

      @media (max-width: 960px) {
        .promo-banners__list {
          grid-auto-columns: minmax(240px, 82vw);
        }
      }

      @media (max-width: 640px) {
        .promo-banners {
          padding-bottom: 2.4rem;
        }

        .promo-banners__empty {
          margin: 0 clamp(1.5rem, 5vw, 2.75rem);
        }
      }

      .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .sidebar-toggle {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 42px;
        height: 42px;
        border: none;
        border-radius: 14px;
        background: rgba(17, 17, 17, 0.08);
        color: #0f172a;
        cursor: pointer;
        transition: transform var(--transition), box-shadow var(--transition), background var(--transition), color var(--transition);
      }

      .sidebar-toggle:hover,
      .sidebar-toggle:focus-visible {
        transform: translateY(-1px);
        box-shadow: 0 18px 28px -22px rgba(15, 23, 42, 0.4);
        background: rgba(17, 17, 17, 0.14);
        outline: none;
      }

      .sidebar-toggle i {
        font-size: 1.05rem;
      }

      .app-shell {
        width: min(1280px, 100%);
        margin: 0 auto;
        display: grid;
        gap: clamp(1.25rem, 3vw, 2.5rem);
        align-items: flex-start;
      }

      .app-sidebar {
        --sidebar-blur: 22px;
        background: #ffffff;
        border-radius: 0 var(--radius-xl) var(--radius-xl) 0;
        border: 1px solid rgba(15, 23, 42, 0.08);
        box-shadow: 0 32px 70px -50px rgba(15, 23, 42, 0.45);
        padding: clamp(1.4rem, 2.4vw, 2rem) clamp(1.2rem, 2.2vw, 1.8rem);
        padding-top: calc(clamp(1.4rem, 2.4vw, 2rem) + env(safe-area-inset-top, 0px));
        padding-bottom: calc(clamp(1.4rem, 2.4vw, 2rem) + env(safe-area-inset-bottom, 0px));
        display: flex;
        flex-direction: column;
        gap: clamp(1.2rem, 2.1vw, 1.7rem);
        width: min(90vw, var(--sidebar-desktop-width, 280px));
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        transform: translateX(calc(-100% - 24px));
        transition: transform var(--transition), opacity var(--transition), box-shadow var(--transition);
        z-index: 80;
        overflow-y: auto;
        opacity: 0;
        color: #0f172a;
        scrollbar-width: thin;
        scrollbar-color: rgba(148, 163, 184, 0.35) transparent;
      }

      .app-sidebar::-webkit-scrollbar {
        width: 6px;
      }

      .app-sidebar::-webkit-scrollbar-track {
        background: transparent;
      }

      .app-sidebar::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.35);
        border-radius: 999px;
      }

      .app-sidebar > * {
        position: relative;
        z-index: 1;
      }

      .app-sidebar.is-open {
        transform: translateX(0);
        opacity: 1;
        box-shadow: 0 60px 120px -50px rgba(15, 23, 42, 0.45);
      }

      .app-sidebar__header {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        position: sticky;
        top: calc(env(safe-area-inset-top, 0px));
        margin-top: calc(-1 * clamp(1.4rem, 2.4vw, 2rem));
        padding-top: calc(clamp(1.4rem, 2.4vw, 2rem) + env(safe-area-inset-top, 0px));
        padding-bottom: 0.5rem;
        margin-bottom: 0.75rem;
        background: #ffffff;
        border-bottom: 1px solid rgba(15, 23, 42, 0.05);
        z-index: 2;
      }

      .app-sidebar__profile {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.9rem 1rem;
        border-radius: var(--radius-lg);
        background: #fff;
        border: 1px solid rgba(15, 23, 42, 0.06);
        box-shadow: 0 28px 55px -45px rgba(15, 23, 42, 0.42);
        backdrop-filter: blur(22px);
        -webkit-backdrop-filter: blur(22px);
      }

      .app-sidebar__profile-avatar {
        width: 52px;
        height: 52px;
        border-radius: 16px;
        display: grid;
        place-items: center;
        background: #fff;
        color: #111827;
        overflow: hidden;
        font-weight: 700;
        font-size: 1.1rem;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.65);
      }

      .app-sidebar__profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .app-sidebar__profile strong {
        display: block;
        color: #0b0f19;
        font-size: 1rem;
      }

      .app-sidebar__profile span {
        display: block;
        color: rgba(15, 23, 42, 0.58);
        font-size: 0.85rem;
      }

      .app-sidebar__nav {
        display: grid;
        gap: 0.6rem;
        flex: 1 1 auto;
        align-content: flex-start;
      }

      .app-sidebar__nav-label {
        text-transform: uppercase;
        letter-spacing: 0.18em;
        font-size: 0.72rem;
        font-weight: 700;
        color: rgba(15, 23, 42, 0.45);
        padding-left: 0.4rem;
      }

      .app-sidebar__nav button {
        border: 1px solid rgba(15, 23, 42, 0.08);
        border-radius: var(--radius-lg);
        padding: 0.85rem 1.05rem;
        display: flex;
        align-items: center;
        gap: 0.9rem;
        background: #ffffff;
        color: rgba(15, 23, 42, 0.85);
        font-weight: 600;
        cursor: pointer;
        transition: transform var(--transition), box-shadow var(--transition), background var(--transition), border var(--transition), color var(--transition);
        width: 100%;
      }

      .app-sidebar__nav button .nav-icon {
        width: 38px;
        height: 38px;
        border-radius: 12px;
        display: grid;
        place-items: center;
        background: rgba(17, 24, 39, 0.05);
        color: #111827;
        font-size: 1rem;
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.05);
      }

      .app-sidebar__nav button:hover,
      .app-sidebar__nav button:focus-visible {
        transform: translateX(6px);
        background: rgba(255, 214, 10, 0.16);
        border-color: rgba(255, 214, 10, 0.5);
        color: #0b0f19;
        outline: none;
        box-shadow: 0 26px 60px -48px rgba(15, 23, 42, 0.35);
      }

      .app-sidebar__nav button:hover .nav-icon,
      .app-sidebar__nav button:focus-visible .nav-icon {
        background: rgba(255, 214, 10, 0.35);
        color: #0f172a;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.45);
      }

      .app-sidebar__nav button.active {
        background: #ffd60a;
        color: #ffffff;
        border-color: #facc15;
        box-shadow: 0 35px 85px -45px rgba(250, 204, 21, 0.8);
      }

      .app-sidebar__nav button.active .nav-icon {
        background: rgba(255, 255, 255, 0.3);
        color: #ffffff;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.4);
      }

      .sidebar-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        opacity: 0;
        pointer-events: none;
        transition: opacity var(--transition);
        z-index: 55;
      }

      .sidebar-backdrop.is-visible {
        opacity: 1;
        pointer-events: auto;
      }

      body.sidebar-open {
        overflow: hidden;
      }

      #profile.panel {
        background: transparent;
        border: none;
        box-shadow: none;
        padding: 0;
      }

      .profile-container {
        width: 100%;
        min-height: calc(100vh - var(--header-height));
        display: flex;
        align-items: center;
        justify-content: center;
        padding: clamp(0.75rem, 5vw, 2.5rem) clamp(0.75rem, 6vw, 2rem);
        padding-bottom: clamp(0.75rem, 5vw, 2.5rem);
      }

      @supports (height: 100dvh) {
        .profile-container {
          min-height: calc(100dvh - var(--header-height));
        }
      }

      @supports (padding-bottom: calc(1rem + env(safe-area-inset-bottom))) {
        .profile-container {
          padding-bottom: calc(clamp(0.75rem, 5vw, 2.5rem) + env(safe-area-inset-bottom));
        }
      }

      .profile-layout {
        width: min(100%, 720px);
        display: grid;
        gap: clamp(1.2rem, 4vw, 2rem);
      }

      .profile-hero {
        display: grid;
        gap: 0.85rem;
        justify-items: center;
        text-align: center;
      }

      .profile-hero__icon {
        width: 68px;
        height: 68px;
        border-radius: 24px;
        display: grid;
        place-items: center;
        background: var(--primary-600);
        color: #fff;
        box-shadow: 0 26px 48px -28px rgba(15, 23, 42, 0.55);
      }

      .profile-hero h3 {
        margin: 0;
        font-size: clamp(1.4rem, 4vw, 1.8rem);
        color: var(--muted-dark);
      }

      .profile-hero p {
        margin: 0;
        color: var(--muted);
        font-size: clamp(0.92rem, 3vw, 1rem);
        line-height: 1.6;
        max-width: 42ch;
      }

      .profile-stage {
        background: var(--surface-strong);
        border-radius: clamp(20px, 6vw, 26px);
        border: 1px solid var(--border-strong);
        box-shadow: var(--shadow-sm);
        padding: clamp(1.2rem, 5vw, 2.2rem);
        display: grid;
        gap: clamp(1rem, 3vw, 1.6rem);
        width: min(100%, 640px);
        margin: 0 auto;
      }

      .profile-stage__header {
        display: grid;
        gap: 0.55rem;
        text-align: center;
      }

      .profile-stage__title {
        margin: 0;
        font-size: clamp(1.2rem, 3.6vw, 1.45rem);
        color: var(--muted-dark);
      }

      .profile-stage__helper {
        margin: 0;
        color: var(--muted);
        font-size: 0.95rem;
        line-height: 1.55;
      }

      .profile-form {
        display: grid;
        gap: clamp(1rem, 3vw, 1.5rem);
      }

      .profile-grid {
        display: grid;
        gap: clamp(0.85rem, 2.6vw, 1.2rem);
      }

      .profile-grid[data-columns="two"] {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }

      .profile-field {
        display: grid;
        gap: 0.45rem;
      }

      .profile-field > span {
        font-size: 0.82rem;
        font-weight: 600;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: rgba(15, 23, 42, 0.62);
      }

      .profile-field--full {
        grid-column: 1 / -1;
      }

      .profile-photo-control {
        display: flex;
        align-items: center;
        gap: clamp(0.85rem, 4vw, 1.4rem);
        flex-wrap: wrap;
      }

      .profile-avatar {
        width: clamp(78px, 24vw, 96px);
        height: clamp(78px, 24vw, 96px);
        border-radius: 50%;
        background: #f8fafc;
        display: grid;
        place-items: center;
        overflow: hidden;
        border: 3px solid rgba(148, 163, 184, 0.35);
        box-shadow: 0 18px 30px -22px rgba(15, 23, 42, 0.35);
        color: var(--primary-600);
        font-size: clamp(1.4rem, 6vw, 2rem);
      }

      .profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .profile-avatar--summary {
        width: clamp(90px, 28vw, 112px);
        height: clamp(90px, 28vw, 112px);
      }

      .profile-photo-actions {
        display: grid;
        gap: 0.45rem;
        min-width: min(240px, 100%);
      }

      .profile-upload {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: fit-content;
        cursor: pointer;
        position: relative;
      }

      .profile-upload i {
        font-size: 0.95rem;
      }

      .profile-photo-hint {
        margin: 0;
        font-size: 0.78rem;
        color: var(--muted);
        line-height: 1.45;
      }

      .profile-form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .profile-summary {
        display: grid;
        gap: clamp(1rem, 3vw, 1.6rem);
      }

      .profile-summary-header {
        display: flex;
        align-items: center;
        gap: clamp(1rem, 4vw, 1.5rem);
      }

      .profile-summary-identity {
        display: grid;
        gap: 0.35rem;
      }

      .profile-summary-identity h3 {
        margin: 0;
        font-size: clamp(1.3rem, 3.6vw, 1.6rem);
        color: var(--muted-dark);
      }

      .profile-summary-identity p {
        margin: 0.15rem 0 0;
        color: var(--muted);
        font-size: 0.92rem;
        line-height: 1.45;
      }

      .profile-summary-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: clamp(0.8rem, 3vw, 1.2rem);
      }

      .profile-summary-item {
        background: rgba(15, 23, 42, 0.03);
        border: 1px solid rgba(15, 23, 42, 0.08);
        border-radius: var(--radius-md);
        padding: 0.9rem 1rem;
        display: grid;
        gap: 0.35rem;
      }

      .profile-summary-item--full {
        grid-column: 1 / -1;
      }

      .profile-summary-item dt {
        margin: 0;
        font-size: 0.8rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: rgba(15, 23, 42, 0.55);
      }

      .profile-summary-item dd {
        margin: 0;
        font-size: 0.96rem;
        color: var(--muted-dark);
        word-break: break-word;
      }

      .profile-summary-footer {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        justify-content: space-between;
        align-items: center;
        border-top: 1px solid rgba(15, 23, 42, 0.08);
        padding-top: 0.85rem;
      }

      .profile-summary-footer span {
        color: var(--muted);
        font-size: 0.88rem;
      }

      .profile-summary-actions {
        display: flex;
        gap: 0.6rem;
        flex-wrap: wrap;
      }

      @media (max-width: 720px) {
        .profile-stage {
          padding: clamp(1.1rem, 7vw, 1.8rem);
        }

        .profile-summary-header {
          flex-direction: column;
          text-align: center;
        }

        .profile-summary-footer {
          justify-content: center;
          text-align: center;
        }

        .profile-summary-actions {
          justify-content: center;
        }
      }

      @media (max-width: 600px) {
        .profile-container {
          padding: clamp(0.6rem, 6vw, 1.2rem) clamp(0.6rem, 6vw, 1.2rem);
          padding-bottom: clamp(0.6rem, 6vw, 1.2rem);
        }

        .profile-form-actions {
          justify-content: center;
        }

        .profile-photo-actions {
          justify-items: center;
          text-align: center;
        }

        .toggle-field {
          flex-direction: column;
          align-items: stretch;
        }

        .toggle {
          align-self: flex-end;
        }

        .sell-selector-grid {
          grid-template-columns: 1fr;
        }

        @supports (padding-bottom: calc(1rem + env(safe-area-inset-bottom))) {
          .profile-container {
            padding-bottom: calc(clamp(0.6rem, 6vw, 1.2rem) + env(safe-area-inset-bottom));
          }
        }
      }

      @media (max-width: 480px) {
        .profile-grid[data-columns="two"] {
          grid-template-columns: 1fr;
        }

        .profile-photo-actions {
          min-width: 100%;
        }
      }

      @media (max-width: 420px) {
        .profile-stage {
          padding: clamp(1rem, 8vw, 1.4rem);
        }
      }

      @media (min-width: 1024px) {
        main {
          padding-left: calc(var(--sidebar-desktop-width) + clamp(0.9rem, 1.5vw, 1.4rem));
          padding-right: clamp(1rem, 1.5vw, 1.5rem);
        }

        .app-shell {
          width: min(1200px, 100%);
          margin: 0;
        }

        .app-sidebar {
          transform: none;
          opacity: 1;
          width: var(--sidebar-desktop-width);
        }

        .sidebar-toggle {
          display: none;
        }

        .sidebar-backdrop {
          display: none !important;
        }
      }

      .header-actions {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        flex-shrink: 0;
        justify-content: flex-end;
      }

      .header-cta {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .header-search {
        position: relative;
        flex: 1 1 auto;
        min-width: 0;
        max-width: 560px;
        margin: 0;
      }

      .header-search input {
        border: none;
        background: transparent;
        padding: 0;
        min-width: 0;
        width: 100%;
        font-size: 0.95rem;
        font-family: inherit;
        font-weight: 500;
        letter-spacing: -0.01em;
        color: #0f172a;
        line-height: 1.2;
        min-height: 44px;
      }

      .header-search input::placeholder {
        color: rgba(15, 23, 42, 0.45);
      }

      .header-search input:focus {
        outline: none;
      }

      .header-notification {
        border: none;
        background: rgba(255, 255, 255, 0.9);
        color: rgba(15, 23, 42, 0.68);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.05rem;
        cursor: pointer;
        box-shadow: 0 16px 32px -26px rgba(15, 23, 42, 0.45);
        transition: transform var(--transition), box-shadow var(--transition), color var(--transition), background var(--transition);
      }

      .header-notification:hover,
      .header-notification:focus-visible {
        transform: translateY(-2px);
        box-shadow: 0 22px 42px -26px rgba(15, 23, 42, 0.55);
        color: rgba(15, 23, 42, 0.85);
        background: #fff;
        outline: none;
      }

      .header-notification:focus-visible {
        box-shadow: 0 0 0 3px rgba(76, 81, 255, 0.2), 0 22px 42px -26px rgba(15, 23, 42, 0.55);
      }

      .btn {
        border: none;
        border-radius: 999px;
        padding: 0.75rem 1.4rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform var(--transition), box-shadow var(--transition), background var(--transition);
      }

      .btn-primary {
        background: var(--primary-600);
        color: #fff;
        box-shadow: 0 18px 30px -16px rgba(30, 64, 175, 0.55);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 26px 46px -20px rgba(30, 64, 175, 0.65);
        background: var(--primary-700);
      }

      .btn-outline {
        background: rgba(17, 17, 17, 0.08);
        color: #111;
        border: 1px solid rgba(17, 17, 17, 0.18);
      }

      .btn-outline:hover {
        background: rgba(17, 17, 17, 0.18);
        transform: translateY(-2px);
      }

      .btn-ghost {
        background: transparent;
        color: var(--muted-dark);
        border: 1px solid transparent;
      }

      .btn-ghost:hover,
      .btn-ghost:focus-visible {
        background: rgba(15, 23, 42, 0.08);
        transform: translateY(-2px);
        outline: none;
      }

      .avatar-thumb {
        width: 40px;
        height: 40px;
        border-radius: 14px;
        overflow: hidden;
        border: 2px solid rgba(76, 81, 255, 0.2);
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.25);
      }

      main {
        width: 100%;
        margin: 0;
        padding: 0 clamp(0.5rem, 1.5vw, 0.9rem) clamp(2.3rem, 3.8vw, 3.2rem);
        display: block;
      }

      .dashboard-grid {
        display: grid;
        gap: clamp(0.85rem, 2.1vw, 1.5rem);
        margin: 0;
        padding: 0;
      }

      @media (max-width: 1024px) {
        :root {
          --header-height: 176px;
        }
        .header-top {
          grid-template-columns: auto minmax(0, 1fr);
          grid-template-areas:
            "brand search"
            "actions actions";
        }
        .header-search-area {
          width: 100%;
        }
        .header-actions {
          justify-content: flex-end;
          flex-wrap: wrap;
          gap: 0.6rem;
        }
        .header-cta {
          flex: 1 1 100%;
          justify-content: flex-end;
          gap: 0.6rem;
          flex-wrap: wrap;
        }
        .header-actions .btn,
        .header-actions #open-auth {
          flex: 0 1 200px;
        }
        .dashboard-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 900px) {
        :root {
          --header-height: 188px;
        }
        .header-actions {
          width: 100%;
          justify-content: center;
        }
        .header-cta {
          justify-content: center;
        }
        main {
          margin-top: 0;
        }
      }

      @media (max-width: 720px) {
        .category-list {
          gap: clamp(0.35rem, 2vw, 0.6rem);
        }
        .category-card {
          padding: clamp(0.5rem, 3vw, 0.75rem);
        }
        .most-viewed-card {
          width: clamp(180px, 68vw, 230px);
        }
        .filters-sheet-header {
          padding: 1.1rem 1.4rem;
        }
        .filters-form {
          padding-inline: 1.1rem;
        }
        .filters-form-footer {
          padding: 1rem 1.1rem 1.2rem;
        }
      }

      @media (max-width: 640px) {
        :root {
          --header-height: 204px;
        }
        .header-shell {
          padding: 1.1rem clamp(0.425rem, 3vw, 0.7rem) 1.5rem;
        }
        .header-actions {
          flex-wrap: wrap;
          gap: 0.5rem;
        }
        .header-search-area {
          width: 100%;
        }
        .header-actions .btn,
        .header-actions #open-auth {
          flex: 1 1 160px;
        }
        .header-search {
          max-width: none;
        }
        .dashboard-grid {
          gap: 2rem;
        }
        .panel {
          padding: 1.4rem;
        }
      }

      @media (max-width: 540px) {
        :root {
          --header-height: 96px;
        }

        body {
          font-size: 0.95rem;
          line-height: 1.6;
          padding-bottom: 108px;
        }

        .header-shell {
          padding: 0.5rem clamp(0.35rem, 3vw, 0.45rem) 0.65rem;
          gap: 0.5rem;
        }

        .header-top {
          grid-template-columns: auto minmax(0, 1fr) auto;
          grid-template-areas: "brand search actions";
          align-items: center;
          gap: 0.45rem;
        }

        .brand {
          gap: 0.5rem;
        }

        .brand-info {
          display: none;
        }

        .brand-mark {
          width: 36px;
          height: 36px;
          border-radius: 12px;
          font-size: 0.95rem;
        }

        .header-search-area {
          gap: 0.35rem;
        }

        .header-actions {
          justify-content: flex-end;
          align-items: center;
          gap: 0;
        }

        .header-cta {
          display: none;
        }

        .sidebar-toggle {
          width: 38px;
          height: 38px;
          border-radius: 12px;
        }

        .header-notification {
          display: none;
        }

        .header-search input {
          font-size: 0.82rem;
        }

        .btn {
          padding: 0.7rem 1.2rem;
          font-size: 0.92rem;
        }

        main {
          padding: clamp(0.75rem, 6vw, 1.3rem) clamp(0.375rem, 3vw, 0.65rem);
        }

        #feed-grid {
          gap: clamp(0.85rem, 6vw, 1.2rem);
        }

        .panel {
          padding: clamp(1.3rem, 6vw, 1.5rem);
        }

        .panel h3 {
          font-size: 1.24rem;
          margin-bottom: 1rem;
        }

        .section-header {
          gap: 0.85rem;
          margin-bottom: 1.4rem;
        }

        .section-title {
          gap: 0.75rem;
        }

        .section-icon {
          width: 52px;
          height: 52px;
          border-radius: 18px;
        }

        .dashboard-grid {
          gap: clamp(1.35rem, 6vw, 1.8rem);
        }

        .category-board,
        .most-viewed-board {
          padding: 1.1rem 1.25rem;
        }

        .product-card-body {
          padding: 0.95rem;
          gap: 0.55rem;
        }

        .product-card-title {
          font-size: 0.96rem;
        }

        .product-card-category,
        .product-card-owner .owner-meta,
        .product-card-rating {
          font-size: 0.7rem;
        }

        .product-detail-dialog {
          width: min(96vw, 520px);
          grid-template-columns: 1fr;
          max-height: 90vh;
        }

        .product-detail-gallery {
          grid-template-rows: minmax(0, 220px) auto;
        }

        .product-detail-close {
          width: 40px;
          height: 40px;
        }

        .product-detail-price {
          padding: 0.55rem 1.1rem;
          font-size: 0.92rem;
        }

        .product-detail-thumbs {
          padding: 0.85rem 1.1rem;
          gap: 0.55rem;
        }

        .product-detail-thumb {
          width: 70px;
          height: 58px;
          border-radius: 14px;
        }

        .product-detail-body {
          padding: 1.05rem;
          gap: 0.8rem;
        }

        .product-detail-body h2 {
          font-size: 1.35rem;
        }

        .product-detail-actions {
          gap: 0.6rem;
        }

        .product-detail-actions .btn {
          width: 100%;
        }

        .premium-bottom-nav__card {
          padding: 0.12rem 0.4rem calc(0.5rem + env(safe-area-inset-bottom, 0px));
          border-radius: 16px;
          min-height: 62px;
        }

        .premium-bottom-nav button {
          font-size: 0.7rem;
          padding: 0.4rem 0.22rem 0.5rem;
          gap: 0.22rem;
        }

        .premium-bottom-nav button .nav-icon {
          width: 26px;
          height: 26px;
          font-size: 1.05rem;
        }

        .premium-bottom-nav button.nav-item--highlight {
          --highlight-size: 54px;
          padding: calc(var(--highlight-size) / 2 + 0.3rem) 0.2rem 0.48rem;
          min-width: calc(var(--highlight-size) + 8px);
        }

        .premium-bottom-nav button.nav-item--highlight .nav-icon {
          font-size: 1.22rem;
        }
      }

      @media (max-width: 480px) {
        :root {
          --header-height: 88px;
        }

        body {
          font-size: 0.94rem;
          line-height: 1.6;
          padding-bottom: 104px;
        }

        header {
          box-shadow: 0 12px 28px -18px rgba(0, 0, 0, 0.4);
        }

        .header-shell {
          padding: 0.48rem clamp(0.34rem, 3.5vw, 0.425rem) 0.6rem;
          gap: 0.45rem;
        }

        .header-top {
          grid-template-columns: auto minmax(0, 1fr) auto;
          grid-template-areas: "brand search actions";
          align-items: center;
          gap: 0.4rem;
        }

        .brand {
          gap: 0.45rem;
        }

        .brand-info {
          display: none;
        }

        .brand-mark {
          width: 30px;
          height: 30px;
          border-radius: 10px;
          font-size: 0.82rem;
        }

        .btn {
          padding: 0.64rem 1.1rem;
          font-size: 0.88rem;
        }

        .header-actions {
          justify-content: flex-end;
          align-items: center;
          gap: 0;
        }

        .header-cta {
          display: none;
        }

        .sidebar-toggle {
          width: 30px;
          height: 30px;
          border-radius: 10px;
        }

        .header-search-area {
          width: 100%;
          gap: 0.3rem;
        }

        .header-search {
          width: 100%;
          max-width: none;
        }

        .header-search input {
          font-size: 0.78rem;
        }

        #feed-grid {
          grid-template-columns: minmax(0, 1fr);
          gap: clamp(0.95rem, 6vw, 1.3rem);
        }

        .category-board,
        .most-viewed-board {
          padding: 1.15rem 1.3rem;
        }

        .category-list {
          grid-template-columns: minmax(0, 1fr);
        }

        .most-viewed-list {
          gap: clamp(0.55rem, 5vw, 0.95rem);
        }

        .category-icon {
          width: 56px;
          height: 56px;
          font-size: 1.4rem;
        }

        .most-viewed-card {
          width: clamp(170px, 82vw, 210px);
          grid-template-rows: minmax(0, 140px) auto;
        }

        .most-viewed-body {
          padding: 0.9rem;
          gap: 0.5rem;
        }

        .most-viewed-title {
          font-size: 0.98rem;
        }

        .most-viewed-category,
        .most-viewed-meta {
          font-size: 0.74rem;
        }

        .most-viewed-views {
          font-size: 0.72rem;
          padding: 0.32rem 0.65rem;
        }

        .most-viewed-rank {
          font-size: 0.72rem;
          padding: 0.2rem 0.6rem;
        }

        .filters-sheet-header h3 {
          font-size: 1.35rem;
        }

        .filters-form-footer {
          gap: 0.8rem;
        }

        .product-card {
          grid-template-rows: minmax(0, 160px) auto;
          border-radius: 20px;
        }

        .product-card-body {
          padding: 1rem;
          gap: 0.55rem;
        }

        .product-card-title {
          font-size: 1rem;
        }

        .product-card-category {
          font-size: 0.74rem;
        }

        .product-card-rating {
          font-size: 0.82rem;
        }

        .product-card-badge {
          font-size: 0.88rem;
          padding: 0.38rem 0.78rem;
        }

        .product-card-owner img {
          width: 36px;
          height: 36px;
          border-radius: 12px;
        }

        .product-card-owner .owner-name {
          font-size: 0.86rem;
        }

        .product-card-owner .owner-meta {
          font-size: 0.72rem;
        }

        .product-card-cta {
          font-size: 0.74rem;
          padding: 0.45rem 0.75rem;
        }

        .panel {
          padding: clamp(1.25rem, 6vw, 1.5rem);
        }

        .panel h3 {
          font-size: 1.18rem;
          margin-bottom: 0.95rem;
        }

        .section-header {
          gap: 0.7rem;
          margin-bottom: 1.2rem;
        }

        .section-title {
          gap: 0.65rem;
        }

        .section-icon {
          width: 48px;
          height: 48px;
          border-radius: 16px;
        }

        .header-notification {
          display: none;
        }

        main {
          padding: clamp(0.85rem, 7vw, 1.35rem) clamp(0.425rem, 3.5vw, 0.675rem);
        }

        .product-detail-dialog {
          margin: max(0.85rem, calc(var(--header-height) - 56px)) auto clamp(0.75rem, 6vw, 1.35rem);
        }

        .product-detail-thumbs {
          padding: 0.75rem 0.95rem;
        }

        .product-detail-thumb {
          width: 64px;
          height: 54px;
        }

        .product-detail-body {
          padding: 0.95rem;
          gap: 0.75rem;
        }

        .product-detail-body h2 {
          font-size: 1.3rem;
        }

        .premium-bottom-nav__card {
          border-radius: 14px;
          padding: 0.08rem 0.32rem calc(0.45rem + env(safe-area-inset-bottom, 0px));
          min-height: 58px;
        }

        .premium-bottom-nav button {
          font-size: 0.66rem;
          padding: 0.36rem 0.2rem 0.46rem;
        }

        .premium-bottom-nav button .nav-icon {
          width: 24px;
          height: 24px;
          font-size: 1rem;
        }

        .premium-bottom-nav button.nav-item--highlight {
          --highlight-size: 50px;
          min-width: calc(var(--highlight-size) + 6px);
          padding: calc(var(--highlight-size) / 2 + 0.26rem) 0.18rem 0.44rem;
        }

        .premium-bottom-nav button.nav-item--highlight .nav-icon {
          font-size: 1.15rem;
        }
      }

      @media (max-width: 360px) {
        :root {
          --header-height: 82px;
        }

        body {
          font-size: 0.9rem;
        }

        .header-shell {
          padding: 0.45rem clamp(0.3rem, 3.5vw, 0.4rem) 0.55rem;
          gap: 0.4rem;
        }

        .header-top {
          gap: 0.5rem;
        }

        .brand-mark {
          width: 28px;
          height: 28px;
          font-size: 0.78rem;
          border-radius: 9px;
        }

        .sidebar-toggle {
          width: 28px;
          height: 28px;
        }

        #feed-grid {
          gap: clamp(0.65rem, 7vw, 1rem);
        }

        .product-card {
          grid-template-rows: minmax(0, 150px) auto;
          border-radius: 18px;
        }

        .product-card-body {
          padding: 0.8rem;
          gap: 0.48rem;
        }

        .product-card-title {
          font-size: 0.92rem;
        }

        .product-card-category {
          font-size: 0.7rem;
        }

        .product-card-badge {
          font-size: 0.8rem;
          padding: 0.32rem 0.62rem;
        }

        .btn {
          padding: 0.58rem 0.95rem;
          font-size: 0.86rem;
        }

        .most-viewed-card {
          width: clamp(160px, 88vw, 200px);
          grid-template-rows: minmax(0, 130px) auto;
        }

        .most-viewed-body {
          padding: 0.78rem;
        }

        .most-viewed-title {
          font-size: 0.92rem;
        }

        .most-viewed-category,
        .most-viewed-meta {
          font-size: 0.7rem;
        }

        .most-viewed-views {
          font-size: 0.66rem;
          padding: 0.3rem 0.58rem;
        }

        .most-viewed-rank {
          font-size: 0.66rem;
        }

        .product-card-owner img {
          width: 30px;
          height: 30px;
        }

        .product-card-cta {
          display: none;
        }

        .panel {
          padding: 1.05rem;
        }

        .panel h3 {
          font-size: 1.08rem;
          margin-bottom: 0.75rem;
        }

        .section-title {
          gap: 0.55rem;
        }

        .section-icon {
          width: 42px;
          height: 42px;
        }

        main {
          padding: clamp(0.6rem, 7vw, 1.05rem) clamp(0.3rem, 3.5vw, 0.525rem);
        }

        .product-detail-dialog {
          margin: max(0.65rem, calc(var(--header-height) - 60px)) auto clamp(0.55rem, 6vw, 1.05rem);
        }

        .product-detail-price {
          padding: 0.48rem 0.88rem;
          font-size: 0.86rem;
        }

        .product-detail-thumbs {
          padding: 0.62rem 0.78rem;
        }

        .product-detail-thumb {
          width: 60px;
          height: 48px;
        }

        .product-detail-body {
          padding: 0.85rem;
          gap: 0.6rem;
        }

        .product-detail-body h2 {
          font-size: 1.2rem;
        }

        .premium-bottom-nav__card {
          min-height: 54px;
          border-radius: 12px;
        }

        .premium-bottom-nav button {
          font-size: 0.62rem;
        }

        .premium-bottom-nav button .nav-icon {
          width: 22px;
          height: 22px;
        }

        .premium-bottom-nav button.nav-item--highlight {
          --highlight-size: 48px;
        }

        .premium-bottom-nav button.nav-item--highlight .nav-icon {
          font-size: 1.12rem;
        }
      }

      .panel {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: clamp(1.6rem, 2vw, 2rem);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-sm);
        backdrop-filter: blur(18px);
      }

      #feed-section.panel {
        background: none;
        border: none;
        border-radius: 0;
        box-shadow: none;
        padding: 0;
      }

      .panel h3 {
        margin: 0 0 1.2rem;
        font-size: 1.35rem;
        letter-spacing: -0.01em;
      }

      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1.6rem;
      }

      .section-title {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .section-icon {
        width: 58px;
        height: 58px;
        border-radius: 22px;
        background: var(--primary-600);
        box-shadow: 0 24px 50px -24px rgba(15, 23, 42, 0.55);
        display: grid;
        place-items: center;
        color: white;
        position: relative;
        overflow: hidden;
        isolation: isolate;
      }

      .section-icon::after {
        content: "";
        position: absolute;
        inset: 0;
        background: transparent;
        opacity: 0.9;
        pointer-events: none;
      }

      .section-icon i {
        font-size: 1.38rem;
        position: relative;
        z-index: 1;
      }

      .section-header p {
        margin: 0;
        color: var(--muted);
      }

      .coupon-panel {
        display: grid;
        gap: clamp(1.8rem, 2.6vw, 2.4rem);
      }

      .coupon-management {
        display: grid;
        grid-template-columns: minmax(0, 1.45fr) minmax(0, 1fr);
        gap: clamp(1.5rem, 2.8vw, 2.4rem);
        align-items: start;
      }

      .coupon-management__list,
      .coupon-management__editor {
        display: grid;
        gap: clamp(1.1rem, 2.4vw, 1.6rem);
      }

      .coupon-list-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .coupon-list-header h4 {
        margin: 0;
        font-size: 1.05rem;
        letter-spacing: -0.01em;
      }

      .coupon-header-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .coupon-counter-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        padding: 0.55rem 0.95rem;
        border-radius: 999px;
        font-size: 0.82rem;
        font-weight: 600;
        background: rgba(76, 81, 255, 0.12);
        color: var(--primary-700);
        border: 1px solid rgba(76, 81, 255, 0.22);
        letter-spacing: 0.05em;
        text-transform: uppercase;
      }

      .coupon-list {
        display: grid;
        gap: clamp(1.1rem, 2.4vw, 1.6rem);
      }

      .coupon-card {
        position: relative;
        border-radius: clamp(22px, 2.8vw, 28px);
        overflow: hidden;
        background: var(--surface-strong);
        border: 1px solid rgba(15, 23, 42, 0.08);
        box-shadow: 0 45px 80px -60px rgba(15, 23, 42, 0.65);
        display: grid;
        grid-template-rows: minmax(0, auto) minmax(0, 1fr);
        transition: transform var(--transition), box-shadow var(--transition), border var(--transition);
      }

      .coupon-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 55px 95px -60px rgba(15, 23, 42, 0.75);
        border-color: rgba(76, 81, 255, 0.35);
      }

      .coupon-card.is-selected {
        border-color: rgba(76, 81, 255, 0.55);
        box-shadow: 0 55px 95px -55px rgba(76, 81, 255, 0.45);
      }

      .coupon-card[data-status="paused"] .coupon-card__status-badge {
        background: rgba(239, 68, 68, 0.18);
        color: #b91c1c;
      }

      .coupon-card__cover {
        position: relative;
        padding: clamp(1.4rem, 2.6vw, 1.9rem);
        background: var(--coupon-gradient, linear-gradient(135deg, #4c51ff 0%, #00b894 100%));
        color: white;
        display: grid;
        gap: clamp(0.7rem, 1.8vw, 1rem);
        align-content: space-between;
        min-height: clamp(150px, 28vw, 190px);
        isolation: isolate;
      }

      .coupon-card__cover::after {
        content: "";
        position: absolute;
        inset: 0;
        background-image: var(--coupon-cover-image, none);
        background-size: cover;
        background-position: center;
        mix-blend-mode: screen;
        opacity: 0.55;
        pointer-events: none;
        border-radius: inherit;
      }

      .coupon-card__top-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        position: relative;
        z-index: 1;
      }

      .coupon-card__status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        padding: 0.45rem 0.85rem;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.22);
        font-size: 0.78rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        backdrop-filter: blur(10px);
      }

      .coupon-card__delete {
        border: none;
        background: rgba(15, 23, 42, 0.22);
        color: white;
        width: 34px;
        height: 34px;
        border-radius: 12px;
        display: inline-grid;
        place-items: center;
        cursor: pointer;
        transition: background var(--transition), transform var(--transition);
      }

      .coupon-card__delete:hover,
      .coupon-card__delete:focus-visible {
        background: rgba(239, 68, 68, 0.9);
        transform: translateY(-2px);
      }

      .coupon-card__discount {
        display: grid;
        gap: 0.2rem;
        position: relative;
        z-index: 1;
      }

      .coupon-card__discount span {
        font-size: 0.85rem;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        opacity: 0.8;
        font-weight: 600;
      }

      .coupon-card__discount strong {
        font-size: clamp(1.8rem, 4vw, 2.4rem);
        letter-spacing: -0.04em;
        line-height: 1.05;
      }

      .coupon-card__discount small {
        font-size: 0.9rem;
        font-weight: 500;
        opacity: 0.9;
      }

      .coupon-card__body {
        padding: clamp(1.3rem, 2.4vw, 1.8rem);
        display: grid;
        gap: clamp(0.9rem, 2.2vw, 1.2rem);
      }

      .coupon-card__meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        font-weight: 600;
        color: var(--muted-dark);
      }

      .coupon-card__code {
        font-size: 0.95rem;
        letter-spacing: 0.22em;
        text-transform: uppercase;
      }

      .coupon-card__availability {
        font-size: 0.85rem;
        color: var(--muted);
      }

      .coupon-card__description {
        margin: 0;
        color: var(--muted);
        font-size: 0.9rem;
        line-height: 1.6;
      }

      .coupon-card__stats {
        display: grid;
        gap: 0.5rem;
        font-size: 0.85rem;
        color: var(--muted-dark);
      }

      .coupon-card__stats span {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
      }

      .coupon-card__progress {
        display: grid;
        gap: 0.4rem;
      }

      .coupon-card__progress-track {
        width: 100%;
        height: 6px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.08);
        overflow: hidden;
      }

      .coupon-card__progress-bar {
        height: 100%;
        background: linear-gradient(135deg, rgba(76, 81, 255, 0.85), rgba(0, 184, 148, 0.85));
        border-radius: 999px;
      }

      .coupon-card__footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
      }

      .coupon-card__footer .btn {
        flex: 1 1 0;
        justify-content: center;
      }

      .coupon-empty {
        border: 1px dashed rgba(148, 163, 184, 0.35);
        border-radius: var(--radius-lg);
        padding: clamp(1.8rem, 3vw, 2.2rem);
        background: rgba(255, 255, 255, 0.72);
        display: grid;
        gap: 0.65rem;
        text-align: center;
      }

      .coupon-empty h5 {
        margin: 0;
        font-size: 1.1rem;
      }

      .coupon-empty p {
        margin: 0;
        color: var(--muted);
        font-size: 0.92rem;
      }

      .coupon-editor-card {
        background: rgba(255, 255, 255, 0.82);
        border-radius: clamp(22px, 2.8vw, 28px);
        padding: clamp(1.6rem, 2.8vw, 2.2rem);
        border: 1px solid rgba(99, 102, 241, 0.16);
        box-shadow: 0 45px 90px -65px rgba(15, 23, 42, 0.65);
        display: grid;
        gap: clamp(1rem, 2.2vw, 1.4rem);
      }

      .coupon-editor-card h4 {
        margin: 0;
        font-size: 1.25rem;
        letter-spacing: -0.01em;
      }

      .coupon-editor-subtitle {
        margin: 0;
        color: var(--muted);
        font-size: 0.92rem;
      }

      .coupon-form {
        display: grid;
        gap: clamp(1rem, 2.2vw, 1.4rem);
      }

      .coupon-form .form-grid {
        display: grid;
        gap: clamp(0.75rem, 1.8vw, 1rem);
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }

      .coupon-form textarea {
        min-height: 96px;
        resize: vertical;
      }

      .coupon-cover-control {
        display: grid;
        gap: 0.75rem;
      }

      .coupon-cover-preview {
        position: relative;
        border-radius: clamp(18px, 2.4vw, 22px);
        padding: clamp(1.2rem, 2.4vw, 1.8rem);
        background: var(--coupon-preview-gradient, linear-gradient(135deg, rgba(76, 81, 255, 0.85), rgba(0, 184, 148, 0.85)));
        color: white;
        min-height: clamp(140px, 26vw, 180px);
        display: grid;
        align-content: space-between;
        gap: 0.6rem;
        overflow: hidden;
        isolation: isolate;
      }

      .coupon-cover-preview::after {
        content: "";
        position: absolute;
        inset: 0;
        background-image: var(--coupon-preview-cover, none);
        background-size: cover;
        background-position: center;
        opacity: 0.55;
        mix-blend-mode: screen;
        pointer-events: none;
      }

      .coupon-preview-status {
        justify-self: flex-start;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.85rem;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.22);
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-weight: 600;
        position: relative;
        z-index: 1;
      }

      .coupon-preview-status.is-paused {
        background: rgba(239, 68, 68, 0.22);
      }

      .coupon-preview-discount {
        position: relative;
        z-index: 1;
        display: grid;
        gap: 0.2rem;
      }

      .coupon-preview-discount span {
        font-size: 0.82rem;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        opacity: 0.8;
      }

      .coupon-preview-discount strong {
        font-size: clamp(1.6rem, 3.8vw, 2.2rem);
        letter-spacing: -0.03em;
      }

      .coupon-preview-meta {
        position: relative;
        z-index: 1;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
        font-size: 0.82rem;
        letter-spacing: 0.14em;
        text-transform: uppercase;
      }

      .coupon-cover-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .coupon-cover-actions .btn {
        flex: 0 0 auto;
      }

      .coupon-form-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        justify-content: flex-end;
      }

      .coupon-form-actions .btn {
        min-width: 140px;
      }

      @media (max-width: 1100px) {
        .coupon-management {
          grid-template-columns: minmax(0, 1fr);
        }

        .coupon-management__editor {
          order: -1;
        }
      }

      @media (max-width: 860px) {
        .coupon-card {
          grid-template-rows: auto auto;
        }

        .coupon-card__body {
          padding: 1.1rem 1.3rem 1.4rem;
        }

        .coupon-card__cover {
          min-height: 160px;
        }
      }

      @media (max-width: 640px) {
        .coupon-card__meta {
          flex-direction: column;
          align-items: flex-start;
        }

        .coupon-card__footer {
          flex-direction: column;
        }

        .coupon-cover-actions {
          flex-direction: column;
          align-items: stretch;
        }

        .coupon-cover-actions .btn {
          width: 100%;
        }
      }

      .category-board {
        position: relative;
        background: #fff;
        border-radius: clamp(22px, 3vw, 32px);
        border: 1px solid rgba(99, 102, 241, 0.16);
        padding: clamp(1rem, 2.4vw, 1.6rem);
        box-shadow: 0 45px 80px -55px rgba(15, 23, 42, 0.55);
        display: grid;
        gap: clamp(0.9rem, 2vw, 1.4rem);
        overflow: hidden;
      }

      .category-board::before {
        content: "";
        position: absolute;
        inset: 0;
        background: transparent;
        pointer-events: none;
      }

      .category-board-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: clamp(0.75rem, 2vw, 1.25rem);
        position: relative;
        z-index: 1;
      }

      .category-board-title {
        display: grid;
        gap: 0.25rem;
      }

      .category-board-title span {
        font-size: 0.78rem;
        letter-spacing: 0.22em;
        text-transform: uppercase;
        color: rgba(15, 23, 42, 0.55);
        font-weight: 600;
      }

      .category-board-title h4 {
        margin: 0;
        font-size: clamp(1.1rem, 2.2vw, 1.5rem);
        letter-spacing: -0.01em;
      }

      .category-board-actions {
        display: flex;
        align-items: center;
      }

      .category-filters {
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-radius: 999px;
        background: #fff;
        color: var(--primary-700);
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 1.3rem;
        cursor: pointer;
        transition: transform var(--transition), box-shadow var(--transition), background var(--transition);
        backdrop-filter: blur(8px);
      }

      .category-filters i {
        font-size: 1rem;
      }

      .category-filters:hover,
      .category-filters:focus-visible {
        transform: translateY(-2px);
        box-shadow: 0 22px 40px -28px rgba(76, 81, 255, 0.45);
        background: #fff;
      }

      .category-list {
        position: relative;
        display: flex;
        gap: clamp(0.4rem, 1.2vw, 0.75rem);
        overflow-x: auto;
        padding: 0.25rem 0.2rem 0.6rem;
        margin: 0;
        scroll-snap-type: x mandatory;
        scrollbar-width: none;
        z-index: 1;
      }

      .category-list::-webkit-scrollbar {
        display: none;
      }

      .category-card {
        border: 1px solid rgba(148, 163, 184, 0.18);
        border-radius: clamp(18px, 3vw, 24px);
        padding: clamp(0.55rem, 1.4vw, 0.85rem);
        min-width: clamp(132px, 17vw, 180px);
        background: #fff;
        backdrop-filter: blur(12px);
        display: grid;
        gap: 0.45rem;
        justify-items: center;
        text-align: center;
        cursor: pointer;
        transition: transform var(--transition), border var(--transition), background var(--transition);
        position: relative;
        scroll-snap-align: center;
        overflow: hidden;
      }

      .most-viewed-board {
        margin-top: 0;
      }

      .most-viewed-board .category-board-title span {
        color: rgba(15, 23, 42, 0.6);
      }

      .most-viewed-list {
        position: relative;
        display: flex;
        gap: clamp(0.65rem, 1.8vw, 1.1rem);
        overflow-x: auto;
        padding: 0.35rem 0.25rem 0.75rem;
        margin: 0;
        scroll-snap-type: x mandatory;
        scroll-padding-inline: clamp(0.75rem, 2vw, 1.25rem);
        scrollbar-width: none;
        scrollbar-gutter: stable both-edges;
        overscroll-behavior-inline: contain;
        -webkit-overflow-scrolling: touch;
        z-index: 1;
        touch-action: pan-x pan-y pinch-zoom;
        scroll-behavior: smooth;
        box-shadow: inset 32px 0 34px -32px rgba(15, 23, 42, 0.16),
          inset -32px 0 34px -32px rgba(15, 23, 42, 0.16);
        transition: box-shadow 240ms ease;
      }

      .most-viewed-list::-webkit-scrollbar {
        display: none;
      }

      .most-viewed-list:focus-visible {
        outline: 3px solid rgba(76, 81, 255, 0.32);
        outline-offset: 4px;
      }

      .most-viewed-list.is-dragging {
        scroll-snap-type: none;
      }

      .most-viewed-list.is-kinetic {
        scroll-behavior: auto;
      }

      .most-viewed-list.is-scroll-start {
        box-shadow: inset -32px 0 34px -32px rgba(15, 23, 42, 0.16);
      }

      .most-viewed-list.is-scroll-end {
        box-shadow: inset 32px 0 34px -32px rgba(15, 23, 42, 0.16);
      }

      .most-viewed-list.is-scroll-start.is-scroll-end {
        box-shadow: none;
      }

      @media (hover: hover) and (pointer: fine) {
        .most-viewed-list {
          cursor: grab;
        }

        .most-viewed-list.is-dragging {
          cursor: grabbing;
        }
      }

      .most-viewed-card {
        flex: 0 0 auto;
        width: clamp(180px, 60vw, 240px);
        border-radius: clamp(18px, 3vw, 24px);
        border: 1px solid rgba(148, 163, 184, 0.18);
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        box-shadow: 0 25px 55px -45px rgba(15, 23, 42, 0.55);
        display: grid;
        grid-template-rows: minmax(0, 160px) auto;
        overflow: hidden;
        scroll-snap-align: center;
        scroll-snap-stop: always;
        cursor: pointer;
        transition: transform var(--transition), box-shadow var(--transition), border var(--transition);
        position: relative;
      }

      .most-viewed-card:hover,
      .most-viewed-card:focus-visible {
        transform: translateY(-4px) scale(0.99);
        box-shadow: 0 32px 70px -45px rgba(76, 81, 255, 0.45);
        border-color: rgba(76, 81, 255, 0.35);
      }

      .most-viewed-card:focus-visible {
        outline: 3px solid rgba(76, 81, 255, 0.32);
        outline-offset: 3px;
      }

      .most-viewed-media {
        position: relative;
        overflow: hidden;
      }

      .most-viewed-media img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform var(--transition);
      }

      .most-viewed-card:hover .most-viewed-media img {
        transform: scale(1.05);
      }

      .most-viewed-rank {
        position: absolute;
        top: 0.75rem;
        left: 0.75rem;
        padding: 0.2rem 0.65rem;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.78);
        color: white;
        font-weight: 600;
        font-size: 0.75rem;
        box-shadow: 0 18px 30px -20px rgba(15, 23, 42, 0.6);
      }

      .most-viewed-views {
        position: absolute;
        right: 0.75rem;
        bottom: 0.75rem;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.7rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.82);
        color: var(--muted-dark);
        font-weight: 600;
        font-size: 0.75rem;
        box-shadow: 0 18px 30px -24px rgba(15, 23, 42, 0.45);
      }

      .most-viewed-body {
        display: grid;
        gap: 0.55rem;
        padding: clamp(0.85rem, 2vw, 1.15rem);
        background: rgba(255, 255, 255, 0.95);
      }

      .most-viewed-category {
        font-size: 0.78rem;
        font-weight: 600;
        color: var(--primary-700);
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      .most-viewed-title {
        margin: 0;
        font-size: 1rem;
        line-height: 1.35;
        color: #0f172a;
        letter-spacing: -0.01em;
      }

      .most-viewed-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.6rem;
        flex-wrap: wrap;
        color: var(--muted);
        font-size: 0.78rem;
      }

      .most-viewed-meta i {
        color: var(--primary-600);
      }

      .most-viewed-rating {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
      }

      .most-viewed-rating i {
        color: #f59e0b;
      }

      .most-viewed-rating.is-new i {
        color: var(--muted);
      }

      .most-viewed-empty {
        flex: 0 0 100%;
        min-height: 120px;
        border-radius: clamp(18px, 3vw, 24px);
        border: 1px dashed rgba(148, 163, 184, 0.35);
        display: grid;
        place-items: center;
        text-align: center;
        padding: 1.5rem;
        color: var(--muted);
        backdrop-filter: blur(12px);
        background: rgba(255, 255, 255, 0.75);
      }

      .most-viewed-empty i {
        font-size: 1.6rem;
        color: var(--primary-600);
      }

      .category-card::after {
        content: "";
        position: absolute;
        inset: 0;
        background: transparent;
        opacity: 0;
        transition: opacity var(--transition);
      }

      .category-card:hover,
      .category-card:focus-visible {
        transform: translateY(-2px);
      }

      .category-card:hover::after,
      .category-card:focus-visible::after,
      .category-card.active::after {
        opacity: 1;
      }

      .category-card.active {
        border-color: rgba(76, 81, 255, 0.38);
        background: rgba(255, 255, 255, 0.94);
      }

      .category-icon {
        width: clamp(44px, 6vw, 52px);
        height: clamp(44px, 6vw, 52px);
        border-radius: 50%;
        display: grid;
        place-items: center;
        background: var(--primary-50);
        color: var(--primary-700);
        font-size: clamp(1.1rem, 2.4vw, 1.35rem);
      }

      .category-label {
        font-weight: 600;
        font-size: clamp(0.78rem, 1.6vw, 0.9rem);
        letter-spacing: 0.03em;
      }

      .filters-overlay {
        position: fixed;
        inset: 0;
        background: rgba(8, 15, 35, 0.72);
        backdrop-filter: blur(18px);
        display: grid;
        place-items: stretch;
        opacity: 0;
        pointer-events: none;
        transition: opacity var(--transition);
        z-index: 140;
      }

      .filters-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }

      .filters-sheet {
        width: 100vw;
        height: 100vh;
        display: grid;
        grid-template-columns: minmax(280px, 360px) minmax(0, 1fr);
        background: transparent;
        position: relative;
        overflow: hidden;
      }

      .filters-sheet::before {
        content: "";
        position: absolute;
        inset: 0;
        background: transparent;
        pointer-events: none;
        z-index: 0;
      }

      .filters-panel {
        background: #0f172a;
        color: white;
        display: grid;
        place-items: stretch;
        position: relative;
        z-index: 1;
      }

      .filters-panel::after {
        content: "";
        position: absolute;
        inset: clamp(1.5rem, 3vw, 2.5rem);
        border-radius: clamp(1.8rem, 3vw, 2.4rem);
        border: 1px solid rgba(255, 255, 255, 0.08);
        opacity: 0.65;
        pointer-events: none;
      }

      .filters-panel-inner {
        padding: clamp(2rem, 4vw, 3rem) clamp(1.8rem, 4vw, 3rem);
        display: grid;
        gap: clamp(1.2rem, 3vw, 1.8rem);
        align-content: start;
        position: relative;
        z-index: 1;
      }

      .filters-panel-eyebrow {
        font-size: 0.78rem;
        letter-spacing: 0.24em;
        text-transform: uppercase;
        opacity: 0.68;
        font-weight: 600;
      }

      .filters-panel-inner h2 {
        margin: 0;
        font-size: clamp(1.6rem, 3vw, 2.25rem);
        letter-spacing: -0.01em;
      }

      .filters-panel-inner p {
        margin: 0;
        color: rgba(255, 255, 255, 0.78);
        line-height: 1.6;
      }

      .filters-panel-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 1rem;
      }

      .filters-panel-list li {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.9);
      }

      .filters-panel-list i {
        width: 34px;
        height: 34px;
        border-radius: 12px;
        display: grid;
        place-items: center;
        background: rgba(255, 255, 255, 0.12);
        color: white;
        font-size: 1rem;
      }

      .filters-content {
        background: var(--surface-strong);
        position: relative;
        z-index: 1;
        display: grid;
        grid-template-rows: auto 1fr;
      }

      .filters-sheet-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: clamp(1rem, 2vw, 1.5rem);
        padding: clamp(1.6rem, 3vw, 2.2rem) clamp(1.6rem, 4vw, 2.8rem);
        border-bottom: 1px solid rgba(148, 163, 184, 0.25);
      }

      .filters-sheet-header .title-block {
        display: grid;
        gap: 0.4rem;
      }

      .filters-sheet-header span {
        font-size: 0.8rem;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: rgba(15, 23, 42, 0.58);
        font-weight: 600;
      }

      .filters-sheet-header h3 {
        margin: 0;
        font-size: clamp(1.4rem, 3vw, 2.1rem);
        letter-spacing: -0.015em;
      }

      .filters-close {
        border: none;
        background: rgba(15, 23, 42, 0.08);
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        font-size: 1.25rem;
        color: rgba(15, 23, 42, 0.75);
        cursor: pointer;
        transition: background var(--transition), transform var(--transition);
      }

      .filters-close:hover,
      .filters-close:focus-visible {
        background: rgba(15, 23, 42, 0.18);
        transform: rotate(90deg);
      }

      .filters-form {
        display: grid;
        grid-template-rows: 1fr auto;
        padding: clamp(1.6rem, 4vw, 2.6rem);
        gap: clamp(1.2rem, 2.8vw, 1.6rem);
        overflow: hidden;
      }

      .filters-grid {
        display: grid;
        gap: clamp(1rem, 2.5vw, 1.6rem);
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        overflow-y: auto;
        padding-right: clamp(0rem, 1vw, 0.6rem);
      }

      .price-range-field {
        grid-column: 1 / -1;
        background: #f8fafc;
        border-radius: clamp(18px, 3vw, 24px);
        padding: clamp(1rem, 2.6vw, 1.6rem);
      }

      .field-heading {
        display: grid;
        gap: 0.35rem;
        margin-bottom: clamp(0.6rem, 2vw, 1rem);
      }

      .field-heading span {
        font-size: 0.82rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: rgba(15, 23, 42, 0.7);
        font-weight: 700;
      }

      .field-heading small {
        color: rgba(15, 23, 42, 0.6);
        font-size: 0.78rem;
      }

      .price-slider {
        position: relative;
        height: 48px;
        display: grid;
        place-items: center;
        --start: 0%;
        --end: 100%;
      }

      .price-slider::before {
        content: "";
        position: absolute;
        width: 100%;
        height: 8px;
        background: rgba(15, 23, 42, 0.15);
        border-radius: 999px;
      }

      .price-slider::after {
        content: "";
        position: absolute;
        height: 8px;
        left: var(--start);
        right: calc(100% - var(--end));
        background: var(--primary-600);
        border-radius: 999px;
      }

      .price-range-input {
        position: absolute;
        width: 100%;
        height: 48px;
        pointer-events: none;
        background: none;
        margin: 0;
        -webkit-appearance: none;
        appearance: none;
      }

      .price-range-input::-webkit-slider-runnable-track {
        height: 8px;
        background: transparent;
      }

      .price-range-input::-moz-range-track {
        height: 8px;
        background: transparent;
      }

      .price-range-input::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: white;
        border: 3px solid var(--primary-600);
        box-shadow: 0 18px 35px -20px rgba(76, 81, 255, 0.6);
        pointer-events: auto;
        cursor: pointer;
        transition: transform var(--transition), box-shadow var(--transition);
      }

      .price-range-input::-moz-range-thumb {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        border: 3px solid var(--primary-600);
        background: white;
        box-shadow: 0 18px 35px -20px rgba(76, 81, 255, 0.6);
        pointer-events: auto;
        cursor: pointer;
        transition: transform var(--transition), box-shadow var(--transition);
      }

      .price-range-input:focus-visible::-webkit-slider-thumb,
      .price-range-input::-webkit-slider-thumb:hover {
        transform: scale(1.08);
        box-shadow: 0 30px 65px -35px rgba(76, 81, 255, 0.6);
      }

      .price-range-input:focus-visible::-moz-range-thumb,
      .price-range-input::-moz-range-thumb:hover {
        transform: scale(1.08);
        box-shadow: 0 30px 65px -35px rgba(76, 81, 255, 0.6);
      }

      .price-values {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: clamp(0.65rem, 2vw, 0.9rem);
        font-weight: 600;
        color: var(--muted-dark);
        font-size: 0.92rem;
        font-variant-numeric: tabular-nums;
      }

      .price-values span {
        display: flex;
        align-items: baseline;
        gap: 0.35rem;
      }

      .price-values strong {
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: rgba(15, 23, 42, 0.6);
      }

      .style-toggle {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.75rem;
      }

      .style-pill {
        border: 1px solid rgba(99, 102, 241, 0.18);
        border-radius: clamp(18px, 3vw, 24px);
        padding: 0.85rem 1rem;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
        background: rgba(255, 255, 255, 0.92);
        color: rgba(15, 23, 42, 0.82);
        font-weight: 600;
        cursor: pointer;
        transition: transform var(--transition), box-shadow var(--transition), border var(--transition), background var(--transition);
      }

      .style-pill i {
        font-size: 1.3rem;
        color: var(--primary-600);
      }

      .style-pill.active {
        border-color: rgba(76, 81, 255, 0.42);
        box-shadow: 0 28px 65px -40px rgba(76, 81, 255, 0.45);
        background: #fff;
      }

      .style-pill:hover,
      .style-pill:focus-visible {
        transform: translateY(-4px);
      }

      .filters-form-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        padding: clamp(1.1rem, 2.6vw, 1.8rem) clamp(1rem, 3vw, 1.8rem) 0;
        border-top: 1px solid rgba(148, 163, 184, 0.2);
        background: #fff;
      }

      .filters-footer-actions {
        display: flex;
        gap: 0.75rem;
      }

      .filters-form-footer .btn {
        min-width: 160px;
      }

      body.filters-open {
        overflow: hidden;
      }

      @media (max-width: 960px) {
        .filters-sheet {
          grid-template-columns: 1fr;
        }

        .filters-panel {
          display: none;
        }

        .filters-content {
          grid-template-rows: auto 1fr;
        }

        .filters-grid {
          grid-template-columns: 1fr;
        }

        .price-range-field {
          padding: clamp(0.85rem, 4vw, 1.2rem);
        }
      }

      @media (max-width: 720px) {
        .category-board {
          padding: clamp(0.9rem, 4vw, 1.2rem);
        }

        .category-filters {
          padding: 0.5rem 1.1rem;
          font-size: 0.72rem;
        }

        .category-list {
          gap: 0.5rem;
        }
      }

      #feed-grid {
        margin: clamp(0.3rem, 1.5vw, 0.7rem) 0 0;
        gap: clamp(0.35rem, 1.2vw, 0.85rem);
      }

      .filters label {
        display: grid;
        gap: 0.4rem;
        font-weight: 600;
        font-size: 0.82rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }

      select,
      input[type="text"],
      input[type="number"],
      input[type="search"],
      input[type="tel"],
      input[type="email"],
      input[type="file"],
      textarea {
        border-radius: var(--radius-md);
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(255, 255, 255, 0.92);
        padding: 0.7rem 0.85rem;
        font-family: inherit;
        font-size: 0.95rem;
        transition: border var(--transition), box-shadow var(--transition);
      }

      textarea {
        min-height: 120px;
        resize: vertical;
      }

      select:focus,
      input:focus,
      textarea:focus {
        outline: none;
        border-color: rgba(76, 81, 255, 0.5);
        box-shadow: 0 0 0 4px rgba(76, 81, 255, 0.12);
      }

      .card-grid {
        display: grid;
        width: 100%;
        gap: clamp(1rem, 2vw, 1.6rem);
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        align-items: stretch;
      }

      .card-grid.mode-marketplace {
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      }

      .card-grid.mode-ecommerce {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      .product-card {
        position: relative;
        display: grid;
        grid-template-rows: minmax(0, 210px) auto;
        background: rgba(255, 255, 255, 0.92);
        border-radius: clamp(18px, 3vw, 26px);
        border: 1px solid rgba(15, 23, 42, 0.06);
        overflow: hidden;
        cursor: pointer;
        box-shadow: 0 32px 82px -56px rgba(15, 23, 42, 0.55);
        transition: transform var(--transition), box-shadow var(--transition);
      }

      .product-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 42px 95px -60px rgba(15, 23, 42, 0.6);
      }

      .product-card:focus-visible {
        outline: 3px solid rgba(76, 81, 255, 0.35);
        outline-offset: 3px;
      }

      .product-card-media {
        position: relative;
        overflow: hidden;
      }

      .product-card-media img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform var(--transition);
      }

      .product-card:hover .product-card-media img {
        transform: scale(1.05);
      }

      .product-card-badge {
        position: absolute;
        right: 1rem;
        bottom: 1rem;
        padding: 0.45rem 0.9rem;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.88);
        color: #fff;
        font-weight: 600;
        font-size: 0.95rem;
        box-shadow: 0 18px 38px -22px rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(12px);
      }

      .product-card-body {
        display: grid;
        gap: 0.65rem;
        padding: clamp(1rem, 2.6vw, 1.4rem);
      }

      .product-card-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.65rem;
      }

      .product-card-category {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.25rem 0.7rem;
        border-radius: 999px;
        background: #f8fafc;
        color: var(--primary-700);
        font-size: 0.78rem;
        font-weight: 600;
        text-transform: capitalize;
        letter-spacing: 0.01em;
      }

      .product-card-rating {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-weight: 600;
        font-size: 0.85rem;
        color: var(--warning);
      }

      .product-card-rating i {
        font-size: 0.85rem;
      }

      .product-card-rating.is-new {
        color: var(--muted);
      }

      .product-card-title {
        margin: 0;
        font-size: 1.08rem;
        letter-spacing: -0.01em;
        color: #0f172a;
        line-height: 1.35;
      }

      .product-card-location {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        margin: 0;
        font-size: 0.84rem;
        color: var(--muted);
      }

      .product-card-location i {
        color: var(--primary-600);
      }

      .product-card-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
      }

      .product-card-owner {
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
      }

      .product-card-owner img {
        width: 38px;
        height: 38px;
        border-radius: 14px;
        object-fit: cover;
        box-shadow: 0 16px 30px -20px rgba(15, 23, 42, 0.45);
      }

      .product-card-owner .owner-meta {
        display: grid;
        gap: 0.15rem;
        font-size: 0.76rem;
        color: var(--muted);
      }

      .product-card-owner .owner-name {
        font-weight: 600;
        color: #0f172a;
        font-size: 0.86rem;
      }

      .product-card-cta {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.45rem 0.85rem;
        border-radius: 999px;
        background: #f8fafc;
        color: var(--primary-700);
        font-weight: 600;
        font-size: 0.78rem;
      }

      .product-card-cta i {
        font-size: 0.75rem;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.75rem;
        padding: 0.3rem 0.6rem;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.08);
        color: var(--muted-dark);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .badge.self {
        background: rgba(34, 197, 94, 0.18);
        color: var(--success);
      }

      .product-detail {
        position: fixed;
        inset: 0;
        opacity: 0;
        pointer-events: none;
        transition: opacity var(--transition);
        z-index: 60;
      }

      .product-detail.open {
        opacity: 1;
        pointer-events: auto;
      }

      .product-detail-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(9, 16, 36, 0.72);
        backdrop-filter: blur(18px);
      }

      .product-detail-dialog {
        position: relative;
        width: min(1040px, 92vw);
        max-height: min(88vh, 760px);
        margin: max(1rem, calc(var(--header-height) - 48px)) auto clamp(0.85rem, 3vw, 2rem);
        background: var(--surface-strong);
        border-radius: clamp(22px, 3vw, 34px);
        border: 1px solid rgba(15, 23, 42, 0.08);
        box-shadow: var(--shadow-lg);
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 0.95fr);
        overflow: hidden;
      }

      .product-detail-close {
        position: absolute;
        top: 1.1rem;
        right: 1.1rem;
        width: 46px;
        height: 46px;
        border-radius: 16px;
        border: none;
        display: grid;
        place-items: center;
        background: rgba(255, 255, 255, 0.9);
        color: #0f172a;
        cursor: pointer;
        box-shadow: 0 18px 45px -30px rgba(15, 23, 42, 0.55);
        transition: transform var(--transition), background var(--transition);
        z-index: 2;
      }

      .product-detail-close:hover,
      .product-detail-close:focus-visible {
        transform: rotate(90deg);
        background: rgba(255, 255, 255, 1);
      }

      .product-detail-gallery {
        position: relative;
        display: grid;
        grid-template-rows: minmax(0, 360px) auto;
        background: #0f172a;
      }

      .product-detail-main {
        position: relative;
        overflow: hidden;
        aspect-ratio: 4 / 3;
      }

      .product-detail-main img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .product-detail-price {
        position: absolute;
        right: 1.2rem;
        bottom: 1.2rem;
        padding: 0.6rem 1.2rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.16);
        color: #f8fafc;
        font-weight: 700;
        font-size: 1rem;
        backdrop-filter: blur(16px);
        box-shadow: 0 18px 40px -24px rgba(15, 23, 42, 0.65);
      }

      .product-detail-thumbs {
        display: flex;
        gap: 0.65rem;
        padding: 1rem 1.4rem;
        overflow-x: auto;
        scrollbar-width: thin;
      }

      .product-detail-thumbs::-webkit-scrollbar {
        height: 6px;
      }

      .product-detail-thumbs::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.4);
        border-radius: 999px;
      }

      .product-detail-thumb {
        border: none;
        background: transparent;
        padding: 0;
        border-radius: 18px;
        overflow: hidden;
        width: 84px;
        height: 72px;
        flex: 0 0 auto;
        opacity: 0.55;
        cursor: pointer;
        transition: transform var(--transition), opacity var(--transition), box-shadow var(--transition);
      }

      .product-detail-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .product-detail-thumb.active,
      .product-detail-thumb:hover {
        opacity: 1;
        transform: translateY(-4px);
        box-shadow: 0 16px 35px -24px rgba(15, 23, 42, 0.6);
      }

      .product-detail-body {
        display: grid;
        gap: clamp(0.9rem, 2.2vw, 1.5rem);
        padding: clamp(1.2rem, 3vw, 1.8rem);
        overflow-y: auto;
      }

      .product-detail-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
      }

      .product-detail-category {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.3rem 0.8rem;
        border-radius: 999px;
        background: #f8fafc;
        color: var(--primary-700);
        font-size: 0.82rem;
        font-weight: 600;
        text-transform: capitalize;
      }

      .product-detail-rating {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        font-weight: 600;
        color: var(--warning);
      }

      .product-detail-rating i {
        font-size: 0.9rem;
      }

      .product-detail-body h2 {
        margin: 0;
        font-size: clamp(1.6rem, 3vw, 2.1rem);
        letter-spacing: -0.015em;
      }

      .product-detail-location {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        margin: 0;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .product-detail-location i {
        color: var(--primary-600);
      }

      .product-detail-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.45rem;
      }

      .product-detail-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.25rem 0.7rem;
        border-radius: 999px;
        background: #f8fafc;
        color: var(--primary-700);
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: capitalize;
      }

      .product-detail-description {
        margin: 0;
        color: var(--muted);
        line-height: 1.6;
      }

      .product-detail-owner {
        display: grid;
        grid-template-columns: auto minmax(0, 1fr);
        gap: 0.85rem;
        align-items: center;
        padding: 1rem 1.2rem;
        border-radius: 22px;
        background: #f8fafc;
        border: 1px solid rgba(148, 163, 184, 0.3);
      }

      .product-detail-owner img {
        width: 64px;
        height: 64px;
        border-radius: 20px;
        object-fit: cover;
        box-shadow: 0 20px 45px -30px rgba(15, 23, 42, 0.55);
      }

      .product-detail-owner-copy {
        display: grid;
        gap: 0.25rem;
      }

      .product-detail-owner-copy .owner-name {
        font-weight: 600;
        font-size: 1rem;
        color: #0f172a;
      }

      .product-detail-owner-copy .owner-meta,
      .product-detail-owner-copy .owner-location {
        color: var(--muted);
        font-size: 0.85rem;
      }

      .product-detail-owner-copy .owner-location {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
      }

      .product-detail-flow {
        display: grid;
        gap: 0.85rem;
      }

      .flow-step {
        display: grid;
        grid-template-columns: auto minmax(0, 1fr);
        gap: 0.8rem;
        align-items: start;
      }

      .flow-step-icon {
        width: 42px;
        height: 42px;
        border-radius: 16px;
        display: grid;
        place-items: center;
        background: #f8fafc;
        color: var(--primary-700);
        font-weight: 700;
      }

      .flow-step h3 {
        margin: 0;
        font-size: 1rem;
      }

      .flow-step p {
        margin: 0.25rem 0 0;
        color: var(--muted);
        font-size: 0.86rem;
        line-height: 1.5;
      }

      .product-detail-actions {
        display: grid;
        gap: 0.75rem;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }

      .product-detail-actions .btn {
        width: 100%;
        justify-content: center;
      }

      @media (max-width: 1080px) {
        .product-detail-dialog {
          grid-template-columns: minmax(0, 1fr);
          max-height: none;
        }
        .product-detail-gallery {
          grid-template-rows: minmax(0, 320px) auto;
        }
        .product-detail-close {
          top: 0.9rem;
          right: 0.9rem;
        }
      }

      @media (max-width: 720px) {
        .product-detail-dialog {
          width: 100vw;
          height: 100vh;
          margin: 0;
          border-radius: 0;
        }
        .product-detail-body {
          padding: 1.2rem 1.1rem 1.6rem;
        }
        .product-detail-thumbs {
          padding: 0.8rem 1rem;
        }
        .product-detail-price {
          right: 1rem;
          bottom: 1rem;
        }
        .product-detail-gallery {
          grid-template-rows: minmax(0, 280px) auto;
        }
      }

      .empty-state {
        border-radius: var(--radius-md);
        padding: 2.2rem;
        text-align: center;
        background: #f8fafc;
        border: 1px dashed rgba(148, 163, 184, 0.35);
        color: var(--muted);
      }

      .empty-state h4 {
        margin: 0 0 0.45rem;
      }

      .list {
        display: grid;
        gap: 1rem;
      }

      .exchange-card {
        background: var(--surface-strong);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        padding: 1.2rem;
        display: grid;
        gap: 0.9rem;
        position: relative;
        box-shadow: var(--shadow-sm);
      }

      .exchange-status {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .status-pendiente {
        background: rgba(59, 130, 246, 0.16);
        color: #1d4ed8;
      }

      .status-negociacion {
        background: rgba(245, 158, 11, 0.14);
        color: var(--warning);
      }

      .status-entrega {
        background: rgba(34, 197, 94, 0.16);
        color: var(--success);
      }

      .chat-box {
        background: rgba(248, 249, 255, 0.9);
        border-radius: var(--radius-md);
        padding: 0.9rem;
        display: grid;
        gap: 0.6rem;
        border: 1px solid rgba(148, 163, 184, 0.3);
      }

      .chat-messages {
        max-height: 180px;
        overflow-y: auto;
        display: grid;
        gap: 0.5rem;
      }

      .chat-message {
        display: grid;
        gap: 0.25rem;
        padding: 0.6rem 0.75rem;
        border-radius: var(--radius-sm);
        background: white;
        border: 1px solid rgba(226, 232, 240, 0.7);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5);
      }

      .chat-message.me {
        background: #f8fafc;
        border-color: rgba(148, 163, 184, 0.35);
      }

      .chat-message small {
        color: var(--muted);
        font-size: 0.7rem;
      }

      .chat-input {
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto;
        gap: 0.6rem;
      }

      .chat-input button {
        border-radius: var(--radius-md);
        padding: 0.6rem 1.1rem;
        border: none;
        background: var(--primary-600);
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: transform var(--transition);
      }

      .chat-input button:hover {
        transform: translateY(-1px);
      }

      .history-card {
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        padding: 1.2rem;
        background: var(--surface-strong);
        display: grid;
        gap: 0.6rem;
      }

      .rating-control {
        display: inline-flex;
        gap: 0.25rem;
        color: #d97706;
        cursor: pointer;
      }

      .rating-control i {
        font-size: 1.2rem;
      }

      .toast {
        position: fixed;
        top: 24px;
        right: 24px;
        background: var(--surface-strong);
        border-radius: var(--radius-md);
        border: 1px solid rgba(76, 81, 255, 0.25);
        padding: 1rem 1.2rem;
        box-shadow: var(--shadow-sm);
        display: flex;
        gap: 0.75rem;
        align-items: flex-start;
        width: min(320px, 80vw);
        transform: translateY(-20px);
        opacity: 0;
        pointer-events: none;
        transition: opacity var(--transition), transform var(--transition);
        z-index: 80;
      }

      .toast.show {
        opacity: 1;
        transform: translateY(0);
        pointer-events: all;
      }

      .toast.success {
        border-color: rgba(22, 163, 74, 0.3);
      }

      .premium-bottom-nav {
        position: fixed;
        left: 0;
        right: 0;
        bottom: max(env(safe-area-inset-bottom, 0px), 0px);
        display: flex;
        justify-content: center;
        padding: 0 clamp(1.1rem, 5vw, 2.4rem) 0;
        pointer-events: none;
        z-index: 60;
      }

      .premium-bottom-nav__card {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 0.35rem;
        width: min(600px, 100%);
        background: #fff;
        border: 1px solid rgba(255, 255, 255, 0.45);
        box-shadow: 0 25px 50px -32px rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(26px);
        border-radius: 20px;
        padding: 0.1rem 0.6rem calc(0.5rem + env(safe-area-inset-bottom, 0px));
        pointer-events: auto;
        position: relative;
        overflow: visible;
        min-height: 72px;
      }

      .premium-bottom-nav button {
        flex: 1 1 0;
        border: none;
        background: transparent;
        color: rgba(15, 23, 42, 0.65);
        font-weight: 600;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.3rem;
        border-radius: 18px;
        padding: 0.45rem 0.4rem 0.55rem;
        font-size: 0.75rem;
        text-align: center;
        white-space: nowrap;
        line-height: 1.1;
        cursor: pointer;
        transition: color var(--transition), background var(--transition), transform var(--transition);
      }

      .premium-bottom-nav button .nav-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        font-size: 1.2rem;
        color: inherit;
        transition: inherit;
      }

      .premium-bottom-nav button .nav-label {
        font-size: 0.74rem;
        letter-spacing: 0.01em;
        display: block;
      }

      .premium-bottom-nav button:hover,
      .premium-bottom-nav button:focus-visible {
        background: #f8fafc;
        color: var(--primary-600);
        outline: none;
      }

      .premium-bottom-nav button.active {
        background: #eef2ff;
        color: var(--primary-600);
        box-shadow: inset 0 0 0 1px rgba(76, 81, 255, 0.25);
      }

      .premium-bottom-nav button.nav-item--highlight {
        --highlight-size: 64px;
        flex: 0 0 auto;
        position: relative;
        padding: calc(var(--highlight-size) / 2 + 0.35rem) 0.4rem 0.6rem;
        background: none;
        color: var(--primary-700);
        z-index: 2;
        gap: 0.35rem;
        min-width: calc(var(--highlight-size) + 12px);
      }

      .premium-bottom-nav button.nav-item--highlight .nav-icon {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translate(-50%, -50%);
        width: var(--highlight-size);
        height: var(--highlight-size);
        border-radius: 999px;
        background: #fff;
        box-shadow: 0 24px 45px -28px rgba(15, 23, 42, 0.75), 0 6px 18px -12px rgba(76, 81, 255, 0.45);
        border: 2px solid rgba(76, 81, 255, 0.12);
        color: var(--primary-600);
        font-size: 1.35rem;
        transition: transform var(--transition), box-shadow var(--transition);
      }

      .premium-bottom-nav button.nav-item--highlight .nav-label {
        font-size: 0.78rem;
        font-weight: 700;
        letter-spacing: 0.01em;
        color: inherit;
      }

      .premium-bottom-nav button.nav-item--highlight:hover,
      .premium-bottom-nav button.nav-item--highlight:focus-visible {
        background: none;
        color: var(--primary-600);
      }

      .premium-bottom-nav button.nav-item--highlight:hover .nav-icon,
      .premium-bottom-nav button.nav-item--highlight:focus-visible .nav-icon {
        transform: translate(-50%, calc(-50% - 2px)) scale(1.04);
        box-shadow: 0 26px 48px -26px rgba(15, 23, 42, 0.8), 0 8px 20px -12px rgba(76, 81, 255, 0.55);
      }

      @media (max-width: 640px) {
        .premium-bottom-nav {
          bottom: max(env(safe-area-inset-bottom, 0px), 0px);
          padding: 0 clamp(0.75rem, 4vw, 1.4rem) 0;
        }

        .premium-bottom-nav__card {
          gap: 0.2rem;
          border-radius: 18px;
          padding: 0.08rem 0.4rem calc(0.45rem + env(safe-area-inset-bottom, 0px));
          min-height: 66px;
        }

        .premium-bottom-nav button {
          font-size: 0.7rem;
          gap: 0.22rem;
          padding: 0.4rem 0.25rem 0.5rem;
        }

        .premium-bottom-nav button .nav-icon {
          width: 28px;
          height: 28px;
          font-size: 1.1rem;
        }

        .premium-bottom-nav button.nav-item--highlight {
          --highlight-size: 58px;
          gap: 0.3rem;
          min-width: calc(var(--highlight-size) + 10px);
          padding: calc(var(--highlight-size) / 2 + 0.3rem) 0.25rem 0.5rem;
        }

        .premium-bottom-nav button.nav-item--highlight .nav-icon {
          font-size: 1.28rem;
        }

        .section-header {
          flex-direction: column;
          align-items: flex-start;
        }

        .section-title {
          width: 100%;
        }

        .section-icon {
          width: 48px;
          height: 48px;
          border-radius: 16px;
        }
      }

      dialog {
        width: 100vw;
        max-width: 100vw;
        height: 100vh;
        margin: 0;
        border: none;
        padding: 0;
        background: transparent;
        display: grid;
        place-items: center;
        position: fixed;
        inset: 0;
        z-index: 40;
        opacity: 0;
        transform: translateY(24px) scale(0.98);
        transition: opacity 280ms ease, transform 320ms cubic-bezier(0.23, 1, 0.32, 1);
        pointer-events: none;
      }

      dialog[open] {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
      }

      dialog.fallback-open {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
      }

      dialog[data-closing] {
        opacity: 0;
        transform: translateY(24px) scale(0.98);
      }

      dialog::backdrop {
        background: rgba(9, 16, 36, 0.68);
        backdrop-filter: blur(18px) saturate(145%);
      }

      dialog.fallback-open::before {
        content: "";
        position: fixed;
        inset: 0;
        background: rgba(9, 16, 36, 0.68);
        backdrop-filter: blur(18px) saturate(145%);
        z-index: -1;
      }

      body.modal-open {
        overflow: hidden;
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(9, 16, 36, 0.68);
        backdrop-filter: blur(18px) saturate(145%);
        z-index: 30;
        opacity: 0;
        pointer-events: none;
        transition: opacity 280ms ease;
      }

      .modal-backdrop.show {
        opacity: 1;
        pointer-events: auto;
      }

      .modal-surface {
        width: min(1080px, 94vw);
        height: min(900px, 92vh);
        background: #ffffff;
        border-radius: clamp(18px, 3vw, 34px);
        box-shadow: 0 35px 80px -60px rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(15, 23, 42, 0.08);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
      }

      .modal-surface--compact {
        width: min(640px, 94vw);
        height: auto;
        max-height: min(760px, 90vh);
      }

      .modal-surface--edge-to-edge {
        width: min(1200px, 98vw);
        height: min(960px, 96vh);
        border-radius: clamp(16px, 3vw, 28px);
      }

      @media (max-width: 960px) {
        .category-board {
          margin-top: 1.2rem;
        }
        .filters-sheet {
          width: 100vw;
          height: 100vh;
          border-radius: 0;
        }
        .filters-form {
          padding-inline: clamp(1.1rem, 4vw, 1.6rem);
        }
        .filters-form-footer {
          flex-direction: column;
          align-items: stretch;
        }
        .filters-footer-actions {
          width: 100%;
          flex-direction: column;
          gap: 0.65rem;
        }
        .filters-form-footer .btn {
          width: 100%;
        }
        .modal-surface {
          width: 100vw;
          height: 100vh;
          border-radius: 0;
        }
        .modal-surface--compact {
          width: min(94vw, 520px);
          max-height: 92vh;
          border-radius: clamp(18px, 5vw, 26px);
          height: auto;
        }
        .modal-surface--edge-to-edge {
          width: 100vw;
          height: 100vh;
          border-radius: 0;
        }
      }

      .modal-toolbar {
        padding: clamp(1.2rem, 3vw, 1.8rem) clamp(1.5rem, 4vw, 2.4rem);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        background: #ffffff;
        border-bottom: 1px solid rgba(15, 23, 42, 0.06);
      }

      .modal-toolbar--with-nav {
        position: relative;
      }

      .modal-title-block {
        display: grid;
        gap: 0.35rem;
      }

      .modal-eyebrow {
        font-size: 0.76rem;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: rgba(15, 23, 42, 0.54);
        font-weight: 700;
        margin: 0;
      }

      .modal-title {
        font-size: clamp(1.35rem, 2.4vw, 1.7rem);
        margin: 0;
        font-weight: 700;
        color: var(--muted-dark);
      }

      .modal-title-subtitle {
        margin: 0;
        font-size: 0.95rem;
        color: rgba(15, 23, 42, 0.68);
        max-width: 520px;
      }

      .modal-body {
        flex: 1;
        padding: clamp(1.4rem, 3.5vw, 2.4rem) clamp(1.4rem, 4vw, 2.8rem) clamp(1.8rem, 4vw, 2.6rem);
        overflow-y: auto;
        display: grid;
        gap: clamp(1.6rem, 3vw, 2.4rem);
        background: #ffffff;
      }

      .modal-close {
        border: none;
        background: rgba(255, 255, 255, 0.6);
        border-radius: 18px;
        width: 46px;
        height: 46px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--muted-dark);
        font-size: 1.1rem;
        box-shadow: 0 10px 30px -14px rgba(15, 23, 42, 0.45);
        transition: background var(--transition), transform var(--transition), box-shadow var(--transition);
      }

      .modal-close:hover {
        background: rgba(255, 255, 255, 0.9);
        transform: translateY(-1px);
      }

      .modal-back {
        border: none;
        background: rgba(15, 23, 42, 0.08);
        border-radius: 16px;
        width: 42px;
        height: 42px;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        color: var(--muted-dark);
        font-size: 1rem;
        box-shadow: 0 12px 28px -18px rgba(15, 23, 42, 0.4);
        transition: background var(--transition), transform var(--transition), box-shadow var(--transition);
      }

      .modal-back:hover {
        background: rgba(15, 23, 42, 0.12);
        transform: translateY(-1px);
      }

      .modal-section {
        border-radius: var(--radius-lg);
        background: transparent;
        border: 1px solid rgba(15, 23, 42, 0.08);
        box-shadow: none;
        padding: clamp(1.2rem, 3vw, 1.8rem);
        display: grid;
        gap: clamp(1rem, 2.5vw, 1.5rem);
      }

      .modal-body--selector {
        gap: clamp(1.2rem, 3vw, 1.8rem);
      }

      @media (max-width: 640px) {
        .modal-toolbar {
          padding: 0.85rem 1.05rem;
        }

        .modal-toolbar--with-nav {
          display: grid;
          grid-template-columns: auto minmax(0, 1fr) auto;
          align-items: center;
          gap: 0.75rem;
        }

        .modal-toolbar--with-nav .modal-back {
          display: inline-flex;
        }

        .modal-toolbar--with-nav .modal-close {
          width: 40px;
          height: 40px;
          border-radius: 14px;
          font-size: 1rem;
        }

        .modal-toolbar--with-nav .modal-back {
          width: 40px;
          height: 40px;
          border-radius: 14px;
        }

        .modal-toolbar--with-nav .modal-title-block {
          justify-self: center;
          text-align: center;
          justify-items: center;
        }

        .modal-toolbar--with-nav .modal-title-subtitle {
          font-size: 0.88rem;
        }
      }

      .sell-selector-intro {
        display: grid;
        gap: 0.35rem;
        text-align: center;
      }

      .sell-selector-intro p {
        margin: 0;
        color: rgba(15, 23, 42, 0.65);
        font-size: 0.95rem;
      }

      .sell-selector-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: clamp(0.85rem, 2.5vw, 1.4rem);
      }

      .sell-option-card {
        border: 1px solid rgba(15, 23, 42, 0.1);
        border-radius: clamp(18px, 3vw, 28px);
        background: #f8fafc;
        padding: clamp(1.1rem, 3vw, 1.5rem);
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        gap: clamp(0.85rem, 3vw, 1.1rem);
        cursor: pointer;
        transition: border-color var(--transition), box-shadow var(--transition), transform var(--transition),
          background var(--transition);
      }

      .sell-option-card__icon {
        width: 52px;
        height: 52px;
        border-radius: 16px;
        display: grid;
        place-items: center;
        background: #ffffff;
        color: #0f172a;
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.06);
        font-size: 1.4rem;
      }

      .sell-option-card__content {
        display: grid;
        gap: 0.25rem;
      }

      .sell-option-card strong {
        font-size: 1.05rem;
        color: #0b0f19;
      }

      .sell-option-card span {
        font-size: 0.9rem;
        color: rgba(15, 23, 42, 0.6);
      }

      .sell-option-card__chevron {
        font-size: 1rem;
        color: rgba(15, 23, 42, 0.35);
      }

      .sell-option-card:hover,
      .sell-option-card:focus-visible {
        transform: translateY(-2px);
        background: #ffffff;
        border-color: rgba(76, 81, 255, 0.25);
        box-shadow: 0 24px 45px -32px rgba(15, 23, 42, 0.25);
        outline: none;
      }

      .sell-option-card.is-active {
        border-color: rgba(76, 81, 255, 0.4);
        background: #ffffff;
        box-shadow: inset 0 0 0 1px rgba(76, 81, 255, 0.18), 0 28px 65px -40px rgba(76, 81, 255, 0.35);
      }

      .sell-option-card.is-active .sell-option-card__icon {
        color: var(--primary-600);
        box-shadow: inset 0 0 0 1px rgba(76, 81, 255, 0.25);
      }

      .sell-form {
        display: grid;
        gap: clamp(1.6rem, 3.2vw, 2.3rem);
      }

      .sell-form__intro {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: clamp(1rem, 2.4vw, 1.6rem);
        padding-bottom: clamp(0.9rem, 2vw, 1.3rem);
        border-bottom: 1px solid rgba(15, 23, 42, 0.08);
      }

      .sell-form__intro-copy {
        display: grid;
        gap: 0.35rem;
      }

      .sell-form__intro-copy h4 {
        margin: 0;
        font-size: 1.08rem;
        color: var(--muted-dark);
      }

      .sell-form__intro-copy p {
        margin: 0;
        color: rgba(15, 23, 42, 0.62);
        font-size: 0.92rem;
        max-width: 50ch;
      }

      .sell-form__pill {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        padding: 0.5rem 0.9rem;
        border-radius: 999px;
        background: #f8fafc;
        color: var(--primary-700);
        font-weight: 600;
        font-size: 0.78rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
      }

      .sell-form__grid {
        display: grid;
        gap: clamp(1.4rem, 3vw, 2rem);
      }

      .sell-form__section {
        display: grid;
        gap: clamp(1rem, 2.4vw, 1.5rem);
      }

      .sell-form__section-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 1rem;
      }

      .sell-form__section-title {
        margin: 0;
        font-size: 1rem;
        font-weight: 700;
        color: var(--muted-dark);
      }

      .sell-form__section-subtitle {
        margin: 0.2rem 0 0;
        color: rgba(15, 23, 42, 0.6);
        font-size: 0.9rem;
      }

      .sell-form__counter {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.35rem 0.8rem;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.06);
        color: var(--muted-dark);
        font-size: 0.78rem;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .sell-form__footer {
        display: flex;
        justify-content: flex-end;
      }

      .sell-form .modal-actions {
        margin-top: clamp(0.4rem, 1.6vw, 0.8rem);
      }

      .sell-form .modal-actions .btn {
        min-width: 160px;
      }

      .sell-form .form-grid.two-column {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .sell-form .toggle-field {
        padding: clamp(0.8rem, 2vw, 1rem);
        border: 1px dashed rgba(15, 23, 42, 0.1);
        border-radius: var(--radius-md);
        background: #f8fafc;
      }

      .sell-form .toggle-field-copy span {
        font-weight: 600;
      }

      .sell-form .toggle-field-copy small {
        color: rgba(15, 23, 42, 0.55);
        font-size: 0.82rem;
      }

      .auth-form {
        display: grid;
        gap: clamp(1.4rem, 3vw, 2rem);
      }

      .auth-form__lead {
        margin: 0;
        color: rgba(15, 23, 42, 0.65);
        font-size: 0.95rem;
        max-width: 52ch;
      }

      .auth-form .profile-field > span {
        letter-spacing: 0.08em;
      }

      .auth-form .profile-photo-control {
        align-items: flex-start;
      }

      .auth-form .profile-avatar {
        background: #e2e8f0;
        border: 2px solid rgba(15, 23, 42, 0.08);
        box-shadow: none;
        color: #475569;
      }

      .auth-form__terms {
        padding: clamp(0.8rem, 2vw, 1rem);
        border: 1px solid rgba(15, 23, 42, 0.08);
        border-radius: var(--radius-md);
        background: #f8fafc;
      }

      .auth-form__actions {
        justify-content: flex-end;
        gap: 0.75rem;
      }

      .modal-section-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 1rem;
      }

      .modal-section-title {
        margin: 0;
        font-size: 1.05rem;
        font-weight: 700;
        color: var(--muted-dark);
      }

      .modal-section-subtitle {
        margin: 0.15rem 0 0;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .modal-chip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.35rem 0.85rem;
        background: #f8fafc;
        color: var(--primary-700);
        border-radius: 999px;
        font-size: 0.78rem;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .form-grid {
        display: grid;
        gap: clamp(1rem, 2.4vw, 1.5rem);
      }

      .form-grid.two-column {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .form-row {
        display: grid;
        gap: 0.6rem;
      }

      .field {
        display: grid;
        gap: 0.45rem;
      }

      .field > span {
        font-size: 0.82rem;
        font-weight: 600;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: rgba(15, 23, 42, 0.62);
      }

      .field small {
        color: var(--muted);
        font-size: 0.78rem;
      }

      .checkbox-field {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        font-size: 0.9rem;
        color: var(--muted-dark);
      }

      .checkbox-field input[type="checkbox"] {
        margin-top: 0.2rem;
        width: 18px;
        height: 18px;
      }

      .toggle-field {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .toggle-field-copy {
        display: grid;
        gap: 0.25rem;
      }

      .toggle-field-copy span {
        font-size: 0.92rem;
        font-weight: 600;
        color: var(--muted-dark);
        letter-spacing: 0.02em;
      }

      .toggle-field-copy small {
        font-size: 0.82rem;
        color: var(--muted);
      }

      .toggle {
        position: relative;
        width: 56px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .toggle input {
        opacity: 0;
        position: absolute;
        inset: 0;
        cursor: pointer;
        margin: 0;
      }

      .toggle-track {
        width: 100%;
        height: 100%;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.18);
        position: relative;
        transition: background var(--transition), box-shadow var(--transition);
      }

      .toggle-track::after {
        content: "";
        position: absolute;
        top: 4px;
        left: 4px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #fff;
        box-shadow: 0 8px 16px -8px rgba(15, 23, 42, 0.55);
        transition: transform var(--transition), background var(--transition);
      }

      .toggle input:checked + .toggle-track {
        background: var(--primary-600);
        box-shadow: 0 18px 30px -18px rgba(76, 81, 255, 0.6);
      }

      .toggle input:checked + .toggle-track::after {
        transform: translateX(24px);
        background: #fff;
      }

      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.85rem;
        flex-wrap: wrap;
        margin-top: auto;
        padding-top: 0.35rem;
      }

      .modal-actions .btn {
        min-width: 160px;
      }

      .image-preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 1rem;
      }

      .image-preview {
        border-radius: var(--radius-lg);
        overflow: hidden;
        border: 1px solid rgba(148, 163, 184, 0.28);
        aspect-ratio: 1;
        position: relative;
        background: rgba(248, 250, 255, 0.9);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.35);
      }

      .image-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .media-upload {
        display: grid;
        gap: clamp(1rem, 3vw, 1.6rem);
      }

      .media-dropzone {
        border-radius: var(--radius-lg);
        border: 1.6px dashed rgba(76, 81, 255, 0.35);
        background: #fff;
        padding: clamp(1.6rem, 4vw, 2.6rem);
        text-align: center;
        display: grid;
        gap: 0.65rem;
        justify-items: center;
        cursor: pointer;
        transition: border-color var(--transition), box-shadow var(--transition), transform var(--transition);
      }

      .media-dropzone:hover {
        border-color: rgba(76, 81, 255, 0.55);
        box-shadow: 0 25px 50px -30px rgba(76, 81, 255, 0.55);
        transform: translateY(-2px);
      }

      .media-dropzone i {
        font-size: 1.6rem;
        width: 56px;
        height: 56px;
        border-radius: 18px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: white;
        background: var(--primary-600);
        box-shadow: 0 18px 30px -18px rgba(76, 81, 255, 0.7);
      }

      .media-dropzone strong {
        font-size: 1.05rem;
        color: var(--muted-dark);
      }

      .media-dropzone span {
        color: var(--muted);
        font-size: 0.9rem;
        max-width: 320px;
      }

      .media-upload input[type="file"] {
        display: none;
      }

      @media (max-width: 720px) {
        .modal-toolbar {
          flex-wrap: wrap;
          justify-content: flex-start;
        }

        .modal-actions {
          justify-content: stretch;
        }

        .modal-actions .btn {
          flex: 1 1 100%;
        }
      }

      .difference-badge {
        border-radius: var(--radius-md);
        padding: 0.75rem 1rem;
        background: #f8fafc;
        border: 1px solid rgba(148, 163, 184, 0.3);
        display: grid;
        gap: 0.35rem;
      }

      .difference-badge strong {
        font-size: 1.05rem;
      }

      .offer-items {
        display: grid;
        gap: 0.6rem;
        max-height: 220px;
        overflow-y: auto;
      }

      .offer-item {
        border-radius: var(--radius-md);
        border: 1px solid rgba(148, 163, 184, 0.3);
        padding: 0.65rem 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: white;
      }

      .offer-item input {
        width: 18px;
        height: 18px;
      }

      .offer-item span {
        font-weight: 600;
      }

      .offer-item small {
        color: var(--muted);
      }

      .tag {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.3rem 0.75rem;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.08);
        color: var(--muted-dark);
        font-weight: 600;
        font-size: 0.78rem;
      }

      .timeline {
        display: grid;
        gap: 1rem;
      }

      .timeline-step {
        display: grid;
        gap: 0.35rem;
        padding: 0.85rem 1rem;
        border-radius: var(--radius-md);
        border: 1px solid rgba(148, 163, 184, 0.25);
        background: rgba(255, 255, 255, 0.9);
      }

      .negotiation-options {
        display: grid;
        gap: 0.75rem;
      }

      .review-list {
        display: grid;
        gap: 1rem;
      }

      .review-card {
        background: var(--surface-strong);
        border-radius: var(--radius-lg);
        padding: 1.1rem;
        border: 1px solid var(--border);
        display: grid;
        gap: 0.4rem;
      }

      .highlight {
        color: var(--primary-600);
        font-weight: 600;
      }

      .danger {
        color: var(--danger);
      }

      .success {
        color: var(--success);
      }

      .hidden {
        display: none !important;
      }

      [data-page-group].page-hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-shell">
        <div class="header-top">
          <div class="brand" aria-label="Cambalaches">
            <div class="brand-mark" aria-hidden="true">CB</div>
            <div class="brand-info">
              <h1>Cambalaches</h1>
              <span>Marketplace premium de canjes en COP</span>
            </div>
          </div>
          <div class="header-search-area">
            <form class="header-search" id="header-search" role="search">
              <input
                type="search"
                id="header-search-input"
                placeholder="ð Buscar productos"
                aria-label="Explorar artÃ­culos del marketplace"
              />
            </form>
            <button class="header-notification" type="button" aria-label="Ver notificaciones">
              <i class="fa-regular fa-bell" aria-hidden="true"></i>
            </button>
          </div>
          <div class="header-actions">
            <button
              class="sidebar-toggle"
              id="sidebar-toggle"
              type="button"
              aria-expanded="false"
              aria-controls="app-sidebar"
            >
              <span class="visually-hidden">Abrir menÃº de navegaciÃ³n</span>
              <i class="fa-solid fa-bars" aria-hidden="true"></i>
            </button>
            <div class="header-cta">
              <button class="btn btn-outline" id="open-auth">Ingresar</button>
              <button class="btn btn-primary" id="quick-publish">Publicar producto</button>
              <div class="avatar-thumb hidden" id="nav-avatar"></div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <section class="promo-banners" aria-label="Banners publicitarios destacados">
      <div class="promo-banners__shell">
        <div class="promo-banner-modal" id="promo-banner-modal" aria-hidden="true">
          <div class="promo-banner-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="promo-banner-modal-title">
            <div class="promo-banner-modal__header">
              <div>
                <h3 class="promo-banner-modal__title" id="promo-banner-modal-title">Nuevo banner publicitario</h3>
                <p class="promo-banner-modal__description">
                  Personaliza la campaÃ±a con imagen, mensaje clave y define la vigencia para mantener tu vitrina siempre actualizada.
                </p>
              </div>
              <button class="promo-banner-modal__close" type="button" id="promo-banner-close" aria-label="Cerrar">
                <i class="fa-solid fa-xmark" aria-hidden="true"></i>
              </button>
            </div>
            <form class="promo-banner-modal__form" id="promo-banner-form">
              <div class="promo-banner-field">
                <label for="promo-banner-title">TÃ­tulo de la campaÃ±a</label>
                <input id="promo-banner-title" name="title" type="text" maxlength="120" placeholder="Lanza tu mejor beneficio" required />
              </div>
              <div class="promo-banner-field">
                <label for="promo-banner-description">DescripciÃ³n breve</label>
                <textarea
                  id="promo-banner-description"
                  name="description"
                  maxlength="220"
                  placeholder="Explica el valor diferenciador de tu promociÃ³n"
                  required
                ></textarea>
              </div>
              <div class="promo-banner-field">
                <label for="promo-banner-label">Etiqueta destacada</label>
                <input
                  id="promo-banner-label"
                  name="label"
                  type="text"
                  maxlength="60"
                  placeholder="Aliado destacado, Publicidad, Lanzamiento, etc."
                />
              </div>
              <div class="promo-banner-field">
                <label for="promo-banner-cta">Texto del botÃ³n</label>
                <input id="promo-banner-cta" name="ctaLabel" type="text" maxlength="35" placeholder="Ver beneficios" />
              </div>
              <div class="promo-banner-field">
                <label for="promo-banner-link">Enlace del botÃ³n (opcional)</label>
                <input
                  id="promo-banner-link"
                  name="ctaLink"
                  type="url"
                  placeholder="https://tusitio.com/promocion"
                  inputmode="url"
                />
              </div>
              <div class="promo-banner-field-group">
                <div class="promo-banner-field">
                  <label for="promo-banner-text-color">Color del texto</label>
                  <input id="promo-banner-text-color" name="textColor" type="color" value="#f8fafc" />
                  <small>Aplica a titulares, descripciÃ³n y temporizador.</small>
                </div>
                <div class="promo-banner-field">
                  <label for="promo-banner-button-color">Color del botÃ³n</label>
                  <input id="promo-banner-button-color" name="buttonColor" type="color" value="#4338ca" />
                  <small>Define el fondo del botÃ³n de llamada a la acciÃ³n.</small>
                </div>
              </div>
              <div class="promo-banner-field">
                <label for="promo-banner-expires">Vigencia de la promociÃ³n</label>
                <input id="promo-banner-expires" name="expiresAt" type="datetime-local" required />
                <p class="promo-banner-modal__timer-hint">El temporizador mostrarÃ¡ el tiempo restante hasta la fecha seleccionada.</p>
              </div>
              <div class="promo-banner-field">
                <label for="promo-banner-image">Imagen promocional</label>
                <input id="promo-banner-image" name="image" type="file" accept="image/*" required />
                <div class="promo-banner-modal__preview" id="promo-banner-image-preview">
                  <div class="promo-banner-modal__preview-placeholder">
                    <i class="fa-regular fa-image" aria-hidden="true"></i>
                    <span>Selecciona una imagen horizontal en alta resoluciÃ³n (JPG o PNG).</span>
                  </div>
                </div>
              </div>
              <div class="promo-banner-modal__footer">
                <button class="btn btn-ghost" type="button" id="promo-banner-cancel">Cancelar</button>
                <button class="btn btn-primary" type="submit">Guardar banner</button>
              </div>
            </form>
          </div>
        </div>
        <div class="promo-banners__empty hidden" id="promo-banners-empty">
          No hay campaÃ±as activas. Toca el Ã­cono Â«+Â» para destacar una nueva alianza.
        </div>
        <div class="promo-banners__list" id="promo-banners-list" role="list" aria-live="polite"></div>
      </div>
    </section>

    <main>
      <div class="app-shell">
        <aside class="app-sidebar" id="app-sidebar" aria-label="NavegaciÃ³n principal">
          <div class="app-sidebar__header">
            <div class="app-sidebar__profile">
              <div class="app-sidebar__profile-avatar" id="sidebar-user-avatar">
                <i class="fa-regular fa-user" aria-hidden="true"></i>
              </div>
              <div>
                <strong id="sidebar-user-name">Invitado</strong>
                <span id="sidebar-user-meta">Crea tu perfil para comenzar a intercambiar.</span>
              </div>
            </div>
          </div>
          <nav class="app-sidebar__nav" aria-label="Secciones del panel">
            <span class="app-sidebar__nav-label">NavegaciÃ³n principal</span>
            <button type="button" id="open-sell" data-role="sell">
              <span class="nav-icon"><i class="fa-solid fa-store" aria-hidden="true"></i></span>
              <span>Vender</span>
            </button>
            <button type="button" data-target="feed-section" data-nav="primary">
              <span class="nav-icon"><i class="fa-solid fa-house" aria-hidden="true"></i></span>
              <span>Explorar</span>
            </button>
            <button type="button" data-target="coupons" data-nav="primary">
              <span class="nav-icon"><i class="fa-solid fa-ticket" aria-hidden="true"></i></span>
              <span>Cupones</span>
            </button>
            <button type="button" data-target="my-items" data-nav="primary">
              <span class="nav-icon"><i class="fa-solid fa-layer-group" aria-hidden="true"></i></span>
              <span>Mis artÃ­culos</span>
            </button>
            <button type="button" data-target="active-exchanges" data-nav="primary">
              <span class="nav-icon"><i class="fa-solid fa-right-left" aria-hidden="true"></i></span>
              <span>Canjes activos</span>
            </button>
            <button type="button" data-target="history" data-nav="primary">
              <span class="nav-icon"><i class="fa-solid fa-clock-rotate-left" aria-hidden="true"></i></span>
              <span>Historial</span>
            </button>
            <button type="button" data-target="reputation" data-nav="primary">
              <span class="nav-icon"><i class="fa-solid fa-gem" aria-hidden="true"></i></span>
              <span>ReputaciÃ³n</span>
            </button>
            <button type="button" data-target="support" data-nav="primary">
              <span class="nav-icon"><i class="fa-solid fa-shield-halved" aria-hidden="true"></i></span>
              <span>Soporte</span>
            </button>
            <button type="button" data-target="profile" data-nav="primary">
              <span class="nav-icon"><i class="fa-solid fa-user" aria-hidden="true"></i></span>
              <span>Perfil</span>
            </button>
          </nav>
        </aside>
        <div class="dashboard-grid">
          <section class="panel" id="feed-section" data-page-group="feed-section">
            <input type="hidden" id="filter-category" value="" />
            <input type="hidden" id="filter-keyword" />
            <input type="hidden" id="filter-style" value="marketplace" />
            <div class="category-board">
              <div class="category-board-header">
                <div class="category-board-title">
                  <span>CategorÃ­as premium</span>
                  <h4>Selecciona la experiencia que buscas</h4>
                </div>
                <div class="category-board-actions">
                  <button class="category-filters" type="button" id="filters-inline">
                    <i class="fa-solid fa-sliders" aria-hidden="true"></i>
                    <span>Filtros avanzados</span>
                  </button>
                </div>
              </div>
              <div class="category-list" role="list">
                <button class="category-card active" type="button" data-category="">
                  <span class="category-icon"><i class="fa-solid fa-shapes" aria-hidden="true"></i></span>
                  <span class="category-label">Todo</span>
                </button>
                <button class="category-card" type="button" data-category="tecnologia">
                  <span class="category-icon"><i class="fa-solid fa-laptop-code" aria-hidden="true"></i></span>
                  <span class="category-label">TecnologÃ­a</span>
                </button>
                <button class="category-card" type="button" data-category="agricultura">
                  <span class="category-icon"><i class="fa-solid fa-seedling" aria-hidden="true"></i></span>
                  <span class="category-label">Agricultura</span>
                </button>
                <button class="category-card" type="button" data-category="servicios">
                  <span class="category-icon"><i class="fa-solid fa-briefcase" aria-hidden="true"></i></span>
                  <span class="category-label">Servicios</span>
                </button>
                <button class="category-card" type="button" data-category="vehiculos">
                  <span class="category-icon"><i class="fa-solid fa-car-side" aria-hidden="true"></i></span>
                  <span class="category-label">VehÃ­culos</span>
                </button>
                <button class="category-card" type="button" data-category="hogar">
                  <span class="category-icon"><i class="fa-solid fa-couch" aria-hidden="true"></i></span>
                  <span class="category-label">Hogar</span>
                </button>
                <button class="category-card" type="button" data-category="moda">
                  <span class="category-icon"><i class="fa-solid fa-shirt" aria-hidden="true"></i></span>
                  <span class="category-label">Moda</span>
                </button>
                <button class="category-card" type="button" data-category="coleccionables">
                  <span class="category-icon"><i class="fa-solid fa-chess-queen" aria-hidden="true"></i></span>
                  <span class="category-label">Coleccionables</span>
                </button>
              </div>
            </div>
            <div class="category-board most-viewed-board">
              <div class="category-board-header">
                <div class="category-board-title">
                  <span>Los mÃ¡s vistos</span>
                  <h4>ArtÃ­culos que cautivan al marketplace</h4>
                </div>
                <div class="category-board-actions">
                  <button class="category-filters" type="button" id="most-viewed-explore">
                    <i class="fa-solid fa-arrow-trend-up" aria-hidden="true"></i>
                    <span>Ver todos</span>
                  </button>
                </div>
              </div>
              <div class="most-viewed-list" id="most-viewed-list" role="list"></div>
            </div>
            <div class="card-grid mode-marketplace" id="feed-grid"></div>
            <div class="filters-overlay" id="filters-overlay" aria-hidden="true">
              <div class="filters-sheet" role="dialog" aria-modal="true" aria-labelledby="filters-title">
                <aside class="filters-panel">
                  <div class="filters-panel-inner">
                    <span class="filters-panel-eyebrow">BÃºsqueda guiada</span>
                    <h2>Configura tu experiencia ideal</h2>
                    <p>
                      Ajusta los parÃ¡metros clave de tu marketplace y obtÃ©n resultados alineados a la inversiÃ³n,
                      ubicaciÃ³n y estilo de vitrina que prefieres.
                    </p>
                    <ul class="filters-panel-list">
                      <li>
                        <i class="fa-solid fa-location-dot" aria-hidden="true"></i>
                        <span>Prioriza canjes cercanos o estratÃ©gicos</span>
                      </li>
                      <li>
                        <i class="fa-solid fa-wand-magic-sparkles" aria-hidden="true"></i>
                        <span>Combina estilos de vitrina en segundos</span>
                      </li>
                      <li>
                        <i class="fa-solid fa-coins" aria-hidden="true"></i>
                        <span>Controla los rangos de inversiÃ³n con precisiÃ³n</span>
                      </li>
                    </ul>
                  </div>
                </aside>
                <div class="filters-content">
                  <div class="filters-sheet-header">
                    <div class="title-block">
                      <span>Filtrado avanzado</span>
                      <h3 id="filters-title">Personaliza tu exploraciÃ³n</h3>
                    </div>
                    <button class="filters-close" type="button" id="filters-close" aria-label="Cerrar filtros">
                      <i class="fa-solid fa-xmark"></i>
                    </button>
                  </div>
                  <form class="filters-form" id="filters-form">
                    <div class="filters-grid">
                      <label class="field">
                        <span>UbicaciÃ³n preferida</span>
                        <input
                          type="search"
                          id="filter-location"
                          placeholder="Ciudad o regiÃ³n"
                          autocomplete="off"
                        />
                      </label>
                      <div class="field price-range-field" role="group" aria-labelledby="price-range-label">
                        <div class="field-heading">
                          <span id="price-range-label">Rango de inversiÃ³n</span>
                          <small>Desliza las perillas para definir el mÃ­nimo y mÃ¡ximo deseado.</small>
                        </div>
                        <div class="price-slider" id="price-slider">
                          <input
                            type="range"
                            id="filter-min"
                            class="price-range-input"
                            data-handle="min"
                            min="0"
                            max="20000000"
                            step="50000"
                            value="0"
                            aria-label="Precio mÃ­nimo"
                          />
                          <input
                            type="range"
                            id="filter-max"
                            class="price-range-input"
                            data-handle="max"
                            min="0"
                            max="20000000"
                            step="50000"
                            value="20000000"
                            aria-label="Precio mÃ¡ximo"
                          />
                        </div>
                      <div class="price-values" aria-live="polite">
                        <span><strong>MÃ­n.</strong> <span id="filter-min-display"></span></span>
                        <span><strong>MÃ¡x.</strong> <span id="filter-max-display"></span></span>
                      </div>
                    </div>
                    <div class="field">
                      <span>Estilo de vitrina</span>
                      <div class="style-toggle" role="radiogroup" aria-label="Estilo de vitrina">
                        <button class="style-pill active" type="button" data-style="marketplace" aria-pressed="true">
                          <i class="fa-solid fa-people-arrows" aria-hidden="true"></i>
                          <span>Marketplace colaborativo</span>
                        </button>
                        <button class="style-pill" type="button" data-style="ecommerce" aria-pressed="false">
                          <i class="fa-solid fa-store" aria-hidden="true"></i>
                          <span>E-commerce profesional</span>
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="filters-form-footer">
                    <button class="btn btn-outline" type="button" id="filters-clear">Limpiar filtros</button>
                    <div class="filters-footer-actions">
                      <button class="btn btn-outline" type="button" id="filters-cancel">Cancelar</button>
                      <button class="btn btn-primary" type="submit">Aplicar filtros</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
            <div class="empty-state hidden" id="feed-empty">
              <h4>No encontramos resultados con los filtros seleccionados</h4>
              <p>Intenta ajustar los filtros o elimina alguno para ampliar la bÃºsqueda.</p>
            </div>
          </section>

        <section class="panel page-hidden coupon-panel" id="coupons" data-page-group="coupons">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon"><i class="fa-solid fa-ticket"></i></span>
                <div>
                  <h3>GestiÃ³n de cupones inteligentes</h3>
                  <p>Personaliza descuentos dinÃ¡micos y mantÃ©n campaÃ±as impecables para tus clientes.</p>
                </div>
              </div>
              <div class="coupon-header-actions">
                <button class="btn btn-outline" type="button" id="coupon-new">
                  <i class="fa-solid fa-plus"></i>
                  <span>Nuevo cupÃ³n</span>
                </button>
              </div>
            </div>
            <div class="coupon-management">
              <div class="coupon-management__list">
                <div class="coupon-list-header">
                  <h4>CampaÃ±as activas</h4>
                  <span class="coupon-counter-pill" id="coupon-counter">
                    <i class="fa-solid fa-circle-notch" aria-hidden="true"></i>
                    <span>0</span>
                  </span>
                </div>
                <div class="coupon-list" id="coupon-list"></div>
                <div class="coupon-empty hidden" id="coupon-empty">
                  <h5>Sin cupones por ahora</h5>
                  <p>Crea tu primer cupÃ³n para impulsar la conversiÃ³n de tus campaÃ±as.</p>
                  <button class="btn btn-primary" type="button" id="coupon-empty-create">Crear cupÃ³n</button>
                </div>
              </div>
              <div class="coupon-management__editor">
                <div class="coupon-editor-card">
                  <div>
                    <h4 id="coupon-editor-title">Crear nuevo cupÃ³n</h4>
                    <p class="coupon-editor-subtitle" id="coupon-editor-subtitle">
                      Define condiciones, personaliza la portada y sorprende a tu comunidad con beneficios Ãºnicos.
                    </p>
                  </div>
                  <div class="coupon-cover-control">
                    <div class="coupon-cover-preview" id="coupon-cover-preview">
                      <span class="coupon-preview-status" id="coupon-preview-status">
                        <i class="fa-solid fa-wand-magic-sparkles" aria-hidden="true"></i>
                        Activo
                      </span>
                      <div class="coupon-preview-discount">
                        <span>Hasta</span>
                        <strong id="coupon-preview-discount">0% OFF</strong>
                        <small id="coupon-preview-name">Nuevo cupÃ³n</small>
                      </div>
                      <div class="coupon-preview-meta" id="coupon-preview-meta">
                        <span>#CUPON</span>
                        <span>MÃ­nimo $0</span>
                      </div>
                    </div>
                    <div class="coupon-cover-actions">
                      <input type="file" id="coupon-cover" accept="image/*" class="visually-hidden" />
                      <label for="coupon-cover" class="btn btn-outline" role="button" tabindex="0">
                        <i class="fa-solid fa-image" aria-hidden="true"></i>
                        <span>Subir portada</span>
                      </label>
                      <button type="button" class="btn btn-ghost" id="coupon-cover-remove">
                        <i class="fa-solid fa-ban" aria-hidden="true"></i>
                        <span>Quitar imagen</span>
                      </button>
                    </div>
                  </div>
                  <form class="coupon-form" id="coupon-form" novalidate>
                    <div class="form-grid two-column">
                      <label class="field">
                        <span>Nombre interno</span>
                        <input type="text" id="coupon-name" name="coupon-name" required placeholder="CampaÃ±a de bienvenida" />
                      </label>
                      <label class="field">
                        <span>CÃ³digo</span>
                        <input type="text" id="coupon-code" name="coupon-code" required placeholder="CB-WELCOME" />
                        <small>Se genera de forma automÃ¡tica para el cliente.</small>
                      </label>
                    </div>
                    <div class="form-grid two-column">
                      <label class="field">
                        <span>Porcentaje de descuento</span>
                        <input
                          type="number"
                          id="coupon-discount"
                          name="coupon-discount"
                          min="1"
                          max="95"
                          step="1"
                          required
                        />
                      </label>
                      <label class="field">
                        <span>Tope mÃ­nimo de compra (COP)</span>
                        <input
                          type="number"
                          id="coupon-min-purchase"
                          name="coupon-min-purchase"
                          min="0"
                          step="1000"
                          required
                        />
                      </label>
                    </div>
                    <div class="form-grid two-column">
                      <label class="field">
                        <span>Tope mÃ¡ximo de cupones</span>
                        <input
                          type="number"
                          id="coupon-max-redemptions"
                          name="coupon-max-redemptions"
                          min="0"
                          step="1"
                        />
                        <small>Deja en blanco para ilimitado.</small>
                      </label>
                      <label class="field">
                        <span>Vigencia</span>
                        <input type="date" id="coupon-valid-until" name="coupon-valid-until" />
                        <small>Define fecha de expiraciÃ³n para automatizar la campaÃ±a.</small>
                      </label>
                    </div>
                    <div class="form-grid two-column">
                      <label class="field">
                        <span>Estado</span>
                        <select id="coupon-status" name="coupon-status" required>
                          <option value="active">Activo</option>
                          <option value="paused">Pausado</option>
                        </select>
                      </label>
                      <label class="field">
                        <span>Estilo visual</span>
                        <select id="coupon-theme" name="coupon-theme" required></select>
                      </label>
                    </div>
                    <label class="field">
                      <span>DescripciÃ³n para usuarios</span>
                      <textarea
                        id="coupon-description"
                        name="coupon-description"
                        placeholder="Describe beneficios, restricciones y tono de la campaÃ±a."
                      ></textarea>
                    </label>
                    <div class="coupon-form-actions">
                      <button type="button" class="btn btn-ghost" id="coupon-cancel">Cancelar</button>
                      <button type="submit" class="btn btn-primary" id="coupon-submit">Guardar cambios</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </section>

        <section class="panel page-hidden" id="my-items" data-page-group="my-items">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon"><i class="fa-solid fa-layer-group"></i></span>
                <div>
                  <h3>Mis artÃ­culos publicados</h3>
                  <p>Gestiona tus publicaciones, edita detalles y controla la disponibilidad.</p>
                </div>
              </div>
              <button class="btn btn-outline" id="add-product">Nuevo artÃ­culo</button>
            </div>
            <div id="my-items-list" class="list"></div>
            <div class="empty-state hidden" id="my-items-empty">
              <h4>AÃºn no has publicado artÃ­culos</h4>
              <p>Publica tus productos con mÃ­nimo 3 imÃ¡genes y sÃºmalos a tus canjes.</p>
              <button class="btn btn-primary" id="add-product-secondary">Publicar ahora</button>
            </div>
          </section>

        <section class="panel page-hidden" id="active-exchanges" data-page-group="active-exchanges">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon"><i class="fa-solid fa-arrows-rotate"></i></span>
                <div>
                  <h3>Mis canjes activos</h3>
                  <p>Revisa ofertas enviadas, contraofertas recibidas y acuerdos en entrega.</p>
                </div>
              </div>
            </div>
            <h4 style="margin-bottom: 0.6rem">Ofertas enviadas</h4>
            <div id="sent-offers" class="list"></div>
            <div class="empty-state hidden" id="sent-empty">
              <h4>No has enviado ofertas todavÃ­a</h4>
              <p>Explora el feed y ofrece varios productos en un mismo canje.</p>
            </div>
            <h4 style="margin-top: 2rem; margin-bottom: 0.6rem">Ofertas recibidas</h4>
            <div id="received-offers" class="list"></div>
            <div class="empty-state hidden" id="received-empty">
              <h4>Sin ofertas entrantes por ahora</h4>
              <p>Cuando otros usuarios oferten sobre tus artÃ­culos, aparecerÃ¡n aquÃ­.</p>
            </div>
            <h4 style="margin-top: 2rem; margin-bottom: 0.6rem">Acuerdos en curso</h4>
            <div id="active-agreements" class="list"></div>
            <div class="empty-state hidden" id="agreements-empty">
              <h4>No tienes acuerdos activos</h4>
              <p>Una vez aceptes un canje, lo verÃ¡s aquÃ­ para coordinar la entrega.</p>
            </div>
          </section>

        <section class="panel page-hidden" id="history" data-page-group="history">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon"><i class="fa-solid fa-trophy"></i></span>
                <div>
                  <h3>Historial de canjes completados</h3>
                  <p>Califica a tus contrapartes y consulta el detalle de cada intercambio.</p>
                </div>
              </div>
            </div>
            <div id="history-list" class="list"></div>
            <div class="empty-state hidden" id="history-empty">
              <h4>TodavÃ­a no has completado canjes</h4>
              <p>Cuando cierres tus acuerdos, podrÃ¡s calificarlos y consultarlos aquÃ­.</p>
            </div>
          </section>

        <section class="panel page-hidden" id="reputation" data-page-group="reputation">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon"><i class="fa-solid fa-gem"></i></span>
                <div>
                  <h3>GestiÃ³n de reputaciÃ³n y reseÃ±as</h3>
                  <p>MantÃ©n un perfil confiable con reseÃ±as verificadas por cada canje.</p>
                </div>
              </div>
            </div>
            <div class="review-list" id="review-list"></div>
            <div class="empty-state hidden" id="review-empty">
              <h4>AÃºn no tienes reseÃ±as</h4>
              <p>Completa canjes y solicita a tus contrapartes que te dejen una reseÃ±a.</p>
            </div>
          </section>

        <section class="panel page-hidden" id="support" data-page-group="support">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon"><i class="fa-solid fa-shield-halved"></i></span>
                <div>
                  <h3>Reportes y soporte</h3>
                  <p>Denuncia publicaciones falsas o incumplimientos para proteger la comunidad.</p>
                </div>
              </div>
            </div>
            <div style="display: grid; gap: 1.2rem">
              <div class="timeline">
                <div class="timeline-step">
                  <strong>Denuncias de publicaciones</strong>
                  <span id="report-count">0 reportes enviados</span>
                  <p style="margin: 0; color: var(--muted); font-size: 0.92rem">
                    Cada reporte es analizado en menos de 24h por nuestro equipo de confianza.
                  </p>
                </div>
                <div class="timeline-step">
                  <strong>PolÃ­tica de protecciÃ³n</strong>
                  <p style="margin: 0; color: var(--muted); font-size: 0.92rem">
                    Documentamos el historial de cada usuario y desactivamos cuentas con
                    incumplimientos repetidos.
                  </p>
                </div>
              </div>
              <button class="btn btn-outline" id="open-report">Denunciar una publicaciÃ³n</button>
            </div>
        </section>

        <section class="panel page-hidden profile-panel" id="profile" data-page-group="profile">
          <div class="profile-container">
            <div class="profile-layout">
              <div class="profile-hero">
                <div class="profile-hero__icon" aria-hidden="true">
                  <i class="fa-solid fa-user-shield"></i>
                </div>
                <div>
                  <h3>Perfil verificado de Cambalaches</h3>
                  <p>Controla la informaciÃ³n que compartes con la comunidad y gestiona tu cuenta.</p>
                </div>
              </div>
              <div class="profile-stage profile-stage--form" id="profile-form-card">
                <div class="profile-stage__header">
                  <h4 class="profile-stage__title" id="profile-form-heading">Crea tu perfil verificado</h4>
                  <p class="profile-stage__helper" id="profile-form-helper">
                    Completa la informaciÃ³n para operar con la comunidad Cambalaches.
                  </p>
                </div>
                <form id="profile-form" class="profile-form" novalidate>
                  <div class="profile-grid" data-columns="two">
                    <label class="profile-field">
                      <span>Nombre completo</span>
                      <input type="text" id="profile-name" name="profile-name" placeholder="Tu nombre" required />
                    </label>
                    <label class="profile-field">
                      <span>Correo electrÃ³nico</span>
                      <input type="email" id="profile-email" name="profile-email" placeholder="nombre@correo.com" required />
                    </label>
                    <label class="profile-field">
                      <span>TelÃ©fono verificado</span>
                      <input type="tel" id="profile-phone" name="profile-phone" placeholder="300 000 0000" required />
                    </label>
                    <label class="profile-field">
                      <span>Departamento</span>
                      <select id="profile-department" name="profile-department" required>
                        <option value="" disabled selected>Selecciona un departamento</option>
                      </select>
                    </label>
                    <label class="profile-field">
                      <span>Municipio</span>
                      <select id="profile-city" name="profile-city" required disabled>
                        <option value="" disabled selected>Selecciona un municipio</option>
                      </select>
                    </label>
                  </div>
                  <label class="profile-field profile-field--full">
                    <span>BiografÃ­a corta</span>
                    <textarea
                      id="profile-bio"
                      name="profile-bio"
                      rows="4"
                      placeholder="Describe tu experiencia intercambiando y quÃ© ofreces a la comunidad"
                    ></textarea>
                  </label>
                  <div class="profile-field profile-field--full">
                    <span>Foto de perfil</span>
                    <div class="profile-photo-control">
                      <div class="profile-avatar" id="profile-photo-preview">
                        <i class="fa-regular fa-user" aria-hidden="true"></i>
                      </div>
                      <div class="profile-photo-actions">
                        <input
                          type="file"
                          id="profile-photo"
                          name="profile-photo"
                          accept="image/*"
                          class="visually-hidden"
                        />
                        <label class="profile-upload btn btn-outline" for="profile-photo" role="button" tabindex="0">
                          <i class="fa-solid fa-arrow-up-from-bracket" aria-hidden="true"></i>
                          <span>Elegir imagen</span>
                        </label>
                        <p class="profile-photo-hint">Formatos JPG o PNG hasta 5 MB.</p>
                      </div>
                    </div>
                  </div>
                  <div class="profile-form-actions">
                    <button type="button" class="btn btn-ghost hidden" id="profile-cancel">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="profile-submit">Crear perfil</button>
                  </div>
                </form>
              </div>
              <div class="profile-stage profile-stage--summary profile-summary hidden" id="profile-summary">
                <div class="profile-summary-header">
                  <div class="profile-avatar profile-avatar--summary" id="profile-summary-avatar">
                    <i class="fa-regular fa-user" aria-hidden="true"></i>
                  </div>
                  <div class="profile-summary-identity">
                    <h3 id="profile-summary-name">Invitado</h3>
                    <p id="profile-summary-meta">Completa tu perfil para que otros te conozcan.</p>
                  </div>
                </div>
                <dl class="profile-summary-list">
                  <div class="profile-summary-item">
                    <dt>Correo</dt>
                    <dd id="profile-summary-email">â</dd>
                  </div>
                  <div class="profile-summary-item">
                    <dt>TelÃ©fono</dt>
                    <dd id="profile-summary-phone">â</dd>
                  </div>
                  <div class="profile-summary-item">
                    <dt>UbicaciÃ³n</dt>
                    <dd id="profile-summary-location">â</dd>
                  </div>
                  <div class="profile-summary-item profile-summary-item--full">
                    <dt>BiografÃ­a</dt>
                    <dd id="profile-summary-bio">â</dd>
                  </div>
                  <div class="profile-summary-item">
                    <dt>ReputaciÃ³n base</dt>
                    <dd id="profile-summary-rating">â</dd>
                  </div>
                </dl>
                <div class="profile-summary-footer">
                  <span id="profile-summary-updated">Perfil sin verificar</span>
                  <div class="profile-summary-actions">
                    <button type="button" class="btn btn-outline" id="profile-edit">Editar perfil</button>
                    <button type="button" class="btn btn-ghost" id="profile-logout">Cerrar sesiÃ³n</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
        </div>
      </div>
    </main>
    <div class="sidebar-backdrop" id="sidebar-backdrop" aria-hidden="true"></div>

    <div class="product-detail" id="product-detail" aria-hidden="true">
      <div class="product-detail-backdrop" data-close-detail></div>
      <div class="product-detail-dialog" role="dialog" aria-modal="true" aria-labelledby="product-detail-title">
        <button class="product-detail-close" type="button" data-close-detail aria-label="Cerrar detalle del artÃ­culo">
          <i class="fa-solid fa-xmark"></i>
        </button>
        <div class="product-detail-gallery">
          <div class="product-detail-main">
            <img id="product-detail-image" src="" alt="" />
            <span class="product-detail-price" id="product-detail-price"></span>
          </div>
          <div class="product-detail-thumbs" id="product-detail-thumbs"></div>
        </div>
        <div class="product-detail-body">
          <div class="product-detail-header">
            <span class="product-detail-category" id="product-detail-category"></span>
            <span class="product-detail-rating" id="product-detail-rating"></span>
          </div>
          <h2 id="product-detail-title"></h2>
          <p class="product-detail-location" id="product-detail-location"></p>
          <div class="product-detail-tags" id="product-detail-tags"></div>
          <p class="product-detail-description" id="product-detail-description"></p>
          <div class="product-detail-owner">
            <img id="product-detail-owner-avatar" src="" alt="" />
            <div class="product-detail-owner-copy">
              <span class="owner-name" id="product-detail-owner-name"></span>
              <span class="owner-meta" id="product-detail-owner-meta"></span>
              <span class="owner-location" id="product-detail-owner-location"></span>
            </div>
          </div>
          <div class="product-detail-flow">
            <div class="flow-step">
              <span class="flow-step-icon">1</span>
              <div>
                <h3>Selecciona tus activos</h3>
                <p>Escoge artÃ­culos propios y compensaciÃ³n en COP para equilibrar el canje.</p>
              </div>
            </div>
            <div class="flow-step">
              <span class="flow-step-icon">2</span>
              <div>
                <h3>EnvÃ­a tu propuesta</h3>
                <p>Comparte condiciones y mensaje personalizado para generar confianza.</p>
              </div>
            </div>
            <div class="flow-step">
              <span class="flow-step-icon">3</span>
              <div>
                <h3>Cierra el canje</h3>
                <p>Coordina entrega y seguimiento dentro de Cambalaches sin perder el hilo.</p>
              </div>
            </div>
          </div>
          <div class="product-detail-actions">
            <button class="btn btn-primary" type="button" id="product-detail-start">Iniciar canje ahora</button>
            <button class="btn btn-outline" type="button" id="product-detail-advanced">Ver oferta avanzada</button>
            <button class="btn btn-ghost" type="button" id="product-detail-report">Reportar publicaciÃ³n</button>
          </div>
        </div>
      </div>
    </div>

    <nav class="premium-bottom-nav" aria-label="NavegaciÃ³n principal de Cambalaches">
      <div class="premium-bottom-nav__card">
        <button type="button" data-target="feed-section" data-nav="primary" class="nav-item active">
          <span class="nav-icon" aria-hidden="true"><i class="fa-solid fa-house"></i></span>
          <span class="nav-label">Explorar</span>
        </button>
        <button type="button" data-target="my-items" data-nav="primary" class="nav-item">
          <span class="nav-icon" aria-hidden="true"><i class="fa-solid fa-layer-group"></i></span>
          <span class="nav-label">Mis artÃ­culos</span>
        </button>
        <button type="button" data-target="active-exchanges" data-nav="primary" class="nav-item nav-item--highlight">
          <span class="nav-icon" aria-hidden="true"><i class="fa-solid fa-right-left"></i></span>
          <span class="nav-label">Canjes</span>
        </button>
        <button type="button" data-target="coupons" data-nav="primary" class="nav-item">
          <span class="nav-icon" aria-hidden="true"><i class="fa-solid fa-ticket"></i></span>
          <span class="nav-label">Cupones</span>
        </button>
        <button type="button" data-role="sell" class="nav-item">
          <span class="nav-icon" aria-hidden="true"><i class="fa-solid fa-store"></i></span>
          <span class="nav-label">Vender</span>
        </button>
      </div>
    </nav>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>
    <div class="modal-backdrop" id="modal-backdrop" aria-hidden="true"></div>

    <dialog id="sell-selector-modal" aria-labelledby="sell-selector-title">
      <div class="modal-surface modal-surface--compact">
        <div class="modal-toolbar modal-toolbar--with-nav">
          <button
            type="button"
            class="modal-back"
            data-close="sell-selector-modal"
            aria-label="Cerrar selector de venta"
          >
            <i class="fa-solid fa-arrow-left"></i>
          </button>
          <div class="modal-title-block">
            <span class="modal-eyebrow">Ventas</span>
            <h3 class="modal-title" id="sell-selector-title">Â¿QuÃ© deseas vender?</h3>
          </div>
          <button type="button" class="modal-close" data-close="sell-selector-modal">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="modal-body modal-body--selector">
          <div class="sell-selector-intro">
            <p>Selecciona la categorÃ­a principal para personalizar tu publicaciÃ³n de venta.</p>
          </div>
          <div class="sell-selector-grid" role="group" aria-label="Opciones de venta">
            <button type="button" class="sell-option-card" data-sell-type="productos" aria-pressed="false">
              <span class="sell-option-card__icon" aria-hidden="true">
                <i class="fa-solid fa-box-open"></i>
              </span>
              <span class="sell-option-card__content">
                <strong>Productos</strong>
                <span>ArtÃ­culos fÃ­sicos, tecnologÃ­a, moda, hogar y mÃ¡s.</span>
              </span>
              <i class="fa-solid fa-chevron-right sell-option-card__chevron" aria-hidden="true"></i>
            </button>
            <button type="button" class="sell-option-card" data-sell-type="vehiculos" aria-pressed="false">
              <span class="sell-option-card__icon" aria-hidden="true">
                <i class="fa-solid fa-car-side"></i>
              </span>
              <span class="sell-option-card__content">
                <strong>VehÃ­culos</strong>
                <span>Carros, motos, bicicletas, maquinaria y partes.</span>
              </span>
              <i class="fa-solid fa-chevron-right sell-option-card__chevron" aria-hidden="true"></i>
            </button>
            <button type="button" class="sell-option-card" data-sell-type="inmuebles" aria-pressed="false">
              <span class="sell-option-card__icon" aria-hidden="true">
                <i class="fa-solid fa-building"></i>
              </span>
              <span class="sell-option-card__content">
                <strong>Inmuebles</strong>
                <span>Viviendas, oficinas, bodegas y lotes para canje.</span>
              </span>
              <i class="fa-solid fa-chevron-right sell-option-card__chevron" aria-hidden="true"></i>
            </button>
            <button type="button" class="sell-option-card" data-sell-type="servicios" aria-pressed="false">
              <span class="sell-option-card__icon" aria-hidden="true">
                <i class="fa-solid fa-briefcase"></i>
              </span>
              <span class="sell-option-card__content">
                <strong>Servicios</strong>
                <span>ConsultorÃ­as, oficios profesionales y soluciones por horas.</span>
              </span>
              <i class="fa-solid fa-chevron-right sell-option-card__chevron" aria-hidden="true"></i>
            </button>
          </div>
        </div>
      </div>
    </dialog>

    <dialog id="sell-modal" aria-labelledby="sell-modal-title">
      <div class="modal-surface modal-surface--edge-to-edge">
        <div class="modal-toolbar modal-toolbar--with-nav">
          <button
            type="button"
            class="modal-back"
            id="sell-modal-back"
            aria-label="Volver al selector de venta"
          >
            <i class="fa-solid fa-arrow-left"></i>
          </button>
          <div class="modal-title-block">
            <span class="modal-eyebrow" id="sell-modal-eyebrow">Ventas Â· Productos</span>
            <h3 class="modal-title" id="sell-modal-title">Publicar productos en venta</h3>
            <p class="modal-title-subtitle" id="sell-modal-subtitle">
              Completa la informaciÃ³n comercial para garantizar una experiencia de compra confiable.
            </p>
          </div>
          <button type="button" class="modal-close" data-close="sell-modal">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <form method="dialog" class="modal-body sell-form" id="sell-form">
          <input type="hidden" id="sell-intent" value="productos" />
          <div class="sell-form__intro">
            <div class="sell-form__intro-copy">
              <h4>Configura tu anuncio</h4>
              <p>
                Comparte informaciÃ³n clara y verificable para que la comunidad confÃ­e en tu oferta antes de
                negociar.
              </p>
            </div>
            <span class="sell-form__pill" id="sell-type-chip">Productos</span>
          </div>
          <div class="sell-form__grid">
            <section class="sell-form__section" aria-labelledby="sell-gallery-title">
              <div class="sell-form__section-header">
                <div>
                  <h4 class="sell-form__section-title" id="sell-gallery-title">GalerÃ­a del anuncio</h4>
                  <p class="sell-form__section-subtitle" id="sell-gallery-subtitle">
                    AÃ±ade entre 3 y 10 fotografÃ­as reales y nÃ­tidas de lo que ofreces.
                  </p>
                </div>
                <span class="sell-form__counter" id="sell-image-counter">0/10 fotos</span>
              </div>
              <div class="media-upload">
                <label class="media-dropzone" for="sell-images">
                  <i class="fa-solid fa-plus"></i>
                  <strong>Agregar fotos</strong>
                  <span>Arrastra o selecciona imÃ¡genes en formato JPG o PNG.</span>
                </label>
                <input
                  type="file"
                  id="sell-images"
                  accept="image/*"
                  multiple
                  required
                  data-preview-target="sell-image-preview"
                  data-counter-target="sell-image-counter"
                  data-min-files="3"
                  data-max-files="10"
                />
                <div class="image-preview-grid" id="sell-image-preview"></div>
              </div>
            </section>
            <section class="sell-form__section" aria-labelledby="sell-details-title">
              <div class="sell-form__section-header">
                <div>
                  <h4 class="sell-form__section-title" id="sell-details-title">Detalles comerciales</h4>
                  <p class="sell-form__section-subtitle" id="sell-details-subtitle">
                    Describe beneficios, entrega y cualquier condiciÃ³n especial para compradores.
                  </p>
                </div>
              </div>
              <div class="form-grid two-column">
                <label class="field">
                  <span>Nombre del anuncio</span>
                  <input type="text" id="sell-name" required placeholder="TÃ­tulo claro y atractivo" />
                </label>
                <label class="field">
                  <span>CategorÃ­a</span>
                  <select id="sell-category" required>
                    <option value="">Selecciona</option>
                    <option value="tecnologia">TecnologÃ­a</option>
                    <option value="agricultura">Agricultura</option>
                    <option value="hogar">Hogar</option>
                    <option value="vehiculos">VehÃ­culos</option>
                    <option value="inmuebles">Inmuebles</option>
                    <option value="servicios">Servicios</option>
                    <option value="moda">Moda</option>
                    <option value="coleccionables">Coleccionables</option>
                  </select>
                </label>
                <label class="field">
                  <span>Precio de venta (COP)</span>
                  <input type="number" id="sell-price" min="0" step="500" required />
                </label>
                <label class="field">
                  <span>UbicaciÃ³n</span>
                  <input type="text" id="sell-location" required placeholder="Ciudad, barrio o zona" />
                </label>
              </div>
              <label class="field">
                <span>DescripciÃ³n</span>
                <textarea
                  id="sell-description"
                  required
                  placeholder="Incluye estado, garantÃ­as, tiempos de entrega y medios de pago aceptados."
                ></textarea>
              </label>
              <div class="toggle-field">
                <div class="toggle-field-copy">
                  <span>Publicar en el Feed</span>
                  <small>Activa para que tu anuncio sea visible inmediatamente en Cambalaches.</small>
                </div>
                <label class="toggle">
                  <input type="checkbox" id="sell-feed-toggle" checked />
                  <span class="toggle-track" aria-hidden="true"></span>
                </label>
              </div>
            </section>
          </div>
          <div class="modal-actions sell-form__footer">
            <button type="button" class="btn btn-outline" data-close="sell-modal">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="sell-submit">Publicar anuncio</button>
          </div>
        </form>
      </div>
    </dialog>

    <dialog id="auth-modal">
      <div class="modal-surface">
        <div class="modal-toolbar">
          <div class="modal-title-block">
            <span class="modal-eyebrow">Identidad</span>
            <h3 class="modal-title">Cuenta verificada</h3>
          </div>
          <button type="button" class="modal-close" data-close="auth-modal">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <form method="dialog" class="modal-body auth-form" id="auth-form">
          <p class="auth-form__lead">
            Completa tus datos personales para habilitar tu perfil verificado y comenzar a publicar en la comunidad.
          </p>
          <div class="profile-field profile-field--full auth-form__photo">
            <span>Foto de perfil</span>
            <div class="profile-photo-control">
              <div class="profile-avatar" id="auth-photo-preview">
                <i class="fa-regular fa-user" aria-hidden="true"></i>
              </div>
              <div class="profile-photo-actions">
                <input type="file" id="auth-photo" accept="image/*" required class="visually-hidden" />
                <label class="profile-upload btn btn-outline" for="auth-photo" role="button" tabindex="0">
                  <i class="fa-solid fa-arrow-up-from-bracket" aria-hidden="true"></i>
                  <span>Subir imagen</span>
                </label>
                <p class="profile-photo-hint">Formatos JPG o PNG hasta 5 MB.</p>
              </div>
            </div>
          </div>
          <div class="profile-grid" data-columns="two">
            <label class="profile-field">
              <span>Nombre completo</span>
              <input type="text" id="auth-name" required placeholder="Tu nombre" />
            </label>
            <label class="profile-field">
              <span>Correo electrÃ³nico</span>
              <input type="email" id="auth-email" required placeholder="nombre@correo.com" />
            </label>
            <label class="profile-field">
              <span>TelÃ©fono verificado</span>
              <input type="tel" id="auth-phone" required placeholder="300 000 0000" />
            </label>
            <label class="profile-field">
              <span>Ciudad y paÃ­s</span>
              <input type="text" id="auth-location" required placeholder="BogotÃ¡, Colombia" />
            </label>
          </div>
          <label class="checkbox-field auth-form__terms">
            <input type="checkbox" id="auth-terms" required />
            <span>Acepto las polÃ­ticas de verificaciÃ³n, reputaciÃ³n y resoluciÃ³n de disputas.</span>
          </label>
          <div class="modal-actions auth-form__actions">
            <button type="button" class="btn btn-outline" data-close="auth-modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Crear cuenta</button>
          </div>
        </form>
      </div>
    </dialog>

    <dialog id="publish-modal">
      <div class="modal-surface">
        <div class="modal-toolbar">
          <div class="modal-title-block">
            <span class="modal-eyebrow">Marketplace</span>
            <h3 class="modal-title">Nueva publicaciÃ³n</h3>
          </div>
          <button type="button" class="modal-close" data-close="publish-modal">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <form method="dialog" class="modal-body" id="publish-form">
          <div class="modal-section">
            <div class="modal-section-header">
              <div>
                <h4 class="modal-section-title">GalerÃ­a del artÃ­culo</h4>
                <p class="modal-section-subtitle">AÃ±ade imÃ¡genes claras para destacar tu publicaciÃ³n.</p>
              </div>
              <span class="modal-chip" id="image-counter">0/10 fotos</span>
            </div>
            <div class="media-upload">
              <label class="media-dropzone" for="product-images">
                <i class="fa-solid fa-plus"></i>
                <strong>Agregar fotos</strong>
                <span>Selecciona entre 3 y 10 imÃ¡genes en formato JPG o PNG.</span>
              </label>
              <input
                type="file"
                id="product-images"
                accept="image/*"
                multiple
                required
                data-preview-target="image-preview"
                data-counter-target="image-counter"
                data-min-files="3"
                data-max-files="10"
              />
              <div class="image-preview-grid" id="image-preview"></div>
            </div>
          </div>
          <div class="modal-section">
            <div class="modal-section-header">
              <div>
                <h4 class="modal-section-title">InformaciÃ³n del producto</h4>
              </div>
            </div>
            <div class="form-grid two-column">
              <label class="field">
                <span>Nombre del artÃ­culo</span>
                <input type="text" id="product-name" required />
              </label>
              <label class="field">
                <span>CategorÃ­a</span>
                <select id="product-category" required>
                  <option value="">Selecciona</option>
                  <option value="tecnologia">TecnologÃ­a</option>
                  <option value="agricultura">Agricultura</option>
                  <option value="hogar">Hogar</option>
                  <option value="vehiculos">VehÃ­culos</option>
                  <option value="inmuebles">Inmuebles</option>
                  <option value="servicios">Servicios</option>
                  <option value="moda">Moda</option>
                  <option value="coleccionables">Coleccionables</option>
                </select>
              </label>
              <label class="field">
                <span>Precio estimado (COP)</span>
                <input type="number" id="product-price" min="0" step="500" required />
              </label>
              <label class="field">
                <span>UbicaciÃ³n</span>
                <input type="text" id="product-location" required placeholder="Ciudad, barrio" />
              </label>
            </div>
            <label class="field">
              <span>DescripciÃ³n detallada</span>
              <textarea id="product-description" required placeholder="Incluye estado, uso y valor estimado en COP."></textarea>
            </label>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-outline" data-close="publish-modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Publicar en el feed</button>
          </div>
        </form>
      </div>
    </dialog>

    <dialog id="offer-modal">
      <div class="modal-surface">
        <div class="modal-toolbar">
          <div class="modal-title-block">
            <span class="modal-eyebrow">Canjes</span>
            <h3 class="modal-title">Crear oferta de canje</h3>
          </div>
          <button type="button" class="modal-close" data-close="offer-modal">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <form method="dialog" class="modal-body" id="offer-form">
          <div class="modal-section">
            <div class="modal-section-header">
              <div>
                <h4 class="modal-section-title">Selecciona los artÃ­culos</h4>
                <p class="modal-section-subtitle">Elige elementos y compensa si lo consideras necesario.</p>
              </div>
            </div>
            <div class="form-grid" id="offer-content"></div>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-outline" data-close="offer-modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Enviar oferta</button>
          </div>
        </form>
      </div>
    </dialog>

    <dialog id="negotiate-modal">
      <div class="modal-surface">
        <div class="modal-toolbar">
          <div class="modal-title-block">
            <span class="modal-eyebrow">Canjes</span>
            <h3 class="modal-title">Responder contraoferta</h3>
          </div>
          <button type="button" class="modal-close" data-close="negotiate-modal">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <form method="dialog" class="modal-body" id="negotiate-form">
          <div class="modal-section">
            <div class="modal-section-header">
              <div>
                <h4 class="modal-section-title">Ajusta la propuesta</h4>
                <p class="modal-section-subtitle">Confirma los artÃ­culos o plantea una diferencia adicional.</p>
              </div>
            </div>
            <div class="form-grid" id="negotiate-content"></div>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-outline" data-close="negotiate-modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Enviar contraoferta</button>
          </div>
        </form>
      </div>
    </dialog>

    <dialog id="report-modal">
      <div class="modal-surface">
        <div class="modal-toolbar">
          <div class="modal-title-block">
            <span class="modal-eyebrow">Confianza</span>
            <h3 class="modal-title">Reportar publicaciÃ³n o usuario</h3>
          </div>
          <button type="button" class="modal-close" data-close="report-modal">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <form method="dialog" class="modal-body" id="report-form">
          <div class="modal-section">
            <div class="modal-section-header">
              <div>
                <h4 class="modal-section-title">Detalle del reporte</h4>
              </div>
            </div>
            <label class="field">
              <span>Enlace o referencia</span>
              <input type="text" id="report-reference" required placeholder="TÃ­tulo del artÃ­culo o ID del canje" />
            </label>
            <label class="field">
              <span>DescripciÃ³n del reporte</span>
              <textarea id="report-description" required placeholder="Explica lo ocurrido, fechas y evidencia disponible."></textarea>
            </label>
            <label class="checkbox-field">
              <input type="checkbox" id="report-terms" required />
              <span>Declaro que la informaciÃ³n compartida es verÃ­dica y puedo aportar evidencia adicional.</span>
            </label>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-outline" data-close="report-modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Enviar reporte</button>
          </div>
        </form>
      </div>
    </dialog>

    <script>
      const $ = (selector, scope = document) => scope.querySelector(selector);
      const $$ = (selector, scope = document) => Array.from(scope.querySelectorAll(selector));

      const on = (selector, event, handler, options) => {
        const element = $(selector);
        if (!element) {
          return null;
        }
        element.addEventListener(event, handler, options);
        return element;
      };

      const onAll = (selector, event, handler, options) => {
        const elements = $$(selector);
        elements.forEach((element) => element.addEventListener(event, handler, options));
        return elements;
      };

      const modalBackdrop = document.getElementById("modal-backdrop");
      const isDialogSupported = typeof HTMLDialogElement === "function";
      const openModals = new Set();
      const horizontalScrollRegistry = new WeakMap();

      const STORAGE_KEYS = {
        user: "cambalaches.currentUser",
        coupons: "cambalaches.coupons",
      };

      const storage = (() => {
        try {
          const ls = window.localStorage;
          const testKey = "__cambalaches-test__";
          ls.setItem(testKey, testKey);
          ls.removeItem(testKey);
          return ls;
        } catch (error) {
          console.warn("Almacenamiento local no disponible", error);
          return null;
        }
      })();

      const COLOMBIAN_DEPARTMENTS = [
        {
          name: "Amazonas",
          municipalities: ["Leticia", "Puerto NariÃ±o", "La Chorrera", "La Pedrera", "TarapacÃ¡"],
        },
        {
          name: "Antioquia",
          municipalities: ["MedellÃ­n", "Bello", "ItagÃ¼Ã­", "Envigado", "Rionegro", "ApartadÃ³"],
        },
        {
          name: "Arauca",
          municipalities: ["Arauca", "Saravena", "Tame", "Arauquita", "Fortul"],
        },
        {
          name: "AtlÃ¡ntico",
          municipalities: ["Barranquilla", "Soledad", "Malambo", "Puerto Colombia", "Sabanalarga"],
        },
        {
          name: "BogotÃ¡ D.C.",
          municipalities: ["BogotÃ¡ D.C."],
        },
        {
          name: "BolÃ­var",
          municipalities: ["Cartagena de Indias", "MaganguÃ©", "Turbaco", "Arjona", "El Carmen de BolÃ­var"],
        },
        {
          name: "BoyacÃ¡",
          municipalities: ["Tunja", "Duitama", "Sogamoso", "ChiquinquirÃ¡", "Paipa"],
        },
        {
          name: "Caldas",
          municipalities: ["Manizales", "VillamarÃ­a", "La Dorada", "ChinchinÃ¡", "Riosucio"],
        },
        {
          name: "CaquetÃ¡",
          municipalities: ["Florencia", "San Vicente del CaguÃ¡n", "Cartagena del ChairÃ¡", "Puerto Rico", "BelÃ©n de los AndaquÃ­es"],
        },
        {
          name: "Casanare",
          municipalities: ["Yopal", "Aguazul", "Tauramena", "Villanueva", "Paz de Ariporo"],
        },
        {
          name: "Cauca",
          municipalities: ["PopayÃ¡n", "Santander de Quilichao", "Puerto Tejada", "GuachenÃ©", "Caloto"],
        },
        {
          name: "Cesar",
          municipalities: ["Valledupar", "Aguachica", "Bosconia", "La Jagua de Ibirico", "CurumanÃ­"],
        },
        {
          name: "ChocÃ³",
          municipalities: ["QuibdÃ³", "Istmina", "TadÃ³", "Condoto", "BahÃ­a Solano"],
        },
        {
          name: "CÃ³rdoba",
          municipalities: ["MonterÃ­a", "Lorica", "SahagÃºn", "CeretÃ©", "Tierralta"],
        },
        {
          name: "Cundinamarca",
          municipalities: ["Soacha", "ZipaquirÃ¡", "ChÃ­a", "FusagasugÃ¡", "Girardot"],
        },
        {
          name: "GuainÃ­a",
          municipalities: ["InÃ­rida", "Barrancominas", "Mapiripana", "San Felipe", "Cacahual"],
        },
        {
          name: "Guaviare",
          municipalities: ["San JosÃ© del Guaviare", "El Retorno", "Calamar", "Miraflores"],
        },
        {
          name: "Huila",
          municipalities: ["Neiva", "Pitalito", "GarzÃ³n", "La Plata", "Campoalegre"],
        },
        {
          name: "La Guajira",
          municipalities: ["Riohacha", "Maicao", "Uribia", "Fonseca", "Villanueva"],
        },
        {
          name: "Magdalena",
          municipalities: ["Santa Marta", "CiÃ©naga", "FundaciÃ³n", "Aracataca", "El Banco"],
        },
        {
          name: "Meta",
          municipalities: ["Villavicencio", "Granada", "AcacÃ­as", "Puerto LÃ³pez", "Restrepo"],
        },
        {
          name: "NariÃ±o",
          municipalities: ["Pasto", "Tumaco", "Ipiales", "TÃºquerres", "La UniÃ³n"],
        },
        {
          name: "Norte de Santander",
          municipalities: ["CÃºcuta", "OcaÃ±a", "Pamplona", "Los Patios", "Villa del Rosario"],
        },
        {
          name: "Putumayo",
          municipalities: ["Mocoa", "Puerto AsÃ­s", "VillagarzÃ³n", "Orito", "Sibundoy"],
        },
        {
          name: "QuindÃ­o",
          municipalities: ["Armenia", "CalarcÃ¡", "Montenegro", "La Tebaida", "Quimbaya"],
        },
        {
          name: "Risaralda",
          municipalities: ["Pereira", "Dosquebradas", "Santa Rosa de Cabal", "La Virginia", "BelÃ©n de UmbrÃ­a"],
        },
        {
          name: "San AndrÃ©s y Providencia",
          municipalities: ["San AndrÃ©s", "Providencia", "Santa Catalina"],
        },
        {
          name: "Santander",
          municipalities: ["Bucaramanga", "Floridablanca", "GirÃ³n", "Piedecuesta", "Barrancabermeja"],
        },
        {
          name: "Sucre",
          municipalities: ["Sincelejo", "Corozal", "TolÃº", "CoveÃ±as", "SampuÃ©s"],
        },
        {
          name: "Tolima",
          municipalities: ["IbaguÃ©", "El Espinal", "Melgar", "Honda", "Chaparral"],
        },
        {
          name: "Valle del Cauca",
          municipalities: ["Cali", "Palmira", "Buenaventura", "TuluÃ¡", "Buga"],
        },
        {
          name: "VaupÃ©s",
          municipalities: ["MitÃº", "CarurÃº", "Taraira", "Pacoa", "YavaratÃ©"],
        },
        {
          name: "Vichada",
          municipalities: ["Puerto CarreÃ±o", "La Primavera", "Santa RosalÃ­a", "Cumaribo"],
        },
      ];

      function getMunicipalitiesByDepartment(department) {
        if (!department) {
          return [];
        }
        const entry = COLOMBIAN_DEPARTMENTS.find((item) => item.name === department);
        return entry ? entry.municipalities : [];
      }

      function parseLocationString(value) {
        if (!value) {
          return { city: "", department: "" };
        }
        const segments = value
          .split(",")
          .map((part) => part.trim())
          .filter(Boolean);
        if (!segments.length) {
          return { city: "", department: "" };
        }
        if (segments.length === 1) {
          return { city: segments[0], department: "" };
        }
        return { city: segments[0], department: segments[segments.length - 1] };
      }

      function resetCitySelect(select) {
        if (!select) {
          return;
        }
        select.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "Selecciona un municipio";
        placeholder.disabled = true;
        placeholder.selected = true;
        select.appendChild(placeholder);
        select.disabled = true;
      }

      function populateCitySelect(select, department, { selectedCity = "" } = {}) {
        if (!select) {
          return;
        }
        const cities = getMunicipalitiesByDepartment(department);
        select.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "Selecciona un municipio";
        placeholder.disabled = true;
        placeholder.selected = !selectedCity;
        select.appendChild(placeholder);

        if (!cities.length) {
          select.disabled = true;
          return;
        }

        cities.forEach((city) => {
          const option = document.createElement("option");
          option.value = city;
          option.textContent = city;
          if (city === selectedCity) {
            option.selected = true;
          }
          select.appendChild(option);
        });

        select.disabled = false;

        if (selectedCity && !cities.includes(selectedCity)) {
          const placeholderOption = select.querySelector('option[value=""]');
          if (placeholderOption) {
            placeholderOption.selected = true;
          }
          select.value = "";
        }
      }

      function ensureLocationSelectorsInitialized() {
        const departmentSelect = $("#profile-department");
        const citySelect = $("#profile-city");
        if (!departmentSelect || !citySelect) {
          return;
        }

        if (!departmentSelect.dataset.enhanced) {
          departmentSelect.innerHTML = "";
          const placeholder = document.createElement("option");
          placeholder.value = "";
          placeholder.textContent = "Selecciona un departamento";
          placeholder.disabled = true;
          placeholder.selected = true;
          departmentSelect.appendChild(placeholder);

          COLOMBIAN_DEPARTMENTS.forEach(({ name }) => {
            const option = document.createElement("option");
            option.value = name;
            option.textContent = name;
            departmentSelect.appendChild(option);
          });

          departmentSelect.dataset.enhanced = "true";
        }

        if (!citySelect.dataset.enhanced) {
          resetCitySelect(citySelect);
          citySelect.dataset.enhanced = "true";
        }

        if (!departmentSelect.dataset.listenerAttached) {
          departmentSelect.addEventListener("change", (event) => {
            const value = event.target.value;
            populateCitySelect(citySelect, value);
          });
          departmentSelect.dataset.listenerAttached = "true";
        }
      }

      function applyLocationToForm({ department = "", city = "" } = {}) {
        const departmentSelect = $("#profile-department");
        const citySelect = $("#profile-city");
        if (!departmentSelect || !citySelect) {
          return;
        }

        ensureLocationSelectorsInitialized();

        if (department && getMunicipalitiesByDepartment(department).length) {
          departmentSelect.value = department;
          populateCitySelect(citySelect, department, { selectedCity: city });
        } else {
          const placeholder = departmentSelect.querySelector('option[value=""]');
          if (placeholder) {
            placeholder.selected = true;
          } else {
            departmentSelect.selectedIndex = 0;
          }
          departmentSelect.value = "";
          resetCitySelect(citySelect);
        }
      }

      function getUserLocationData(user) {
        if (!user) {
          return { department: "", city: "" };
        }
        if (user.department || user.city) {
          return { department: user.department || "", city: user.city || "" };
        }
        return parseLocationString(user.location || "");
      }

      const loadStoredUser = () => {
        if (!storage) {
          return null;
        }
        try {
          const raw = storage.getItem(STORAGE_KEYS.user);
          if (!raw) {
            return null;
          }
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== "object") {
            return null;
          }
          return parsed;
        } catch (error) {
          console.warn("No se pudo recuperar el perfil almacenado", error);
          return null;
        }
      };

      const persistUser = (user) => {
        if (!storage) {
          return;
        }
        try {
          if (user) {
            storage.setItem(STORAGE_KEYS.user, JSON.stringify(user));
          } else {
            storage.removeItem(STORAGE_KEYS.user);
          }
        } catch (error) {
          console.warn("No se pudo persistir el perfil", error);
        }
      };

      const formatDateTime = (isoString) => {
        if (!isoString) {
          return "";
        }
        try {
          return new Date(isoString).toLocaleString("es-CO", {
            dateStyle: "medium",
            timeStyle: "short",
          });
        } catch (error) {
          return "";
        }
      };

      const enhanceHorizontalScroll = (container, options = {}) => {
        if (!container) {
          return null;
        }

        if (horizontalScrollRegistry.has(container)) {
          return horizontalScrollRegistry.get(container);
        }

        const state = {
          pointerId: null,
          isPointerDown: false,
          startScrollLeft: 0,
          startClientX: 0,
          lastClientX: 0,
          lastTimestamp: 0,
          velocity: 0,
          momentumFrame: 0,
          suppressClick: false,
          dragExceeded: false,
          currentScrollLeft: 0,
        };

        const dragThreshold =
          Number.isFinite(options.dragThreshold) && options.dragThreshold >= 0
            ? Number(options.dragThreshold)
            : 6;
        const minMomentumVelocity = 0.08;
        const momentumDecay = 0.92;

        const snapOptions = {
          enabled: Boolean(options.snapToChildren),
          selector: typeof options.snapSelector === "string" ? options.snapSelector : null,
          align: options.snapAlign === "start" || options.snapAlign === "end" ? options.snapAlign : "center",
          behavior: options.snapBehavior === "auto" ? "auto" : "smooth",
          wheel: options.snapOnWheel !== false,
        };

        if (!container.hasAttribute("tabindex")) {
          container.setAttribute("tabindex", "0");
        }

        container.setAttribute("data-scroll-enhanced", "true");

        const getSnapItems = () => {
          if (!snapOptions.enabled) {
            return [];
          }
          const nodes = snapOptions.selector
            ? container.querySelectorAll(snapOptions.selector)
            : container.children;
          return Array.from(nodes).filter((node) => node instanceof HTMLElement);
        };

        const scrollToItem = (item, behavior = snapOptions.behavior) => {
          if (!item) {
            return;
          }
          const maxScroll = Math.max(0, container.scrollWidth - container.clientWidth);
          let target = item.offsetLeft;
          if (snapOptions.align === "center") {
            target -= (container.clientWidth - item.offsetWidth) / 2;
          } else if (snapOptions.align === "end") {
            target -= container.clientWidth - item.offsetWidth;
          }
          target = Math.max(0, Math.min(maxScroll, target));
          container.scrollTo({ left: target, behavior });
          requestAnimationFrame(updateOverflow);
        };

        const getActiveIndex = () => {
          const items = getSnapItems();
          if (!items.length) {
            return -1;
          }
          const center = container.scrollLeft + container.clientWidth / 2;
          let closest = 0;
          let minDistance = Infinity;
          items.forEach((item, index) => {
            const itemCenter = item.offsetLeft + item.offsetWidth / 2;
            const distance = Math.abs(itemCenter - center);
            if (distance < minDistance) {
              closest = index;
              minDistance = distance;
            }
          });
          return closest;
        };

        const snapToClosest = (direction = 0, behavior) => {
          if (!snapOptions.enabled) {
            return;
          }
          const items = getSnapItems();
          if (!items.length) {
            return;
          }
          let index = getActiveIndex();
          if (index === -1) {
            index = direction > 0 ? 0 : items.length - 1;
          }
          if (direction > 0 && index < items.length - 1) {
            index += 1;
          } else if (direction < 0 && index > 0) {
            index -= 1;
          }
          scrollToItem(items[index], behavior);
        };

        const cancelMomentum = () => {
          if (state.momentumFrame) {
            cancelAnimationFrame(state.momentumFrame);
            state.momentumFrame = 0;
          }
          container.classList.remove("is-kinetic");
        };

        const updateOverflow = () => {
          const maxScroll = Math.max(0, container.scrollWidth - container.clientWidth);
          if (maxScroll <= 0) {
            container.classList.add("is-scroll-start", "is-scroll-end");
            return;
          }
          const atStart = container.scrollLeft <= 1;
          const atEnd = container.scrollLeft >= maxScroll - 1;
          container.classList.toggle("is-scroll-start", atStart);
          container.classList.toggle("is-scroll-end", atEnd);
        };

        const startMomentum = () => {
          const maxScroll = Math.max(0, container.scrollWidth - container.clientWidth);
          if (Math.abs(state.velocity) <= minMomentumVelocity || maxScroll <= 0) {
            state.velocity = 0;
            cancelMomentum();
            updateOverflow();
            return;
          }

          cancelMomentum();
          container.classList.add("is-kinetic");

          const step = () => {
            const maxBound = Math.max(0, container.scrollWidth - container.clientWidth);
            const reachedStart = container.scrollLeft <= 0 && state.velocity < 0;
            const reachedEnd = container.scrollLeft >= maxBound && state.velocity > 0;
            if (Math.abs(state.velocity) <= minMomentumVelocity || reachedStart || reachedEnd) {
              if (reachedStart) {
                container.scrollLeft = 0;
              } else if (reachedEnd) {
                container.scrollLeft = maxBound;
              }
              cancelMomentum();
              state.velocity = 0;
              updateOverflow();
              return;
            }

            container.scrollLeft += state.velocity;
            updateOverflow();
            state.velocity *= momentumDecay;
            state.momentumFrame = requestAnimationFrame(step);
          };

          state.momentumFrame = requestAnimationFrame(step);
        };

        const releasePointer = () => {
          state.isPointerDown = false;
          state.pointerId = null;
          container.classList.remove("is-dragging");
        };

        const onPointerDown = (event) => {
          if (event.pointerType === "mouse" && event.button !== 0) {
            return;
          }

          if (event.pointerType === "touch") {
            state.isPointerDown = false;
            state.pointerId = null;
            return;
          }

          state.isPointerDown = true;
          state.pointerId = event.pointerId;
          state.startScrollLeft = container.scrollLeft;
          state.startClientX = event.clientX;
          state.lastClientX = event.clientX;
          state.lastTimestamp = event.timeStamp;
          state.velocity = 0;
          state.dragExceeded = false;
          state.suppressClick = false;
          state.currentScrollLeft = container.scrollLeft;

          cancelMomentum();
          container.classList.add("is-dragging");

          try {
            container.setPointerCapture(event.pointerId);
          } catch (_) {
            /* noop */
          }

          if (container.hasAttribute("tabindex")) {
            container.focus({ preventScroll: true });
          }
        };

        const onPointerMove = (event) => {
          if (!state.isPointerDown || event.pointerId !== state.pointerId) {
            return;
          }

          const offset = event.clientX - state.startClientX;
          container.scrollLeft = state.startScrollLeft - offset;

          if (!state.dragExceeded && Math.abs(offset) > dragThreshold) {
            state.dragExceeded = true;
          }

          const deltaX = event.clientX - state.lastClientX;
          const deltaTime = event.timeStamp - state.lastTimestamp || 16;
          state.velocity = -(deltaX / deltaTime) * 16;
          state.lastClientX = event.clientX;
          state.lastTimestamp = event.timeStamp;
          state.currentScrollLeft = container.scrollLeft;

          if (event.pointerType === "mouse") {
            event.preventDefault();
          }

          updateOverflow();
        };

        const onPointerEnd = (event) => {
          if (event.pointerId !== state.pointerId) {
            return;
          }

          try {
            container.releasePointerCapture(event.pointerId);
          } catch (_) {
            /* noop */
          }

          releasePointer();

          const dragged = state.dragExceeded;
          state.dragExceeded = false;

          if (dragged) {
            state.suppressClick = true;
            setTimeout(() => {
              state.suppressClick = false;
            }, 0);
          } else {
            state.velocity = 0;
          }

          state.currentScrollLeft = container.scrollLeft;

          if (snapOptions.enabled) {
            cancelMomentum();
            const traveled = state.currentScrollLeft - state.startScrollLeft;
            let direction = 0;
            if (Math.abs(state.velocity) > minMomentumVelocity) {
              direction = state.velocity > 0 ? 1 : -1;
            } else if (Math.abs(traveled) > dragThreshold) {
              direction = traveled > 0 ? 1 : -1;
            }
            snapToClosest(direction);
            updateOverflow();
            state.velocity = 0;
            return;
          }

          startMomentum();
          updateOverflow();
        };

        const onPointerCancel = (event) => {
          if (event.pointerId !== state.pointerId) {
            return;
          }
          releasePointer();
          state.dragExceeded = false;
          state.velocity = 0;
          cancelMomentum();
          if (snapOptions.enabled) {
            snapToClosest();
          }
          updateOverflow();
        };

        const onClickCapture = (event) => {
          if (state.suppressClick) {
            event.preventDefault();
            event.stopPropagation();
          }
        };

        const onWheel = (event) => {
          if (event.ctrlKey) {
            return;
          }

          const hasOverflow = container.scrollWidth > container.clientWidth;
          if (!hasOverflow) {
            return;
          }

          if (snapOptions.enabled && snapOptions.wheel) {
            const primaryDelta = Math.abs(event.deltaY) >= Math.abs(event.deltaX) ? event.deltaY : event.deltaX;
            if (primaryDelta !== 0) {
              event.preventDefault();
              cancelMomentum();
              snapToClosest(primaryDelta > 0 ? 1 : -1);
              return;
            }
            return;
          }

          const maxScroll = Math.max(0, container.scrollWidth - container.clientWidth);
          const atStart = container.scrollLeft <= 1;
          const atEnd = container.scrollLeft >= maxScroll - 1;
          const scrollingForward = event.deltaY > 0;

          if ((scrollingForward && atEnd) || (!scrollingForward && atStart)) {
            return;
          }

          container.scrollLeft += event.deltaY;
          event.preventDefault();
          updateOverflow();
        };

        const onKeyDown = (event) => {
          if (event.defaultPrevented) {
            return;
          }

          if (event.key === "ArrowRight" || event.key === "ArrowLeft") {
            const direction = event.key === "ArrowRight" ? 1 : -1;
            if (snapOptions.enabled) {
              snapToClosest(direction);
            } else {
              const distance = Math.max(160, container.clientWidth * 0.6);
              container.scrollBy({ left: distance * direction, behavior: "smooth" });
            }
            event.preventDefault();
          }
        };

        const onScroll = () => {
          if (!state.isPointerDown && !state.momentumFrame) {
            updateOverflow();
          }
        };

        container.addEventListener("pointerdown", onPointerDown);
        container.addEventListener("pointermove", onPointerMove);
        container.addEventListener("pointerup", onPointerEnd);
        container.addEventListener("pointercancel", onPointerCancel);
        container.addEventListener("lostpointercapture", onPointerCancel);
        container.addEventListener("click", onClickCapture, true);
        container.addEventListener("wheel", onWheel, { passive: false });
        container.addEventListener("keydown", onKeyDown);
        container.addEventListener("scroll", onScroll, { passive: true });

        let resizeObserver = null;
        if (typeof ResizeObserver === "function") {
          resizeObserver = new ResizeObserver(updateOverflow);
          resizeObserver.observe(container);
        } else {
          window.addEventListener("resize", updateOverflow);
        }

        const controller = {
          refresh: () => requestAnimationFrame(updateOverflow),
          snap: (direction = 0) => requestAnimationFrame(() => snapToClosest(direction)),
        };

        horizontalScrollRegistry.set(container, controller);

        requestAnimationFrame(updateOverflow);

        return controller;
      };

      const updateModalState = () => {
        const hasOpen = openModals.size > 0;
        if (document.body) {
          document.body.classList.toggle("modal-open", hasOpen);
        }
        if (modalBackdrop) {
          const requiresBackdrop = Array.from(openModals).some(
            (dialog) => dialog.dataset.fallback === "true"
          );
          modalBackdrop.classList.toggle("show", hasOpen && requiresBackdrop);
        }
      };

      const formatCOP = (value) =>
        new Intl.NumberFormat("es-CO", { style: "currency", currency: "COP", maximumFractionDigits: 0 }).format(value);

      const couponThemes = [
        {
          id: "aurora",
          label: "Aurora cÃ¡lida",
          gradient: "linear-gradient(135deg, #ff5f6d 0%, #ff3f5f 48%, #ffb270 100%)",
        },
        {
          id: "emerald",
          label: "Esmeralda digital",
          gradient: "linear-gradient(135deg, #0ba360 0%, #2eb872 40%, #4ade80 100%)",
        },
        {
          id: "midnight",
          label: "Zafiro nocturno",
          gradient: "linear-gradient(135deg, #1e3a8a 0%, #312e81 45%, #111827 100%)",
        },
        {
          id: "citrus",
          label: "CÃ­trico moderno",
          gradient: "linear-gradient(135deg, #f9d423 0%, #ff4e50 100%)",
        },
        {
          id: "plasma",
          label: "Futuro neÃ³n",
          gradient: "linear-gradient(135deg, #667eea 0%, #764ba2 45%, #6b8dd6 100%)",
        },
      ];

      const randomId = () =>
        typeof crypto !== "undefined" && typeof crypto.randomUUID === "function"
          ? crypto.randomUUID()
          : `coupon-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 10)}`;

      const normalizeCoupon = (coupon) => {
        if (!coupon || typeof coupon !== "object") {
          return null;
        }

        const theme = coupon.theme && couponThemes.some((item) => item.id === coupon.theme) ? coupon.theme : couponThemes[0].id;

        const discountValue = Number.parseFloat(coupon.discount);
        const discount = Number.isFinite(discountValue)
          ? Math.max(1, Math.min(95, Math.round(discountValue)))
          : 10;

        const minPurchaseValue = Number.parseFloat(coupon.minPurchase);
        const minPurchase = Number.isFinite(minPurchaseValue) ? Math.max(0, Math.round(minPurchaseValue)) : 0;

        const maxRedemptionsValue = coupon.maxRedemptions === null || coupon.maxRedemptions === ""
          ? null
          : Number.parseInt(coupon.maxRedemptions, 10);
        const maxRedemptions = Number.isFinite(maxRedemptionsValue) && maxRedemptionsValue > 0
          ? Math.min(5000, Math.round(maxRedemptionsValue))
          : null;

        const usageValue = Number.parseInt(coupon.usageCount, 10);
        const usageCount = Number.isFinite(usageValue) && usageValue > 0 ? Math.max(0, usageValue) : 0;
        const safeUsage = maxRedemptions ? Math.min(maxRedemptions, usageCount) : usageCount;

        const rawStatus = coupon.status === "paused" ? "paused" : "active";

        const sanitizedCode = (coupon.code || "CUPON")
          .toString()
          .trim()
          .toUpperCase()
          .replace(/[^A-Z0-9_-]/g, "");

        return {
          id: coupon.id || randomId(),
          name: (coupon.name || "CupÃ³n sin nombre").toString().trim(),
          code: sanitizedCode || "CUPON",
          discount,
          minPurchase,
          maxRedemptions,
          usageCount: safeUsage,
          theme,
          cover: coupon.cover || "",
          status: rawStatus,
          description: (coupon.description || "").toString().trim(),
          validUntil: coupon.validUntil || "",
        };
      };

      const rawDefaultCoupons = [
        {
          id: "cpn-bienvenida",
          name: "Bienvenida Premium",
          code: "CB-BIENVENIDA25",
          discount: 25,
          minPurchase: 150000,
          maxRedemptions: 500,
          usageCount: 138,
          theme: "aurora",
          cover: "https://images.unsplash.com/photo-1521737604893-d14cc237f11d?auto=format&fit=crop&w=1200&q=80",
          status: "active",
          description: "Descuento de bienvenida para los primeros canjes verificados en la plataforma.",
          validUntil: "2024-12-31T23:59:59.000Z",
        },
        {
          id: "cpn-logistica",
          name: "LogÃ­stica Express",
          code: "CB-ENVIO40",
          discount: 40,
          minPurchase: 250000,
          maxRedemptions: 150,
          usageCount: 42,
          theme: "emerald",
          cover: "https://images.unsplash.com/photo-1523475472560-d2df97ec485c?auto=format&fit=crop&w=1200&q=80",
          status: "active",
          description: "Acelera la primera entrega de tus clientes con envÃ­os subsidiados y seguimiento premium.",
          validUntil: "2024-09-30T23:59:59.000Z",
        },
        {
          id: "cpn-fidelidad",
          name: "Fidelidad Estelar",
          code: "CB-STARS15",
          discount: 15,
          minPurchase: 90000,
          maxRedemptions: null,
          usageCount: 218,
          theme: "midnight",
          cover: "",
          status: "paused",
          description: "Premia a usuarios recurrentes con un descuento escalable segÃºn su reputaciÃ³n.",
          validUntil: "",
        },
      ];

      const couponElements = {
        list: $("#coupon-list"),
        empty: $("#coupon-empty"),
        counter: $("#coupon-counter"),
        form: $("#coupon-form"),
        coverInput: $("#coupon-cover"),
        coverRemove: $("#coupon-cover-remove"),
        preview: $("#coupon-cover-preview"),
        previewStatus: $("#coupon-preview-status"),
        previewDiscount: $("#coupon-preview-discount"),
        previewName: $("#coupon-preview-name"),
        previewMeta: $("#coupon-preview-meta"),
        themeSelect: $("#coupon-theme"),
        statusSelect: $("#coupon-status"),
        nameInput: $("#coupon-name"),
        codeInput: $("#coupon-code"),
        discountInput: $("#coupon-discount"),
        minPurchaseInput: $("#coupon-min-purchase"),
        maxRedemptionsInput: $("#coupon-max-redemptions"),
        validUntilInput: $("#coupon-valid-until"),
        descriptionInput: $("#coupon-description"),
        submitButton: $("#coupon-submit"),
        cancelButton: $("#coupon-cancel"),
        newButton: $("#coupon-new"),
        emptyCreateButton: $("#coupon-empty-create"),
        editorTitle: $("#coupon-editor-title"),
        editorSubtitle: $("#coupon-editor-subtitle"),
      };

      if (couponElements.themeSelect) {
        couponElements.themeSelect.innerHTML = couponThemes
          .map((theme) => `<option value="${theme.id}">${theme.label}</option>`)
          .join("");
      }

      const defaultCoupons = rawDefaultCoupons
        .map((coupon) => normalizeCoupon(coupon))
        .filter((coupon) => coupon !== null);

      const loadStoredCoupons = () => {
        if (!storage) {
          return [];
        }
        try {
          const raw = storage.getItem(STORAGE_KEYS.coupons);
          if (!raw) {
            return [];
          }
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) {
            return [];
          }
          return parsed
            .map((item) => normalizeCoupon(item))
            .filter((item) => item !== null);
        } catch (error) {
          console.warn("No se pudo recuperar la configuraciÃ³n de cupones", error);
          return [];
        }
      };

      const persistCoupons = () => {
        if (!storage) {
          return;
        }
        try {
          storage.setItem(STORAGE_KEYS.coupons, JSON.stringify(coupons));
        } catch (error) {
          console.warn("No se pudieron guardar los cupones", error);
        }
      };

      let coupons = loadStoredCoupons();
      if (!coupons.length) {
        coupons = defaultCoupons.slice();
      }

      let editingCouponId = coupons.length ? coupons[0].id : null;
      let couponCoverDraft = null;

      const getThemeById = (id) => couponThemes.find((theme) => theme.id === id) || couponThemes[0];

      const toDateInputValue = (value) => {
        if (!value) {
          return "";
        }
        const date = value instanceof Date ? value : new Date(value);
        if (Number.isNaN(date.getTime())) {
          return "";
        }
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
      };

      const formatCouponDate = (isoString, { prefix = "Vigente hasta" } = {}) => {
        if (!isoString) {
          return "Sin caducidad definida";
        }
        try {
          const date = new Date(isoString);
          if (Number.isNaN(date.getTime())) {
            return "Sin caducidad definida";
          }
          const formatted = date.toLocaleDateString("es-CO", {
            day: "2-digit",
            month: "short",
            year: "numeric",
          });
          return `${prefix} ${formatted}`;
        } catch (error) {
          return "Sin caducidad definida";
        }
      };

      const ensureEditingCoupon = () => {
        if (!coupons.length) {
          editingCouponId = null;
          return null;
        }
        if (!editingCouponId || !coupons.some((coupon) => coupon.id === editingCouponId)) {
          editingCouponId = coupons[0].id;
        }
        return coupons.find((coupon) => coupon.id === editingCouponId) || null;
      };

      const updateCouponCounter = () => {
        if (!couponElements.counter) {
          return;
        }
        const total = coupons.length;
        const active = coupons.filter((coupon) => coupon.status === "active").length;
        couponElements.counter.innerHTML = `
          <i class="fa-solid fa-circle-notch" aria-hidden="true"></i>
          <span>${active} activos Â· ${total} en total</span>
        `;
      };

      const getCouponFormState = () => {
        if (!couponElements.form) {
          return {};
        }
        const formData = new FormData(couponElements.form);
        const discount = Number.parseFloat(formData.get("coupon-discount"));
        const minPurchase = Number.parseFloat(formData.get("coupon-min-purchase"));
        const maxRaw = formData.get("coupon-max-redemptions");
        const maxRedemptions = maxRaw === "" || maxRaw === null ? null : Number.parseInt(maxRaw, 10);
        const dateRaw = formData.get("coupon-valid-until");
        const validUntil = dateRaw ? new Date(`${dateRaw}T23:59:59`).toISOString() : "";

        return {
          id: couponElements.form.dataset.id || null,
          name: (formData.get("coupon-name") || "").toString().trim(),
          code: (formData.get("coupon-code") || "").toString().trim().toUpperCase().replace(/[^A-Z0-9_-]/g, ""),
          discount: Number.isFinite(discount) ? discount : 0,
          minPurchase: Number.isFinite(minPurchase) ? minPurchase : 0,
          maxRedemptions: Number.isFinite(maxRedemptions) && maxRedemptions > 0 ? maxRedemptions : null,
          validUntil,
          description: (formData.get("coupon-description") || "").toString().trim(),
          status: formData.get("coupon-status") === "paused" ? "paused" : "active",
          theme: formData.get("coupon-theme") || couponThemes[0].id,
          cover: couponCoverDraft,
        };
      };

      const updateCouponPreview = (state = {}) => {
        if (!couponElements.preview) {
          return;
        }
        const merged = {
          name: state.name || "Nuevo cupÃ³n",
          code: state.code || "#CUPON",
          discount: Number.isFinite(state.discount) ? Math.max(0, Math.round(state.discount)) : 0,
          minPurchase: Number.isFinite(state.minPurchase) ? Math.max(0, Math.round(state.minPurchase)) : 0,
          validUntil: state.validUntil || "",
          status: state.status === "paused" ? "paused" : "active",
          theme: state.theme,
          cover: state.cover,
        };

        const theme = getThemeById(merged.theme);
        couponElements.preview.style.setProperty("--coupon-preview-gradient", theme.gradient);
        if (merged.cover) {
          couponElements.preview.style.setProperty("--coupon-preview-cover", `url("${merged.cover}")`);
        } else {
          couponElements.preview.style.setProperty("--coupon-preview-cover", "none");
        }

        if (couponElements.previewStatus) {
          const isActive = merged.status === "active";
          couponElements.previewStatus.classList.toggle("is-paused", !isActive);
          couponElements.previewStatus.innerHTML = `
            <i class="fa-solid ${isActive ? "fa-circle-check" : "fa-circle-pause"}" aria-hidden="true"></i>
            <span>${isActive ? "Activo" : "Pausado"}</span>
          `;
        }

        if (couponElements.previewDiscount) {
          couponElements.previewDiscount.textContent = `${merged.discount}% OFF`;
        }

        if (couponElements.previewName) {
          couponElements.previewName.textContent = merged.name;
        }

        if (couponElements.previewMeta) {
          const metaParts = [merged.code, merged.minPurchase > 0 ? `MÃ­nimo ${formatCOP(merged.minPurchase)}` : "Sin mÃ­nimo"];
          if (merged.validUntil) {
            metaParts.push(formatCouponDate(merged.validUntil, { prefix: "Hasta" }));
          }
          couponElements.previewMeta.innerHTML = metaParts
            .map((part) => `<span>${part}</span>`)
            .join("");
        }
      };

      const updateCouponPreviewFromForm = () => {
        const state = getCouponFormState();
        updateCouponPreview(state);
      };

      const renderCouponForm = (coupon = null, { focus = false } = {}) => {
        if (!couponElements.form) {
          return;
        }

        const normalized = coupon ? normalizeCoupon(coupon) : null;
        couponElements.form.dataset.mode = normalized ? "edit" : "create";
        couponElements.form.dataset.id = normalized ? normalized.id : "";

        if (couponElements.nameInput) {
          couponElements.nameInput.value = normalized ? normalized.name : "";
        }
        if (couponElements.codeInput) {
          couponElements.codeInput.value = normalized ? normalized.code : "";
        }
        if (couponElements.discountInput) {
          couponElements.discountInput.value = normalized ? normalized.discount : 10;
        }
        if (couponElements.minPurchaseInput) {
          couponElements.minPurchaseInput.value = normalized ? normalized.minPurchase : 0;
        }
        if (couponElements.maxRedemptionsInput) {
          couponElements.maxRedemptionsInput.value = normalized && normalized.maxRedemptions ? normalized.maxRedemptions : "";
        }
        if (couponElements.validUntilInput) {
          couponElements.validUntilInput.value = normalized ? toDateInputValue(normalized.validUntil) : "";
        }
        if (couponElements.descriptionInput) {
          couponElements.descriptionInput.value = normalized ? normalized.description : "";
        }
        if (couponElements.statusSelect) {
          couponElements.statusSelect.value = normalized ? normalized.status : "active";
        }
        if (couponElements.themeSelect) {
          const themeId = normalized ? normalized.theme : couponThemes[0].id;
          couponElements.themeSelect.value = themeId;
        }

        couponCoverDraft = normalized ? normalized.cover : null;

        if (couponElements.editorTitle) {
          couponElements.editorTitle.textContent = normalized ? "Editar cupÃ³n" : "Crear nuevo cupÃ³n";
        }

        if (couponElements.editorSubtitle) {
          couponElements.editorSubtitle.textContent = normalized
            ? `Actualiza beneficios, vigencia y estilo visual de ${normalized.name}.`
            : "Define condiciones, personaliza la portada y sorprende a tu comunidad con beneficios Ãºnicos.";
        }

        if (couponElements.submitButton) {
          couponElements.submitButton.textContent = normalized ? "Guardar cambios" : "Crear cupÃ³n";
        }

        if (couponElements.cancelButton) {
          couponElements.cancelButton.textContent = normalized ? "Cancelar" : "Limpiar";
        }

        updateCouponPreviewFromForm();

        if (focus && couponElements.nameInput) {
          couponElements.nameInput.focus();
        }
      };

      const renderCouponList = () => {
        if (!couponElements.list) {
          return;
        }

        couponElements.list.innerHTML = "";

        if (!coupons.length) {
          couponElements.list.classList.add("hidden");
          if (couponElements.empty) {
            couponElements.empty.classList.remove("hidden");
          }
        } else {
          couponElements.list.classList.remove("hidden");
          if (couponElements.empty) {
            couponElements.empty.classList.add("hidden");
          }
        }

        coupons.forEach((coupon) => {
          const card = document.createElement("article");
          card.className = "coupon-card";
          card.dataset.id = coupon.id;
          card.dataset.status = coupon.status;
          if (coupon.id === editingCouponId) {
            card.classList.add("is-selected");
          }

          const hasLimit = Number.isFinite(coupon.maxRedemptions);
          const usage = Number.isFinite(coupon.usageCount) ? coupon.usageCount : 0;
          const remaining = hasLimit ? Math.max(0, coupon.maxRedemptions - usage) : null;
          const progress = hasLimit && coupon.maxRedemptions > 0
            ? Math.min(100, Math.round((usage / coupon.maxRedemptions) * 100))
            : 0;

          const coverTheme = getThemeById(coupon.theme);
          const availabilityText = hasLimit
            ? `${remaining} de ${coupon.maxRedemptions} disponibles`
            : "Sin lÃ­mite de canjes";
          const validityText = formatCouponDate(coupon.validUntil);
          const limitText = hasLimit ? `${coupon.maxRedemptions} canjes mÃ¡x.` : "Canjes ilimitados";

          card.innerHTML = `
            <div class="coupon-card__cover">
              <div class="coupon-card__top-row">
                <span class="coupon-card__status-badge">
                  <i class="fa-solid ${coupon.status === "active" ? "fa-circle-check" : "fa-circle-pause"}" aria-hidden="true"></i>
                  ${coupon.status === "active" ? "Activo" : "Pausado"}
                </span>
                <button type="button" class="coupon-card__delete" data-action="delete" title="Eliminar ${coupon.name}">
                  <i class="fa-solid fa-trash" aria-hidden="true"></i>
                </button>
              </div>
              <div class="coupon-card__discount">
                <span>Hasta</span>
                <strong>${coupon.discount}% OFF</strong>
                <small>${coupon.name}</small>
              </div>
            </div>
            <div class="coupon-card__body">
              <div class="coupon-card__meta">
                <span class="coupon-card__code">${coupon.code}</span>
                <span class="coupon-card__availability">${availabilityText}</span>
              </div>
              <p class="coupon-card__description">${
                coupon.description || "AÃ±ade una descripciÃ³n inspiradora para tus compradores."
              }</p>
              <div class="coupon-card__stats">
                <span><i class="fa-solid fa-bag-shopping" aria-hidden="true"></i>MÃ­nimo ${formatCOP(coupon.minPurchase)}</span>
                <span><i class="fa-solid fa-users" aria-hidden="true"></i>${limitText}</span>
                <span><i class="fa-solid fa-calendar-day" aria-hidden="true"></i>${validityText}</span>
              </div>
              ${
                hasLimit
                  ? `<div class="coupon-card__progress">
                      <div class="coupon-card__progress-track">
                        <div class="coupon-card__progress-bar" style="width: ${progress}%"></div>
                      </div>
                      <small class="coupon-card__availability">${usage} canjes usados Â· ${remaining} disponibles</small>
                    </div>`
                  : `<div class="coupon-card__availability">Sin lÃ­mite de canjes registrados</div>`
              }
              <div class="coupon-card__footer">
                <button type="button" class="btn btn-outline" data-action="edit">
                  <i class="fa-solid fa-pen-to-square" aria-hidden="true"></i>
                  <span>Gestionar</span>
                </button>
                <button type="button" class="btn btn-ghost" data-action="toggle">
                  <i class="fa-solid ${coupon.status === "active" ? "fa-circle-pause" : "fa-circle-play"}" aria-hidden="true"></i>
                  <span>${coupon.status === "active" ? "Pausar" : "Reactivar"}</span>
                </button>
              </div>
            </div>
          `;

          const coverEl = card.querySelector(".coupon-card__cover");
          if (coverEl) {
            coverEl.style.setProperty("--coupon-gradient", coverTheme.gradient);
            if (coupon.cover) {
              coverEl.style.setProperty("--coupon-cover-image", `url("${coupon.cover}")`);
            } else {
              coverEl.style.setProperty("--coupon-cover-image", "none");
            }
          }

          const handleSelect = () => {
            if (editingCouponId !== coupon.id) {
              editingCouponId = coupon.id;
              renderCouponForm(coupon);
              renderCouponList();
            }
          };

          card.addEventListener("click", (event) => {
            const actionButton = event.target.closest("[data-action]");
            if (actionButton) {
              return;
            }
            handleSelect();
          });

          const editBtn = card.querySelector('[data-action="edit"]');
          if (editBtn) {
            editBtn.addEventListener("click", (event) => {
              event.stopPropagation();
              editingCouponId = coupon.id;
              renderCouponForm(coupon, { focus: true });
              renderCouponList();
            });
          }

          const deleteBtn = card.querySelector('[data-action="delete"]');
          if (deleteBtn) {
            deleteBtn.addEventListener("click", (event) => {
              event.stopPropagation();
              handleCouponDelete(coupon.id);
            });
          }

          const toggleBtn = card.querySelector('[data-action="toggle"]');
          if (toggleBtn) {
            toggleBtn.addEventListener("click", (event) => {
              event.stopPropagation();
              handleCouponToggle(coupon.id);
            });
          }

          couponElements.list.appendChild(card);
        });

        updateCouponCounter();
      };

      const renderCoupons = () => {
        const activeCoupon = ensureEditingCoupon();
        renderCouponForm(activeCoupon);
        renderCouponList();
      };

      const handleCouponCoverChange = (event) => {
        const file = event.target.files && event.target.files[0];
        if (!file) {
          return;
        }
        if (!file.type.startsWith("image/")) {
          showToast("Selecciona un archivo de imagen vÃ¡lido.", "danger");
          event.target.value = "";
          return;
        }

        const reader = new FileReader();
        reader.onload = () => {
          couponCoverDraft = reader.result;
          updateCouponPreviewFromForm();
          showToast("Portada actualizada.", "success");
        };
        reader.onerror = () => {
          showToast("No pudimos procesar la imagen seleccionada.", "danger");
        };
        reader.readAsDataURL(file);
      };

      const handleCouponCoverRemove = () => {
        if (!couponCoverDraft) {
          return;
        }
        couponCoverDraft = null;
        if (couponElements.coverInput) {
          couponElements.coverInput.value = "";
        }
        updateCouponPreviewFromForm();
        showToast("Imagen retirada del cupÃ³n.", "info");
      };

      const handleCouponSubmit = (event) => {
        event.preventDefault();
        const state = getCouponFormState();

        if (!state.name || !state.code) {
          showToast("Completa el nombre interno y el cÃ³digo del cupÃ³n.", "danger");
          return;
        }

        if (state.discount < 1 || state.discount > 95) {
          showToast("Define un porcentaje entre 1% y 95%.", "danger");
          return;
        }

        const isEdit = couponElements.form.dataset.mode === "edit" && state.id;

        if (isEdit) {
          const index = coupons.findIndex((coupon) => coupon.id === state.id);
          if (index === -1) {
            showToast("No encontramos el cupÃ³n que deseas actualizar.", "danger");
            return;
          }
          const updated = normalizeCoupon({ ...coupons[index], ...state, usageCount: coupons[index].usageCount });
          coupons.splice(index, 1, updated);
          editingCouponId = updated.id;
          couponCoverDraft = updated.cover;
          showToast("CupÃ³n actualizado correctamente.", "success");
        } else {
          const created = normalizeCoupon({ ...state, id: randomId(), usageCount: 0 });
          coupons = [created, ...coupons];
          editingCouponId = created.id;
          couponCoverDraft = created.cover;
          showToast(
            created.status === "active"
              ? "Nuevo cupÃ³n creado y disponible para los usuarios."
              : "CupÃ³n creado en estado pausado.",
            created.status === "active" ? "success" : "info"
          );
        }

        persistCoupons();
        renderCoupons();
      };

      const handleCouponDelete = (id) => {
        const coupon = coupons.find((item) => item.id === id);
        if (!coupon) {
          showToast("No encontramos el cupÃ³n seleccionado.", "danger");
          return;
        }
        if (!confirm(`Â¿Eliminar el cupÃ³n "${coupon.name}"?`)) {
          return;
        }
        coupons = coupons.filter((item) => item.id !== id);
        if (editingCouponId === id) {
          editingCouponId = coupons.length ? coupons[0].id : null;
        }
        couponCoverDraft = null;
        persistCoupons();
        renderCoupons();
        showToast("CupÃ³n eliminado correctamente.", "info");
      };

      const handleCouponToggle = (id) => {
        const coupon = coupons.find((item) => item.id === id);
        if (!coupon) {
          showToast("No encontramos el cupÃ³n seleccionado.", "danger");
          return;
        }
        const nextStatus = coupon.status === "active" ? "paused" : "active";
        coupons = coupons.map((item) =>
          item.id === id
            ? { ...item, status: nextStatus }
            : item
        );
        if (editingCouponId === id) {
          const current = coupons.find((item) => item.id === id);
          renderCouponForm(current);
        }
        persistCoupons();
        renderCouponList();
        showToast(
          nextStatus === "active" ? "CupÃ³n reactivado correctamente." : "CupÃ³n pausado. Ya no estarÃ¡ visible para los usuarios.",
          nextStatus === "active" ? "success" : "info"
        );
      };

      const handleCouponNew = () => {
        editingCouponId = null;
        couponCoverDraft = null;
        renderCouponForm(null, { focus: true });
        renderCouponList();
      };

      const handleCouponCancel = () => {
        const current = ensureEditingCoupon();
        couponCoverDraft = current ? current.cover : null;
        renderCouponForm(current);
      };

      const handleCouponFormInput = (event) => {
        if (event && event.target === couponElements.codeInput) {
          const rawValue = event.target.value || "";
          event.target.value = rawValue.toUpperCase().replace(/[^A-Z0-9_-]/g, "");
        }
        updateCouponPreviewFromForm();
      };

      const formatViews = (value = 0) => {
        const number = Number.isFinite(Number(value)) ? Number(value) : 0;
        const options = { maximumFractionDigits: 1 };
        if (number >= 1000) {
          options.notation = "compact";
          options.compactDisplay = "short";
        }
        return new Intl.NumberFormat("es-CO", options).format(number);
      };

      const titleize = (value = "") =>
        value
          .toString()
          .replace(/[\-_]+/g, " ")
          .replace(/\s+/g, " ")
          .trim()
          .replace(/(^|\s)\p{L}/gu, (letter) => letter.toUpperCase());

      const categoryLabels = {
        agricultura: "Agricultura",
        tecnologia: "TecnologÃ­a",
        hogar: "Hogar",
        vehiculos: "VehÃ­culos",
        inmuebles: "Inmuebles",
        servicios: "Servicios",
        moda: "Moda",
        coleccionables: "Coleccionables",
      };

      const getCategoryLabel = (key) => categoryLabels[key] || titleize(key || "");

      const SELL_INTENTS = {
        productos: {
          label: "Productos",
          description: "Publica inventario nuevo o de segunda con informaciÃ³n precisa y verificada.",
          gallery: "AÃ±ade diferentes Ã¡ngulos, accesorios incluidos y empaques si aplica.",
          details: "Describe estado, garantÃ­a y disponibilidad inmediata para concretar la venta.",
          defaultCategory: "",
          namePlaceholder: "TÃ­tulo claro y atractivo",
          locationPlaceholder: "Ciudad, barrio o zona",
        },
        vehiculos: {
          label: "VehÃ­culos",
          description: "Presenta datos tÃ©cnicos, kilometraje y estado legal del vehÃ­culo.",
          gallery: "Incluye fotos del exterior, interior y documentos relevantes.",
          details: "Indica modelo, aÃ±o, kilometraje y condiciones de entrega.",
          defaultCategory: "vehiculos",
          namePlaceholder: "Modelo, aÃ±o y versiÃ³n",
          locationPlaceholder: "Ciudad o municipio del vehÃ­culo",
        },
        inmuebles: {
          label: "Inmuebles",
          description: "Comparte informaciÃ³n clara sobre el espacio, administraciÃ³n y tiempos de entrega.",
          gallery: "Agrega fotografÃ­as luminosas de cada ambiente y amenidades.",
          details: "Indica Ã¡rea, estrato, disponibilidad y requisitos de negociaciÃ³n.",
          defaultCategory: "inmuebles",
          namePlaceholder: "Tipo de inmueble y ubicaciÃ³n clave",
          locationPlaceholder: "Barrio, ciudad o conjunto",
        },
        servicios: {
          label: "Servicios",
          description: "Explica el alcance, modalidad y requisitos de tu servicio profesional.",
          gallery: "Comparte evidencias visuales o piezas de tu portafolio.",
          details: "Detalla entregables, tiempos estimados y condiciones de pago.",
          defaultCategory: "servicios",
          namePlaceholder: "Servicio y especialidad",
          locationPlaceholder: "Cobertura o zona de atenciÃ³n",
        },
      };

      const getSellIntent = (key = "productos") => SELL_INTENTS[key] || SELL_INTENTS.productos;

      const FALLBACK_IMAGE =
        "https://images.unsplash.com/photo-1522199995590-980c4e48eb63?auto=format&fit=crop&w=900&q=80";
      const FALLBACK_AVATAR =
        "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=160&q=80";

      const generateId = (prefix) => `${prefix}-${Math.random().toString(36).slice(2, 9)}`;

      const safeNumber = (value, fallback = 0) => {
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : fallback;
      };

      const PRICE_LIMITS = {
        min: 0,
        max: 20000000,
      };

      const updatePriceSlider = (handle) => {
        const minInput = $("#filter-min");
        const maxInput = $("#filter-max");
        const slider = $("#price-slider");
        const minDisplay = $("#filter-min-display");
        const maxDisplay = $("#filter-max-display");

        if (!minInput || !maxInput) {
          return;
        }

        let minValue = safeNumber(minInput.value, PRICE_LIMITS.min);
        let maxValue = safeNumber(maxInput.value, PRICE_LIMITS.max);

        minValue = Math.max(PRICE_LIMITS.min, Math.min(minValue, PRICE_LIMITS.max));
        maxValue = Math.max(PRICE_LIMITS.min, Math.min(maxValue, PRICE_LIMITS.max));

        if (handle === "min" && minValue > maxValue) {
          maxValue = minValue;
        }

        if (handle === "max" && maxValue < minValue) {
          minValue = maxValue;
        }

        minInput.value = String(minValue);
        maxInput.value = String(maxValue);

        if (minDisplay) {
          minDisplay.textContent = formatCOP(minValue);
        }

        if (maxDisplay) {
          maxDisplay.textContent =
            maxValue >= PRICE_LIMITS.max ? "Sin tope" : formatCOP(maxValue);
        }

        if (slider) {
          const range = PRICE_LIMITS.max - PRICE_LIMITS.min;
          const start = range ? ((minValue - PRICE_LIMITS.min) / range) * 100 : 0;
          const end = range ? ((maxValue - PRICE_LIMITS.min) / range) * 100 : 100;
          slider.style.setProperty("--start", `${Math.max(0, Math.min(start, 100))}%`);
          slider.style.setProperty("--end", `${Math.max(0, Math.min(end, 100))}%`);
        }
      };

      const storedUser = loadStoredUser();
      const storedLocation = getUserLocationData(storedUser);
      const initialUser = storedUser
        ? {
            ...storedUser,
            id: storedUser.id || generateId("user"),
            rating: Number(storedUser.rating || 5),
            bio: storedUser.bio || "",
            department: storedLocation.department,
            city: storedLocation.city,
            location:
              storedUser.location ||
              (storedLocation.city && storedLocation.department
                ? `${storedLocation.city}, ${storedLocation.department}`
                : ""),
            createdAt: storedUser.createdAt || new Date().toISOString(),
            updatedAt: storedUser.updatedAt || storedUser.createdAt || new Date().toISOString(),
        }
        : null;

      const initialPromoBanners = [
        {
          id: generateId("banner"),
          label: "Publicidad",
          title: "Impulsa tus canjes corporativos",
          description:
            "Conecta tu marca con comunidades verificadas y cierra alianzas estratÃ©gicas en cuestiÃ³n de horas.",
          ctaLabel: "Ver paquetes",
          ctaLink: "#",
          theme: "midnight",
          textColor: "#f8fafc",
          buttonColor: "#4338ca",
          image: "https://images.unsplash.com/photo-1521737604893-d14cc237f11d?auto=format&fit=crop&w=1600&q=80",
          expiresAt: Date.now() + 1000 * 60 * 60 * 72,
        },
        {
          id: generateId("banner"),
          label: "Aliado destacado",
          title: "Tarjetas regalo hasta 30% OFF",
          description: "Integra beneficios exclusivos y multiplica los incentivos en tus negociaciones premium.",
          ctaLabel: "Descubrir ofertas",
          ctaLink: "#",
          theme: "sunrise",
          textColor: "#111827",
          buttonColor: "#111827",
          image: "https://images.unsplash.com/photo-1523275335684-37898b6baf30?auto=format&fit=crop&w=1600&q=80",
          expiresAt: Date.now() + 1000 * 60 * 60 * 24 * 5,
        },
        {
          id: generateId("banner"),
          label: "Publicidad",
          title: "Haz match con vendedores verificados",
          description: "Reserva espacios destacados y muestra tus productos en la portada diaria del marketplace.",
          ctaLabel: "Reservar espacio",
          ctaLink: "#",
          theme: "ocean",
          textColor: "#f8fafc",
          buttonColor: "#0ea5e9",
          image: "https://images.unsplash.com/photo-1556740749-887f6717d7e4?auto=format&fit=crop&w=1600&q=80",
          expiresAt: Date.now() + 1000 * 60 * 60 * 24 * 2,
        },
      ];

      const state = {
        currentUser: initialUser,
        products: [],
        offersSent: [],
        offersReceived: [],
        activeAgreements: [],
        history: [],
        reviews: [],
        reports: 0,
        modals: {},
        pendingSales: [],
        promoBanners: initialPromoBanners,
      };

      let activePage = "feed-section";
      let primaryNavButtons = [];
      let activeProductDetail = null;
      let profileMode = initialUser ? "view" : "create";
      let sidebarElement = null;
      let sidebarToggleButton = null;
      let sidebarBackdropElement = null;
      let activeSellIntent = "productos";
      const mobileSidebarQuery = window.matchMedia("(max-width: 1023px)");
      const PROMO_BANNER_THEMES = ["midnight", "sunrise", "ocean", "forest"];
      const PROMO_BANNER_DEFAULT_DURATION = 1000 * 60 * 60 * 24 * 7;
      const PROMO_BANNER_PREVIEW_PLACEHOLDER = `
        <div class="promo-banner-modal__preview-placeholder">
          <i class="fa-regular fa-image" aria-hidden="true"></i>
          <span>Selecciona una imagen horizontal en alta resoluciÃ³n (JPG o PNG).</span>
        </div>
      `;
      const PROMO_BANNER_THEME_DEFAULTS = {
        midnight: { textColor: "#f8fafc", buttonColor: "#4338ca" },
        sunrise: { textColor: "#111827", buttonColor: "#111827" },
        ocean: { textColor: "#f8fafc", buttonColor: "#0ea5e9" },
        forest: { textColor: "#f0fdf4", buttonColor: "#10b981" },
      };
      let promoBannersScrollController = null;
      let promoBannerTimers = [];
      let promoBannerModalElement = null;
      let promoBannerFormElement = null;
      let promoBannerImagePreviewElement = null;
      let promoBannerExpiresInput = null;
      let promoBannerTextColorInput = null;
      let promoBannerButtonColorInput = null;
      let nextPromoBannerTheme = PROMO_BANNER_THEMES[0];

      const isMobileSidebar = () => mobileSidebarQuery.matches;

      function setSidebarAriaHidden(hidden) {
        if (sidebarElement) {
          sidebarElement.setAttribute("aria-hidden", hidden ? "true" : "false");
        }
      }

      function openSidebar() {
        if (!sidebarElement) {
          return;
        }
        sidebarElement.classList.add("is-open");
        document.body.classList.add("sidebar-open");
        setSidebarAriaHidden(false);
        if (sidebarBackdropElement) {
          sidebarBackdropElement.classList.add("is-visible");
          sidebarBackdropElement.setAttribute("aria-hidden", "false");
        }
        if (sidebarToggleButton) {
          sidebarToggleButton.setAttribute("aria-expanded", "true");
        }
      }

      function closeSidebar() {
        if (!sidebarElement) {
          return;
        }
        sidebarElement.classList.remove("is-open");
        document.body.classList.remove("sidebar-open");
        setSidebarAriaHidden(isMobileSidebar());
        if (sidebarBackdropElement) {
          sidebarBackdropElement.classList.remove("is-visible");
          sidebarBackdropElement.setAttribute("aria-hidden", "true");
        }
        if (sidebarToggleButton) {
          sidebarToggleButton.setAttribute("aria-expanded", "false");
        }
      }

      function toggleSidebar() {
        if (!sidebarElement) {
          return;
        }
        if (sidebarElement.classList.contains("is-open")) {
          closeSidebar();
        } else {
          openSidebar();
        }
      }

      function syncSidebarWithViewport() {
        if (!sidebarElement) {
          return;
        }
        if (isMobileSidebar()) {
          setSidebarAriaHidden(!sidebarElement.classList.contains("is-open"));
        } else {
          sidebarElement.classList.remove("is-open");
          document.body.classList.remove("sidebar-open");
          setSidebarAriaHidden(false);
          if (sidebarBackdropElement) {
            sidebarBackdropElement.classList.remove("is-visible");
            sidebarBackdropElement.setAttribute("aria-hidden", "true");
          }
          if (sidebarToggleButton) {
            sidebarToggleButton.setAttribute("aria-expanded", "false");
          }
        }
      }

      function switchToPage(targetId, options = {}) {
        const sections = $$("[data-page-group]");
        const matched = sections.some((section) => section.dataset.pageGroup === targetId);

        if (!matched) {
          return false;
        }

        sections.forEach((section) => {
          const group = section.dataset.pageGroup;
          const shouldShow = group === "shared" || group === targetId;
          section.classList.toggle("page-hidden", !shouldShow);
        });

        primaryNavButtons.forEach((btn) => {
          const isActive = btn.getAttribute("data-target") === targetId;
          btn.classList.toggle("active", isActive);
          if (isActive) {
            btn.setAttribute("aria-current", "page");
          } else {
            btn.removeAttribute("aria-current");
          }
        });

        activePage = targetId;

        if (options.scroll !== false) {
          const main = document.querySelector("main");
          if (main) {
            main.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        }

        return true;
      }

      function focusProfileForm() {
        requestAnimationFrame(() => {
          const nameInput = $("#profile-name");
          if (nameInput) {
            nameInput.focus();
          }
        });
      }

      function setCurrentUser(user, { silent } = {}) {
        state.currentUser = user;
        persistUser(user);
        profileMode = user ? "view" : "create";
        if (!silent) {
          updateUI();
        }
      }

      function logout({ toast = true } = {}) {
        setCurrentUser(null, { silent: true });
        state.offersSent = [];
        state.offersReceived = [];
        state.activeAgreements = [];
        state.history = [];
        state.reviews = [];
        profileMode = "create";
        updateUI();
        if (toast) {
          showToast("SesiÃ³n cerrada. Hasta pronto.", "info");
        }
        switchToPage("profile", { scroll: false });
        closeSidebar();
        focusProfileForm();
      }

      const sampleUsers = [
        {
          id: "u-laura",
          name: "Laura MejÃ­a",
          email: "laura@agrotech.co",
          phone: "+57 300 123 4567",
          location: "MedellÃ­n, Colombia",
          avatar:
            "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=160&q=80",
          rating: 4.8,
        },
        {
          id: "u-diego",
          name: "Diego Serrano",
          email: "diego@techtune.co",
          phone: "+57 318 222 1199",
          location: "BogotÃ¡, Colombia",
          avatar:
            "https://images.unsplash.com/photo-1527980965255-d3b416303d12?auto=format&fit=crop&w=160&q=80",
          rating: 4.6,
        },
        {
          id: "u-maria",
          name: "MarÃ­a Rivera",
          email: "maria@creativa.studio",
          phone: "+57 315 879 3344",
          location: "Cali, Colombia",
          avatar:
            "https://images.unsplash.com/photo-1544723795-3fb6469f5b39?auto=format&fit=crop&w=160&q=80",
          rating: 4.9,
        },
      ];

      const sampleProducts = [
        {
          id: "prod-drone",
          title: "Drone agrÃ­cola DJI Agras T30",
          description:
            "Equipo con 40 vuelos, mantenimiento al dÃ­a y capacidad de fumigaciÃ³n de precisiÃ³n en cultivos de hasta 20 hectÃ¡reas.",
          category: "agricultura",
          price: 7800000,
          location: "MedellÃ­n, Antioquia",
          images: [
            "https://images.unsplash.com/photo-1512820790803-83ca734da794?auto=format&fit=crop&w=900&q=80",
            "https://images.unsplash.com/photo-1504198453319-5ce911bafcde?auto=format&fit=crop&w=900&q=80",
            "https://images.unsplash.com/photo-1501290836517-b22a21c47cbb?auto=format&fit=crop&w=900&q=80",
          ],
          rating: 4.9,
          views: 18800,
          tags: ["Agricultura", "Drones", "Alta precisiÃ³n"],
          owner: sampleUsers[0],
        },
        {
          id: "prod-studio",
          title: "Estudio fotogrÃ¡fico portÃ¡til",
          description:
            "Kit completo con luces LED regulables, panel difusor y fondo plegable. Ideal para e-commerce y contenido de producto.",
          category: "servicios",
          price: 1850000,
          location: "BogotÃ¡, Cundinamarca",
          images: [
            "https://images.unsplash.com/photo-1526045612212-70caf35c14df?auto=format&fit=crop&w=900&q=80",
            "https://images.unsplash.com/photo-1469474968028-56623f02e42e?auto=format&fit=crop&w=900&q=80",
            "https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=900&q=80",
          ],
          rating: 4.7,
          views: 15400,
          tags: ["Servicios creativos", "IluminaciÃ³n", "PortÃ¡til"],
          owner: sampleUsers[1],
        },
        {
          id: "prod-roadbike",
          title: "Bicicleta de ruta carbono Ultegra",
          description:
            "Marca Canyon Ultimate CF SL8, marco talla M, mantenimiento reciente y accesorios de alto rendimiento incluidos.",
          category: "vehiculos",
          price: 9500000,
          location: "Cali, Valle del Cauca",
          images: [
            "https://images.unsplash.com/photo-1529429617124-aee711a615c3?auto=format&fit=crop&w=900&q=80",
            "https://images.unsplash.com/photo-1558980664-10ea646823c3?auto=format&fit=crop&w=900&q=80",
            "https://images.unsplash.com/photo-1507831228880-ec414a4be0c1?auto=format&fit=crop&w=900&q=80",
          ],
          rating: 4.8,
          views: 13950,
          tags: ["Ciclismo", "Carbono", "Ultraligera"],
          owner: sampleUsers[2],
        },
        {
          id: "prod-cafe",
          title: "Lote cafÃ© especial microtostado",
          description:
            "40 kg de cafÃ© origen Pijao, tostado medio, notas a panela y cacao. Incluye anÃ¡lisis de laboratorio SCA 86.",
          category: "agricultura",
          price: 3200000,
          location: "Armenia, QuindÃ­o",
          images: [
            "https://images.unsplash.com/photo-1447933601403-0c6688de566e?auto=format&fit=crop&w=900&q=80",
            "https://images.unsplash.com/photo-1470162656305-6f429ba817b7?auto=format&fit=crop&w=900&q=80",
            "https://images.unsplash.com/photo-1447935765200-8841221efcb6?auto=format&fit=crop&w=900&q=80",
          ],
          rating: 4.6,
          views: 9800,
          tags: ["Origen Ãºnico", "Microtostado", "Especialidad"],
          owner: sampleUsers[0],
        },
      ];

      const sampleIncomingOffer = () => ({
        id: generateId("offer"),
        product: null,
        proposer: sampleUsers[1],
        items: [
          { title: "Servicio de fotografÃ­a para catÃ¡logo", price: 850000 },
          { title: "ConsultorÃ­a SEO 4 horas", price: 450000 },
        ],
        extra: 250000,
        status: "pendiente",
        createdAt: new Date(),
        notes: "Podemos entregar el servicio en mÃ¡ximo 5 dÃ­as hÃ¡biles.",
      });

      state.products = [...sampleProducts];
      const toastEl = $("#toast");
      let toastTimeout = null;
      let filtersSnapshot = null;
      let pendingStyle = "marketplace";

      const captureFilterSnapshot = () => ({
        location: $("#filter-location")?.value || "",
        min: $("#filter-min") ? $("#filter-min").value ?? PRICE_LIMITS.min : PRICE_LIMITS.min,
        max: $("#filter-max") ? $("#filter-max").value ?? PRICE_LIMITS.max : PRICE_LIMITS.max,
        style: $("#filter-style")?.value || "marketplace",
        category: $("#filter-category")?.value || "",
      });

      const setStyleSelection = (value = "marketplace", { updateHidden = false } = {}) => {
        pendingStyle = value || "marketplace";
        const styleInput = $("#filter-style");
        const pills = $$(".style-pill");
        pills.forEach((pill) => {
          const isActive = pill.dataset.style === pendingStyle;
          pill.classList.toggle("active", isActive);
          pill.setAttribute("aria-pressed", isActive ? "true" : "false");
        });
        if (updateHidden && styleInput) {
          styleInput.value = pendingStyle;
        }
      };

      const applyFiltersSnapshot = (snapshot, { updateHidden = true } = {}) => {
        if (!snapshot) return;
        const locationInput = $("#filter-location");
        if (locationInput) {
          locationInput.value = snapshot.location || "";
        }
        const minInput = $("#filter-min");
        if (minInput) {
          minInput.value = snapshot.min ?? PRICE_LIMITS.min;
        }
        const maxInput = $("#filter-max");
        if (maxInput) {
          maxInput.value = snapshot.max ?? PRICE_LIMITS.max;
        }
        updatePriceSlider();
        setStyleSelection(snapshot.style || "marketplace", { updateHidden });
        const categoryInput = $("#filter-category");
        if (categoryInput && typeof snapshot.category !== "undefined") {
          categoryInput.value = snapshot.category || "";
        }
        const categoryCards = $$(".category-card");
        categoryCards.forEach((card) => {
          const target = card.dataset.category || "";
          const categoryValue = $("#filter-category")?.value || "";
          card.classList.toggle("active", target === categoryValue);
        });
      };

      const openFiltersOverlay = () => {
        const overlay = $("#filters-overlay");
        if (!overlay) return;
        filtersSnapshot = captureFilterSnapshot();
        setStyleSelection(filtersSnapshot.style || "marketplace", { updateHidden: false });
        updatePriceSlider();
        overlay.classList.add("active");
        overlay.setAttribute("aria-hidden", "false");
        document.body.classList.add("filters-open");
        const firstField = $("#filter-location");
        if (firstField) {
          requestAnimationFrame(() => firstField.focus());
        }
      };

      const closeFiltersOverlay = ({ restore = false } = {}) => {
        const overlay = $("#filters-overlay");
        if (!overlay) return;
        overlay.classList.remove("active");
        overlay.setAttribute("aria-hidden", "true");
        document.body.classList.remove("filters-open");
        if (restore && filtersSnapshot) {
          applyFiltersSnapshot(filtersSnapshot, { updateHidden: true });
          pendingStyle = filtersSnapshot.style || "marketplace";
        } else {
          filtersSnapshot = captureFilterSnapshot();
          pendingStyle = filtersSnapshot.style || "marketplace";
          updatePriceSlider();
        }
      };

      function showToast(message, type = "info") {
        if (!toastEl) {
          return;
        }
        toastEl.textContent = "";
        toastEl.className = `toast ${type}`;
        toastEl.innerHTML = `<i class="fa-solid fa-bell"></i><div>${message}</div>`;
        toastEl.classList.add("show");
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => toastEl.classList.remove("show"), 3800);
      }

      function ensurePromoBannersScrollEnhancement() {
        const list = $("#promo-banners-list");
        if (!list) {
          return;
        }
        if (!promoBannersScrollController) {
          promoBannersScrollController = enhanceHorizontalScroll(list, {
            snapToChildren: true,
            snapSelector: ".promo-banners__item",
            snapAlign: "start",
            dragThreshold: 4,
            snapOnWheel: false,
          });
        } else {
          promoBannersScrollController.refresh();
        }
      }

      function handlePromoBannerRemove(id) {
        const before = state.promoBanners.length;
        state.promoBanners = state.promoBanners.filter((banner) => banner.id !== id);
        if (before !== state.promoBanners.length) {
          renderPromoBanners();
          showToast("Banner eliminado de la secciÃ³n publicitaria.", "warning");
        }
      }

      function handlePromoBannerAdd() {
        openPromoBannerModal();
      }

      function createPromoBannerAddItem() {
        const addButton = document.createElement("button");
        addButton.type = "button";
        addButton.id = "promo-banners-add";
        addButton.className = "promo-banners__item promo-banners__item--add";
        addButton.setAttribute("role", "listitem");
        addButton.setAttribute("aria-label", "Agregar banner publicitario");
        addButton.innerHTML = `
          <span class="promo-banners__add-icon">
            <i class="fa-solid fa-plus" aria-hidden="true"></i>
          </span>
          <span class="visually-hidden">Agregar banner publicitario</span>
        `;
        addButton.addEventListener("click", handlePromoBannerAdd);
        return addButton;
      }

      function ensurePromoBannerElements() {
        if (!promoBannerModalElement) {
          promoBannerModalElement = $("#promo-banner-modal");
        }
        if (!promoBannerFormElement) {
          promoBannerFormElement = $("#promo-banner-form");
        }
        if (!promoBannerImagePreviewElement) {
          promoBannerImagePreviewElement = $("#promo-banner-image-preview");
        }
        if (!promoBannerExpiresInput) {
          promoBannerExpiresInput = $("#promo-banner-expires");
        }
        if (!promoBannerTextColorInput) {
          promoBannerTextColorInput = $("#promo-banner-text-color");
        }
        if (!promoBannerButtonColorInput) {
          promoBannerButtonColorInput = $("#promo-banner-button-color");
        }
      }

      function formatDateTimeLocal(date) {
        if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
          return "";
        }
        const pad = (value) => String(value).padStart(2, "0");
        return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(
          date.getMinutes()
        )}`;
      }

      function getPromoBannerThemeDefaults(theme) {
        return PROMO_BANNER_THEME_DEFAULTS[theme] || PROMO_BANNER_THEME_DEFAULTS.midnight;
      }

      function normalizeHexColor(value) {
        if (typeof value !== "string") {
          return null;
        }
        const trimmed = value.trim();
        const match = /^#?([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.exec(trimmed);
        if (!match) {
          return null;
        }
        let hex = match[1];
        if (hex.length === 3) {
          hex = hex
            .split("")
            .map((char) => char + char)
            .join("");
        }
        return `#${hex.toLowerCase()}`;
      }

      function hexToRgb(color) {
        const normalized = normalizeHexColor(color);
        if (!normalized) {
          return null;
        }
        const value = normalized.slice(1);
        return {
          r: parseInt(value.slice(0, 2), 16),
          g: parseInt(value.slice(2, 4), 16),
          b: parseInt(value.slice(4, 6), 16),
        };
      }

      function rgbToHex({ r, g, b }) {
        const clamp = (channel) => Math.max(0, Math.min(255, Math.round(channel)));
        const toHex = (channel) => clamp(channel).toString(16).padStart(2, "0");
        return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
      }

      function lightenColor(color, amount = 0.18) {
        const rgb = hexToRgb(color);
        if (!rgb) {
          return normalizeHexColor(color) || color;
        }
        const lightenChannel = (channel) => channel + (255 - channel) * Math.max(0, Math.min(amount, 1));
        return rgbToHex({
          r: lightenChannel(rgb.r),
          g: lightenChannel(rgb.g),
          b: lightenChannel(rgb.b),
        });
      }

      function getReadableTextColor(color, fallback = "#ffffff") {
        const rgb = hexToRgb(color);
        if (!rgb) {
          return normalizeHexColor(fallback) || fallback;
        }
        const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
        return brightness > 160 ? "#111827" : "#ffffff";
      }

      function resetPromoBannerForm() {
        ensurePromoBannerElements();
        if (promoBannerFormElement) {
          promoBannerFormElement.reset();
        }
        if (promoBannerImagePreviewElement) {
          promoBannerImagePreviewElement.innerHTML = PROMO_BANNER_PREVIEW_PLACEHOLDER;
        }
        const defaultExpiration = new Date(Date.now() + PROMO_BANNER_DEFAULT_DURATION);
        if (promoBannerExpiresInput) {
          const minExpiration = new Date(Date.now() + 1000 * 60 * 30);
          promoBannerExpiresInput.min = formatDateTimeLocal(minExpiration);
          promoBannerExpiresInput.value = formatDateTimeLocal(defaultExpiration);
        }
      }

      function openPromoBannerModal() {
        ensurePromoBannerElements();
        resetPromoBannerForm();
        const themeIndex = state.promoBanners.length % PROMO_BANNER_THEMES.length;
        const theme = PROMO_BANNER_THEMES[themeIndex] || PROMO_BANNER_THEMES[0];
        nextPromoBannerTheme = theme;
        const defaults = getPromoBannerThemeDefaults(theme);
        if (promoBannerTextColorInput) {
          promoBannerTextColorInput.value = defaults.textColor;
        }
        if (promoBannerButtonColorInput) {
          promoBannerButtonColorInput.value = defaults.buttonColor;
        }
        if (!promoBannerModalElement) {
          return;
        }
        promoBannerModalElement.classList.add("is-visible");
        promoBannerModalElement.setAttribute("aria-hidden", "false");
        document.body.classList.add("modal-open");
        const firstField = $("#promo-banner-title");
        if (firstField) {
          requestAnimationFrame(() => firstField.focus());
        }
      }

      function closePromoBannerModal({ restoreFocus = true } = {}) {
        ensurePromoBannerElements();
        if (!promoBannerModalElement) {
          return;
        }
        promoBannerModalElement.classList.remove("is-visible");
        promoBannerModalElement.setAttribute("aria-hidden", "true");
        document.body.classList.remove("modal-open");
        if (restoreFocus) {
          const trigger = $("#promo-banners-add");
          if (trigger) {
            trigger.focus();
          }
        }
      }

      function handlePromoBannerOverlayClick(event) {
        if (event.target === event.currentTarget) {
          closePromoBannerModal({ restoreFocus: false });
        }
      }

      function handlePromoBannerKeydown(event) {
        if (event.key === "Escape" && promoBannerModalElement && promoBannerModalElement.classList.contains("is-visible")) {
          event.preventDefault();
          closePromoBannerModal({ restoreFocus: false });
        }
      }

      function handlePromoBannerImageChange(event) {
        ensurePromoBannerElements();
        if (!promoBannerImagePreviewElement) {
          return;
        }
        const file = event.target.files && event.target.files[0];
        if (!file) {
          promoBannerImagePreviewElement.innerHTML = PROMO_BANNER_PREVIEW_PLACEHOLDER;
          return;
        }
        if (!file.type.startsWith("image/")) {
          showToast("Selecciona un archivo de imagen vÃ¡lido.", "danger");
          event.target.value = "";
          promoBannerImagePreviewElement.innerHTML = PROMO_BANNER_PREVIEW_PLACEHOLDER;
          return;
        }
        const reader = new FileReader();
        reader.onload = () => {
          promoBannerImagePreviewElement.innerHTML = "";
          const img = document.createElement("img");
          img.src = reader.result;
          img.alt = "Vista previa del banner publicitario";
          promoBannerImagePreviewElement.appendChild(img);
        };
        reader.onerror = () => {
          showToast("No pudimos cargar la imagen seleccionada.", "danger");
          promoBannerImagePreviewElement.innerHTML = PROMO_BANNER_PREVIEW_PLACEHOLDER;
        };
        reader.readAsDataURL(file);
      }

      function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(new Error("No se pudo procesar el archivo"));
          reader.readAsDataURL(file);
        });
      }

      async function handlePromoBannerFormSubmit(event) {
        event.preventDefault();
        ensurePromoBannerElements();
        if (!promoBannerFormElement) {
          return;
        }

        const formData = new FormData(promoBannerFormElement);
        const title = (formData.get("title") || "").toString().trim();
        const description = (formData.get("description") || "").toString().trim();
        const label = (formData.get("label") || "Publicidad").toString().trim() || "Publicidad";
        const ctaLabel = (formData.get("ctaLabel") || "Ver mÃ¡s").toString().trim() || "Ver mÃ¡s";
        const rawLink = (formData.get("ctaLink") || "").toString().trim();
        const expiresValue = (formData.get("expiresAt") || "").toString();
        const textColorValue = (formData.get("textColor") || "").toString();
        const buttonColorValue = (formData.get("buttonColor") || "").toString();
        const imageFile = promoBannerFormElement.querySelector("#promo-banner-image")?.files?.[0] || null;

        if (!title || !description) {
          showToast("Completa el tÃ­tulo y la descripciÃ³n de la campaÃ±a.", "danger");
          return;
        }

        if (!expiresValue) {
          showToast("Define la vigencia de la promociÃ³n.", "danger");
          return;
        }

        const expiresAt = new Date(expiresValue);
        if (Number.isNaN(expiresAt.getTime()) || expiresAt.getTime() <= Date.now()) {
          showToast("Selecciona una fecha futura para la vigencia de la promociÃ³n.", "danger");
          return;
        }

        if (!imageFile) {
          showToast("Selecciona una imagen para el banner.", "danger");
          return;
        }

        let imageData = "";
        try {
          imageData = await readFileAsDataURL(imageFile);
        } catch (error) {
          showToast("OcurriÃ³ un error al procesar la imagen.", "danger");
          return;
        }

        const hasValidLink = /^https?:\/\//i.test(rawLink);
        const ctaLink = hasValidLink ? rawLink : "#";
        const fallbackThemeIndex = state.promoBanners.length % PROMO_BANNER_THEMES.length;
        const theme = nextPromoBannerTheme || PROMO_BANNER_THEMES[fallbackThemeIndex] || "midnight";
        const themeDefaults = getPromoBannerThemeDefaults(theme);
        const textColor = normalizeHexColor(textColorValue) || themeDefaults.textColor;
        const buttonColor = normalizeHexColor(buttonColorValue) || themeDefaults.buttonColor;

        state.promoBanners = [
          ...state.promoBanners,
          {
            id: generateId("banner"),
            label,
            title,
            description,
            ctaLabel,
            ctaLink,
            theme,
            textColor,
            buttonColor,
            image: imageData,
            expiresAt: expiresAt.getTime(),
          },
        ];

        renderPromoBanners();
        showToast("Nuevo banner agregado correctamente.", "success");
        closePromoBannerModal();
      }

      function clearPromoBannerTimers() {
        promoBannerTimers.forEach((timerId) => clearInterval(timerId));
        promoBannerTimers = [];
      }

      function formatTimeRemaining(milliseconds) {
        if (!Number.isFinite(milliseconds) || milliseconds <= 0) {
          return "Finalizada";
        }
        const totalSeconds = Math.floor(milliseconds / 1000);
        const days = Math.floor(totalSeconds / 86400);
        const hours = Math.floor((totalSeconds % 86400) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        const pad = (value) => String(value).padStart(2, "0");
        const segments = [];
        if (days > 0) {
          segments.push(`${days}d`);
        }
        segments.push(`${pad(hours)}h`);
        segments.push(`${pad(minutes)}m`);
        if (days === 0) {
          segments.push(`${pad(seconds)}s`);
        }
        return segments.join(" ");
      }

      function startPromoBannerTimer(timerElement, labelElement, expiresAt) {
        if (!timerElement || !labelElement) {
          return;
        }
        const target = Number(expiresAt);
        if (!Number.isFinite(target)) {
          labelElement.textContent = "Sin fecha definida";
          timerElement.classList.remove("is-expired");
          return;
        }

        const update = () => {
          const remaining = target - Date.now();
          const expired = remaining <= 0;
          labelElement.textContent = formatTimeRemaining(remaining);
          timerElement.classList.toggle("is-expired", expired);
        };

        update();
        const intervalId = window.setInterval(update, 1000);
        promoBannerTimers.push(intervalId);
      }

      function renderPromoBanners() {
        const list = $("#promo-banners-list");
        const emptyState = $("#promo-banners-empty");
        if (!list || !emptyState) {
          return;
        }

        clearPromoBannerTimers();
        list.innerHTML = "";
        const banners = Array.isArray(state.promoBanners) ? state.promoBanners : [];
        const hasBanners = banners.length > 0;

        if (hasBanners) {
          emptyState.classList.add("hidden");
        } else {
          emptyState.classList.remove("hidden");
        }
        list.removeAttribute("aria-hidden");

        banners.forEach((banner) => {
          const item = document.createElement("article");
          item.className = "promo-banners__item";
          item.dataset.theme = banner.theme || PROMO_BANNER_THEMES[0];
          item.setAttribute("role", "listitem");
          if (banner.image) {
            const escapedImage = banner.image.replace(/"/g, '\\"');
            item.style.setProperty("--banner-image", `url("${escapedImage}")`);
          } else {
            item.style.removeProperty("--banner-image");
          }

          const themeDefaults = getPromoBannerThemeDefaults(item.dataset.theme);
          const textColor = normalizeHexColor(banner.textColor) || themeDefaults.textColor;
          if (textColor) {
            item.style.setProperty("--banner-text-color", textColor);
          } else {
            item.style.removeProperty("--banner-text-color");
          }
          const buttonColor = normalizeHexColor(banner.buttonColor) || themeDefaults.buttonColor;
          if (buttonColor) {
            item.style.setProperty("--banner-button-color", buttonColor);
            item.style.setProperty("--banner-button-hover-color", lightenColor(buttonColor));
            item.style.setProperty(
              "--banner-button-text-color",
              getReadableTextColor(buttonColor, textColor || themeDefaults.textColor)
            );
          } else {
            item.style.removeProperty("--banner-button-color");
            item.style.removeProperty("--banner-button-hover-color");
            item.style.removeProperty("--banner-button-text-color");
          }

          const meta = document.createElement("div");
          meta.className = "promo-banner__meta";

          const metaLeft = document.createElement("div");
          metaLeft.className = "promo-banner__meta-left";

          const tag = document.createElement("span");
          tag.className = "promo-banner__tag";
          tag.textContent = banner.label || "Publicidad";

          metaLeft.appendChild(tag);

          const metaRight = document.createElement("div");
          metaRight.className = "promo-banner__meta-right";

          const timer = document.createElement("span");
          timer.className = "promo-banner__timer";
          timer.setAttribute("aria-live", "polite");
          timer.setAttribute("aria-label", "Tiempo restante de la promociÃ³n");
          if (Number.isFinite(Number(banner.expiresAt))) {
            try {
              timer.title = new Date(Number(banner.expiresAt)).toLocaleString("es-CO");
            } catch (error) {
              timer.title = "";
            }
          }

          const timerIcon = document.createElement("i");
          timerIcon.className = "fa-regular fa-clock";
          timerIcon.setAttribute("aria-hidden", "true");

          const timerLabel = document.createElement("span");
          timerLabel.className = "promo-banner__timer-label";

          timer.appendChild(timerIcon);
          timer.appendChild(timerLabel);

          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.className = "promo-banner__remove";
          removeBtn.setAttribute("data-remove-banner", banner.id);
          removeBtn.setAttribute("aria-label", `Eliminar banner â${banner.title}â`);
          removeBtn.innerHTML = '<i class="fa-solid fa-xmark" aria-hidden="true"></i>';
          removeBtn.addEventListener("click", () => handlePromoBannerRemove(banner.id));

          metaRight.appendChild(timer);
          metaRight.appendChild(removeBtn);

          meta.appendChild(metaLeft);
          meta.appendChild(metaRight);

          const body = document.createElement("div");
          body.className = "promo-banner__body";

          const titleEl = document.createElement("h3");
          titleEl.textContent = banner.title || "CampaÃ±a destacada";

          const descEl = document.createElement("p");
          descEl.textContent = banner.description || "Maximiza tu visibilidad dentro del marketplace.";

          body.appendChild(titleEl);
          body.appendChild(descEl);

          const footer = document.createElement("div");
          footer.className = "promo-banner__footer";

          const cta = document.createElement("a");
          cta.className = "promo-banner__cta";
          cta.textContent = banner.ctaLabel || "Ver mÃ¡s";
          const hasExternalLink = Boolean(banner.ctaLink && banner.ctaLink !== "#");
          cta.href = hasExternalLink ? banner.ctaLink : "#";
          if (hasExternalLink) {
            cta.target = "_blank";
            cta.rel = "noopener noreferrer";
          }
          const ctaIcon = document.createElement("i");
          ctaIcon.className = "fa-solid fa-arrow-up-right-from-square";
          ctaIcon.setAttribute("aria-hidden", "true");
          cta.appendChild(ctaIcon);

          footer.appendChild(cta);

          item.appendChild(meta);
          item.appendChild(body);
          item.appendChild(footer);

          list.appendChild(item);

          startPromoBannerTimer(timer, timerLabel, banner.expiresAt);
        });

        const addItem = createPromoBannerAddItem();
        list.appendChild(addItem);

        list.scrollLeft = 0;
        ensurePromoBannersScrollEnhancement();
      }

      function getMediaConstraints(input) {
        if (!input) {
          return { min: 0, max: 10 };
        }
        const min = Number.isFinite(Number(input.dataset.minFiles))
          ? Number(input.dataset.minFiles)
          : 0;
        const max = Number.isFinite(Number(input.dataset.maxFiles)) && Number(input.dataset.maxFiles) > 0
          ? Number(input.dataset.maxFiles)
          : 10;
        return { min, max };
      }

      function resetMediaInput(input) {
        if (!input) {
          return;
        }
        const { max } = getMediaConstraints(input);
        const previewId = input.dataset.previewTarget;
        const counterId = input.dataset.counterTarget;
        if (previewId) {
          const preview = document.getElementById(previewId);
          if (preview) {
            preview.innerHTML = "";
          }
        }
        if (counterId) {
          const counter = document.getElementById(counterId);
          if (counter) {
            const limit = Number.isFinite(max) ? max : 10;
            counter.textContent = `0/${limit} fotos`;
          }
        }
        input.value = "";
      }

      function syncSellOptions(intentKey = activeSellIntent) {
        const buttons = $$(".sell-option-card");
        buttons.forEach((button) => {
          const sellType = button.dataset.sellType || "";
          const isActive = sellType === intentKey;
          button.classList.toggle("is-active", isActive);
          button.setAttribute("aria-pressed", isActive ? "true" : "false");
        });
      }

      function configureSellModal(intentKey = activeSellIntent, { resetForm = true } = {}) {
        const intent = getSellIntent(intentKey);
        const form = $("#sell-form");
        const imagesInput = $("#sell-images");

        if (resetForm && form) {
          form.reset();
        }
        if (resetForm && imagesInput) {
          resetMediaInput(imagesInput);
        }

        activeSellIntent = intentKey;

        const hidden = $("#sell-intent");
        if (hidden) {
          hidden.value = intentKey;
          hidden.setAttribute("value", intentKey);
        }

        const eyebrow = $("#sell-modal-eyebrow");
        if (eyebrow) {
          eyebrow.textContent = `Ventas Â· ${intent.label}`;
        }

        const title = $("#sell-modal-title");
        if (title) {
          title.textContent = `Publicar ${intent.label.toLowerCase()} en venta`;
        }

        const subtitle = $("#sell-modal-subtitle");
        if (subtitle) {
          subtitle.textContent = intent.description;
        }

        const gallerySubtitle = $("#sell-gallery-subtitle");
        if (gallerySubtitle) {
          gallerySubtitle.textContent = intent.gallery;
        }

        const detailsSubtitle = $("#sell-details-subtitle");
        if (detailsSubtitle) {
          detailsSubtitle.textContent = intent.details;
        }

        const typeChip = $("#sell-type-chip");
        if (typeChip) {
          typeChip.textContent = intent.label;
        }

        const nameField = $("#sell-name");
        if (nameField && intent.namePlaceholder) {
          nameField.placeholder = intent.namePlaceholder;
        }

        const locationField = $("#sell-location");
        if (locationField && intent.locationPlaceholder) {
          locationField.placeholder = intent.locationPlaceholder;
        }

        const categoryField = $("#sell-category");
        if (categoryField && resetForm) {
          categoryField.value = intent.defaultCategory || "";
        }

        const feedToggle = $("#sell-feed-toggle");
        if (feedToggle && resetForm) {
          feedToggle.checked = true;
        }

        syncSellOptions(intentKey);
      }

      function openSellSelector() {
        syncSellOptions(activeSellIntent);
        openModal("sell-selector-modal");
      }

      function handleSellOptionSelect(event) {
        const target = event.currentTarget;
        const intentKey = target?.dataset?.sellType || activeSellIntent;
        configureSellModal(intentKey);
        closeModal("sell-selector-modal");
        openModal("sell-modal");
        requestAnimationFrame(() => {
          const focusField = $("#sell-name");
          if (focusField) {
            focusField.focus();
          }
        });
      }

      function openModal(id) {
        const dialog = document.getElementById(id);
        if (!dialog) {
          return;
        }

        if (openModals.has(dialog)) {
          updateModalState();
          return;
        }

        const canUseNative = isDialogSupported && typeof dialog.showModal === "function";
        let fallback = !canUseNative;

        if (canUseNative && !dialog.open) {
          dialog.removeAttribute("data-closing");
          try {
            dialog.showModal();
            fallback = false;
          } catch (error) {
            fallback = true;
          }
        } else if (canUseNative && dialog.open) {
          fallback = dialog.dataset.fallback === "true";
        }

        if (fallback) {
          dialog.setAttribute("open", "true");
          dialog.classList.add("fallback-open");
          if (typeof dialog.focus === "function") {
            dialog.focus();
          }
        } else {
          dialog.classList.remove("fallback-open");
        }

        dialog.dataset.fallback = fallback ? "true" : "false";
        openModals.add(dialog);
        updateModalState();
      }

      function closeModal(id) {
        const dialog = document.getElementById(id);
        if (!dialog) {
          return;
        }

        const finalize = () => {
          dialog.classList.remove("fallback-open");
          dialog.removeAttribute("data-closing");
          dialog.removeAttribute("open");
          delete dialog.dataset.fallback;
          openModals.delete(dialog);
          updateModalState();
        };

        const usesFallback = dialog.dataset.fallback === "true" || dialog.classList.contains("fallback-open");

        if (!usesFallback && isDialogSupported && typeof dialog.close === "function" && dialog.open) {
          if (dialog.hasAttribute("data-closing")) {
            return;
          }

          dialog.setAttribute("data-closing", "true");

          const handleTransition = (event) => {
            if (event.propertyName === "transform") {
              dialog.removeEventListener("transitionend", handleTransition);
              if (dialog.open) {
                dialog.close();
              }
              finalize();
            }
          };

          dialog.addEventListener("transitionend", handleTransition);

          setTimeout(() => {
            if (dialog.hasAttribute("data-closing")) {
              dialog.removeEventListener("transitionend", handleTransition);
              if (dialog.open) {
                dialog.close();
              }
              finalize();
            }
          }, 350);
        } else {
          finalize();
        }
      }

      function readFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(new Error("Error al leer archivo"));
          reader.readAsDataURL(file);
        });
      }

      function ensureAuthenticated(callback) {
        if (!state.currentUser) {
          showToast("Debes crear tu perfil verificado para continuar.", "danger");
          profileMode = "create";
          switchToPage("profile");
          closeSidebar();
          focusProfileForm();
          return false;
        }
        if (typeof callback === "function") callback();
        return true;
      }

      function updateProfileSection() {
        const formCard = $("#profile-form-card");
        const summaryCard = $("#profile-summary");
        if (!formCard || !summaryCard) {
          return;
        }

        const formHeading = $("#profile-form-heading");
        const formHelper = $("#profile-form-helper");
        const submitBtn = $("#profile-submit");
        const cancelBtn = $("#profile-cancel");
        const photoPreview = $("#profile-photo-preview");
        const nameInput = $("#profile-name");
        const emailInput = $("#profile-email");
        const phoneInput = $("#profile-phone");
        ensureLocationSelectorsInitialized();
        const bioInput = $("#profile-bio");
        const photoInput = $("#profile-photo");

        const user = state.currentUser;
        const mode = profileMode || (user ? "view" : "create");
        const previousMode = formCard.dataset.renderedMode || "";
        const modeChanged = previousMode !== mode;
        formCard.dataset.renderedMode = mode;

        const showForm = mode === "create" || mode === "edit" || !user;

        if (showForm) {
          formCard.classList.remove("hidden");
          summaryCard.classList.add("hidden");

          if (formHeading) {
            formHeading.textContent =
              user && mode === "edit" ? "Actualiza tu perfil verificado" : "Crea tu perfil verificado";
          }
          if (formHelper) {
            formHelper.textContent =
              user && mode === "edit"
                ? "Actualiza la informaciÃ³n visible para otros usuarios en tus canjes."
                : "Completa la informaciÃ³n para operar con la comunidad Cambalaches.";
          }
          if (submitBtn) {
            submitBtn.textContent = user && mode === "edit" ? "Guardar cambios" : "Crear perfil";
          }
          if (cancelBtn) {
            cancelBtn.classList.toggle("hidden", !(user && mode === "edit"));
          }

          if (mode === "edit" && user) {
            if (modeChanged) {
              if (nameInput) nameInput.value = user.name || "";
              if (emailInput) emailInput.value = user.email || "";
              if (phoneInput) phoneInput.value = user.phone || "";
              applyLocationToForm(getUserLocationData(user));
              if (bioInput) bioInput.value = user.bio || "";
              if (photoInput) photoInput.value = "";
              if (photoPreview) {
                photoPreview.innerHTML = user.avatar
                  ? `<img src="${user.avatar}" alt="Foto de ${user.name}" />`
                  : '<i class="fa-regular fa-user" aria-hidden="true"></i>';
              }
            }
          } else if (modeChanged) {
            if (nameInput) nameInput.value = "";
            if (emailInput) emailInput.value = "";
            if (phoneInput) phoneInput.value = "";
            applyLocationToForm({ department: "", city: "" });
            if (bioInput) bioInput.value = "";
            if (photoInput) photoInput.value = "";
            if (photoPreview) {
              photoPreview.innerHTML = '<i class="fa-regular fa-user" aria-hidden="true"></i>';
            }
          }
        } else {
          formCard.classList.add("hidden");
          summaryCard.classList.remove("hidden");

          const summaryName = $("#profile-summary-name");
          const summaryMeta = $("#profile-summary-meta");
          const summaryEmail = $("#profile-summary-email");
          const summaryPhone = $("#profile-summary-phone");
          const summaryLocation = $("#profile-summary-location");
          const summaryBio = $("#profile-summary-bio");
          const summaryRating = $("#profile-summary-rating");
          const summaryUpdated = $("#profile-summary-updated");
          const summaryAvatar = $("#profile-summary-avatar");

          if (user) {
            if (summaryName) summaryName.textContent = user.name;
            if (summaryMeta) {
              const joined = user.createdAt
                ? new Date(user.createdAt).toLocaleDateString("es-CO", { month: "long", year: "numeric" })
                : "fecha desconocida";
              summaryMeta.textContent = `Miembro desde ${joined}`;
            }
            if (summaryEmail) summaryEmail.textContent = user.email;
            if (summaryPhone) summaryPhone.textContent = user.phone;
            if (summaryLocation) summaryLocation.textContent = user.location;
            if (summaryBio) {
              summaryBio.textContent = user.bio ? user.bio : "AÃ±ade una breve biografÃ­a para generar confianza.";
            }
            if (summaryRating) {
              const ratingValue = Number(user.rating || 5);
              summaryRating.innerHTML = `<i class="fa-solid fa-star" aria-hidden="true"></i> ${ratingValue.toFixed(1)}`;
            }
            if (summaryUpdated) {
              summaryUpdated.textContent = user.updatedAt
                ? `Actualizado el ${formatDateTime(user.updatedAt)}`
                : "Perfil creado recientemente";
            }
            if (summaryAvatar) {
              summaryAvatar.innerHTML = user.avatar
                ? `<img src="${user.avatar}" alt="Foto de ${user.name}" />`
                : '<i class="fa-regular fa-user" aria-hidden="true"></i>';
            }
          } else {
            if (summaryName) summaryName.textContent = "Invitado";
            if (summaryMeta) summaryMeta.textContent = "Completa tu perfil para que otros te conozcan.";
            if (summaryEmail) summaryEmail.textContent = "â";
            if (summaryPhone) summaryPhone.textContent = "â";
            if (summaryLocation) summaryLocation.textContent = "â";
            if (summaryBio) summaryBio.textContent = "â";
            if (summaryRating) summaryRating.textContent = "â";
            if (summaryUpdated) summaryUpdated.textContent = "Perfil sin verificar";
            if (summaryAvatar) {
              summaryAvatar.innerHTML = '<i class="fa-regular fa-user" aria-hidden="true"></i>';
            }
          }
        }
      }

      function handleProfilePhotoChange(event) {
        const input = event?.target;
        const preview = $("#profile-photo-preview");
        if (!input || !preview) {
          return;
        }
        const file = input.files && input.files[0];
        if (!file) {
          preview.innerHTML = '<i class="fa-regular fa-user" aria-hidden="true"></i>';
          return;
        }
        if (file.type && !file.type.startsWith("image")) {
          showToast("Selecciona una imagen vÃ¡lida para tu perfil.", "danger");
          input.value = "";
          preview.innerHTML = '<i class="fa-regular fa-user" aria-hidden="true"></i>';
          return;
        }
        readFile(file)
          .then((data) => {
            preview.innerHTML = `<img src="${data}" alt="PrevisualizaciÃ³n de foto de perfil" />`;
          })
          .catch(() => {
            showToast("No pudimos previsualizar la imagen seleccionada.", "danger");
            input.value = "";
            preview.innerHTML = '<i class="fa-regular fa-user" aria-hidden="true"></i>';
          });
      }

      function handleAuthPhotoChange(event) {
        const input = event?.target;
        const preview = $("#auth-photo-preview");
        if (!input || !preview) {
          return;
        }
        const file = input.files && input.files[0];
        if (!file) {
          preview.innerHTML = '<i class="fa-regular fa-user" aria-hidden="true"></i>';
          return;
        }
        if (file.type && !file.type.startsWith("image")) {
          showToast("Selecciona una imagen vÃ¡lida para tu perfil.", "danger");
          input.value = "";
          preview.innerHTML = '<i class="fa-regular fa-user" aria-hidden="true"></i>';
          return;
        }
        readFile(file)
          .then((data) => {
            preview.innerHTML = `<img src="${data}" alt="PrevisualizaciÃ³n de foto de perfil" />`;
          })
          .catch(() => {
            showToast("No pudimos previsualizar la imagen seleccionada.", "danger");
            input.value = "";
            preview.innerHTML = '<i class="fa-regular fa-user" aria-hidden="true"></i>';
          });
      }

      function handleProfileSubmit(event) {
        event.preventDefault();
        const form = event?.currentTarget;
        const nameInput = $("#profile-name");
        const emailInput = $("#profile-email");
        const phoneInput = $("#profile-phone");
        const departmentSelect = $("#profile-department");
        const citySelect = $("#profile-city");
        const bioInput = $("#profile-bio");
        const photoInput = $("#profile-photo");
        const name = nameInput ? nameInput.value.trim() : "";
        const email = emailInput ? emailInput.value.trim() : "";
        const phone = phoneInput ? phoneInput.value.trim() : "";
        const department = departmentSelect ? departmentSelect.value : "";
        const city = citySelect ? citySelect.value : "";
        const location = department && city ? `${city}, ${department}` : "";
        const bio = bioInput ? bioInput.value.trim() : "";
        const file = photoInput && photoInput.files ? photoInput.files[0] : null;
        const existingAvatar = state.currentUser && state.currentUser.avatar;

        if (!name || !email || !phone || !department || !city) {
          showToast("Completa todos los campos obligatorios del perfil.", "danger");
          return;
        }

        const finalize = (avatar) => {
          const now = new Date().toISOString();
          const previous = state.currentUser || {};
          const user = {
            ...previous,
            id: previous.id || generateId("user"),
            name,
            email,
            phone,
            location,
            department,
            city,
            bio,
            avatar: avatar || previous.avatar || "",
            rating: Number(previous.rating || 5),
            createdAt: previous.createdAt || now,
            updatedAt: now,
          };
          profileMode = "view";
          setCurrentUser(user);
          if (photoInput) {
            photoInput.value = "";
          }
          if (form && typeof form.reset === "function") {
            form.reset();
          }
          applyLocationToForm({ department: "", city: "" });
          showToast(previous && previous.id ? "Perfil actualizado correctamente." : "Perfil creado correctamente.", "success");
          switchToPage("profile", { scroll: false });
        };

        if (file) {
          if (file.type && !file.type.startsWith("image")) {
            showToast("Selecciona una imagen vÃ¡lida para tu perfil.", "danger");
            return;
          }
          readFile(file)
            .then((data) => finalize(data))
            .catch(() => {
              showToast("No pudimos procesar la imagen seleccionada.", "danger");
            });
        } else if (existingAvatar) {
          finalize(existingAvatar);
        } else {
          showToast("Agrega una foto de perfil para completar tu registro.", "danger");
        }
      }

      function startProfileEdit() {
        profileMode = state.currentUser ? "edit" : "create";
        updateProfileSection();
        focusProfileForm();
      }

      function cancelProfileEdit() {
        profileMode = state.currentUser ? "view" : "create";
        updateProfileSection();
      }

      function updateProfileCard() {
        const navAvatar = $("#nav-avatar");
        const sidebarAvatar = $("#sidebar-user-avatar");
        const sidebarName = $("#sidebar-user-name");
        const sidebarMeta = $("#sidebar-user-meta");

        if (navAvatar) {
          if (!state.currentUser) {
            navAvatar.classList.add("hidden");
            navAvatar.innerHTML = "";
          } else {
            navAvatar.innerHTML = `<img src="${state.currentUser.avatar}" alt="${state.currentUser.name}" />`;
            navAvatar.classList.remove("hidden");
          }
        }

        if (sidebarAvatar && sidebarName && sidebarMeta) {
          if (!state.currentUser) {
            sidebarAvatar.innerHTML = '<i class="fa-regular fa-user" aria-hidden="true"></i>';
            sidebarName.textContent = "Invitado";
            sidebarMeta.textContent = "Crea tu perfil para comenzar a intercambiar.";
          } else {
            sidebarAvatar.innerHTML = state.currentUser.avatar
              ? `<img src="${state.currentUser.avatar}" alt="${state.currentUser.name}" />`
              : '<i class="fa-regular fa-user" aria-hidden="true"></i>';
            sidebarName.textContent = state.currentUser.name;
            sidebarMeta.textContent = state.currentUser.location
              ? `UbicaciÃ³n: ${state.currentUser.location}`
              : "Perfil verificado";
          }
        }
      }

      function renderMostViewed() {
        const list = $("#most-viewed-list");
        if (!list) {
          return;
        }

        const scroller = enhanceHorizontalScroll(list, {
          snapToChildren: true,
          snapSelector: ".most-viewed-card",
          snapOnWheel: true,
        });
        const refreshScroll = () => {
          if (scroller && typeof scroller.refresh === "function") {
            scroller.refresh();
          }
        };

        list.innerHTML = "";

        const products = Array.from(state.products)
          .sort((a, b) => (Number(b?.views) || 0) - (Number(a?.views) || 0))
          .slice(0, 6);

        if (!products.length) {
          const empty = document.createElement("div");
          empty.className = "most-viewed-empty";
          empty.innerHTML =
            '<i class="fa-regular fa-eye-slash" aria-hidden="true"></i><p style="margin:0.45rem 0 0; max-width: 240px;">Explora y publica artÃ­culos para que destaquemos aquÃ­ los mÃ¡s populares.</p>';
          list.appendChild(empty);
          refreshScroll();
          return;
        }

        products.forEach((product, index) => {
          const card = document.createElement("article");
          card.className = "most-viewed-card";
          card.setAttribute("role", "listitem");
          card.setAttribute("tabindex", "0");
          card.setAttribute(
            "aria-label",
            `${product.title} con ${formatViews(product.views ?? 0)} vistas`
          );

          const media = document.createElement("div");
          media.className = "most-viewed-media";
          const img = document.createElement("img");
          img.src = product.images?.[0] || FALLBACK_IMAGE;
          img.alt = product.title;
          media.appendChild(img);

          const rank = document.createElement("span");
          rank.className = "most-viewed-rank";
          rank.textContent = `#${index + 1}`;
          media.appendChild(rank);

          const viewsBadge = document.createElement("span");
          viewsBadge.className = "most-viewed-views";
          viewsBadge.innerHTML = `<i class="fa-regular fa-eye" aria-hidden="true"></i>${formatViews(
            product.views ?? 0
          )} vistas`;
          viewsBadge.setAttribute(
            "aria-label",
            `${formatViews(product.views ?? 0)} vistas registradas`
          );
          media.appendChild(viewsBadge);

          const body = document.createElement("div");
          body.className = "most-viewed-body";

          const category = document.createElement("span");
          category.className = "most-viewed-category";
          category.textContent = titleize(getCategoryLabel(product.category));
          body.appendChild(category);

          const title = document.createElement("h5");
          title.className = "most-viewed-title";
          title.textContent = product.title;
          body.appendChild(title);

          const meta = document.createElement("div");
          meta.className = "most-viewed-meta";

          const location = document.createElement("span");
          const locationIcon = document.createElement("i");
          locationIcon.className = "fa-solid fa-location-dot";
          locationIcon.setAttribute("aria-hidden", "true");
          const locationText = document.createElement("span");
          locationText.textContent = product.location;
          location.append(locationIcon, locationText);
          meta.appendChild(location);

          const baseRating =
            product.rating != null
              ? Number(product.rating)
              : product.owner?.rating != null
              ? Number(product.owner.rating)
              : null;
          const rating = document.createElement("span");
          rating.className = "most-viewed-rating";
          if (Number.isFinite(baseRating)) {
            rating.innerHTML = `<i class="fa-solid fa-star" aria-hidden="true"></i>${baseRating.toFixed(1)}`;
            rating.setAttribute("aria-label", `${baseRating.toFixed(1)} sobre 5`);
          } else {
            rating.classList.add("is-new");
            rating.innerHTML = '<i class="fa-regular fa-star" aria-hidden="true"></i>Nuevo';
            rating.setAttribute("aria-label", "ArtÃ­culo nuevo sin calificaciones");
          }
          meta.appendChild(rating);

          body.appendChild(meta);

          card.append(media, body);
          list.appendChild(card);

          const openDetail = () => openProductDetail(product);
          card.addEventListener("click", openDetail);
          card.addEventListener("keydown", (event) => {
            if (event.key === "Enter" || event.key === " ") {
              event.preventDefault();
              openDetail();
            }
          });
        });

        refreshScroll();
      }

      function renderFeed() {
        const grid = $("#feed-grid");
        const empty = $("#feed-empty");
        if (!grid || !empty) {
          return;
        }
        grid.innerHTML = "";

        const categorySelect = $("#filter-category");
        const locationInput = $("#filter-location");
        const minInput = $("#filter-min");
        const maxInput = $("#filter-max");
        const keywordInput = $("#filter-keyword");
        const styleInput = $("#filter-style");

        const category = categorySelect ? categorySelect.value : "";
        const location = locationInput ? locationInput.value.trim().toLowerCase() : "";
        const minLimit = PRICE_LIMITS.min;
        const maxLimit = PRICE_LIMITS.max;
        const rawMin = minInput ? safeNumber(minInput.value, minLimit) : minLimit;
        const sliderCap = maxInput ? safeNumber(maxInput.max, maxLimit) : maxLimit;
        const rawMax = maxInput ? safeNumber(maxInput.value, sliderCap) : sliderCap;
        const min = Math.max(minLimit, Math.min(rawMin, sliderCap));
        const max =
          rawMax >= sliderCap
            ? Number.MAX_SAFE_INTEGER
            : Math.max(min, Math.min(rawMax, sliderCap));
        const keyword = keywordInput ? keywordInput.value.trim().toLowerCase() : "";
        const layoutStyle = styleInput ? styleInput.value || "marketplace" : "marketplace";

        grid.classList.toggle("mode-ecommerce", layoutStyle === "ecommerce");
        grid.classList.toggle("mode-marketplace", layoutStyle !== "ecommerce");

        const results = state.products.filter((product) => {
          const matchesCategory = category ? product.category === category : true;
          const matchesLocation = location
            ? product.location.toLowerCase().includes(location)
            : true;
          const matchesKeyword = keyword
            ? `${product.title} ${product.description}`.toLowerCase().includes(keyword)
            : true;
          const matchesPrice = product.price >= min && product.price <= max;
          return matchesCategory && matchesLocation && matchesKeyword && matchesPrice;
        });

        if (!results.length) {
          empty.classList.remove("hidden");
          return;
        }

        empty.classList.add("hidden");

        results.forEach((product) => {
          const card = document.createElement("article");
          card.className = "product-card";
          card.setAttribute("role", "button");
          card.setAttribute("tabindex", "0");
          card.setAttribute("aria-label", `Ver detalles de ${product.title}`);

          const media = document.createElement("div");
          media.className = "product-card-media";
          const img = document.createElement("img");
          img.src = product.images?.[0] || FALLBACK_IMAGE;
          img.alt = product.title;
          media.appendChild(img);

          const priceBadge = document.createElement("span");
          priceBadge.className = "product-card-badge";
          priceBadge.textContent = formatCOP(product.price);
          media.appendChild(priceBadge);

          const body = document.createElement("div");
          body.className = "product-card-body";

          const topRow = document.createElement("div");
          topRow.className = "product-card-top";

          const categoryChip = document.createElement("span");
          categoryChip.className = "product-card-category";
          categoryChip.textContent = titleize(getCategoryLabel(product.category));
          topRow.appendChild(categoryChip);

          const baseRating =
            product.rating != null
              ? Number(product.rating)
              : product.owner?.rating != null
              ? Number(product.owner.rating)
              : null;
          const rating = document.createElement("span");
          rating.className = "product-card-rating";
          if (Number.isFinite(baseRating)) {
            rating.innerHTML = `<i class="fa-solid fa-star" aria-hidden="true"></i>${baseRating.toFixed(1)}`;
          } else {
            rating.classList.add("is-new");
            rating.innerHTML = '<i class="fa-regular fa-star" aria-hidden="true"></i>Nuevo';
          }
          rating.setAttribute("aria-label", Number.isFinite(baseRating) ? `${baseRating.toFixed(1)} sobre 5` : "Nuevo artÃ­culo sin calificaciones");
          topRow.appendChild(rating);

          const title = document.createElement("h3");
          title.className = "product-card-title";
          title.textContent = product.title;

          const locationRow = document.createElement("p");
          locationRow.className = "product-card-location";
          const locationIcon = document.createElement("i");
          locationIcon.className = "fa-solid fa-location-dot";
          locationIcon.setAttribute("aria-hidden", "true");
          const locationText = document.createElement("span");
          locationText.textContent = product.location;
          locationRow.append(locationIcon, locationText);

          const footer = document.createElement("div");
          footer.className = "product-card-footer";

          const owner = document.createElement("div");
          owner.className = "product-card-owner";
          const ownerAvatar = document.createElement("img");
          ownerAvatar.src = product.owner?.avatar || FALLBACK_AVATAR;
          ownerAvatar.alt = product.owner?.name ? `Perfil de ${product.owner.name}` : "Perfil del propietario";
          const ownerMeta = document.createElement("div");
          ownerMeta.className = "owner-meta";
          const ownerName = document.createElement("span");
          ownerName.className = "owner-name";
          ownerName.textContent = product.owner?.name || "Propietario anÃ³nimo";
          const ownerScore = document.createElement("span");
          ownerScore.textContent = product.owner?.rating != null
            ? `${Number(product.owner.rating).toFixed(1)} reputaciÃ³n`
            : "Nuevo en Cambalaches";
          ownerMeta.append(ownerName, ownerScore);
          owner.append(ownerAvatar, ownerMeta);

          const cta = document.createElement("span");
          cta.className = "product-card-cta";
          const ctaIcon = document.createElement("i");
          ctaIcon.className = "fa-solid fa-arrow-trend-up";
          ctaIcon.setAttribute("aria-hidden", "true");
          const ctaText = document.createElement("span");
          ctaText.textContent = "Ver flujo";
          cta.append(ctaIcon, ctaText);

          footer.append(owner, cta);

          body.append(topRow, title, locationRow, footer);

          card.append(media, body);
          grid.appendChild(card);

          const openDetail = () => openProductDetail(product);
          card.addEventListener("click", openDetail);
          card.addEventListener("keydown", (event) => {
            if (event.key === "Enter" || event.key === " ") {
              event.preventDefault();
              openDetail();
            }
          });
        });
      }

      function closeProductDetail() {
        const detail = $("#product-detail");
        if (!detail) {
          return;
        }
        detail.setAttribute("aria-hidden", "true");
        detail.classList.remove("open");
        document.body.classList.remove("detail-open");
        activeProductDetail = null;
      }

      function openProductDetail(product) {
        const detail = $("#product-detail");
        if (!detail || !product) {
          showToast("No pudimos abrir el detalle del artÃ­culo.", "danger");
          return;
        }

        const currentViews = Number.isFinite(Number(product.views)) ? Number(product.views) : 0;
        product.views = currentViews + 1;
        renderMostViewed();

        activeProductDetail = product;

        const images = Array.isArray(product.images) && product.images.length ? product.images : [FALLBACK_IMAGE];
        const mainImage = $("#product-detail-image");
        if (mainImage) {
          mainImage.src = images[0];
          mainImage.alt = `${product.title} imagen principal`;
        }

        const priceEl = $("#product-detail-price");
        if (priceEl) {
          priceEl.textContent = formatCOP(product.price);
        }

        const thumbs = $("#product-detail-thumbs");
        if (thumbs) {
          thumbs.innerHTML = "";
          images.forEach((src, index) => {
            const thumbBtn = document.createElement("button");
            thumbBtn.type = "button";
            thumbBtn.className = "product-detail-thumb";
            if (index === 0) {
              thumbBtn.classList.add("active");
            }
            thumbBtn.setAttribute("aria-label", `Ver imagen ${index + 1} de ${product.title}`);
            const thumbImg = document.createElement("img");
            thumbImg.src = src;
            thumbImg.alt = `${product.title} imagen ${index + 1}`;
            thumbBtn.appendChild(thumbImg);
            thumbBtn.addEventListener("click", () => {
              if (mainImage) {
                mainImage.src = src;
                mainImage.alt = `${product.title} imagen principal`;
              }
              $$(".product-detail-thumb", thumbs).forEach((button) =>
                button.classList.toggle("active", button === thumbBtn)
              );
            });
            thumbs.appendChild(thumbBtn);
          });
        }

        const categoryEl = $("#product-detail-category");
        if (categoryEl) {
          categoryEl.textContent = titleize(getCategoryLabel(product.category));
        }

        const ratingEl = $("#product-detail-rating");
        if (ratingEl) {
          const baseRating =
            product.rating != null
              ? Number(product.rating)
              : product.owner?.rating != null
              ? Number(product.owner.rating)
              : null;
          if (Number.isFinite(baseRating)) {
            ratingEl.innerHTML = `<i class="fa-solid fa-star" aria-hidden="true"></i>${baseRating.toFixed(
              1
            )} confiabilidad`;
          } else {
            ratingEl.innerHTML = '<i class="fa-regular fa-star" aria-hidden="true"></i>ArtÃ­culo nuevo';
          }
        }

        const titleEl = $("#product-detail-title");
        if (titleEl) {
          titleEl.textContent = product.title;
        }

        const locationEl = $("#product-detail-location");
        if (locationEl) {
          locationEl.innerHTML = `<i class="fa-solid fa-location-dot" aria-hidden="true"></i><span>${product.location}</span>`;
        }

        const tagsEl = $("#product-detail-tags");
        if (tagsEl) {
          tagsEl.innerHTML = "";
          const tags = Array.isArray(product.tags) ? product.tags.filter(Boolean) : [];
          const items = tags.length ? tags.slice(0, 5) : [getCategoryLabel(product.category)];
          items.forEach((tag) => {
            const chip = document.createElement("span");
            chip.className = "product-detail-tag";
            chip.textContent = titleize(tag);
            tagsEl.appendChild(chip);
          });
        }

        const descriptionEl = $("#product-detail-description");
        if (descriptionEl) {
          descriptionEl.textContent = product.description;
        }

        const ownerAvatarEl = $("#product-detail-owner-avatar");
        if (ownerAvatarEl) {
          ownerAvatarEl.src = product.owner?.avatar || FALLBACK_AVATAR;
          ownerAvatarEl.alt = product.owner?.name
            ? `Retrato de ${product.owner.name}`
            : "Propietario del artÃ­culo";
        }

        const ownerNameEl = $("#product-detail-owner-name");
        if (ownerNameEl) {
          ownerNameEl.textContent = product.owner?.name || "Propietario anÃ³nimo";
        }

        const ownerMetaEl = $("#product-detail-owner-meta");
        if (ownerMetaEl) {
          ownerMetaEl.textContent =
            product.owner?.rating != null
              ? `${Number(product.owner.rating).toFixed(1)} reputaciÃ³n verificada`
              : "AÃºn sin reseÃ±as";
        }

        const ownerLocationEl = $("#product-detail-owner-location");
        if (ownerLocationEl) {
          const origin = product.owner?.location || product.location;
          ownerLocationEl.innerHTML = `<i class="fa-solid fa-location-arrow" aria-hidden="true"></i>${origin}`;
        }

        const bodyPanel = detail.querySelector(".product-detail-body");
        if (bodyPanel) {
          bodyPanel.scrollTop = 0;
        }

        detail.setAttribute("aria-hidden", "false");
        detail.classList.add("open");
        document.body.classList.add("detail-open");
        const closeBtn = detail.querySelector(".product-detail-close");
        closeBtn?.focus();
      }

      function renderMyItems() {
        const list = $("#my-items-list");
        const empty = $("#my-items-empty");
        if (!list || !empty) {
          return;
        }
        list.innerHTML = "";

        if (!state.currentUser) {
          empty.classList.remove("hidden");
          list.classList.add("hidden");
          return;
        }

        const mine = state.products.filter((product) => product.owner.id === state.currentUser.id);
        if (!mine.length) {
          empty.classList.remove("hidden");
          list.classList.add("hidden");
          return;
        }

        empty.classList.add("hidden");
        list.classList.remove("hidden");

        mine.forEach((product) => {
          const card = document.createElement("div");
          card.className = "exchange-card";
          card.innerHTML = `
            <div style="display:flex; gap:1rem; align-items:flex-start;">
              <div style="flex:0 0 120px; border-radius:var(--radius-md); overflow:hidden;">
                <img src="${product.images[0]}" alt="${product.title}" style="width:100%;height:100%;object-fit:cover;" />
              </div>
              <div style="flex:1; display:grid; gap:0.45rem;">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:1rem;">
                  <h4 style="margin:0;">${product.title}</h4>
                  <span class="badge">${product.category}</span>
                </div>
                <span class="highlight">${formatCOP(product.price)}</span>
                <p style="margin:0; color:var(--muted); line-height:1.5;">${product.description}</p>
                <span style="color:var(--muted); font-size:0.9rem;"><i class="fa-solid fa-location-dot" style="color: var(--primary-600);"></i> ${product.location}</span>
                <div style="display:flex; gap:0.75rem; flex-wrap:wrap;">
                  <button class="btn btn-outline" type="button" data-edit="${product.id}">Editar</button>
                  <button class="btn btn-outline" type="button" data-remove="${product.id}">Marcar como canjeado</button>
                </div>
              </div>
            </div>
          `;
          list.appendChild(card);
        });

        $$("[data-edit]", list).forEach((btn) =>
          btn.addEventListener("click", () => showToast("La ediciÃ³n avanzada estarÃ¡ disponible pronto.", "info"))
        );
        $$("[data-remove]", list).forEach((btn) =>
          btn.addEventListener("click", (event) => {
            const id = event.currentTarget.getAttribute("data-remove");
            state.products = state.products.filter((product) => product.id !== id);
            showToast("ArtÃ­culo marcado como canjeado.", "success");
            updateUI();
          })
        );
      }

      function renderOffers() {
        const sentList = $("#sent-offers");
        const receivedList = $("#received-offers");
        const sentEmpty = $("#sent-empty");
        const receivedEmpty = $("#received-empty");
        if (!sentList || !receivedList || !sentEmpty || !receivedEmpty) {
          return;
        }
        sentList.innerHTML = "";
        receivedList.innerHTML = "";

        if (!state.currentUser) {
          sentEmpty.classList.remove("hidden");
          receivedEmpty.classList.remove("hidden");
          return;
        }

        if (!state.offersSent.length) {
          sentEmpty.classList.remove("hidden");
        } else {
          sentEmpty.classList.add("hidden");
          state.offersSent.forEach((offer) => {
            const card = document.createElement("div");
            card.className = "exchange-card";
            card.innerHTML = `
              <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:1rem;">
                <div>
                  <h4 style="margin:0;">Oferta a ${offer.product.owner.name}</h4>
                  <p style="margin:0.35rem 0; color:var(--muted);">${offer.product.title}</p>
                  <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                    ${offer.items
                      .map((item) => `<span class="tag">${item.title} Â· ${formatCOP(item.price)}</span>`)
                      .join("")}
                  </div>
                  <p style="margin:0.35rem 0 0; color:var(--muted);">
                    Diferencia: <strong>${formatCOP(offer.difference)}</strong>
                    ${offer.difference >= 0 ? "a tu favor" : "a favor del receptor"}
                  </p>
                  ${
                    offer.extra > 0
                      ? `<p style="margin:0; color:var(--muted);">CompensaciÃ³n en COP: <strong>${formatCOP(
                          offer.extra
                        )}</strong></p>`
                      : ""
                  }
                </div>
                <span class="exchange-status status-pendiente">${offer.status}</span>
              </div>
            `;
            sentList.appendChild(card);
          });
        }

        if (!state.offersReceived.length) {
          receivedEmpty.classList.remove("hidden");
        } else {
          receivedEmpty.classList.add("hidden");
          state.offersReceived.forEach((offer) => {
            const card = document.createElement("div");
            card.className = "exchange-card";
            card.innerHTML = `
              <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:1rem;">
                <div>
                  <h4 style="margin:0;">${offer.proposer.name} desea tu ${offer.product.title}</h4>
                  <p style="margin:0.35rem 0; color:var(--muted);">Mensaje: ${offer.notes}</p>
                  <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                    ${offer.items
                      .map((item) => `<span class="tag">${item.title} Â· ${formatCOP(item.price)}</span>`)
                      .join("")}
                  </div>
                  <p style="margin:0.35rem 0 0; color:var(--muted);">
                    Oferta total: <strong>${formatCOP(
                      offer.items.reduce((sum, item) => sum + item.price, 0) + offer.extra
                    )}</strong>
                  </p>
                  <p style="margin:0; color:var(--muted);">
                    Diferencia frente a tu artÃ­culo: <strong>${formatCOP(offer.difference)}</strong> ${offer.difference >= 0 ? '(recibirÃ­as valor extra)' : '(deben equilibrar con mÃ¡s valor)'}
                  </p>
                </div>
                <div style="display:grid; gap:0.6rem;">
                  <span class="exchange-status status-pendiente">Pendiente de tu respuesta</span>
                  <button class="btn btn-primary" type="button" data-accept="${offer.id}">Aceptar canje</button>
                  <button class="btn btn-outline" type="button" data-negotiate="${offer.id}">Negociar</button>
                  <button class="btn btn-outline" type="button" data-reject="${offer.id}">Rechazar</button>
                </div>
              </div>
            `;
            receivedList.appendChild(card);
          });

          $$("[data-accept]", receivedList).forEach((btn) =>
            btn.addEventListener("click", (event) => {
              const id = event.currentTarget.getAttribute("data-accept");
              const offer = state.offersReceived.find((item) => item.id === id);
              if (!offer) return;
              state.offersReceived = state.offersReceived.filter((item) => item.id !== id);
              state.activeAgreements.push({
                id: generateId("agreement"),
                role: "owner",
                status: "Pendiente de entrega",
                startedAt: new Date(),
                offer,
                chat: [
                  {
                    author: offer.proposer.name,
                    message: "Gracias por aceptar, coordino entrega en tu horario.",
                    me: false,
                    timestamp: new Date(),
                  },
                ],
              });
              showToast("Has aceptado el canje. Coordina la entrega.", "success");
              updateUI();
            })
          );

          $$("[data-negotiate]", receivedList).forEach((btn) =>
            btn.addEventListener("click", (event) => {
              const id = event.currentTarget.getAttribute("data-negotiate");
              const offer = state.offersReceived.find((item) => item.id === id);
              if (!offer) return;
              openNegotiateModal(offer);
            })
          );

          $$("[data-reject]", receivedList).forEach((btn) =>
            btn.addEventListener("click", (event) => {
              const id = event.currentTarget.getAttribute("data-reject");
              state.offersReceived = state.offersReceived.filter((item) => item.id !== id);
              showToast("Oferta rechazada.", "info");
              updateUI();
            })
          );
        }
      }

      function renderAgreements() {
        const list = $("#active-agreements");
        const empty = $("#agreements-empty");
        if (!list || !empty) {
          return;
        }
        list.innerHTML = "";

        if (!state.currentUser || !state.activeAgreements.length) {
          empty.classList.remove("hidden");
          return;
        }

        empty.classList.add("hidden");

        state.activeAgreements.forEach((agreement) => {
          const card = document.createElement("div");
          card.className = "exchange-card";
          const offer = agreement.offer;
          const totalOffer = offer.items.reduce((sum, item) => sum + item.price, 0) + offer.extra;
          card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:1rem;">
              <div style="display:grid; gap:0.5rem;">
                <h4 style="margin:0;">${offer.proposer.name} â ${state.currentUser.name}</h4>
                <span class="exchange-status status-entrega">${agreement.status}</span>
                <p style="margin:0; color:var(--muted);">Producto objetivo: <strong>${offer.product.title}</strong></p>
                <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                  ${offer.items
                    .map((item) => `<span class="tag">${item.title} Â· ${formatCOP(item.price)}</span>`)
                    .join("")}
                </div>
                <p style="margin:0; color:var(--muted);">Total de la oferta: <strong>${formatCOP(totalOffer)}</strong></p>
              </div>
              <div style="display:grid; gap:0.6rem;">
                <button class="btn btn-primary" type="button" data-complete="${agreement.id}">Marcar completado</button>
              </div>
            </div>
            <div class="chat-box">
              <strong>Chat seguro</strong>
              <div class="chat-messages" data-chat="${agreement.id}"></div>
              <div class="chat-input">
                <input type="text" placeholder="Escribe un mensaje" data-chat-input="${agreement.id}" />
                <button type="button" data-chat-send="${agreement.id}">Enviar</button>
              </div>
            </div>
          `;
          list.appendChild(card);
        });

        state.activeAgreements.forEach((agreement) => {
          const container = $(`[data-chat="${agreement.id}"]`);
          container.innerHTML = "";
          agreement.chat.forEach((message) => {
            const bubble = document.createElement("div");
            bubble.className = `chat-message ${message.me ? "me" : ""}`;
            bubble.innerHTML = `
              <small>${message.me ? "TÃº" : message.author} Â· ${new Date(message.timestamp).toLocaleString("es-CO", {
                hour: "2-digit",
                minute: "2-digit",
              })}</small>
              <span>${message.message}</span>
            `;
            container.appendChild(bubble);
          });
        });

        $$("[data-chat-send]").forEach((btn) =>
          btn.addEventListener("click", (event) => {
            const id = event.currentTarget.getAttribute("data-chat-send");
            const input = $(`[data-chat-input="${id}"]`);
            if (!input.value.trim()) return;
            const agreement = state.activeAgreements.find((item) => item.id === id);
            agreement.chat.push({
              author: state.currentUser.name,
              message: input.value.trim(),
              me: true,
              timestamp: new Date(),
            });
            input.value = "";
            renderAgreements();
          })
        );

        $$("[data-complete]").forEach((btn) =>
          btn.addEventListener("click", (event) => {
            const id = event.currentTarget.getAttribute("data-complete");
            const agreement = state.activeAgreements.find((item) => item.id === id);
            if (!agreement) return;
            state.activeAgreements = state.activeAgreements.filter((item) => item.id !== id);
            state.history.push({
              id: generateId("history"),
              completedAt: new Date(),
              offer: agreement.offer,
              rating: null,
              comment: "",
            });
            showToast("Canje marcado como completado. Califica a tu contraparte.", "success");
            updateUI();
          })
        );
      }

      function renderHistory() {
        const list = $("#history-list");
        const empty = $("#history-empty");
        if (!list || !empty) {
          return;
        }
        list.innerHTML = "";

        if (!state.currentUser || !state.history.length) {
          empty.classList.remove("hidden");
          return;
        }

        empty.classList.add("hidden");

        state.history.forEach((entry) => {
          const { offer } = entry;
          const totalOffer = offer.items.reduce((sum, item) => sum + item.price, 0) + offer.extra;
          const card = document.createElement("div");
          card.className = "history-card";
          card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; gap:1rem;">
              <h4 style="margin:0;">${offer.proposer.name} â ${state.currentUser.name}</h4>
              <span style="color:var(--muted); font-size:0.85rem;">${new Date(entry.completedAt).toLocaleDateString("es-CO")}</span>
            </div>
            <p style="margin:0; color:var(--muted);">Producto canjeado: <strong>${offer.product.title}</strong></p>
            <p style="margin:0; color:var(--muted);">Valor total recibido: <strong>${formatCOP(totalOffer)}</strong></p>
            <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
              ${offer.items
                .map((item) => `<span class="tag">${item.title} Â· ${formatCOP(item.price)}</span>`)
                .join("")}
            </div>
            ${
              entry.rating
                ? `<p style="margin:0;">CalificaciÃ³n dada: <strong>${entry.rating} â­</strong><br/>Comentario: ${entry.comment}</p>`
                : `<div>
                    <span style="display:block; margin-bottom:0.4rem;">Califica a ${offer.proposer.name}</span>
                    <div class="rating-control" data-rate="${entry.id}">
                      ${Array.from({ length: 5 })
                        .map((_, index) => `<i class="fa-solid fa-star" data-value="${index + 1}"></i>`)
                        .join("")}
                    </div>
                    <textarea data-comment="${entry.id}" placeholder="Comparte tu experiencia"></textarea>
                    <button class="btn btn-primary" type="button" data-save-review="${entry.id}">Guardar reseÃ±a</button>
                  </div>`
            }
          `;
          list.appendChild(card);
        });

        $$("[data-rate]").forEach((wrapper) => {
          wrapper.addEventListener("click", (event) => {
            const star = event.target.closest("[data-value]");
            if (!star) return;
            const value = Number(star.getAttribute("data-value"));
            wrapper.dataset.selected = value;
            $$("[data-value]", wrapper).forEach((item) => {
              const starValue = Number(item.getAttribute("data-value"));
              item.style.color = starValue <= value ? "#fbbf24" : "#d1d5db";
            });
          });
        });

        $$("[data-save-review]").forEach((btn) =>
          btn.addEventListener("click", (event) => {
            const id = event.currentTarget.getAttribute("data-save-review");
            const wrapper = $(`[data-rate="${id}"]`);
            const commentField = $(`[data-comment="${id}"]`);
            const rating = wrapper ? Number(wrapper.dataset.selected) : NaN;
            if (!rating || Number.isNaN(rating)) {
              showToast("Selecciona una calificaciÃ³n antes de guardar.", "danger");
              return;
            }
            const comment = commentField ? commentField.value.trim() : "";
            const entry = state.history.find((item) => item.id === id);
            if (!entry) {
              showToast("No encontramos el canje a calificar.", "danger");
              return;
            }
            entry.rating = rating;
            entry.comment = comment;
            state.reviews.push({
              id: generateId("review"),
              rating,
              comment,
              counterpart: entry.offer.proposer.name,
              createdAt: new Date(),
            });
            showToast("Â¡Gracias por calificar!", "success");
            updateUI();
          })
        );
      }

      function renderReviews() {
        const list = $("#review-list");
        const empty = $("#review-empty");
        if (!list || !empty) {
          return;
        }
        list.innerHTML = "";

        if (!state.currentUser || !state.reviews.length) {
          empty.classList.remove("hidden");
          return;
        }

        empty.classList.add("hidden");

        state.reviews.forEach((review) => {
          const card = document.createElement("div");
          card.className = "review-card";
          card.innerHTML = `
            <strong>${review.counterpart}</strong>
            <span>${"â".repeat(review.rating)}${"â".repeat(5 - review.rating)}</span>
            <p style="margin:0; color:var(--muted);">${review.comment || "Sin comentarios adicionales."}</p>
            <small style="color:var(--muted);">${new Date(review.createdAt).toLocaleDateString("es-CO")}</small>
          `;
          list.appendChild(card);
        });
      }

      function openOfferModal(product) {
        if (!ensureAuthenticated()) return;
        const myItems = state.products.filter((item) => item.owner.id === state.currentUser.id);
        if (!myItems.length) {
          showToast("Publica primero tus artÃ­culos para poder ofertar.", "danger");
          return;
        }

        const content = $("#offer-content");
        if (!content) {
          showToast("No pudimos cargar el formulario de oferta.", "danger");
          return;
        }
        content.innerHTML = "";
        const info = document.createElement("div");
        info.innerHTML = `
          <div class="difference-badge">
            <span>EstÃ¡s ofertando por</span>
            <strong>${product.title}</strong>
            <span>Valor objetivo: ${formatCOP(product.price)}</span>
          </div>
        `;
        content.appendChild(info);

        const list = document.createElement("div");
        list.className = "offer-items";
        myItems.forEach((item) => {
          const row = document.createElement("label");
          row.className = "offer-item";
          row.innerHTML = `
            <input type="checkbox" value="${item.id}" data-price="${item.price}" data-title="${item.title}" />
            <div style="display:grid; gap:0.2rem;">
              <span>${item.title}</span>
              <small>${formatCOP(item.price)}</small>
            </div>
          `;
          list.appendChild(row);
        });

        const cashRow = document.createElement("div");
        cashRow.className = "form-row";
        cashRow.innerHTML = `
          <label class="field">
            <span>CompensaciÃ³n adicional en COP (opcional)</span>
            <input type="number" min="0" step="1000" id="offer-extra" />
          </label>
        `;

        const summary = document.createElement("div");
        summary.className = "difference-badge";
        summary.id = "offer-summary";
        summary.innerHTML = `
          <span>Total de tu oferta: <strong>${formatCOP(0)}</strong></span>
          <span>Diferencia vs artÃ­culo objetivo: <strong>${formatCOP(-product.price)}</strong></span>
          <small>Selecciona artÃ­culos y agrega compensaciÃ³n si tu oferta es menor.</small>
        `;

        content.append(list, cashRow, summary);
        openModal("offer-modal");

        const extraInput = $("#offer-extra");

        const updateSummary = () => {
          const selected = $$("input[type='checkbox'][data-price]:checked", content);
          const extra = extraInput ? Number(extraInput.value || 0) : 0;
          const totalProducts = selected.reduce((sum, input) => sum + Number(input.dataset.price), 0);
          const totalOffer = totalProducts + extra;
          const difference = totalOffer - product.price;
          summary.innerHTML = `
            <span>Total de tu oferta: <strong>${formatCOP(totalOffer)}</strong></span>
            <span>Diferencia vs artÃ­culo objetivo: <strong>${formatCOP(difference)}</strong></span>
            <small>${
              difference >= 0
                ? "Tu oferta cubre el valor del artÃ­culo."
                : "Agrega mÃ¡s productos o compensaciÃ³n para equilibrar la oferta."
            }</small>
          `;
          summary.dataset.difference = difference;
          summary.dataset.total = totalOffer;
        };

        list.addEventListener("change", updateSummary);
        if (extraInput) {
          extraInput.addEventListener("input", updateSummary);
        }
        updateSummary();

        const form = $("#offer-form");
        if (!form) {
          showToast("Formulario de oferta no disponible.", "danger");
          return;
        }
        form.onsubmit = (event) => {
          event.preventDefault();
          const selected = $$("input[type='checkbox'][data-price]:checked", content);
          if (!selected.length) {
            showToast("Selecciona al menos un artÃ­culo propio para ofertar.", "danger");
            return;
          }
          const currentExtra = extraInput ? Number(extraInput.value || 0) : 0;
          const total = Number(summary.dataset.total || 0);
          const difference = Number(summary.dataset.difference || 0);
          if (difference < 0 && currentExtra === 0) {
            showToast("Aporta compensaciÃ³n en COP si tu oferta es menor.", "danger");
            return;
          }
          const items = selected.map((input) => ({
            id: input.value,
            title: input.dataset.title,
            price: Number(input.dataset.price),
          }));
          state.offersSent.push({
            id: generateId("offer"),
            product,
            items,
            extra: currentExtra,
            total,
            difference,
            status: "Enviada",
            createdAt: new Date(),
          });
          showToast("Oferta enviada correctamente.", "success");
          closeModal("offer-modal");
          updateUI();
        };
      }

      function openNegotiateModal(offer) {
        const content = $("#negotiate-content");
        if (!content) {
          showToast("No pudimos preparar la contraoferta.", "danger");
          return;
        }
        content.innerHTML = `
          <div class="difference-badge">
            <span>Contraofertar sobre: <strong>${offer.product.title}</strong></span>
            <span>Oferta actual: <strong>${formatCOP(
              offer.items.reduce((sum, item) => sum + item.price, 0) + offer.extra
            )}</strong></span>
          </div>
          <div class="negotiation-options">
            <label class="field">
              <span>Ajustar compensaciÃ³n en COP</span>
              <input type="number" min="0" step="500" id="negotiate-extra" value="${offer.extra}" />
            </label>
            <label class="field">
              <span>Comentarios adicionales</span>
              <textarea id="negotiate-message" placeholder="PropÃ³n cambios, fechas de entrega o condiciones.">${
                offer.notes || ""
              }</textarea>
            </label>
          </div>
        `;
        openModal("negotiate-modal");

        const form = $("#negotiate-form");
        if (!form) {
          showToast("Formulario de contraoferta no disponible.", "danger");
          return;
        }
        form.onsubmit = (event) => {
          event.preventDefault();
          const extraInput = $("#negotiate-extra");
          const messageField = $("#negotiate-message");
          const extra = extraInput ? Number(extraInput.value || 0) : 0;
          const message = messageField ? messageField.value.trim() : "";
          const productValue = offer.product.price;
          const currentItems = offer.items.reduce((sum, item) => sum + item.price, 0);
          const newDifference = currentItems + extra - productValue;
          offer.extra = extra;
          offer.difference = newDifference;
          offer.notes = message || "Contraoferta enviada";
          offer.status = "negociacion";
          showToast("Contraoferta enviada al usuario.", "success");
          closeModal("negotiate-modal");
          updateUI();
        };
      }

      function openReportModal(product) {
        const referenceInput = $("#report-reference");
        const descriptionInput = $("#report-description");
        const termsCheckbox = $("#report-terms");
        const form = $("#report-form");
        if (!referenceInput || !descriptionInput || !termsCheckbox || !form) {
          showToast("No pudimos cargar el formulario de reporte.", "danger");
          return;
        }
        if (product) {
          referenceInput.value = `${product.title} (${product.id})`;
        }
        openModal("report-modal");
        form.onsubmit = (event) => {
          event.preventDefault();
          if (!termsCheckbox.checked) {
            showToast("Debes aceptar la declaraciÃ³n para enviar el reporte.", "danger");
            return;
          }
          state.reports += 1;
          $("#report-count").textContent = `${state.reports} reportes enviados`;
          showToast("Reporte enviado. Nuestro equipo lo revisarÃ¡.", "success");
          closeModal("report-modal");
          event.target.reset();
        };
      }

      function handleAuth(event) {
        event.preventDefault();
        const nameInput = $("#auth-name");
        const emailInput = $("#auth-email");
        const phoneInput = $("#auth-phone");
        const locationInput = $("#auth-location");
        const fileInput = $("#auth-photo");
        const termsCheckbox = $("#auth-terms");
        const name = nameInput ? nameInput.value.trim() : "";
        const email = emailInput ? emailInput.value.trim() : "";
        const phone = phoneInput ? phoneInput.value.trim() : "";
        const location = locationInput ? locationInput.value.trim() : "";
        const file = fileInput && fileInput.files ? fileInput.files[0] : null;
        const acceptedTerms = termsCheckbox ? Boolean(termsCheckbox.checked) : false;
        if (!name || !email || !phone || !location || !file || !acceptedTerms) {
          showToast("Completa todos los campos de verificaciÃ³n.", "danger");
          return;
        }
        readFile(file)
          .then((avatar) => {
            const now = new Date().toISOString();
            const user = {
              id: generateId("user"),
              name,
              email,
              phone,
              location,
              bio: "",
              avatar,
              rating: 5,
              createdAt: now,
              updatedAt: now,
            };
            closeModal("auth-modal");
            profileMode = "view";
            setCurrentUser(user);
            showToast("Cuenta verificada creada. Â¡Ya puedes publicar!", "success");
            switchToPage("profile", { scroll: false });
          })
          .catch(() => {
            showToast("No pudimos procesar la imagen seleccionada.", "danger");
          });
      }

      function handlePublish(event) {
        event.preventDefault();
        if (!ensureAuthenticated()) return;
        const titleField = $("#product-name");
        const categoryField = $("#product-category");
        const descriptionField = $("#product-description");
        const priceField = $("#product-price");
        const locationField = $("#product-location");
        const imagesInput = $("#product-images");
        const { min: minFiles, max: maxFiles } = getMediaConstraints(imagesInput);
        const title = titleField ? titleField.value.trim() : "";
        const category = categoryField ? categoryField.value : "";
        const description = descriptionField ? descriptionField.value.trim() : "";
        const price = priceField ? Number(priceField.value || 0) : 0;
        const location = locationField ? locationField.value.trim() : "";
        const files = Array.from((imagesInput && imagesInput.files) || []);

        if (!title || !category || !description || !price || !location) {
          showToast("Completa todos los campos obligatorios.", "danger");
          return;
        }
        if (files.length < minFiles || files.length > maxFiles) {
          showToast(
            `Adjunta entre ${minFiles} y ${maxFiles} imÃ¡genes reales.`,
            "danger"
          );
          return;
        }

        Promise.all(files.map((file) => readFile(file))).then((images) => {
          const product = {
            id: generateId("prod"),
            title,
            description,
            category,
            price,
            location,
            images,
            views: 0,
            owner: state.currentUser,
          };
          state.products.unshift(product);
          closeModal("publish-modal");
          showToast("Producto publicado en el feed.", "success");
          event.target.reset();
          if (imagesInput) {
            resetMediaInput(imagesInput);
          }
          updateUI();
          setTimeout(() => simulateIncomingOffer(product), 5500);
        });
      }

      function handleSell(event) {
        event.preventDefault();
        const intentField = $("#sell-intent");
        const nameField = $("#sell-name");
        const categoryField = $("#sell-category");
        const descriptionField = $("#sell-description");
        const priceField = $("#sell-price");
        const locationField = $("#sell-location");
        const imagesInput = $("#sell-images");
        const feedToggle = $("#sell-feed-toggle");
        const { min: minFiles, max: maxFiles } = getMediaConstraints(imagesInput);

        if (!state.currentUser) {
          showToast("Debes crear tu perfil verificado para vender en Cambalaches.", "danger");
          closeModal("sell-modal");
          openModal("auth-modal");
          return;
        }

        const intentKey = intentField ? intentField.value || activeSellIntent : activeSellIntent;
        const intent = getSellIntent(intentKey);
        const title = nameField ? nameField.value.trim() : "";
        const category = categoryField ? categoryField.value : "";
        const description = descriptionField ? descriptionField.value.trim() : "";
        const price = priceField ? Number(priceField.value || 0) : 0;
        const location = locationField ? locationField.value.trim() : "";
        const files = Array.from((imagesInput && imagesInput.files) || []);
        const publishToFeed = feedToggle ? Boolean(feedToggle.checked) : true;

        if (!title || !category || !description || !price || !location) {
          showToast("Completa todos los campos obligatorios.", "danger");
          return;
        }

        if (files.length < minFiles || files.length > maxFiles) {
          showToast(
            `Adjunta entre ${minFiles} y ${maxFiles} imÃ¡genes reales.`,
            "danger"
          );
          return;
        }

        Promise.all(files.map((file) => readFile(file))).then((images) => {
          const product = {
            id: generateId("sale"),
            title,
            description,
            category,
            price,
            location,
            images,
            views: 0,
            owner: state.currentUser,
            listingType: "venta",
            sellIntent: intentKey,
            publishedToFeed,
            createdAt: new Date().toISOString(),
          };

          if (publishToFeed) {
            state.products.unshift(product);
            showToast(`Anuncio de ${intent.label.toLowerCase()} publicado en el feed.`, "success");
            updateUI();
            setTimeout(() => simulateIncomingOffer(product), 5500);
          } else {
            state.pendingSales.unshift(product);
            showToast("Borrador guardado. PodrÃ¡s publicarlo cuando quieras.", "info");
          }

          closeModal("sell-modal");
          event.target.reset();
          if (imagesInput) {
            resetMediaInput(imagesInput);
          }
          activeSellIntent = intentKey;
          configureSellModal(intentKey, { resetForm: false });
        });
      }

      function simulateIncomingOffer(product) {
        if (!state.currentUser || product.owner.id !== state.currentUser.id) return;
        const offer = sampleIncomingOffer();
        offer.product = product;
        const totalItems = offer.items.reduce((sum, item) => sum + item.price, 0);
        offer.difference = totalItems + offer.extra - product.price;
        state.offersReceived.unshift(offer);
        showToast(`Nueva oferta recibida para ${product.title}.`, "info");
        updateUI();
      }

      function updatePreview(event) {
        const input = event?.target;
        if (!input) {
          return;
        }
        const files = Array.from(input.files || []);
        const previewId = input.dataset.previewTarget;
        const counterId = input.dataset.counterTarget;
        const { max } = getMediaConstraints(input);
        const limit = Number.isFinite(max) ? max : 10;
        const container = previewId ? document.getElementById(previewId) : null;
        if (container) {
          container.innerHTML = "";
        }
        let count = 0;
        files.forEach((file) => {
          if (!file.type.startsWith("image") || count >= limit) {
            return;
          }
          count += 1;
          if (container) {
            const preview = document.createElement("div");
            preview.className = "image-preview";
            const img = document.createElement("img");
            preview.appendChild(img);
            container.appendChild(preview);
            const reader = new FileReader();
            reader.onload = () => {
              img.src = reader.result;
            };
            reader.readAsDataURL(file);
          }
        });
        if (counterId) {
          const counter = document.getElementById(counterId);
          if (counter) {
            counter.textContent = `${count}/${limit} fotos`;
          }
        }
      }

      function updateAuthButton() {
        const authBtn = $("#open-auth");
        if (!authBtn) return;
        if (state.currentUser) {
          authBtn.textContent = "Cerrar sesiÃ³n";
          authBtn.onclick = () => logout();
        } else {
          authBtn.textContent = "Crear perfil";
          authBtn.onclick = () => {
            profileMode = "create";
            switchToPage("profile");
            closeSidebar();
            focusProfileForm();
          };
        }
      }

      function updateUI() {
        updateProfileSection();
        updateProfileCard();
        updateAuthButton();
        renderPromoBanners();
        renderMostViewed();
        renderFeed();
        renderCoupons();
        renderMyItems();
        renderOffers();
        renderAgreements();
        renderHistory();
        renderReviews();
      }

      function registerNavigation() {
        const navButtons = $$("[data-target]");
        const pageGroups = new Set($$("[data-page-group]").map((section) => section.dataset.pageGroup));
        primaryNavButtons = navButtons.filter(
          (btn) => btn.dataset.nav === "primary" && pageGroups.has(btn.dataset.target)
        );

        navButtons.forEach((btn) =>
          btn.addEventListener("click", (event) => {
            const target = event.currentTarget.getAttribute("data-target");
            const handled = switchToPage(target);
            if (handled && isMobileSidebar()) {
              closeSidebar();
            }
            if (!handled) {
              const section = document.getElementById(target);
              if (section) {
                section.scrollIntoView({ behavior: "smooth", block: "start" });
              }
            }
          })
        );

        switchToPage(activePage, { scroll: false });
      }

      document.addEventListener("DOMContentLoaded", () => {
        sidebarElement = $("#app-sidebar");
        sidebarToggleButton = $("#sidebar-toggle");
        sidebarBackdropElement = $("#sidebar-backdrop");

        const syncHandler = () => syncSidebarWithViewport();
        syncSidebarWithViewport();
        if (typeof mobileSidebarQuery.addEventListener === "function") {
          mobileSidebarQuery.addEventListener("change", syncHandler);
        } else if (typeof mobileSidebarQuery.addListener === "function") {
          mobileSidebarQuery.addListener(syncHandler);
        }

        if (sidebarToggleButton) {
          sidebarToggleButton.addEventListener("click", toggleSidebar);
        }
        if (sidebarBackdropElement) {
          sidebarBackdropElement.addEventListener("click", closeSidebar);
        }
        if (sidebarElement) {
          setSidebarAriaHidden(isMobileSidebar() ? !sidebarElement.classList.contains("is-open") : false);
        }

        registerNavigation();
        ensureLocationSelectorsInitialized();
        updateUI();

        ensurePromoBannerElements();
        resetPromoBannerForm();

        on("#promo-banner-form", "submit", (event) => handlePromoBannerFormSubmit(event));
        on("#promo-banner-image", "change", handlePromoBannerImageChange);
        on("#promo-banner-close", "click", () => closePromoBannerModal());
        on("#promo-banner-cancel", "click", () => closePromoBannerModal());
        on("#promo-banner-modal", "click", handlePromoBannerOverlayClick);
        document.addEventListener("keydown", handlePromoBannerKeydown);

        on("#cta-register", "click", () => {
          profileMode = state.currentUser ? "view" : "create";
          switchToPage("profile");
          closeSidebar();
          focusProfileForm();
        });
        on("#profile-publish", "click", () => ensureAuthenticated(() => openModal("publish-modal")));
        on("#quick-publish", "click", () => ensureAuthenticated(() => openModal("publish-modal")));
        on("#feed-publish", "click", () => ensureAuthenticated(() => openModal("publish-modal")));
        on("#add-product", "click", () => ensureAuthenticated(() => openModal("publish-modal")));
        on("#add-product-secondary", "click", () => ensureAuthenticated(() => openModal("publish-modal")));

        on("#auth-form", "submit", handleAuth);
        on("#auth-photo", "change", handleAuthPhotoChange);
        on("#profile-form", "submit", handleProfileSubmit);
        on("#profile-photo", "change", handleProfilePhotoChange);
        on("#profile-edit", "click", startProfileEdit);
        on("#profile-cancel", "click", cancelProfileEdit);
        on("#profile-logout", "click", () => logout());
        on("#coupon-form", "submit", handleCouponSubmit);
        on("#coupon-cover", "change", handleCouponCoverChange);
        on("#coupon-cover-remove", "click", handleCouponCoverRemove);
        on("#coupon-new", "click", handleCouponNew);
        on("#coupon-empty-create", "click", handleCouponNew);
        on("#coupon-cancel", "click", handleCouponCancel);

        if (couponElements.form) {
          couponElements.form.addEventListener("input", handleCouponFormInput);
          couponElements.form.addEventListener("change", handleCouponFormInput);
        }
        on("#nav-avatar", "click", () => {
          profileMode = state.currentUser ? "view" : "create";
          switchToPage("profile");
          closeSidebar();
        });

        const handleSellEntry = () => {
          closeSidebar();
          if (!state.currentUser) {
            showToast("Debes verificar tu cuenta para comenzar a vender.", "danger");
            openModal("auth-modal");
            return;
          }
          openSellSelector();
        };

        onAll('[data-role="sell"]', "click", handleSellEntry);

        onAll(".sell-option-card", "click", handleSellOptionSelect);

        on("#sell-modal-back", "click", () => {
          closeModal("sell-modal");
          setTimeout(() => {
            openSellSelector();
            requestAnimationFrame(() => {
              const activeOption = document.querySelector(
                ".sell-option-card.is-active"
              );
              if (activeOption && typeof activeOption.focus === "function") {
                activeOption.focus();
              }
            });
          }, 200);
        });

        on("#sell-form", "submit", handleSell);

        on("#publish-form", "submit", handlePublish);
        onAll('input[data-preview-target]', 'change', updatePreview);

        configureSellModal(activeSellIntent, { resetForm: false });

        const headerSearchForm = $("#header-search");
        const headerSearchInput = $("#header-search-input");
        const feedKeywordInput = $("#filter-keyword");
        const categoryInput = $("#filter-category");
        const categoryCards = $$(".category-card");
        const filtersTrigger = $("#filters-trigger");
        const inlineFiltersTrigger = $("#filters-inline");
        const mostViewedExplore = $("#most-viewed-explore");
        const filtersOverlay = $("#filters-overlay");
        const filtersClose = $("#filters-close");
        const filtersCancel = $("#filters-cancel");
        const filtersClear = $("#filters-clear");
        const filtersForm = $("#filters-form");
        const stylePills = $$(".style-pill");
        const priceMinInput = $("#filter-min");
        const priceMaxInput = $("#filter-max");
        const detailStartBtn = $("#product-detail-start");
        const detailAdvancedBtn = $("#product-detail-advanced");
        const detailReportBtn = $("#product-detail-report");
        const detailCloseNodes = $$("[data-close-detail]");

        if (headerSearchForm) {
          headerSearchForm.addEventListener("submit", (event) => {
            event.preventDefault();
            if (headerSearchInput && feedKeywordInput) {
              feedKeywordInput.value = headerSearchInput.value;
              renderFeed();
              switchToPage("feed-section", { scroll: false });
              const feedSection = document.getElementById("feed-section");
              if (feedSection) {
                feedSection.scrollIntoView({ behavior: "smooth", block: "start" });
              }
            }
          });
        }

        if (headerSearchInput && feedKeywordInput) {
          headerSearchInput.addEventListener("input", (event) => {
            feedKeywordInput.value = event.target.value;
            renderFeed();
            if (activePage !== "feed-section") {
              switchToPage("feed-section", { scroll: false });
            }
          });
        }

        if (categoryCards.length) {
          categoryCards.forEach((card) => {
            card.addEventListener("click", () => {
              const value = card.dataset.category || "";
              if (categoryInput) {
                categoryInput.value = value;
              }
              categoryCards.forEach((btn) => btn.classList.toggle("active", btn === card));
              renderFeed();
              filtersSnapshot = captureFilterSnapshot();
            });
          });
        }

        if (mostViewedExplore) {
          mostViewedExplore.addEventListener("click", () => {
            switchToPage("feed-section", { scroll: false });
            const feedSection = document.getElementById("feed-section");
            if (feedSection) {
              feedSection.scrollIntoView({ behavior: "smooth", block: "start" });
            }
          });
        }

        if (stylePills.length) {
          stylePills.forEach((pill) =>
            pill.addEventListener("click", () => {
              const value = pill.dataset.style || "marketplace";
              setStyleSelection(value, { updateHidden: false });
            })
          );
        }

        if (filtersTrigger) {
          filtersTrigger.addEventListener("click", () => {
            openFiltersOverlay();
          });
        }

        if (inlineFiltersTrigger) {
          inlineFiltersTrigger.addEventListener("click", () => {
            openFiltersOverlay();
          });
        }

        if (filtersClose) {
          filtersClose.addEventListener("click", () => closeFiltersOverlay({ restore: true }));
        }

        if (filtersCancel) {
          filtersCancel.addEventListener("click", () => closeFiltersOverlay({ restore: true }));
        }

        if (filtersOverlay) {
          filtersOverlay.addEventListener("click", (event) => {
            if (event.target === filtersOverlay) {
              closeFiltersOverlay({ restore: true });
            }
          });
        }

        if (detailCloseNodes.length) {
          detailCloseNodes.forEach((node) =>
            node.addEventListener("click", () => closeProductDetail())
          );
        }

        if (detailStartBtn) {
          detailStartBtn.addEventListener("click", () => {
            if (!activeProductDetail) return;
            const product = activeProductDetail;
            closeProductDetail();
            openOfferModal(product);
          });
        }

        if (detailAdvancedBtn) {
          detailAdvancedBtn.addEventListener("click", () => {
            if (!activeProductDetail) return;
            const product = activeProductDetail;
            closeProductDetail();
            openOfferModal(product);
          });
        }

        if (detailReportBtn) {
          detailReportBtn.addEventListener("click", () => {
            if (!activeProductDetail) return;
            const product = activeProductDetail;
            closeProductDetail();
            openReportModal(product);
          });
        }

        if (filtersForm) {
          filtersForm.addEventListener("submit", (event) => {
            event.preventDefault();
            updatePriceSlider();
            setStyleSelection(pendingStyle, { updateHidden: true });
            renderFeed();
            filtersSnapshot = captureFilterSnapshot();
            closeFiltersOverlay({ restore: false });
          });
        }

        if (filtersClear) {
          filtersClear.addEventListener("click", () => {
            const locationField = $("#filter-location");
            const minField = $("#filter-min");
            const maxField = $("#filter-max");
            if (locationField) locationField.value = "";
            if (minField) minField.value = PRICE_LIMITS.min;
            if (maxField) maxField.value = PRICE_LIMITS.max;
            updatePriceSlider();
            setStyleSelection("marketplace", { updateHidden: true });
            if (categoryInput) {
              categoryInput.value = "";
            }
            categoryCards.forEach((btn) => {
              const target = btn.dataset.category || "";
              btn.classList.toggle("active", target === "");
            });
            renderFeed();
            filtersSnapshot = captureFilterSnapshot();
          });
        }

        const priceInputs = [priceMinInput, priceMaxInput].filter(Boolean);
        if (priceInputs.length) {
          const handlePriceInput = (event) => {
            const handle = event?.currentTarget?.dataset?.handle;
            updatePriceSlider(handle);
          };
          priceInputs.forEach((input) => input.addEventListener("input", handlePriceInput));
          updatePriceSlider();
        }

        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape") {
            if (sidebarElement && sidebarElement.classList.contains("is-open")) {
              closeSidebar();
              return;
            }
            const overlay = $("#filters-overlay");
            if (overlay && overlay.classList.contains("active")) {
              closeFiltersOverlay({ restore: true });
              return;
            }
            const detail = $("#product-detail");
            if (detail && detail.classList.contains("open")) {
              closeProductDetail();
            }
          }
        });

        pendingStyle = $("#filter-style")?.value || "marketplace";
        setStyleSelection(pendingStyle, { updateHidden: true });
        updatePriceSlider();
        filtersSnapshot = captureFilterSnapshot();

        onAll("[data-close]", "click", (event) => {
          const target = event.currentTarget.getAttribute("data-close");
          if (target) {
            closeModal(target);
          }
        });

        onAll("dialog", "cancel", (event) => {
          event.preventDefault();
          const dialogElement = event.currentTarget;
          if (dialogElement && dialogElement.id) {
            closeModal(dialogElement.id);
          }
        });

        on("#open-report", "click", () => openReportModal());
      });
    </script>
  </body>
</html>
