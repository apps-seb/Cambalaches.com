<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cambalaches · Marketplace de canjes inteligentes</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SVLmH31c+3fjSnVAk0nnBYnCTsRmRykGGBqBPdZiZsaAJ+lZeXqIuAvV38DSHLVbkP4SRrped1IovnHgkmHGWw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: light only;
        --primary-50: #eef2ff;
        --primary-100: #e0e7ff;
        --primary-500: #4c51ff;
        --primary-600: #3a3fe0;
        --primary-700: #2a2bbd;
        --accent: #00b894;
        --surface: rgba(255, 255, 255, 0.85);
        --surface-strong: rgba(255, 255, 255, 0.95);
        --border: rgba(99, 102, 241, 0.15);
        --border-strong: rgba(15, 23, 42, 0.08);
        --muted: #657195;
        --muted-dark: #1e2a4a;
        --success: #16a34a;
        --warning: #f59e0b;
        --danger: #ef4444;
        --shadow-lg: 0 35px 70px -40px rgba(15, 23, 42, 0.5);
        --shadow-sm: 0 18px 30px -25px rgba(15, 23, 42, 0.35);
        --radius-xl: 28px;
        --radius-lg: 22px;
        --radius-md: 16px;
        --radius-sm: 12px;
        --transition: 240ms cubic-bezier(0.23, 1, 0.32, 1);
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      html {
        overflow-x: hidden;
        width: 100%;
        scroll-behavior: smooth;
      }

      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background: radial-gradient(circle at 10% 20%, rgba(76, 81, 255, 0.14) 0%, transparent 42%),
          radial-gradient(circle at 82% 4%, rgba(0, 184, 148, 0.18) 0%, transparent 48%),
          linear-gradient(165deg, #f5f8ff 0%, #f0f4ff 45%, #f9fbff 100%);
        color: #0f172a;
        min-height: 100vh;
        padding-bottom: 140px;
        overflow-x: hidden;
        max-width: 100vw;
      }

      img {
        max-width: 100%;
        display: block;
      }

      button {
        font-family: inherit;
      }

      header {
        position: sticky;
        top: 0;
        z-index: 40;
        backdrop-filter: blur(22px);
        background: rgba(245, 247, 255, 0.95);
        border-bottom: 1px solid rgba(79, 70, 229, 0.08);
        box-shadow: 0 18px 40px -32px rgba(15, 23, 42, 0.35);
      }

      .topbar {
        width: min(1280px, 94vw);
        margin: 0 auto;
        padding: 1.1rem 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 2rem;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-family: "Plus Jakarta Sans", "Inter", sans-serif;
      }

      .brand-mark {
        width: 48px;
        height: 48px;
        border-radius: 16px;
        display: grid;
        place-items: center;
        background: linear-gradient(135deg, #4c51ff, #8a5dff);
        color: #fff;
        font-weight: 700;
        letter-spacing: 0.02em;
        box-shadow: 0 20px 45px rgba(76, 81, 255, 0.35);
      }

      .brand h1 {
        margin: 0;
        font-size: clamp(1.5rem, 2.6vw, 2.3rem);
        letter-spacing: -0.03em;
      }

      nav {
        display: flex;
        align-items: center;
        gap: 0.65rem;
      }

      nav button {
        border: none;
        border-radius: 999px;
        background: transparent;
        padding: 0.65rem 1.1rem;
        font-weight: 600;
        color: #1f2a54;
        cursor: pointer;
        transition: background var(--transition), color var(--transition), transform var(--transition);
      }

      nav button:hover,
      nav button:focus-visible {
        background: rgba(76, 81, 255, 0.12);
        color: var(--primary-700);
        transform: translateY(-1px);
      }

      .header-actions {
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }

      .btn {
        border: none;
        border-radius: 999px;
        padding: 0.75rem 1.4rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform var(--transition), box-shadow var(--transition), background var(--transition);
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--primary-600), var(--primary-500));
        color: white;
        box-shadow: 0 18px 30px -20px rgba(76, 81, 255, 0.55);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 24px 40px -20px rgba(76, 81, 255, 0.55);
      }

      .btn-outline {
        background: rgba(76, 81, 255, 0.08);
        color: var(--primary-700);
      }

      .btn-outline:hover {
        background: rgba(76, 81, 255, 0.18);
        transform: translateY(-2px);
      }

      .avatar-thumb {
        width: 40px;
        height: 40px;
        border-radius: 14px;
        overflow: hidden;
        border: 2px solid rgba(76, 81, 255, 0.2);
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.25);
      }

      main {
        width: min(1280px, 94vw);
        margin: 0 auto 5rem;
        display: grid;
        gap: 3rem;
      }

      .hero {
        background: var(--surface);
        margin-top: 2.8rem;
        border-radius: var(--radius-xl);
        padding: clamp(2.2rem, 3vw, 3.4rem);
        box-shadow: var(--shadow-lg);
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 360px);
        gap: clamp(2rem, 4vw, 4.2rem);
        align-items: center;
      }

      .hero h2 {
        margin: 0 0 1.2rem;
        font-size: clamp(2.1rem, 4vw, 2.9rem);
        letter-spacing: -0.03em;
      }

      .hero p {
        margin: 0 0 1.8rem;
        max-width: 620px;
        color: var(--muted);
        line-height: 1.6;
      }

      .hero-stats {
        display: grid;
        gap: 1rem;
      }

      .hero-stat {
        background: var(--surface-strong);
        border-radius: var(--radius-lg);
        padding: 1.1rem 1.4rem;
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 1.1rem;
        box-shadow: var(--shadow-sm);
      }

      .hero-stat i {
        width: 46px;
        height: 46px;
        border-radius: 14px;
        display: grid;
        place-items: center;
        background: rgba(76, 81, 255, 0.12);
        color: var(--primary-600);
        font-size: 1.2rem;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
        gap: 2.5rem;
        align-items: start;
      }

      @media (max-width: 1024px) {
        .hero {
          grid-template-columns: 1fr;
        }
        .dashboard-grid {
          grid-template-columns: 1fr;
        }
        nav {
          display: none;
        }
      }

      .panel {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: clamp(1.6rem, 2vw, 2rem);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-sm);
        backdrop-filter: blur(18px);
      }

      .panel h3 {
        margin: 0 0 1.2rem;
        font-size: 1.35rem;
        letter-spacing: -0.01em;
      }

      .profile-panel {
        display: grid;
        gap: 1.6rem;
        position: sticky;
        top: 120px;
      }

      .profile-card {
        display: grid;
        gap: 1.2rem;
      }

      .profile-main {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .profile-main .avatar-large {
        width: 72px;
        height: 72px;
        border-radius: 24px;
        overflow: hidden;
        border: 3px solid rgba(76, 81, 255, 0.2);
        box-shadow: 0 25px 45px -28px rgba(15, 23, 42, 0.6);
      }

      .profile-main h4 {
        margin: 0 0 0.35rem;
        font-size: 1.2rem;
      }

      .verified {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.25rem 0.65rem;
        border-radius: 999px;
        background: rgba(34, 197, 94, 0.16);
        color: var(--success);
        font-size: 0.75rem;
        font-weight: 600;
      }

      .profile-meta {
        display: grid;
        gap: 0.35rem;
        color: var(--muted);
        font-size: 0.92rem;
      }

      .profile-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.75rem;
      }

      .stat-card {
        background: var(--surface-strong);
        border-radius: var(--radius-md);
        padding: 0.95rem 1.1rem;
        border: 1px solid var(--border-strong);
        display: grid;
        gap: 0.35rem;
      }

      .stat-card span {
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }

      .stat-card strong {
        font-size: 1.1rem;
      }

      .quick-links {
        display: grid;
        gap: 0.75rem;
      }

      .quick-links button {
        border: 1px solid rgba(76, 81, 255, 0.18);
        border-radius: var(--radius-md);
        background: transparent;
        padding: 0.9rem 1.1rem;
        text-align: left;
        font-weight: 600;
        color: #1f2a54;
        display: flex;
        align-items: center;
        gap: 0.8rem;
        cursor: pointer;
        transition: background var(--transition), transform var(--transition);
      }

      .quick-links button i {
        width: 32px;
        height: 32px;
        border-radius: 12px;
        background: rgba(76, 81, 255, 0.12);
        display: grid;
        place-items: center;
        color: var(--primary-600);
      }

      .quick-links button:hover {
        background: rgba(76, 81, 255, 0.12);
        transform: translateY(-2px);
      }

      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1.6rem;
      }

      .section-title {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .section-icon {
        width: 58px;
        height: 58px;
        border-radius: 22px;
        background: linear-gradient(135deg, rgba(76, 81, 255, 0.82), rgba(0, 184, 148, 0.72));
        box-shadow: 0 24px 50px -24px rgba(15, 23, 42, 0.55);
        display: grid;
        place-items: center;
        color: white;
        position: relative;
        overflow: hidden;
        isolation: isolate;
      }

      .section-icon::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.35), transparent 55%);
        opacity: 0.9;
        pointer-events: none;
      }

      .section-icon i {
        font-size: 1.38rem;
        position: relative;
        z-index: 1;
      }

      .section-header p {
        margin: 0;
        color: var(--muted);
      }

      .filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.9rem;
        margin-bottom: 1.5rem;
      }

      .filters label {
        display: grid;
        gap: 0.4rem;
        font-weight: 600;
        font-size: 0.82rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }

      select,
      input[type="text"],
      input[type="number"],
      input[type="search"],
      input[type="tel"],
      input[type="email"],
      input[type="file"],
      textarea {
        border-radius: var(--radius-md);
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(255, 255, 255, 0.92);
        padding: 0.7rem 0.85rem;
        font-family: inherit;
        font-size: 0.95rem;
        transition: border var(--transition), box-shadow var(--transition);
      }

      textarea {
        min-height: 120px;
        resize: vertical;
      }

      select:focus,
      input:focus,
      textarea:focus {
        outline: none;
        border-color: rgba(76, 81, 255, 0.5);
        box-shadow: 0 0 0 4px rgba(76, 81, 255, 0.12);
      }

      .card-grid {
        display: grid;
        gap: 1.4rem;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      .product-card {
        position: relative;
        display: grid;
        gap: 1rem;
        background: var(--surface-strong);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        padding: 1.2rem;
        box-shadow: var(--shadow-sm);
      }

      .product-media {
        position: relative;
        border-radius: var(--radius-md);
        overflow: hidden;
        aspect-ratio: 4 / 3;
      }

      .product-media img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .media-controls {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 0.4rem;
        pointer-events: none;
      }

      .media-controls button {
        pointer-events: auto;
        width: 34px;
        height: 34px;
        border-radius: 50%;
        border: none;
        display: grid;
        place-items: center;
        background: rgba(15, 23, 42, 0.55);
        color: white;
        cursor: pointer;
        transition: transform var(--transition);
      }

      .media-controls button:hover {
        transform: scale(1.05);
      }

      .product-body {
        display: grid;
        gap: 0.55rem;
      }

      .product-body h4 {
        margin: 0;
        font-size: 1.1rem;
      }

      .product-price {
        font-weight: 700;
        color: var(--primary-700);
        font-size: 1.1rem;
      }

      .product-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.55rem 1rem;
        color: var(--muted);
        font-size: 0.92rem;
      }

      .product-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: center;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.75rem;
        padding: 0.3rem 0.6rem;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.08);
        color: var(--muted-dark);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .badge.self {
        background: rgba(34, 197, 94, 0.18);
        color: var(--success);
      }

      .empty-state {
        border-radius: var(--radius-md);
        padding: 2.2rem;
        text-align: center;
        background: rgba(76, 81, 255, 0.06);
        border: 1px dashed rgba(76, 81, 255, 0.25);
        color: var(--muted);
      }

      .empty-state h4 {
        margin: 0 0 0.45rem;
      }

      .list {
        display: grid;
        gap: 1rem;
      }

      .exchange-card {
        background: var(--surface-strong);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        padding: 1.2rem;
        display: grid;
        gap: 0.9rem;
        position: relative;
        box-shadow: var(--shadow-sm);
      }

      .exchange-status {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .status-pendiente {
        background: rgba(59, 130, 246, 0.16);
        color: #1d4ed8;
      }

      .status-negociacion {
        background: rgba(245, 158, 11, 0.14);
        color: var(--warning);
      }

      .status-entrega {
        background: rgba(34, 197, 94, 0.16);
        color: var(--success);
      }

      .chat-box {
        background: rgba(248, 249, 255, 0.9);
        border-radius: var(--radius-md);
        padding: 0.9rem;
        display: grid;
        gap: 0.6rem;
        border: 1px solid rgba(148, 163, 184, 0.3);
      }

      .chat-messages {
        max-height: 180px;
        overflow-y: auto;
        display: grid;
        gap: 0.5rem;
      }

      .chat-message {
        display: grid;
        gap: 0.25rem;
        padding: 0.6rem 0.75rem;
        border-radius: var(--radius-sm);
        background: white;
        border: 1px solid rgba(226, 232, 240, 0.7);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5);
      }

      .chat-message.me {
        background: rgba(76, 81, 255, 0.1);
        border-color: rgba(76, 81, 255, 0.25);
      }

      .chat-message small {
        color: var(--muted);
        font-size: 0.7rem;
      }

      .chat-input {
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto;
        gap: 0.6rem;
      }

      .chat-input button {
        border-radius: var(--radius-md);
        padding: 0.6rem 1.1rem;
        border: none;
        background: var(--primary-600);
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: transform var(--transition);
      }

      .chat-input button:hover {
        transform: translateY(-1px);
      }

      .history-card {
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        padding: 1.2rem;
        background: var(--surface-strong);
        display: grid;
        gap: 0.6rem;
      }

      .rating-control {
        display: inline-flex;
        gap: 0.25rem;
        color: #d97706;
        cursor: pointer;
      }

      .rating-control i {
        font-size: 1.2rem;
      }

      .toast {
        position: fixed;
        top: 24px;
        right: 24px;
        background: var(--surface-strong);
        border-radius: var(--radius-md);
        border: 1px solid rgba(76, 81, 255, 0.25);
        padding: 1rem 1.2rem;
        box-shadow: var(--shadow-sm);
        display: flex;
        gap: 0.75rem;
        align-items: flex-start;
        width: min(320px, 80vw);
        transform: translateY(-20px);
        opacity: 0;
        pointer-events: none;
        transition: opacity var(--transition), transform var(--transition);
        z-index: 80;
      }

      .toast.show {
        opacity: 1;
        transform: translateY(0);
        pointer-events: all;
      }

      .toast.success {
        border-color: rgba(22, 163, 74, 0.3);
      }

      .premium-bottom-nav {
        position: fixed;
        bottom: 28px;
        left: 50%;
        transform: translateX(-50%);
        width: min(520px, 92vw);
        background: rgba(248, 250, 255, 0.75);
        backdrop-filter: blur(24px) saturate(140%);
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.6);
        box-shadow: 0 28px 60px -28px rgba(15, 23, 42, 0.6);
        padding: 0.55rem;
        display: grid;
        grid-template-columns: repeat(5, minmax(0, 1fr));
        gap: 0.45rem;
        z-index: 60;
      }

      .premium-bottom-nav button {
        border: none;
        background: transparent;
        color: #1f2a54;
        font-weight: 600;
        display: grid;
        justify-items: center;
        gap: 0.4rem;
        border-radius: 26px;
        padding: 0.6rem 0.75rem;
        font-size: 0.78rem;
        cursor: pointer;
        transition: background var(--transition), transform var(--transition), color var(--transition);
      }

      .premium-bottom-nav button .nav-icon {
        width: 48px;
        height: 48px;
        border-radius: 18px;
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.4), rgba(203, 213, 225, 0.15));
        border: 1px solid rgba(255, 255, 255, 0.55);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6), 0 14px 32px -18px rgba(15, 23, 42, 0.45);
        display: grid;
        place-items: center;
        transition: transform var(--transition), background var(--transition), border var(--transition);
        color: var(--primary-600);
      }

      .premium-bottom-nav button .nav-icon i {
        font-size: 1.2rem;
        filter: drop-shadow(0 12px 18px rgba(76, 81, 255, 0.25));
      }

      .premium-bottom-nav button .nav-label {
        font-size: 0.72rem;
        letter-spacing: 0.02em;
      }

      .premium-bottom-nav button.active,
      .premium-bottom-nav button:hover {
        background: linear-gradient(135deg, rgba(76, 81, 255, 0.2), rgba(59, 130, 246, 0.16));
        color: var(--primary-700);
        transform: translateY(-2px);
      }

      .premium-bottom-nav button.active .nav-icon,
      .premium-bottom-nav button:hover .nav-icon {
        background: linear-gradient(135deg, rgba(76, 81, 255, 0.86), rgba(37, 99, 235, 0.68));
        border-color: rgba(255, 255, 255, 0.75);
        color: white;
      }

      @media (max-width: 640px) {
        .premium-bottom-nav {
          bottom: 16px;
          padding: 0.45rem;
          width: min(460px, 94vw);
          grid-template-columns: repeat(5, minmax(0, 1fr));
        }

        .premium-bottom-nav button {
          font-size: 0.72rem;
          padding: 0.5rem 0.6rem;
        }

        .premium-bottom-nav button .nav-icon {
          width: 42px;
          height: 42px;
        }

        .premium-bottom-nav button .nav-label {
          font-size: 0.64rem;
        }

        .section-header {
          flex-direction: column;
          align-items: flex-start;
        }

        .section-title {
          width: 100%;
        }

        .section-icon {
          width: 48px;
          height: 48px;
          border-radius: 16px;
        }
      }

      dialog {
        border: none;
        border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        padding: 0;
        width: min(720px, 96vw);
        background: rgba(250, 252, 255, 0.96);
        box-shadow: 0 48px 80px -40px rgba(15, 23, 42, 0.55);
        position: fixed;
        left: 50%;
        bottom: 0;
        transform: translate(-50%, 110%);
        transition: transform 320ms cubic-bezier(0.23, 1, 0.32, 1);
        margin: 0;
        max-height: 90vh;
      }

      dialog[open] {
        transform: translate(-50%, 0);
      }

      dialog[data-closing] {
        transform: translate(-50%, 110%);
      }

      dialog::backdrop {
        background: rgba(15, 23, 42, 0.45);
        backdrop-filter: blur(12px);
      }

      .modal-body {
        padding: clamp(2rem, 4vw, 2.8rem);
        display: grid;
        gap: 1.5rem;
        max-height: min(80vh, 640px);
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .modal-header h3 {
        margin: 0;
        font-size: 1.4rem;
      }

      .modal-close {
        border: none;
        background: rgba(15, 23, 42, 0.06);
        border-radius: 999px;
        width: 36px;
        height: 36px;
        cursor: pointer;
      }

      .form-grid {
        display: grid;
        gap: 1.1rem;
      }

      .form-row {
        display: grid;
        gap: 0.6rem;
      }

      .form-row.inline {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.85rem;
      }

      .image-preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.75rem;
      }

      .image-preview {
        border-radius: var(--radius-md);
        overflow: hidden;
        border: 1px solid rgba(148, 163, 184, 0.3);
        aspect-ratio: 1;
        position: relative;
      }

      .image-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .difference-badge {
        border-radius: var(--radius-md);
        padding: 0.75rem 1rem;
        background: rgba(76, 81, 255, 0.08);
        border: 1px solid rgba(76, 81, 255, 0.2);
        display: grid;
        gap: 0.35rem;
      }

      .difference-badge strong {
        font-size: 1.05rem;
      }

      .offer-items {
        display: grid;
        gap: 0.6rem;
        max-height: 220px;
        overflow-y: auto;
      }

      .offer-item {
        border-radius: var(--radius-md);
        border: 1px solid rgba(148, 163, 184, 0.3);
        padding: 0.65rem 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: white;
      }

      .offer-item input {
        width: 18px;
        height: 18px;
      }

      .offer-item span {
        font-weight: 600;
      }

      .offer-item small {
        color: var(--muted);
      }

      .tag {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.3rem 0.75rem;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.08);
        color: var(--muted-dark);
        font-weight: 600;
        font-size: 0.78rem;
      }

      .timeline {
        display: grid;
        gap: 1rem;
      }

      .timeline-step {
        display: grid;
        gap: 0.35rem;
        padding: 0.85rem 1rem;
        border-radius: var(--radius-md);
        border: 1px solid rgba(148, 163, 184, 0.25);
        background: rgba(255, 255, 255, 0.9);
      }

      .negotiation-options {
        display: grid;
        gap: 0.75rem;
      }

      .review-list {
        display: grid;
        gap: 1rem;
      }

      .review-card {
        background: var(--surface-strong);
        border-radius: var(--radius-lg);
        padding: 1.1rem;
        border: 1px solid var(--border);
        display: grid;
        gap: 0.4rem;
      }

      .highlight {
        color: var(--primary-600);
        font-weight: 600;
      }

      .danger {
        color: var(--danger);
      }

      .success {
        color: var(--success);
      }

      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="topbar">
        <div class="brand">
          <div class="brand-mark">CB</div>
          <div>
            <h1>Cambalaches</h1>
            <span style="color: var(--muted); font-size: 0.85rem; font-weight: 500"
              >Marketplace premium de canjes en COP</span
            >
          </div>
        </div>
        <nav>
          <button data-target="feed-section">Explorar</button>
          <button data-target="publish-anchor">Publicar</button>
          <button data-target="my-items">Mis artículos</button>
          <button data-target="active-exchanges">Canjes activos</button>
          <button data-target="history">Historial</button>
          <button data-target="reputation">Reputación</button>
        </nav>
        <div class="header-actions">
          <button class="btn btn-outline" id="open-auth">Ingresar</button>
          <button class="btn btn-primary" id="quick-publish">Publicar producto</button>
          <div class="avatar-thumb hidden" id="nav-avatar"></div>
        </div>
      </div>
    </header>

    <main>
      <section class="hero" id="publish-anchor">
        <div>
          <h2>Intercambia valor con seguridad y claridad financiera</h2>
          <p>
            Conecta con personas verificadas, negocia con múltiples productos y mantén la
            diferencia en pesos colombianos controlada en todo momento. Administra tus canjes,
            conversaciones y reputación desde un solo lugar.
          </p>
          <div style="display: flex; gap: 1rem; flex-wrap: wrap">
            <button class="btn btn-primary" id="cta-register">Crear mi cuenta verificada</button>
            <button class="btn btn-outline" data-target="feed-section">Explorar artículos</button>
          </div>
        </div>
        <div class="hero-stats">
          <div class="hero-stat">
            <i class="fa-solid fa-shield-check"></i>
            <div>
              <strong>Verificación integral</strong>
              <p style="margin: 0; color: var(--muted); font-size: 0.92rem">
                Validamos identidad, correo y teléfono para cada usuario antes de publicar.
              </p>
            </div>
          </div>
          <div class="hero-stat">
            <i class="fa-solid fa-scale-unbalanced"></i>
            <div>
              <strong>Diferencias calculadas en COP</strong>
              <p style="margin: 0; color: var(--muted); font-size: 0.92rem">
                Visualiza la diferencia exacta en pesos y agrega compensaciones instantáneamente.
              </p>
            </div>
          </div>
          <div class="hero-stat">
            <i class="fa-solid fa-comments"></i>
            <div>
              <strong>Negocia y acuerda entregas</strong>
              <p style="margin: 0; color: var(--muted); font-size: 0.92rem">
                Chat seguro, contraofertas, reseñas y reportes listos para proteger tus canjes.
              </p>
            </div>
          </div>
        </div>
      </section>

      <div class="dashboard-grid">
        <aside class="profile-panel">
          <div class="panel profile-card" id="profile-card">
            <div class="profile-main">
              <div class="avatar-large" id="profile-avatar"></div>
              <div>
                <h4 id="profile-name">Invitado</h4>
                <span class="verified hidden" id="verified-badge"
                  ><i class="fa-solid fa-circle-check"></i> Cuenta verificada</span
                >
                <div class="profile-meta">
                  <span id="profile-email">Regístrate para publicar</span>
                  <span id="profile-phone"></span>
                  <span id="profile-location"></span>
                </div>
              </div>
            </div>
            <div class="profile-stats">
              <div class="stat-card">
                <span>Canjes completados</span>
                <strong id="stat-completed">0</strong>
              </div>
              <div class="stat-card">
                <span>Ofertas activas</span>
                <strong id="stat-active">0</strong>
              </div>
              <div class="stat-card">
                <span>Reputación</span>
                <strong id="stat-rating">-</strong>
              </div>
            </div>
            <button class="btn btn-primary" id="profile-publish">Publicar un nuevo producto</button>
          </div>
          <div class="panel quick-links">
            <button data-target="my-items">
              <i class="fa-solid fa-box"></i>
              Mis artículos publicados
            </button>
            <button data-target="active-exchanges">
              <i class="fa-solid fa-shuffle"></i>
              Mis canjes activos
            </button>
            <button data-target="history">
              <i class="fa-solid fa-clock-rotate-left"></i>
              Historial y reseñas
            </button>
            <button data-target="reputation">
              <i class="fa-solid fa-star"></i>
              Gestión de reputación
            </button>
            <button data-target="support">
              <i class="fa-solid fa-flag"></i>
              Reportes y soporte
            </button>
          </div>
        </aside>

        <div class="content-stack" style="display: grid; gap: 2.8rem">
          <section class="panel" id="feed-section">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon"><i class="fa-solid fa-compass"></i></span>
                <div>
                  <h3>Feed público de artículos</h3>
                  <p>Filtra por categoría, ubicación y rango en pesos colombianos.</p>
                </div>
              </div>
              <button class="btn btn-primary" id="feed-publish">Publicar producto</button>
            </div>
            <div class="filters">
              <label>
                Categoría
                <select id="filter-category">
                  <option value="">Todas</option>
                  <option value="tecnologia">Tecnología</option>
                  <option value="agricultura">Agricultura</option>
                  <option value="hogar">Hogar</option>
                  <option value="vehiculos">Vehículos</option>
                  <option value="servicios">Servicios</option>
                  <option value="moda">Moda</option>
                  <option value="coleccionables">Coleccionables</option>
                </select>
              </label>
              <label>
                Ubicación
                <input type="search" id="filter-location" placeholder="Ciudad o región" />
              </label>
              <label>
                Precio mínimo (COP)
                <input type="number" id="filter-min" min="0" step="1000" />
              </label>
              <label>
                Precio máximo (COP)
                <input type="number" id="filter-max" min="0" step="1000" />
              </label>
              <label>
                Palabra clave
                <input type="search" id="filter-keyword" placeholder="Buscar..." />
              </label>
            </div>
            <div class="card-grid" id="feed-grid"></div>
            <div class="empty-state hidden" id="feed-empty">
              <h4>No encontramos resultados con los filtros seleccionados</h4>
              <p>Intenta ajustar los filtros o elimina alguno para ampliar la búsqueda.</p>
            </div>
          </section>

          <section class="panel" id="my-items">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon"><i class="fa-solid fa-layer-group"></i></span>
                <div>
                  <h3>Mis artículos publicados</h3>
                  <p>Gestiona tus publicaciones, edita detalles y controla la disponibilidad.</p>
                </div>
              </div>
              <button class="btn btn-outline" id="add-product">Nuevo artículo</button>
            </div>
            <div id="my-items-list" class="list"></div>
            <div class="empty-state hidden" id="my-items-empty">
              <h4>Aún no has publicado artículos</h4>
              <p>Publica tus productos con mínimo 3 imágenes y súmalos a tus canjes.</p>
              <button class="btn btn-primary" id="add-product-secondary">Publicar ahora</button>
            </div>
          </section>

          <section class="panel" id="active-exchanges">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon"><i class="fa-solid fa-arrows-rotate"></i></span>
                <div>
                  <h3>Mis canjes activos</h3>
                  <p>Revisa ofertas enviadas, contraofertas recibidas y acuerdos en entrega.</p>
                </div>
              </div>
            </div>
            <h4 style="margin-bottom: 0.6rem">Ofertas enviadas</h4>
            <div id="sent-offers" class="list"></div>
            <div class="empty-state hidden" id="sent-empty">
              <h4>No has enviado ofertas todavía</h4>
              <p>Explora el feed y ofrece varios productos en un mismo canje.</p>
            </div>
            <h4 style="margin-top: 2rem; margin-bottom: 0.6rem">Ofertas recibidas</h4>
            <div id="received-offers" class="list"></div>
            <div class="empty-state hidden" id="received-empty">
              <h4>Sin ofertas entrantes por ahora</h4>
              <p>Cuando otros usuarios oferten sobre tus artículos, aparecerán aquí.</p>
            </div>
            <h4 style="margin-top: 2rem; margin-bottom: 0.6rem">Acuerdos en curso</h4>
            <div id="active-agreements" class="list"></div>
            <div class="empty-state hidden" id="agreements-empty">
              <h4>No tienes acuerdos activos</h4>
              <p>Una vez aceptes un canje, lo verás aquí para coordinar la entrega.</p>
            </div>
          </section>

          <section class="panel" id="history">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon"><i class="fa-solid fa-trophy"></i></span>
                <div>
                  <h3>Historial de canjes completados</h3>
                  <p>Califica a tus contrapartes y consulta el detalle de cada intercambio.</p>
                </div>
              </div>
            </div>
            <div id="history-list" class="list"></div>
            <div class="empty-state hidden" id="history-empty">
              <h4>Todavía no has completado canjes</h4>
              <p>Cuando cierres tus acuerdos, podrás calificarlos y consultarlos aquí.</p>
            </div>
          </section>

          <section class="panel" id="reputation">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon"><i class="fa-solid fa-gem"></i></span>
                <div>
                  <h3>Gestión de reputación y reseñas</h3>
                  <p>Mantén un perfil confiable con reseñas verificadas por cada canje.</p>
                </div>
              </div>
            </div>
            <div class="review-list" id="review-list"></div>
            <div class="empty-state hidden" id="review-empty">
              <h4>Aún no tienes reseñas</h4>
              <p>Completa canjes y solicita a tus contrapartes que te dejen una reseña.</p>
            </div>
          </section>

          <section class="panel" id="support">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon"><i class="fa-solid fa-shield-halved"></i></span>
                <div>
                  <h3>Reportes y soporte</h3>
                  <p>Denuncia publicaciones falsas o incumplimientos para proteger la comunidad.</p>
                </div>
              </div>
            </div>
            <div style="display: grid; gap: 1.2rem">
              <div class="timeline">
                <div class="timeline-step">
                  <strong>Denuncias de publicaciones</strong>
                  <span id="report-count">0 reportes enviados</span>
                  <p style="margin: 0; color: var(--muted); font-size: 0.92rem">
                    Cada reporte es analizado en menos de 24h por nuestro equipo de confianza.
                  </p>
                </div>
                <div class="timeline-step">
                  <strong>Política de protección</strong>
                  <p style="margin: 0; color: var(--muted); font-size: 0.92rem">
                    Documentamos el historial de cada usuario y desactivamos cuentas con
                    incumplimientos repetidos.
                  </p>
                </div>
              </div>
              <button class="btn btn-outline" id="open-report">Denunciar una publicación</button>
            </div>
          </section>
        </div>
      </div>
    </main>

    <nav class="premium-bottom-nav" aria-label="Navegación principal de Cambalaches">
      <button type="button" data-target="feed-section" data-nav="primary" class="active">
        <span class="nav-icon" aria-hidden="true"><i class="fa-solid fa-compass"></i></span>
        <span class="nav-label">Explorar</span>
      </button>
      <button type="button" data-target="my-items" data-nav="primary">
        <span class="nav-icon" aria-hidden="true"><i class="fa-solid fa-layer-group"></i></span>
        <span class="nav-label">Mis artículos</span>
      </button>
      <button type="button" data-target="active-exchanges" data-nav="primary">
        <span class="nav-icon" aria-hidden="true"><i class="fa-solid fa-arrows-rotate"></i></span>
        <span class="nav-label">Canjes</span>
      </button>
      <button type="button" data-target="reputation" data-nav="primary">
        <span class="nav-icon" aria-hidden="true"><i class="fa-solid fa-gem"></i></span>
        <span class="nav-label">Reputación</span>
      </button>
      <button type="button" data-target="support" data-nav="primary">
        <span class="nav-icon" aria-hidden="true"><i class="fa-solid fa-shield-halved"></i></span>
        <span class="nav-label">Soporte</span>
      </button>
    </nav>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <dialog id="auth-modal">
      <form method="dialog" class="modal-body" id="auth-form">
        <div class="modal-header">
          <div>
            <h3>Crea tu cuenta verificada</h3>
            <p style="margin: 0; color: var(--muted)">
              Sube tu foto, completa tus datos y habilita la publicación de artículos.
            </p>
          </div>
          <button type="button" class="modal-close" data-close="auth-modal">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="form-grid">
          <div class="form-row inline">
            <label>
              Nombre completo
              <input type="text" id="auth-name" required placeholder="Tu nombre" />
            </label>
            <label>
              Correo electrónico
              <input type="email" id="auth-email" required placeholder="nombre@correo.com" />
            </label>
          </div>
          <div class="form-row inline">
            <label>
              Teléfono verificado
              <input type="tel" id="auth-phone" required placeholder="300 000 0000" />
            </label>
            <label>
              Ciudad y país
              <input type="text" id="auth-location" required placeholder="Bogotá, Colombia" />
            </label>
          </div>
          <div class="form-row">
            <label>
              Foto de perfil (PNG o JPG)
              <input type="file" id="auth-photo" accept="image/*" required />
            </label>
          </div>
          <div class="form-row">
            <label style="display: flex; align-items: flex-start; gap: 0.6rem">
              <input type="checkbox" id="auth-terms" required />
              <span>Acepto las políticas de verificación, reputación y resolución de disputas.</span>
            </label>
          </div>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 0.75rem">
          <button type="button" class="btn btn-outline" data-close="auth-modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Crear cuenta</button>
        </div>
      </form>
    </dialog>

    <dialog id="publish-modal">
      <form method="dialog" class="modal-body" id="publish-form">
        <div class="modal-header">
          <div>
            <h3>Publicar nuevo producto o servicio</h3>
            <p style="margin: 0; color: var(--muted)">
              Completa la información con mínimo tres imágenes reales. Todos los campos son
              obligatorios.
            </p>
          </div>
          <button type="button" class="modal-close" data-close="publish-modal">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="form-grid">
          <div class="form-row inline">
            <label>
              Nombre del artículo
              <input type="text" id="product-name" required />
            </label>
            <label>
              Categoría
              <select id="product-category" required>
                <option value="">Selecciona</option>
                <option value="tecnologia">Tecnología</option>
                <option value="agricultura">Agricultura</option>
                <option value="hogar">Hogar</option>
                <option value="vehiculos">Vehículos</option>
                <option value="servicios">Servicios</option>
                <option value="moda">Moda</option>
                <option value="coleccionables">Coleccionables</option>
              </select>
            </label>
          </div>
          <div class="form-row">
            <label>
              Descripción detallada
              <textarea id="product-description" required placeholder="Incluye estado, uso y valor estimado en COP."></textarea>
            </label>
          </div>
          <div class="form-row inline">
            <label>
              Precio estimado (COP)
              <input type="number" id="product-price" min="0" step="500" required />
            </label>
            <label>
              Ubicación
              <input type="text" id="product-location" required placeholder="Ciudad, barrio" />
            </label>
          </div>
          <div class="form-row">
            <label>
              Imágenes (mínimo 3, máximo 10)
              <input type="file" id="product-images" accept="image/*" multiple required />
            </label>
            <div class="image-preview-grid" id="image-preview"></div>
          </div>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 0.75rem">
          <button type="button" class="btn btn-outline" data-close="publish-modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Publicar en el feed</button>
        </div>
      </form>
    </dialog>

    <dialog id="offer-modal">
      <form method="dialog" class="modal-body" id="offer-form">
        <div class="modal-header">
          <div>
            <h3>Crear oferta de canje</h3>
            <p style="margin: 0; color: var(--muted)">
              Selecciona uno o varios de tus productos y ajusta la compensación en COP.
            </p>
          </div>
          <button type="button" class="modal-close" data-close="offer-modal">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="form-grid" id="offer-content"></div>
        <div style="display: flex; justify-content: flex-end; gap: 0.75rem">
          <button type="button" class="btn btn-outline" data-close="offer-modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Enviar oferta</button>
        </div>
      </form>
    </dialog>

    <dialog id="negotiate-modal">
      <form method="dialog" class="modal-body" id="negotiate-form">
        <div class="modal-header">
          <div>
            <h3>Responder contraoferta</h3>
            <p style="margin: 0; color: var(--muted)">
              Ajusta los artículos aceptados o propone una nueva diferencia en COP.
            </p>
          </div>
          <button type="button" class="modal-close" data-close="negotiate-modal">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="form-grid" id="negotiate-content"></div>
        <div style="display: flex; justify-content: flex-end; gap: 0.75rem">
          <button type="button" class="btn btn-outline" data-close="negotiate-modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Enviar contraoferta</button>
        </div>
      </form>
    </dialog>

    <dialog id="report-modal">
      <form method="dialog" class="modal-body" id="report-form">
        <div class="modal-header">
          <div>
            <h3>Reportar publicación o usuario</h3>
            <p style="margin: 0; color: var(--muted)">
              Describe el motivo del reporte con la mayor cantidad de detalles posibles.
            </p>
          </div>
          <button type="button" class="modal-close" data-close="report-modal">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="form-grid">
          <div class="form-row">
            <label>
              Enlace o referencia
              <input type="text" id="report-reference" required placeholder="Título del artículo o ID del canje" />
            </label>
          </div>
          <div class="form-row">
            <label>
              Descripción del reporte
              <textarea id="report-description" required placeholder="Explica lo ocurrido, fechas y evidencia disponible."></textarea>
            </label>
          </div>
          <div class="form-row">
            <label style="display: flex; align-items: flex-start; gap: 0.6rem">
              <input type="checkbox" id="report-terms" required />
              <span>Declaro que la información compartida es verídica y puedo aportar evidencia adicional.</span>
            </label>
          </div>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 0.75rem">
          <button type="button" class="btn btn-outline" data-close="report-modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Enviar reporte</button>
        </div>
      </form>
    </dialog>

    <script>
      const $ = (selector, scope = document) => scope.querySelector(selector);
      const $$ = (selector, scope = document) => Array.from(scope.querySelectorAll(selector));

      const formatCOP = (value) =>
        new Intl.NumberFormat("es-CO", { style: "currency", currency: "COP", maximumFractionDigits: 0 }).format(value);

      const generateId = (prefix) => `${prefix}-${Math.random().toString(36).slice(2, 9)}`;

      const state = {
        currentUser: null,
        products: [],
        offersSent: [],
        offersReceived: [],
        activeAgreements: [],
        history: [],
        reviews: [],
        reports: 0,
        modals: {},
      };

      const sampleUsers = [
        {
          id: "u-laura",
          name: "Laura Mejía",
          email: "laura@agrotech.co",
          phone: "+57 300 123 4567",
          location: "Medellín, Colombia",
          avatar:
            "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=160&q=80",
          rating: 4.8,
        },
        {
          id: "u-diego",
          name: "Diego Serrano",
          email: "diego@techtune.co",
          phone: "+57 318 222 1199",
          location: "Bogotá, Colombia",
          avatar:
            "https://images.unsplash.com/photo-1527980965255-d3b416303d12?auto=format&fit=crop&w=160&q=80",
          rating: 4.6,
        },
        {
          id: "u-maria",
          name: "María Rivera",
          email: "maria@creativa.studio",
          phone: "+57 315 879 3344",
          location: "Cali, Colombia",
          avatar:
            "https://images.unsplash.com/photo-1544723795-3fb6469f5b39?auto=format&fit=crop&w=160&q=80",
          rating: 4.9,
        },
      ];

      const sampleProducts = [
        {
          id: "prod-drone",
          title: "Drone agrícola DJI Agras T30",
          description:
            "Equipo con 40 vuelos, mantenimiento al día y capacidad de fumigación de precisión en cultivos de hasta 20 hectáreas.",
          category: "agricultura",
          price: 7800000,
          location: "Medellín, Antioquia",
          images: [
            "https://images.unsplash.com/photo-1512820790803-83ca734da794?auto=format&fit=crop&w=900&q=80",
            "https://images.unsplash.com/photo-1504198453319-5ce911bafcde?auto=format&fit=crop&w=900&q=80",
            "https://images.unsplash.com/photo-1501290836517-b22a21c47cbb?auto=format&fit=crop&w=900&q=80",
          ],
          owner: sampleUsers[0],
        },
        {
          id: "prod-studio",
          title: "Estudio fotográfico portátil",
          description:
            "Kit completo con luces LED regulables, panel difusor y fondo plegable. Ideal para e-commerce y contenido de producto.",
          category: "servicios",
          price: 1850000,
          location: "Bogotá, Cundinamarca",
          images: [
            "https://images.unsplash.com/photo-1526045612212-70caf35c14df?auto=format&fit=crop&w=900&q=80",
            "https://images.unsplash.com/photo-1469474968028-56623f02e42e?auto=format&fit=crop&w=900&q=80",
            "https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=900&q=80",
          ],
          owner: sampleUsers[1],
        },
        {
          id: "prod-roadbike",
          title: "Bicicleta de ruta carbono Ultegra",
          description:
            "Marca Canyon Ultimate CF SL8, marco talla M, mantenimiento reciente y accesorios de alto rendimiento incluidos.",
          category: "vehiculos",
          price: 9500000,
          location: "Cali, Valle del Cauca",
          images: [
            "https://images.unsplash.com/photo-1529429617124-aee711a615c3?auto=format&fit=crop&w=900&q=80",
            "https://images.unsplash.com/photo-1558980664-10ea646823c3?auto=format&fit=crop&w=900&q=80",
            "https://images.unsplash.com/photo-1507831228880-ec414a4be0c1?auto=format&fit=crop&w=900&q=80",
          ],
          owner: sampleUsers[2],
        },
        {
          id: "prod-cafe",
          title: "Lote café especial microtostado",
          description:
            "40 kg de café origen Pijao, tostado medio, notas a panela y cacao. Incluye análisis de laboratorio SCA 86.",
          category: "agricultura",
          price: 3200000,
          location: "Armenia, Quindío",
          images: [
            "https://images.unsplash.com/photo-1447933601403-0c6688de566e?auto=format&fit=crop&w=900&q=80",
            "https://images.unsplash.com/photo-1470162656305-6f429ba817b7?auto=format&fit=crop&w=900&q=80",
            "https://images.unsplash.com/photo-1447935765200-8841221efcb6?auto=format&fit=crop&w=900&q=80",
          ],
          owner: sampleUsers[0],
        },
      ];

      const sampleIncomingOffer = () => ({
        id: generateId("offer"),
        product: null,
        proposer: sampleUsers[1],
        items: [
          { title: "Servicio de fotografía para catálogo", price: 850000 },
          { title: "Consultoría SEO 4 horas", price: 450000 },
        ],
        extra: 250000,
        status: "pendiente",
        createdAt: new Date(),
        notes: "Podemos entregar el servicio en máximo 5 días hábiles.",
      });

      state.products = [...sampleProducts];

      const toastEl = $("#toast");
      let toastTimeout = null;

      function showToast(message, type = "info") {
        toastEl.textContent = "";
        toastEl.className = `toast ${type}`;
        toastEl.innerHTML = `<i class="fa-solid fa-bell"></i><div>${message}</div>`;
        toastEl.classList.add("show");
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => toastEl.classList.remove("show"), 3800);
      }

      function openModal(id) {
        const dialog = document.getElementById(id);
        if (dialog && !dialog.open) {
          dialog.removeAttribute("data-closing");
          dialog.showModal();
        }
      }

      function closeModal(id) {
        const dialog = document.getElementById(id);
        if (dialog && dialog.open) {
          dialog.setAttribute("data-closing", "true");
          const handleTransition = (event) => {
            if (event.propertyName === "transform") {
              dialog.removeEventListener("transitionend", handleTransition);
              dialog.removeAttribute("data-closing");
              dialog.close();
            }
          };

          dialog.addEventListener("transitionend", handleTransition);

          setTimeout(() => {
            if (dialog.hasAttribute("data-closing")) {
              dialog.removeEventListener("transitionend", handleTransition);
              dialog.removeAttribute("data-closing");
              dialog.close();
            }
          }, 350);
        }
      }

      function readFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(new Error("Error al leer archivo"));
          reader.readAsDataURL(file);
        });
      }

      function ensureAuthenticated(callback) {
        if (!state.currentUser) {
          showToast("Debes crear tu cuenta verificada para continuar.", "danger");
          openModal("auth-modal");
          return false;
        }
        if (typeof callback === "function") callback();
        return true;
      }

      function updateProfileCard() {
        const avatar = $("#profile-avatar");
        const navAvatar = $("#nav-avatar");
        const nameEl = $("#profile-name");
        const emailEl = $("#profile-email");
        const phoneEl = $("#profile-phone");
        const locationEl = $("#profile-location");
        const badge = $("#verified-badge");

        if (!state.currentUser) {
          avatar.innerHTML =
            '<div style="width:100%;height:100%;display:grid;place-items:center;background:rgba(76,81,255,0.08);color:var(--primary-600);font-weight:700;">CB</div>';
          navAvatar.classList.add("hidden");
          nameEl.textContent = "Invitado";
          emailEl.textContent = "Regístrate para publicar";
          phoneEl.textContent = "";
          locationEl.textContent = "";
          badge.classList.add("hidden");
        } else {
          avatar.innerHTML = `<img src="${state.currentUser.avatar}" alt="${state.currentUser.name}" />`;
          navAvatar.innerHTML = `<img src="${state.currentUser.avatar}" alt="${state.currentUser.name}" />`;
          navAvatar.classList.remove("hidden");
          nameEl.textContent = state.currentUser.name;
          emailEl.textContent = state.currentUser.email;
          phoneEl.textContent = state.currentUser.phone;
          locationEl.textContent = state.currentUser.location;
          badge.classList.remove("hidden");
        }

        $("#stat-completed").textContent = state.history.length;
        $("#stat-active").textContent = state.activeAgreements.length + state.offersSent.length;
        const average =
          state.reviews.length
            ? (state.reviews.reduce((sum, review) => sum + review.rating, 0) / state.reviews.length).toFixed(1)
            : "-";
        $("#stat-rating").textContent = average;
      }

      function renderFeed() {
        const grid = $("#feed-grid");
        const empty = $("#feed-empty");
        grid.innerHTML = "";

        const category = $("#filter-category").value;
        const location = $("#filter-location").value.trim().toLowerCase();
        const min = Number($("#filter-min").value) || 0;
        const max = Number($("#filter-max").value) || Number.MAX_SAFE_INTEGER;
        const keyword = $("#filter-keyword").value.trim().toLowerCase();

        const results = state.products.filter((product) => {
          const matchesCategory = category ? product.category === category : true;
          const matchesLocation = location
            ? product.location.toLowerCase().includes(location)
            : true;
          const matchesKeyword = keyword
            ? `${product.title} ${product.description}`.toLowerCase().includes(keyword)
            : true;
          const matchesPrice = product.price >= min && product.price <= max;
          return matchesCategory && matchesLocation && matchesKeyword && matchesPrice;
        });

        if (!results.length) {
          empty.classList.remove("hidden");
          return;
        }

        empty.classList.add("hidden");

        results.forEach((product) => {
          const card = document.createElement("article");
          card.className = "product-card";

          const media = document.createElement("div");
          media.className = "product-media";
          const img = document.createElement("img");
          img.src = product.images[0];
          img.alt = product.title;
          media.appendChild(img);

          if (product.images.length > 1) {
            let currentIndex = 0;
            const controls = document.createElement("div");
            controls.className = "media-controls";
            const prevBtn = document.createElement("button");
            prevBtn.type = "button";
            prevBtn.innerHTML = '<i class="fa-solid fa-chevron-left"></i>';
            const nextBtn = document.createElement("button");
            nextBtn.type = "button";
            nextBtn.innerHTML = '<i class="fa-solid fa-chevron-right"></i>';
            controls.append(prevBtn, nextBtn);
            prevBtn.addEventListener("click", () => {
              currentIndex = (currentIndex - 1 + product.images.length) % product.images.length;
              img.src = product.images[currentIndex];
            });
            nextBtn.addEventListener("click", () => {
              currentIndex = (currentIndex + 1) % product.images.length;
              img.src = product.images[currentIndex];
            });
            media.appendChild(controls);
          }

          const body = document.createElement("div");
          body.className = "product-body";
          body.innerHTML = `
            <div class="product-price">${formatCOP(product.price)}</div>
            <h4>${product.title}</h4>
            <div class="product-meta">
              <span><i class="fa-solid fa-location-dot" style="color: var(--primary-600);"></i> ${product.location}</span>
              <span><i class="fa-solid fa-tag" style="color: var(--muted);"></i> ${product.category}</span>
            </div>
            <p style="margin:0; color: var(--muted); line-height:1.5;">${product.description}</p>
            <div class="product-meta">
              <span><i class="fa-solid fa-user-check" style="color: var(--primary-600);"></i> ${product.owner.name}</span>
              <span>Reputación ${product.owner.rating ?? "4.7"} ⭐</span>
            </div>
          `;

          const actions = document.createElement("div");
          actions.className = "product-actions";

          if (state.currentUser && product.owner.id === state.currentUser.id) {
            const ownBadge = document.createElement("span");
            ownBadge.className = "badge self";
            ownBadge.innerHTML = '<i class="fa-solid fa-circle"></i> Tu publicación';
            actions.appendChild(ownBadge);
          } else {
            const offerBtn = document.createElement("button");
            offerBtn.type = "button";
            offerBtn.className = "btn btn-primary";
            offerBtn.textContent = "Ofertar canje";
            offerBtn.addEventListener("click", () => openOfferModal(product));
            actions.appendChild(offerBtn);
          }

          const reportBtn = document.createElement("button");
          reportBtn.type = "button";
          reportBtn.className = "btn btn-outline";
          reportBtn.textContent = "Reportar";
          reportBtn.addEventListener("click", () => openReportModal(product));
          actions.appendChild(reportBtn);

          card.append(media, body, actions);
          grid.appendChild(card);
        });
      }

      function renderMyItems() {
        const list = $("#my-items-list");
        const empty = $("#my-items-empty");
        list.innerHTML = "";

        if (!state.currentUser) {
          empty.classList.remove("hidden");
          list.classList.add("hidden");
          return;
        }

        const mine = state.products.filter((product) => product.owner.id === state.currentUser.id);
        if (!mine.length) {
          empty.classList.remove("hidden");
          list.classList.add("hidden");
          return;
        }

        empty.classList.add("hidden");
        list.classList.remove("hidden");

        mine.forEach((product) => {
          const card = document.createElement("div");
          card.className = "exchange-card";
          card.innerHTML = `
            <div style="display:flex; gap:1rem; align-items:flex-start;">
              <div style="flex:0 0 120px; border-radius:var(--radius-md); overflow:hidden;">
                <img src="${product.images[0]}" alt="${product.title}" style="width:100%;height:100%;object-fit:cover;" />
              </div>
              <div style="flex:1; display:grid; gap:0.45rem;">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:1rem;">
                  <h4 style="margin:0;">${product.title}</h4>
                  <span class="badge">${product.category}</span>
                </div>
                <span class="highlight">${formatCOP(product.price)}</span>
                <p style="margin:0; color:var(--muted); line-height:1.5;">${product.description}</p>
                <span style="color:var(--muted); font-size:0.9rem;"><i class="fa-solid fa-location-dot" style="color: var(--primary-600);"></i> ${product.location}</span>
                <div style="display:flex; gap:0.75rem; flex-wrap:wrap;">
                  <button class="btn btn-outline" type="button" data-edit="${product.id}">Editar</button>
                  <button class="btn btn-outline" type="button" data-remove="${product.id}">Marcar como canjeado</button>
                </div>
              </div>
            </div>
          `;
          list.appendChild(card);
        });

        $$("[data-edit]", list).forEach((btn) =>
          btn.addEventListener("click", () => showToast("La edición avanzada estará disponible pronto.", "info"))
        );
        $$("[data-remove]", list).forEach((btn) =>
          btn.addEventListener("click", (event) => {
            const id = event.currentTarget.getAttribute("data-remove");
            state.products = state.products.filter((product) => product.id !== id);
            showToast("Artículo marcado como canjeado.", "success");
            updateUI();
          })
        );
      }

      function renderOffers() {
        const sentList = $("#sent-offers");
        const receivedList = $("#received-offers");
        const sentEmpty = $("#sent-empty");
        const receivedEmpty = $("#received-empty");
        sentList.innerHTML = "";
        receivedList.innerHTML = "";

        if (!state.currentUser) {
          sentEmpty.classList.remove("hidden");
          receivedEmpty.classList.remove("hidden");
          return;
        }

        if (!state.offersSent.length) {
          sentEmpty.classList.remove("hidden");
        } else {
          sentEmpty.classList.add("hidden");
          state.offersSent.forEach((offer) => {
            const card = document.createElement("div");
            card.className = "exchange-card";
            card.innerHTML = `
              <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:1rem;">
                <div>
                  <h4 style="margin:0;">Oferta a ${offer.product.owner.name}</h4>
                  <p style="margin:0.35rem 0; color:var(--muted);">${offer.product.title}</p>
                  <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                    ${offer.items
                      .map((item) => `<span class="tag">${item.title} · ${formatCOP(item.price)}</span>`)
                      .join("")}
                  </div>
                  <p style="margin:0.35rem 0 0; color:var(--muted);">
                    Diferencia: <strong>${formatCOP(offer.difference)}</strong>
                    ${offer.difference >= 0 ? "a tu favor" : "a favor del receptor"}
                  </p>
                  ${
                    offer.extra > 0
                      ? `<p style="margin:0; color:var(--muted);">Compensación en COP: <strong>${formatCOP(
                          offer.extra
                        )}</strong></p>`
                      : ""
                  }
                </div>
                <span class="exchange-status status-pendiente">${offer.status}</span>
              </div>
            `;
            sentList.appendChild(card);
          });
        }

        if (!state.offersReceived.length) {
          receivedEmpty.classList.remove("hidden");
        } else {
          receivedEmpty.classList.add("hidden");
          state.offersReceived.forEach((offer) => {
            const card = document.createElement("div");
            card.className = "exchange-card";
            card.innerHTML = `
              <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:1rem;">
                <div>
                  <h4 style="margin:0;">${offer.proposer.name} desea tu ${offer.product.title}</h4>
                  <p style="margin:0.35rem 0; color:var(--muted);">Mensaje: ${offer.notes}</p>
                  <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                    ${offer.items
                      .map((item) => `<span class="tag">${item.title} · ${formatCOP(item.price)}</span>`)
                      .join("")}
                  </div>
                  <p style="margin:0.35rem 0 0; color:var(--muted);">
                    Oferta total: <strong>${formatCOP(
                      offer.items.reduce((sum, item) => sum + item.price, 0) + offer.extra
                    )}</strong>
                  </p>
                  <p style="margin:0; color:var(--muted);">
                    Diferencia frente a tu artículo: <strong>${formatCOP(offer.difference)}</strong> ${offer.difference >= 0 ? '(recibirías valor extra)' : '(deben equilibrar con más valor)'}
                  </p>
                </div>
                <div style="display:grid; gap:0.6rem;">
                  <span class="exchange-status status-pendiente">Pendiente de tu respuesta</span>
                  <button class="btn btn-primary" type="button" data-accept="${offer.id}">Aceptar canje</button>
                  <button class="btn btn-outline" type="button" data-negotiate="${offer.id}">Negociar</button>
                  <button class="btn btn-outline" type="button" data-reject="${offer.id}">Rechazar</button>
                </div>
              </div>
            `;
            receivedList.appendChild(card);
          });

          $$("[data-accept]", receivedList).forEach((btn) =>
            btn.addEventListener("click", (event) => {
              const id = event.currentTarget.getAttribute("data-accept");
              const offer = state.offersReceived.find((item) => item.id === id);
              if (!offer) return;
              state.offersReceived = state.offersReceived.filter((item) => item.id !== id);
              state.activeAgreements.push({
                id: generateId("agreement"),
                role: "owner",
                status: "Pendiente de entrega",
                startedAt: new Date(),
                offer,
                chat: [
                  {
                    author: offer.proposer.name,
                    message: "Gracias por aceptar, coordino entrega en tu horario.",
                    me: false,
                    timestamp: new Date(),
                  },
                ],
              });
              showToast("Has aceptado el canje. Coordina la entrega.", "success");
              updateUI();
            })
          );

          $$("[data-negotiate]", receivedList).forEach((btn) =>
            btn.addEventListener("click", (event) => {
              const id = event.currentTarget.getAttribute("data-negotiate");
              const offer = state.offersReceived.find((item) => item.id === id);
              if (!offer) return;
              openNegotiateModal(offer);
            })
          );

          $$("[data-reject]", receivedList).forEach((btn) =>
            btn.addEventListener("click", (event) => {
              const id = event.currentTarget.getAttribute("data-reject");
              state.offersReceived = state.offersReceived.filter((item) => item.id !== id);
              showToast("Oferta rechazada.", "info");
              updateUI();
            })
          );
        }
      }

      function renderAgreements() {
        const list = $("#active-agreements");
        const empty = $("#agreements-empty");
        list.innerHTML = "";

        if (!state.currentUser || !state.activeAgreements.length) {
          empty.classList.remove("hidden");
          return;
        }

        empty.classList.add("hidden");

        state.activeAgreements.forEach((agreement) => {
          const card = document.createElement("div");
          card.className = "exchange-card";
          const offer = agreement.offer;
          const totalOffer = offer.items.reduce((sum, item) => sum + item.price, 0) + offer.extra;
          card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:1rem;">
              <div style="display:grid; gap:0.5rem;">
                <h4 style="margin:0;">${offer.proposer.name} ⇄ ${state.currentUser.name}</h4>
                <span class="exchange-status status-entrega">${agreement.status}</span>
                <p style="margin:0; color:var(--muted);">Producto objetivo: <strong>${offer.product.title}</strong></p>
                <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                  ${offer.items
                    .map((item) => `<span class="tag">${item.title} · ${formatCOP(item.price)}</span>`)
                    .join("")}
                </div>
                <p style="margin:0; color:var(--muted);">Total de la oferta: <strong>${formatCOP(totalOffer)}</strong></p>
              </div>
              <div style="display:grid; gap:0.6rem;">
                <button class="btn btn-primary" type="button" data-complete="${agreement.id}">Marcar completado</button>
              </div>
            </div>
            <div class="chat-box">
              <strong>Chat seguro</strong>
              <div class="chat-messages" data-chat="${agreement.id}"></div>
              <div class="chat-input">
                <input type="text" placeholder="Escribe un mensaje" data-chat-input="${agreement.id}" />
                <button type="button" data-chat-send="${agreement.id}">Enviar</button>
              </div>
            </div>
          `;
          list.appendChild(card);
        });

        state.activeAgreements.forEach((agreement) => {
          const container = $(`[data-chat="${agreement.id}"]`);
          container.innerHTML = "";
          agreement.chat.forEach((message) => {
            const bubble = document.createElement("div");
            bubble.className = `chat-message ${message.me ? "me" : ""}`;
            bubble.innerHTML = `
              <small>${message.me ? "Tú" : message.author} · ${new Date(message.timestamp).toLocaleString("es-CO", {
                hour: "2-digit",
                minute: "2-digit",
              })}</small>
              <span>${message.message}</span>
            `;
            container.appendChild(bubble);
          });
        });

        $$("[data-chat-send]").forEach((btn) =>
          btn.addEventListener("click", (event) => {
            const id = event.currentTarget.getAttribute("data-chat-send");
            const input = $(`[data-chat-input="${id}"]`);
            if (!input.value.trim()) return;
            const agreement = state.activeAgreements.find((item) => item.id === id);
            agreement.chat.push({
              author: state.currentUser.name,
              message: input.value.trim(),
              me: true,
              timestamp: new Date(),
            });
            input.value = "";
            renderAgreements();
          })
        );

        $$("[data-complete]").forEach((btn) =>
          btn.addEventListener("click", (event) => {
            const id = event.currentTarget.getAttribute("data-complete");
            const agreement = state.activeAgreements.find((item) => item.id === id);
            if (!agreement) return;
            state.activeAgreements = state.activeAgreements.filter((item) => item.id !== id);
            state.history.push({
              id: generateId("history"),
              completedAt: new Date(),
              offer: agreement.offer,
              rating: null,
              comment: "",
            });
            showToast("Canje marcado como completado. Califica a tu contraparte.", "success");
            updateUI();
          })
        );
      }

      function renderHistory() {
        const list = $("#history-list");
        const empty = $("#history-empty");
        list.innerHTML = "";

        if (!state.currentUser || !state.history.length) {
          empty.classList.remove("hidden");
          return;
        }

        empty.classList.add("hidden");

        state.history.forEach((entry) => {
          const { offer } = entry;
          const totalOffer = offer.items.reduce((sum, item) => sum + item.price, 0) + offer.extra;
          const card = document.createElement("div");
          card.className = "history-card";
          card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; gap:1rem;">
              <h4 style="margin:0;">${offer.proposer.name} ⇄ ${state.currentUser.name}</h4>
              <span style="color:var(--muted); font-size:0.85rem;">${new Date(entry.completedAt).toLocaleDateString("es-CO")}</span>
            </div>
            <p style="margin:0; color:var(--muted);">Producto canjeado: <strong>${offer.product.title}</strong></p>
            <p style="margin:0; color:var(--muted);">Valor total recibido: <strong>${formatCOP(totalOffer)}</strong></p>
            <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
              ${offer.items
                .map((item) => `<span class="tag">${item.title} · ${formatCOP(item.price)}</span>`)
                .join("")}
            </div>
            ${
              entry.rating
                ? `<p style="margin:0;">Calificación dada: <strong>${entry.rating} ⭐</strong><br/>Comentario: ${entry.comment}</p>`
                : `<div>
                    <span style="display:block; margin-bottom:0.4rem;">Califica a ${offer.proposer.name}</span>
                    <div class="rating-control" data-rate="${entry.id}">
                      ${Array.from({ length: 5 })
                        .map((_, index) => `<i class="fa-solid fa-star" data-value="${index + 1}"></i>`)
                        .join("")}
                    </div>
                    <textarea data-comment="${entry.id}" placeholder="Comparte tu experiencia"></textarea>
                    <button class="btn btn-primary" type="button" data-save-review="${entry.id}">Guardar reseña</button>
                  </div>`
            }
          `;
          list.appendChild(card);
        });

        $$("[data-rate]").forEach((wrapper) => {
          wrapper.addEventListener("click", (event) => {
            const star = event.target.closest("[data-value]");
            if (!star) return;
            const value = Number(star.getAttribute("data-value"));
            wrapper.dataset.selected = value;
            $$("[data-value]", wrapper).forEach((item) => {
              const starValue = Number(item.getAttribute("data-value"));
              item.style.color = starValue <= value ? "#fbbf24" : "#d1d5db";
            });
          });
        });

        $$("[data-save-review]").forEach((btn) =>
          btn.addEventListener("click", (event) => {
            const id = event.currentTarget.getAttribute("data-save-review");
            const wrapper = $(`[data-rate="${id}"]`);
            const commentField = $(`[data-comment="${id}"]`);
            const rating = Number(wrapper?.dataset.selected);
            if (!rating) {
              showToast("Selecciona una calificación antes de guardar.", "danger");
              return;
            }
            const comment = commentField.value.trim();
            const entry = state.history.find((item) => item.id === id);
            entry.rating = rating;
            entry.comment = comment;
            state.reviews.push({
              id: generateId("review"),
              rating,
              comment,
              counterpart: entry.offer.proposer.name,
              createdAt: new Date(),
            });
            showToast("¡Gracias por calificar!", "success");
            updateUI();
          })
        );
      }

      function renderReviews() {
        const list = $("#review-list");
        const empty = $("#review-empty");
        list.innerHTML = "";

        if (!state.currentUser || !state.reviews.length) {
          empty.classList.remove("hidden");
          return;
        }

        empty.classList.add("hidden");

        state.reviews.forEach((review) => {
          const card = document.createElement("div");
          card.className = "review-card";
          card.innerHTML = `
            <strong>${review.counterpart}</strong>
            <span>${"★".repeat(review.rating)}${"☆".repeat(5 - review.rating)}</span>
            <p style="margin:0; color:var(--muted);">${review.comment || "Sin comentarios adicionales."}</p>
            <small style="color:var(--muted);">${new Date(review.createdAt).toLocaleDateString("es-CO")}</small>
          `;
          list.appendChild(card);
        });
      }

      function openOfferModal(product) {
        if (!ensureAuthenticated()) return;
        const myItems = state.products.filter((item) => item.owner.id === state.currentUser.id);
        if (!myItems.length) {
          showToast("Publica primero tus artículos para poder ofertar.", "danger");
          return;
        }

        const content = $("#offer-content");
        content.innerHTML = "";
        const info = document.createElement("div");
        info.innerHTML = `
          <div class="difference-badge">
            <span>Estás ofertando por</span>
            <strong>${product.title}</strong>
            <span>Valor objetivo: ${formatCOP(product.price)}</span>
          </div>
        `;
        content.appendChild(info);

        const list = document.createElement("div");
        list.className = "offer-items";
        myItems.forEach((item) => {
          const row = document.createElement("label");
          row.className = "offer-item";
          row.innerHTML = `
            <input type="checkbox" value="${item.id}" data-price="${item.price}" data-title="${item.title}" />
            <div style="display:grid; gap:0.2rem;">
              <span>${item.title}</span>
              <small>${formatCOP(item.price)}</small>
            </div>
          `;
          list.appendChild(row);
        });

        const cashRow = document.createElement("div");
        cashRow.className = "form-row";
        cashRow.innerHTML = `
          <label>
            Compensación adicional en COP (opcional)
            <input type="number" min="0" step="1000" id="offer-extra" />
          </label>
        `;

        const summary = document.createElement("div");
        summary.className = "difference-badge";
        summary.id = "offer-summary";
        summary.innerHTML = `
          <span>Total de tu oferta: <strong>${formatCOP(0)}</strong></span>
          <span>Diferencia vs artículo objetivo: <strong>${formatCOP(-product.price)}</strong></span>
          <small>Selecciona artículos y agrega compensación si tu oferta es menor.</small>
        `;

        content.append(list, cashRow, summary);
        openModal("offer-modal");

        const updateSummary = () => {
          const selected = $$("input[type='checkbox'][data-price]:checked", content);
          const extra = Number($("#offer-extra").value) || 0;
          const totalProducts = selected.reduce((sum, input) => sum + Number(input.dataset.price), 0);
          const totalOffer = totalProducts + extra;
          const difference = totalOffer - product.price;
          summary.innerHTML = `
            <span>Total de tu oferta: <strong>${formatCOP(totalOffer)}</strong></span>
            <span>Diferencia vs artículo objetivo: <strong>${formatCOP(difference)}</strong></span>
            <small>${
              difference >= 0
                ? "Tu oferta cubre el valor del artículo."
                : "Agrega más productos o compensación para equilibrar la oferta."
            }</small>
          `;
          summary.dataset.difference = difference;
          summary.dataset.total = totalOffer;
        };

        list.addEventListener("change", updateSummary);
        $("#offer-extra").addEventListener("input", updateSummary);
        updateSummary();

        const form = $("#offer-form");
        form.onsubmit = (event) => {
          event.preventDefault();
          const selected = $$("input[type='checkbox'][data-price]:checked", content);
          if (!selected.length) {
            showToast("Selecciona al menos un artículo propio para ofertar.", "danger");
            return;
          }
          const extra = Number($("#offer-extra").value) || 0;
          const total = Number(summary.dataset.total || 0);
          const difference = Number(summary.dataset.difference || 0);
          if (difference < 0 && extra === 0) {
            showToast("Aporta compensación en COP si tu oferta es menor.", "danger");
            return;
          }
          const items = selected.map((input) => ({
            id: input.value,
            title: input.dataset.title,
            price: Number(input.dataset.price),
          }));
          state.offersSent.push({
            id: generateId("offer"),
            product,
            items,
            extra,
            total,
            difference,
            status: "Enviada",
            createdAt: new Date(),
          });
          showToast("Oferta enviada correctamente.", "success");
          closeModal("offer-modal");
          updateUI();
        };
      }

      function openNegotiateModal(offer) {
        const content = $("#negotiate-content");
        content.innerHTML = `
          <div class="difference-badge">
            <span>Contraofertar sobre: <strong>${offer.product.title}</strong></span>
            <span>Oferta actual: <strong>${formatCOP(
              offer.items.reduce((sum, item) => sum + item.price, 0) + offer.extra
            )}</strong></span>
          </div>
          <div class="negotiation-options">
            <label>
              Ajustar compensación en COP
              <input type="number" min="0" step="500" id="negotiate-extra" value="${offer.extra}" />
            </label>
            <label>
              Comentarios adicionales
              <textarea id="negotiate-message" placeholder="Propón cambios, fechas de entrega o condiciones.">${
                offer.notes || ""
              }</textarea>
            </label>
          </div>
        `;
        openModal("negotiate-modal");

        const form = $("#negotiate-form");
        form.onsubmit = (event) => {
          event.preventDefault();
          const extra = Number($("#negotiate-extra").value) || 0;
          const message = $("#negotiate-message").value.trim();
          const productValue = offer.product.price;
          const currentItems = offer.items.reduce((sum, item) => sum + item.price, 0);
          const newDifference = currentItems + extra - productValue;
          offer.extra = extra;
          offer.difference = newDifference;
          offer.notes = message || "Contraoferta enviada";
          offer.status = "negociacion";
          showToast("Contraoferta enviada al usuario.", "success");
          closeModal("negotiate-modal");
          updateUI();
        };
      }

      function openReportModal(product) {
        if (product) {
          $("#report-reference").value = `${product.title} (${product.id})`;
        }
        openModal("report-modal");
        $("#report-form").onsubmit = (event) => {
          event.preventDefault();
          if (!$("#report-terms").checked) {
            showToast("Debes aceptar la declaración para enviar el reporte.", "danger");
            return;
          }
          state.reports += 1;
          $("#report-count").textContent = `${state.reports} reportes enviados`;
          showToast("Reporte enviado. Nuestro equipo lo revisará.", "success");
          closeModal("report-modal");
          event.target.reset();
        };
      }

      function handleAuth(event) {
        event.preventDefault();
        const name = $("#auth-name").value.trim();
        const email = $("#auth-email").value.trim();
        const phone = $("#auth-phone").value.trim();
        const location = $("#auth-location").value.trim();
        const file = $("#auth-photo").files[0];
        const acceptedTerms = $("#auth-terms").checked;
        if (!name || !email || !phone || !location || !file || !acceptedTerms) {
          showToast("Completa todos los campos de verificación.", "danger");
          return;
        }
        readFile(file).then((avatar) => {
          state.currentUser = {
            id: generateId("user"),
            name,
            email,
            phone,
            location,
            avatar,
            rating: 5,
          };
          closeModal("auth-modal");
          showToast("Cuenta verificada creada. ¡Ya puedes publicar!", "success");
          updateUI();
        });
      }

      function handlePublish(event) {
        event.preventDefault();
        if (!ensureAuthenticated()) return;
        const title = $("#product-name").value.trim();
        const category = $("#product-category").value;
        const description = $("#product-description").value.trim();
        const price = Number($("#product-price").value);
        const location = $("#product-location").value.trim();
        const files = Array.from($("#product-images").files || []);

        if (!title || !category || !description || !price || !location) {
          showToast("Completa todos los campos obligatorios.", "danger");
          return;
        }
        if (files.length < 3 || files.length > 10) {
          showToast("Adjunta entre 3 y 10 imágenes reales.", "danger");
          return;
        }

        Promise.all(files.map((file) => readFile(file))).then((images) => {
          const product = {
            id: generateId("prod"),
            title,
            description,
            category,
            price,
            location,
            images,
            owner: state.currentUser,
          };
          state.products.unshift(product);
          closeModal("publish-modal");
          showToast("Producto publicado en el feed.", "success");
          event.target.reset();
          $("#image-preview").innerHTML = "";
          updateUI();
          setTimeout(() => simulateIncomingOffer(product), 5500);
        });
      }

      function simulateIncomingOffer(product) {
        if (!state.currentUser || product.owner.id !== state.currentUser.id) return;
        const offer = sampleIncomingOffer();
        offer.product = product;
        const totalItems = offer.items.reduce((sum, item) => sum + item.price, 0);
        offer.difference = totalItems + offer.extra - product.price;
        state.offersReceived.unshift(offer);
        showToast(`Nueva oferta recibida para ${product.title}.`, "info");
        updateUI();
      }

      function updatePreview(event) {
        const files = Array.from(event.target.files || []);
        const container = $("#image-preview");
        container.innerHTML = "";
        files.slice(0, 10).forEach((file) => {
          if (!file.type.startsWith("image")) return;
          const preview = document.createElement("div");
          preview.className = "image-preview";
          const img = document.createElement("img");
          preview.appendChild(img);
          container.appendChild(preview);
          const reader = new FileReader();
          reader.onload = () => (img.src = reader.result);
          reader.readAsDataURL(file);
        });
      }

      function updateAuthButton() {
        const authBtn = $("#open-auth");
        if (!authBtn) return;
        if (state.currentUser) {
          authBtn.textContent = "Cerrar sesión";
          authBtn.onclick = () => {
            state.currentUser = null;
            state.offersSent = [];
            state.offersReceived = [];
            state.activeAgreements = [];
            state.history = [];
            state.reviews = [];
            showToast("Sesión cerrada. Hasta pronto.", "info");
            updateUI();
          };
        } else {
          authBtn.textContent = "Ingresar";
          authBtn.onclick = () => openModal("auth-modal");
        }
      }

      function updateUI() {
        updateProfileCard();
        updateAuthButton();
        renderFeed();
        renderMyItems();
        renderOffers();
        renderAgreements();
        renderHistory();
        renderReviews();
      }

      function registerNavigation() {
        const scrollToSection = (targetId) => {
          const section = document.getElementById(targetId);
          if (section) {
            section.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        };

        const navButtons = $$("[data-target]");
        const primaryButtons = navButtons.filter((btn) => btn.dataset.nav === "primary");

        const setActive = (targetId) => {
          primaryButtons.forEach((btn) => {
            const isActive = btn.getAttribute("data-target") === targetId;
            btn.classList.toggle("active", isActive);
          });
        };

        navButtons.forEach((btn) =>
          btn.addEventListener("click", (event) => {
            const target = event.currentTarget.getAttribute("data-target");
            scrollToSection(target);
            if (event.currentTarget.dataset.nav === "primary") {
              setActive(target);
            }
          })
        );

        if (primaryButtons.length) {
          setActive("feed-section");
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        registerNavigation();
        updateUI();

        $("#cta-register").addEventListener("click", () => openModal("auth-modal"));
        $("#profile-publish").addEventListener("click", () => ensureAuthenticated(() => openModal("publish-modal")));
        $("#quick-publish").addEventListener("click", () => ensureAuthenticated(() => openModal("publish-modal")));
        $("#feed-publish").addEventListener("click", () => ensureAuthenticated(() => openModal("publish-modal")));
        $("#add-product").addEventListener("click", () => ensureAuthenticated(() => openModal("publish-modal")));
        $("#add-product-secondary").addEventListener("click", () => ensureAuthenticated(() => openModal("publish-modal")));

        $("#auth-form").addEventListener("submit", handleAuth);
        $("#publish-form").addEventListener("submit", handlePublish);
        $("#product-images").addEventListener("change", updatePreview);

        $$("[data-close]").forEach((btn) =>
          btn.addEventListener("click", (event) => closeModal(event.currentTarget.getAttribute("data-close")))
        );

        $$("dialog").forEach((dialog) =>
          dialog.addEventListener("cancel", (event) => {
            event.preventDefault();
            closeModal(dialog.id);
          })
        );

        $("#open-report").addEventListener("click", () => openReportModal());
      });
    </script>
  </body>
</html>
