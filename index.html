<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>CanjeApp - Marketplace de Equivalencia</title>

    <!-- PWA & SEO -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#7d31d2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Canje">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./icons/favicon-16x16.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firebasestorage.googleapis.com" crossorigin>
    <link rel="dns-prefetch" href="//firebasestorage.googleapis.com">
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'brand': {
                            'light': '#b890e1',
                            'DEFAULT': '#7d31d2',
                            'dark': '#4b1d7e',
                        },
                        'gray': {
                            50: '#F9FAFB',
                            100: '#F3F4F6',
                            200: '#E5E7EB',
                            300: '#D1D5DB',
                            400: '#9CA3AF',
                            500: '#6B7280',
                            600: '#4B5563',
                            700: '#374151',
                            800: '#1F2937',
                            900: '#111827',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F9FA;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .page {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Barra lateral */
        #desktop-sidebar { transition: width 0.3s ease-in-out; }
        #desktop-sidebar.collapsed { width: 80px; }
        #desktop-sidebar.collapsed .sidebar-text { display: none; }
        #desktop-sidebar.collapsed .sidebar-title { justify-content: center; }
        #desktop-sidebar.collapsed .sidebar-title .sidebar-text { display: none; }
        #main-content-wrapper.sidebar-collapsed {
            margin-left: 80px;
            transition: margin-left 0.3s ease-in-out;
        }

        /* Input de b√∫squeda */
        .search-input { transition: all 0.2s ease-in-out; }
        .search-input:focus-within {
            box-shadow: 0 1px 6px 0 rgba(32,33,36,0.28);
            border-color: rgba(223,225,229,0);
        }

        /* Nav activo */
        .nav-link-mobile.active { color: #7d31d2; }
        .nav-link-desktop.active {
            background-color: #E8F0FE;
            color: #1A73E8;
            font-weight: 600;
        }
        .nav-link-desktop.active svg { color: #1A73E8; }

        .mobile-nav {
            backdrop-filter: blur(14px);
            padding: 0.25rem 0;
        }
        .mobile-nav-inner {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            width: min(100%, 42rem);
            padding: 0 1.5rem 0.3rem;
            margin: 0 auto;
            height: 58px;
        }
        .mobile-nav-item {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            gap: 0.25rem;
            font-size: 0.7rem;
            font-weight: 500;
            line-height: 1;
            min-width: 3.75rem;
            padding-bottom: 0.25rem;
            transition: all 0.2s ease-in-out;
        }
        .mobile-nav-item .mobile-nav-label {
            font-size: 0.68rem;
            font-weight: 500;
        }
        .mobile-nav-item .mobile-nav-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 9999px;
            background: #F3F4F6;
            color: #4B5563;
            box-shadow: inset 0 0 0 1px rgba(125, 49, 210, 0.05);
            transition: all 0.25s ease;
        }
        .mobile-nav-item.active .mobile-nav-icon {
            background: #7d31d2;
            color: #FFFFFF;
            box-shadow: 0 14px 28px -18px rgba(125, 49, 210, 0.75);
            transform: translateY(-6px);
        }
        .mobile-nav-item--primary {
            padding-bottom: 0.1rem;
        }
        .mobile-nav-item--primary .mobile-nav-icon {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 9999px;
            border: 4px solid #FFFFFF;
            background: #FFFFFF;
            color: #7d31d2;
            box-shadow: 0 18px 32px -18px rgba(125, 49, 210, 0.55);
            transform: translateY(-22px);
        }
        .mobile-nav-item--primary.active .mobile-nav-icon {
            background: #7d31d2;
            color: #FFFFFF;
            border-color: #FFFFFF;
            box-shadow: 0 24px 36px -18px rgba(125, 49, 210, 0.75);
            transform: translateY(-24px);
        }
        .mobile-nav-item.active .mobile-nav-label { color: #7d31d2; }
        
        /* Modal */
        .modal-backdrop { transition: opacity 0.3s ease-in-out; }
        .modal-content {
            transition: all 0.3s ease-in-out;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
        }
        .modal.open .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        
        /* Carrusel */
        .carousel-slide {
            transition: transform 0.5s ease-in-out;
        }

        #most-viewed-container .popular-card {
            width: clamp(11rem, 38vw, 15rem);
        }

        @media (min-width: 640px) {
            #most-viewed-container .popular-card {
                width: clamp(12rem, 28vw, 14.5rem);
            }
        }

        @media (min-width: 1024px) {
            #most-viewed-container .popular-card {
                width: clamp(12.5rem, 20vw, 15rem);
            }
        }

        /* --- NUEVOS ESTILOS --- */

        /* Estilo Glassmorphism para Timer */
        .promo-timer {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            padding: 0.35rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #F8FAFC;
            background: rgba(17, 24, 39, 0.45);
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 18px 32px -18px rgba(15, 23, 42, 0.65);
            backdrop-filter: blur(12px);
            z-index: 30;
        }

        .promo-timer span {
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.06em;
        }

        .promo-timer-dot {
            width: 0.45rem;
            height: 0.45rem;
            border-radius: 9999px;
            background: #7d31d2;
            box-shadow: 0 0 0 3px rgba(125, 49, 210, 0.35);
        }

        .promo-timer.is-finished {
            background: rgba(220, 38, 38, 0.75);
            border-color: rgba(255, 255, 255, 0.35);
            color: #fff;
            letter-spacing: 0.05em;
        }

        .promo-timer.is-finished .promo-timer-dot {
            background: #fff;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.25);
        }

        @media (min-width: 768px) {
            .promo-timer {
                font-size: 0.75rem;
                padding: 0.45rem 0.85rem;
                gap: 0.5rem;
            }
        }

        .skeleton {
            position: relative;
            overflow: hidden;
            background-color: #E5E7EB;
        }

        .skeleton::after {
            content: "";
            position: absolute;
            inset: 0;
            transform: translateX(-100%);
            background-image: linear-gradient(90deg, rgba(229, 231, 235, 0), rgba(255, 255, 255, 0.75), rgba(229, 231, 235, 0));
            animation: shimmer 1.35s ease-in-out infinite;
        }

        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #app-preloader {
            transition: opacity 0.35s ease, visibility 0.35s ease;
        }

        #app-preloader.is-hidden {
            opacity: 0;
            visibility: hidden;
        }

        .preloader-spinner {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 9999px;
            border: 4px solid rgba(125, 49, 210, 0.25);
            border-top-color: #7d31d2;
            animation: spin 0.85s linear infinite;
        }

        /* --- ESTILOS PARA CARGA PROGRESIVA DE IMAGEN --- */
        .image-loader-wrapper {
            position: relative;
            overflow: hidden;
            background-color: #E5E7EB; /* Mismo color que el esqueleto */
        }

        .image-loader-wrapper::after {
            content: "";
            position: absolute;
            inset: 0;
            transform: translateX(-100%);
            background-image: linear-gradient(90deg, rgba(229, 231, 235, 0), rgba(255, 255, 255, 0.75), rgba(229, 231, 235, 0));
            animation: shimmer 1.35s ease-in-out infinite;
        }

        .image-loader-wrapper img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }

        .image-loader-wrapper.is-loaded img {
            opacity: 1;
        }

        /* Oculta el pseudo-elemento de shimmer una vez que la imagen se ha cargado */
        .image-loader-wrapper.is-loaded::after {
            display: none;
        }
        
        /* Men√∫ M√≥vil */
        #mobile-menu-panel {
            transition: transform 0.3s ease-in-out;
        }
        
        /* Icono Premium de Categor√≠a */
        .category-item-icon {
            position: relative;
        }
        .premium-icon {
            position: absolute;
            top: -4px; /* Ajuste fino */
            right: -4px; /* Ajuste fino */
            filter: drop-shadow(0 0 3px rgba(255, 223, 0, 0.8));
            animation: pulse-premium 2.5s infinite ease-in-out;
        }
        @keyframes pulse-premium {
            0%, 100% {
                opacity: 0.9;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.25);
            }
        }

        /* --- ESTILOS PARA SUBIDA DE FOTOS --- */
        /* Contenedor de vista previa de imagen */
        .photo-preview-item {
            position: relative;
            width: 100%;
            padding-top: 100%; /* 1:1 Aspect Ratio */
            background-color: #F3F4F6;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .photo-preview-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .btn-remove-photo {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            padding: 0.25rem;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border-radius: 9999px;
            transition: background-color 0.2s;
        }
        .btn-remove-photo:hover {
            background-color: rgba(0, 0, 0, 0.75);
        }

        /* --- ESTILOS CANJE PROFESIONAL --- */
        /* Checkbox personalizado para selecci√≥n de item */
        .modal-item-checkbox:checked + img + div {
            opacity: 1;
        }
        .modal-item-checkbox:checked + img {
             border: 2px solid #4285F4;
        }
        .modal-item-checkbox-label { 
             transition: all 0.2s ease-in-out; 
             border: 2px solid transparent; 
        }
         .modal-item-checkbox-label:has(.modal-item-checkbox:checked) {
             border-color: #4285F4;
             background-color: #E8F0FE;
         }

        #product-detail-view {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }

        #product-detail-view.open {
            opacity: 1;
            pointer-events: auto;
        }

        #product-detail-gallery::-webkit-scrollbar {
            display: none;
        }

        #product-detail-gallery {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* --- ESTILOS PARA CHAT EN PANTALLA COMPLETA --- */
        body.chat-abierto #main-content-wrapper > header,
        body.chat-abierto .mobile-nav,
        body.chat-abierto #desktop-sidebar,
        body.chat-abierto #main-content-wrapper > footer {
            display: none;
        }

        body.chat-abierto #main-content-wrapper {
            margin-left: 0 !important;
            padding-bottom: 0 !important;
        }

        /* --- ESTILOS HEADER M√ìVIL REDISE√ëADO --- */
        /* La responsividad del header ahora se maneja directamente con clases de Tailwind */

        /* Logo editable para Admin */
        .admin-logo-editable.is-admin:hover {
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(125, 49, 210, 0.2);
            border-radius: 6px;
        }

        /* --- ESTILOS CARRUSEL DETALLE DE PRODUCTO --- */
        .product-detail-carousel-slide {
            flex-shrink: 0;
            width: 100%;
            height: 100%;
        }
        .product-detail-carousel-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .carousel-dot {
            width: 10px;
            height: 10px;
            border-radius: 9999px;
            background-color: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .carousel-dot.active {
            background-color: #FFFFFF;
            transform: scale(1.25);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        /* --- ESTILOS PARA BANNER DE INSTALACI√ìN Y SAFE AREA --- */
        body.install-banner-visible {
            /* Empuja todo el contenido hacia abajo la altura de la safe-area */
            padding-top: var(--install-banner-height, 0px);
        }

        body.install-banner-visible #main-content-wrapper > header {
            /* El header es 'sticky', as√≠ que ajustamos su 'top' */
            top: var(--install-banner-height, 0px);
        }

        body.install-banner-visible #desktop-sidebar,
        body.install-banner-visible #mobile-menu-panel {
             /* Los men√∫s laterales fijos tambi√©n necesitan el ajuste */
            top: var(--install-banner-height, 0px);
            height: calc(100vh - var(--install-banner-height, 0px));
        }

        /* Ajuste para la barra de estado de iOS en los encabezados principales */
        #main-content-wrapper > header,
        #chat-header,
        #product-detail-view header {
            padding-top: calc(0.75rem + env(safe-area-inset-top)); /* 0.75rem = 12px */
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="install-banner" class="hidden fixed top-0 left-0 right-0 z-[60] bg-brand-dark text-white shadow-lg transition-transform duration-300 ease-in-out -translate-y-full" style="padding-bottom: 0.75rem;">
        <div class="w-full h-full" style="padding-top: env(safe-area-inset-top);">
            <div class="max-w-4xl mx-auto flex items-center justify-between p-3 pl-4">
                <div class="flex items-center">
                    <img src="icons/icon-192x192.png" alt="App Icon" class="w-11 h-11 mr-4 rounded-lg">
                    <div class="flex-1">
                        <h4 class="font-semibold leading-tight">Instalar Mercado Canje</h4>
                        <p class="text-sm text-brand-light leading-tight">Acceso r√°pido desde tu pantalla de inicio.</p>
                    </div>
                </div>
                <div class="flex items-center flex-shrink-0 ml-4">
                    <button id="btn-install" class="bg-white text-brand font-semibold px-5 py-2 rounded-full mr-2 text-sm hover:bg-gray-200 transition-colors">Instalar</button>
                    <button id="btn-dismiss-install" class="p-2 rounded-full hover:bg-white/20" aria-label="Cerrar">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="app-preloader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white/95 backdrop-blur-sm">
        <div class="preloader-spinner"></div>
        <p class="mt-4 text-sm font-medium text-gray-700">Cargando experiencia...</p>
    </div>

    <div id="mobile-menu-backdrop" class="fixed inset-0 z-30 hidden bg-black bg-opacity-50 lg:hidden"></div>
    <aside id="mobile-menu-panel" class="fixed top-0 left-0 z-40 flex flex-col w-64 h-screen max-w-[80vw] bg-white border-r border-gray-200 transition-transform duration-300 ease-in-out -translate-x-full lg:hidden">
        <div class="flex items-center h-16 px-6 border-b border-gray-200">
            <i data-lucide="arrow-right-left" class="text-brand"></i>
            <span class="ml-3 text-lg font-semibold">CanjeApp</span>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <a href="#" class="nav-link-mobile-menu nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100" data-page="page-explorar">
                <i data-lucide="compass" class="w-5 h-5 text-gray-500"></i>
                <span class="ml-4">Explorar</span>
            </a>
            <a href="#" class="nav-link-mobile-menu nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100" data-page="page-vender">
                <i data-lucide="tag" class="w-5 h-5 text-gray-500"></i>
                <span class="ml-4">Vender</span>
            </a>
            <a href="#" class="nav-link-mobile-menu nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100" data-page="page-canjes">
                <i data-lucide="repeat" class="w-5 h-5 text-gray-500"></i>
                <span class="ml-4">Mis Canjes</span>
            </a>
            <a href="#" class="nav-link-mobile-menu nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100" data-page="page-carrito">
                <i data-lucide="shopping-cart" class="w-5 h-5 text-gray-500"></i>
                <span class="ml-4">Carrito</span>
            </a>
            <a href="#" class="nav-link-mobile-menu nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100" data-page="page-perfil">
                <i data-lucide="user" class="w-5 h-5 text-gray-500"></i>
                <span class="ml-4">Perfil</span>
            </a>
        </nav>

        <div class="border-t border-gray-200">
            <div class="flex items-center justify-between px-4 pt-4">
                <div>
                    <p class="text-sm font-semibold text-gray-800">Mi carrito</p>
                    <p class="text-xs text-gray-500">Gestiona tus canjes pendientes</p>
                </div>
                <span id="mobile-cart-count" class="px-2 py-1 text-xs font-semibold text-white rounded-full bg-brand-dark">0</span>
            </div>
            <div id="mobile-cart-feedback" class="hidden px-4 mt-2 text-xs font-medium"></div>
            <div id="mobile-cart-items" class="px-4 py-4 space-y-3 max-h-64 overflow-y-auto text-sm text-gray-500">
                <p class="text-sm text-gray-500">Tu carrito est√° vac√≠o.</p>
            </div>
            <div class="px-4 pt-3 pb-4 border-t border-gray-200 space-y-2">
                <div class="flex items-center justify-between text-sm font-medium text-gray-700">
                    <span>Total estimado</span>
                    <span id="mobile-cart-total">$0 COP</span>
                </div>
                <button id="mobile-cart-clear" class="w-full px-4 py-2 text-sm font-semibold text-gray-700 transition-colors bg-gray-100 rounded-lg hover:bg-gray-200" type="button">
                    Vaciar carrito
                </button>
            </div>
        </div>
    </aside>

    <aside id="desktop-sidebar" class="hidden lg:flex flex-col w-64 h-screen bg-white border-r border-gray-200 fixed top-0 left-0 z-20">
        <div class="flex items-center h-16 px-6 border-b border-gray-200 sidebar-title">
            <i data-lucide="arrow-right-left" class="text-brand"></i>
            <span class="ml-3 text-lg font-semibold sidebar-text">CanjeApp</span>
        </div>
        
        <nav class="flex-1 p-4 space-y-2">
            <a href="#" class="nav-link nav-link-desktop flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 active" data-page="page-explorar">
                <i data-lucide="compass" class="w-5 h-5 text-gray-500"></i>
                <span class="ml-4 sidebar-text">Explorar</span>
            </a>
            <a href="#" class="nav-link nav-link-desktop flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100" data-page="page-vender">
                <i data-lucide="tag" class="w-5 h-5 text-gray-500"></i>
                <span class="ml-4 sidebar-text">Vender</span>
            </a>
            <a href="#" class="nav-link nav-link-desktop flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100" data-page="page-canjes">
                <i data-lucide="repeat" class="w-5 h-5 text-gray-500"></i>
                <span class="ml-4 sidebar-text">Mis Canjes</span>
            </a>
            <a href="#" class="nav-link nav-link-desktop flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100" data-page="page-carrito">
                <i data-lucide="shopping-cart" class="w-5 h-5 text-gray-500"></i>
                <span class="ml-4 sidebar-text">Carrito</span>
            </a>
            <a href="#" class="nav-link nav-link-desktop flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100" data-page="page-perfil">
                <i data-lucide="user" class="w-5 h-5 text-gray-500"></i>
                <span class="ml-4 sidebar-text">Perfil</span>
            </a>
        </nav>

        <div id="sidebar-cart" class="border-t border-gray-200 p-4 space-y-3">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-semibold text-gray-800 sidebar-text">Mi carrito</p>
                    <p class="text-xs text-gray-500 sidebar-text">Tus selecciones para canjear</p>
                </div>
                <span id="sidebar-cart-count" class="px-2 py-1 text-xs font-semibold text-white rounded-full bg-brand-dark">0</span>
            </div>
            <div id="sidebar-cart-feedback" class="hidden text-xs font-medium"></div>
            <div id="sidebar-cart-items" class="space-y-3 max-h-64 overflow-y-auto pr-1">
                <p class="text-sm text-gray-500">Tu carrito est√° vac√≠o.</p>
            </div>
            <div class="pt-3 border-t border-gray-200 space-y-2">
                <div class="flex items-center justify-between text-sm font-medium text-gray-700">
                    <span>Total estimado</span>
                    <span id="sidebar-cart-total">$0 COP</span>
                </div>
                <button id="sidebar-cart-clear" class="w-full px-4 py-2 text-sm font-semibold text-gray-700 transition-colors bg-gray-100 rounded-lg hover:bg-gray-200" type="button">
                    Vaciar carrito
                </button>
            </div>
        </div>
    </aside>

    <div id="main-content-wrapper" class="lg:ml-64 transition-all duration-300 pb-20 lg:pb-0">
        
        <header class="sticky top-0 z-10 flex items-center justify-between px-4 bg-brand shadow-sm md:px-6 pb-3">
            <!-- Logo a la izquierda -->
            <div class="flex items-center">
                 <img id="header-logo" src="https://placehold.co/120x40/7d31d2/FFFFFF?text=CanjeApp" alt="Logo" class="h-8 cursor-pointer admin-logo-editable">
                 <input type="file" id="logo-file-input" class="hidden" accept="image/*">
                 <span id="admin-badge" class="hidden ml-2 px-3 py-1 text-xs font-semibold text-white bg-red-600 rounded-full">ADMIN</span>
            </div>

            <!-- Buscador en el centro (visible en m√≥vil) -->
            <div class="flex-1 max-w-xs mx-4 lg:max-w-lg">
                 <div class="relative flex items-center w-full text-white/80">
                     <i data-lucide="search" class="absolute w-5 h-5 left-3"></i>
                     <input type="text" placeholder="Buscar art√≠culos..." class="w-full h-10 py-2 pl-10 pr-4 text-white bg-white/20 border-transparent rounded-full placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-brand-light focus:bg-white focus:text-gray-800">
                 </div>
            </div>

            <!-- Men√∫ hamburguesa a la derecha -->
            <div class="flex items-center">
                 <button id="mobile-menu-btn" class="p-2 text-white rounded-full lg:hidden hover:bg-white/20">
                     <i data-lucide="menu" class="w-6 h-6"></i>
                 </button>
                 <button id="sidebar-toggle-btn" class="hidden p-2 text-white rounded-full lg:block hover:bg-white/20">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>

             <!-- Elementos de escritorio (se mantienen igual, pero ocultos en m√≥vil) -->
             <div class="items-center hidden lg:flex">
                 <button class="p-2 text-white rounded-full hover:bg-white/20">
                     <i data-lucide="bell" class="w-6 h-6"></i>
                 </button>
                 <button class="ml-2 nav-link" data-page="page-perfil">
                     <img id="header-profile-img" src="https://placehold.co/40x40/E8F0FE/4285F4?text=U" alt="Perfil" class="w-10 h-10 rounded-full">
                 </button>
             </div>
        </header>

        <main class="p-4 md:p-6">

            <section id="page-explorar" class="page">
                
                <div id="promo-carousel" class="relative w-full h-48 mb-6 overflow-hidden bg-gray-200 rounded-lg md:h-64">
                    <div id="carousel-slider" class="flex h-full transition-transform duration-500 ease-in-out">
                    </div>

                    <button id="carousel-prev" class="absolute top-1/2 left-2 md:left-4 p-2 -translate-y-1/2 text-white bg-black rounded-full bg-opacity-40 hover:bg-opacity-70">
                        <i data-lucide="chevron-left" class="w-5 h-5 md:w-6 md:h-6"></i>
                    </button>
                    <button id="carousel-next" class="absolute top-1/2 right-2 md:right-4 p-2 -translate-y-1/2 text-white bg-black rounded-full bg-opacity-40 hover:bg-opacity-70">
                        <i data-lucide="chevron-right" class="w-5 h-5 md:w-6 md:h-6"></i>
                    </button>

                    <input type="file" id="cover-file-input" class="hidden" accept="image/*">
                    <button id="upload-cover-btn" data-icon-name="upload-cloud" class="absolute bottom-2 left-2 md:bottom-4 md:left-4 p-2 text-white bg-black rounded-full bg-opacity-40 hover:bg-opacity-70 admin-only hidden" title="Subir nueva portada (Admin)">
                        <i data-lucide="upload-cloud" class="w-5 h-5 md:w-6 md:h-6"></i>
                    </button>
                </div>

                <div id="carousel-meta" class="px-1 mt-3 space-y-1 hidden">
                    <h2 id="carousel-title" class="text-lg font-semibold text-gray-900 truncate"></h2>
                    <p id="carousel-subtitle" class="text-sm text-gray-600"></p>
                </div>

                <h3 class="mb-4 text-xl font-semibold text-gray-900">Categor√≠as</h3>
                <div id="category-list-container" class="flex pb-4 mb-6 space-x-4 overflow-x-auto no-scrollbar">
                    <div class="text-sm text-gray-500">Cargando categor√≠as...</div>
                </div>

                <h3 class="mb-4 text-xl font-semibold text-gray-900">Populares</h3>
                <div id="most-viewed-container" class="flex pb-4 mb-6 space-x-4 overflow-x-auto no-scrollbar">
                    <div class="text-sm text-gray-500">Cargando productos...</div>
                </div>
                <h3 class="mb-4 text-xl font-semibold text-gray-900">Art√≠culos Recientes</h3>
                <div id="explorar-product-grid" class="grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5">
                    <div class="text-sm text-gray-500">Cargando productos...</div>
                </div>
            </section>

            <section id="page-canjes" class="page hidden max-w-4xl mx-auto">
                <div id="canjes-auth-required" class="hidden">
                    <div class="flex flex-col items-center justify-center p-10 text-center bg-white border border-gray-200 rounded-lg shadow-sm">
                        <i data-lucide="lock" class="w-16 h-16 text-gray-400"></i>
                        <h2 class="mt-4 text-2xl font-semibold">Acceso Restringido</h2>
                        <p class="mt-2 text-gray-600">Debes iniciar sesi√≥n para ver tus canjes y ofertas.</p>
                        <button class="nav-link px-6 py-2 mt-6 text-white bg-brand rounded-lg hover:bg-brand-dark" data-page="page-perfil">
                            Iniciar Sesi√≥n
                        </button>
                    </div>
                </div>

                <div id="canjes-content" class="">
                    <h2 class="mb-6 text-3xl font-bold text-gray-900 sm:text-4xl">Mis Canjes</h2>
                    <div class="border-b border-gray-200">
                        <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                            <button class="px-1 py-3 text-sm font-medium text-brand border-b-2 border-brand whitespace-nowrap canje-tab-btn" data-tab="tab-ofertas">
                                Ofertas Recibidas (<span id="ofertas-count">0</span>)
                            </button>
                            <button class="px-1 py-3 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 whitespace-nowrap canje-tab-btn" data-tab="tab-mis-articulos">
                                Mis Art√≠culos (<span id="mis-articulos-count">0</span>)
                            </button>
                        </nav>
                    </div>
                    
                    <div class="mt-6">
                        <div id="tab-ofertas" class="canje-tab-content space-y-4">
                            <p class="text-gray-500">No tienes ofertas recibidas.</p>
                        </div>
                        
                        <div id="tab-mis-articulos" class="canje-tab-content hidden space-y-4">
                            <p class="text-gray-500">No has publicado ning√∫n art√≠culo.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="page-chats" class="page hidden max-w-4xl mx-auto">
                <h2 class="mb-6 text-3xl font-bold text-gray-900 sm:text-4xl">Chats</h2>
                <div id="chats-activos-container" class="space-y-4">
                    <p class="text-gray-500">No tienes canjes activos.</p>
                </div>
            </section>

            <section id="page-vender" class="page hidden max-w-2xl mx-auto">
                <div id="vender-auth-required" class="hidden">
                         <div class="flex flex-col items-center justify-center p-10 text-center bg-white border border-gray-200 rounded-lg shadow-sm">
                               <i data-lucide="lock" class="w-16 h-16 text-gray-400"></i>
                               <h2 class="mt-4 text-2xl font-semibold">Acceso Restringido</h2>
                               <p class="mt-2 text-gray-600">Debes iniciar sesi√≥n para publicar un art√≠culo.</p>
                               <button class="nav-link px-6 py-2 mt-6 text-white bg-brand rounded-lg hover:bg-brand-dark" data-page="page-perfil">
                                   Iniciar Sesi√≥n
                               </button>
                         </div>
                </div>

                <div id="vender-content" class="p-6 bg-white border border-gray-200 rounded-lg shadow-sm">
                    <h2 class="mb-6 text-2xl font-semibold text-gray-900">Publicar un art√≠culo para canje</h2>
                    <form id="form-vender" class="space-y-6">
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Fotos del art√≠culo (M√≠n 2, M√°x 10)</label>
                            
                            <label id="photo-upload-label" for="product-photo-upload" class="flex flex-col items-center justify-center w-full h-32 px-6 mt-1 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer transition-colors hover:border-brand hover:bg-brand-light">
                                <div id="photo-upload-text" class="text-center">
                                    <i data-lucide="upload-cloud" class="w-10 h-10 mx-auto text-gray-400"></i>
                                    <p class="mt-1 text-sm text-gray-600">Arrastra o <span class="font-medium text-brand">selecciona</span> tus archivos</p>
                                    <p class="text-xs text-gray-500">Hasta 10 im√°genes</p>
                                </div>
                                <div id="photo-upload-summary" class="hidden text-center">
                                    <i data-lucide="check-circle" class="w-10 h-10 mx-auto text-green-500"></i>
                                    <p class="mt-1 text-sm font-medium text-gray-700"><span id="photo-count">0</span> fotos seleccionadas</p>
                                    <p class="mt-1 text-xs text-brand hover:underline">A√±adir m√°s fotos</p>
                                </div>
                            </label>
                            <input type="file" id="product-photo-upload" class="sr-only" multiple accept="image/*">
                            
                            <div id="photo-preview-container" class="grid grid-cols-3 gap-4 mt-4 sm:grid-cols-4 md:grid-cols-5">
                                 </div>
                            
                            <p id="photo-error-msg" class="hidden mt-2 text-sm text-red-600"></p>
                        </div>

                        
                        <div>
                            <label for="titulo" class="block text-sm font-medium text-gray-700">T√≠tulo</label>
                            <input type="text" id="titulo" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" placeholder="Ej: Smartwatch en buen estado" required>
                        </div>

                        <div>
                            <label for="categoria" class="block text-sm font-medium text-gray-700">Categor√≠a</label>
                            <select id="categoria" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" required>
                                <option value="">Cargando categor√≠as...</option>
                                </select>
                        </div>
                        
                        <div>
                            <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripci√≥n</label>
                            <textarea id="descripcion" rows="4" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" placeholder="Describe tu art√≠culo, estado, tiempo de uso, etc."></textarea>
                        </div>

                        <div>
                            <label for="busco" class="block text-sm font-medium text-gray-700">¬øQu√© buscas a cambio?</label>
                            <input type="text" id="busco" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" placeholder="Ej: iPhone, bicicleta, monitor" required>
                        </div>
                        
                        <div>
                            <label for="valor-cop" class="block text-sm font-medium text-gray-700">Valor de equivalencia (COP)</label>
                            <p class="text-xs text-gray-500">Establece un valor en pesos colombianos para calcular la equivalencia.</p>
                            <div class="relative mt-1">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">COP $</span>
                                <input type="number" id="valor-cop" class="w-full pl-12 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" placeholder="Ej: 750000" required>
                            </div>
                        </div>

                        <div class="pt-4 border-t border-gray-200">
                            <button type="submit" id="btn-publicar-articulo" class="w-full px-6 py-3 font-semibold text-white bg-brand rounded-lg shadow-sm transition-colors hover:bg-brand-dark">
                                Publicar Art√≠culo
                            </button>
                            <p id="publicar-error-msg" class="hidden mt-2 text-sm text-center text-red-600"></p>
                        </div>
                    </form>
                </div>
            </section>

            <section id="page-carrito" class="page hidden">
                <div class="max-w-6xl px-4 py-8 mx-auto space-y-8 lg:px-8">
                    <header class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
                        <div>
                            <p class="text-sm font-semibold tracking-wide text-brand uppercase">Tu selecci√≥n</p>
                            <h1 class="text-3xl font-semibold text-gray-900 sm:text-4xl">Carrito de canjes</h1>
                            <p class="mt-2 text-sm text-gray-600">Gestiona tus art√≠culos guardados y finaliza el acuerdo cuando est√©s listo.</p>
                        </div>
                        <a href="#" class="inline-flex items-center gap-2 text-sm font-semibold text-brand hover:text-brand-dark nav-link" data-page="page-explorar">
                            <i data-lucide="compass" class="w-4 h-4"></i>
                            Seguir explorando
                        </a>
                    </header>

                    <div id="cart-page-feedback" class="hidden px-4 py-3 text-sm font-medium rounded-xl"></div>

                    <div id="cart-page-empty-state" class="flex flex-col items-center justify-center gap-4 px-6 py-16 text-center bg-white border border-dashed border-gray-200 rounded-3xl shadow-sm">
                        <div class="flex items-center justify-center w-16 h-16 rounded-full bg-brand-light text-brand">
                            <i data-lucide="shopping-bag" class="w-7 h-7"></i>
                        </div>
                        <div class="space-y-2">
                            <h2 class="text-2xl font-semibold text-gray-900">Tu carrito est√° vac√≠o</h2>
                            <p class="text-sm text-gray-600">Explora el cat√°logo y a√±ade art√≠culos para iniciar nuevos canjes.</p>
                        </div>
                        <a href="#" class="inline-flex items-center gap-2 px-5 py-2 text-sm font-semibold text-white transition-colors rounded-full bg-brand hover:bg-brand-dark nav-link" data-page="page-explorar">
                            <i data-lucide="sparkles" class="w-4 h-4"></i>
                            Descubrir art√≠culos
                        </a>
                    </div>

                    <div id="cart-page-content" class="hidden grid gap-8 lg:grid-cols-[minmax(0,2fr)_minmax(0,1fr)]">
                        <div class="space-y-4" id="cart-page-items"></div>
                        <aside class="p-6 space-y-6 bg-white border border-gray-200 rounded-3xl shadow-xl">
                            <div>
                                <h2 class="text-xl font-semibold text-gray-900">Resumen del canje</h2>
                                <p class="mt-1 text-sm text-gray-500">Confirma los detalles antes de contactar al vendedor.</p>
                            </div>
                            <dl class="space-y-3 text-sm text-gray-700">
                                <div class="flex items-center justify-between">
                                    <dt>Art√≠culos</dt>
                                    <dd id="cart-page-quantity" class="font-semibold">0</dd>
                                </div>
                                <div class="flex items-center justify-between text-base">
                                    <dt>Total estimado</dt>
                                    <dd id="cart-page-total" class="text-lg font-semibold text-gray-900">$0 COP</dd>
                                </div>
                            </dl>
                            <div class="space-y-3">
                                <button class="w-full px-4 py-3 text-sm font-semibold text-white transition-colors rounded-full bg-brand hover:bg-brand-dark" type="button">
                                    Continuar con el pedido
                                </button>
                                <button id="cart-page-clear" class="w-full px-4 py-3 text-sm font-semibold text-gray-700 transition-colors rounded-full bg-gray-100 hover:bg-gray-200" type="button">
                                    Vaciar carrito
                                </button>
                            </div>
                            <div class="flex items-center gap-3 p-4 text-xs text-gray-600 bg-gray-50 border border-gray-200 rounded-2xl">
                                <i data-lucide="shield" class="w-4 h-4 text-brand"></i>
                                <span>Protegemos tu informaci√≥n. Solo compartimos los datos del vendedor al iniciar un canje.</span>
                            </div>
                        </aside>
                    </div>
                </div>
            </section>

            <section id="page-perfil" class="page hidden max-w-md mx-auto">
                
                <div id="perfil-auth-form" class="p-6 bg-white border border-gray-200 rounded-lg shadow-sm">
                    <div class="border-b border-gray-200">
                        <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                            <button class="px-1 py-3 text-sm font-medium text-brand border-b-2 border-brand whitespace-nowrap auth-tab-btn" data-auth-tab="auth-login">
                                Iniciar Sesi√≥n
                            </button>
                            <button class="px-1 py-3 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 whitespace-nowrap auth-tab-btn" data-auth-tab="auth-register">
                                Registrarse
                            </button>
                        </nav>
                    </div>

                    <form id="auth-login" class="mt-6 space-y-4 auth-tab-content">
                        <div>
                            <label for="email-login" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="email-login" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" placeholder="Usa admin@canje.app para modo admin" required>
                        </div>
                        <div>
                            <label for="pass-login" class="block text-sm font-medium text-gray-700">Contrase√±a</label>
                            <input type="password" id="pass-login" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" required>
                        </div>
                        <button type="submit" class="w-full px-4 py-2 font-medium text-white bg-brand rounded-lg hover:bg-brand-dark">
                            Entrar
                        </button>
                        <p id="login-error-msg" class="hidden text-sm text-center text-red-600"></p>
                    </form>

                    <form id="auth-register" class="hidden mt-6 space-y-4 auth-tab-content">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Foto de Perfil</label>
                            <div class="flex items-center mt-1 space-x-4">
                                <img id="profile-pic-preview" src="https://placehold.co/80x80/E8F0FE/4285F4?text=U" class="w-16 h-16 rounded-full" alt="Vista previa">
                                <label for="profile-pic-upload" class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50">
                                    <span>Subir foto</span>
                                    <input id="profile-pic-upload" name="profile-pic" type="file" class="sr-only" accept="image/*">
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label for="nombre-reg" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                            <input type="text" id="nombre-reg" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" required>
                        </div>
                        <div>
                            <label for="doc-reg" class="block text-sm font-medium text-gray-700">Documento de Identidad (C.C.)</label>
                            <input type="text" id="doc-reg" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" placeholder="Ej: 1061..." required>
                        </div>
                        <div>
                            <label for="dir-reg" class="block text-sm font-medium text-gray-700">Direcci√≥n de Residencia</label>
                            <input type="text" id="dir-reg" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" placeholder="Ej: Cra 5 # 10-20, Bogot√°" required>
                        </div>
                        <div>
                            <label for="email-reg" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="email-reg" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" required>
                        </div>
                        <div>
                            <label for="pass-reg" class="block text-sm font-medium text-gray-700">Contrase√±a</dlabel>
                            <input type="password" id="pass-reg" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" required>
                        </div>
                        <button type="submit" class="w-full px-4 py-2 font-medium text-white bg-brand rounded-lg hover:bg-brand-dark">
                            Crear Cuenta
                        </button>
                        <p id="register-error-msg" class="hidden text-sm text-center text-red-600"></p>
                    </form>
                </div>

                <div id="perfil-logged-in" class="hidden p-6 space-y-6">
                    <div class="flex flex-col items-center">
                        <img id="main-profile-img" src="https://placehold.co/100x100/E8F0FE/4285F4?text=U" alt="Foto de Perfil" class="w-24 h-24 rounded-full">
                        <h2 id="user-name" class="mt-4 text-2xl font-semibold">Usuario de Prueba</h2>
                        <p id="user-email" class="text-gray-600">usuario@canje.app</p>
                    </div>
                    
                    <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-500">Direcci√≥n</span>
                            <a href="#" class="text-sm font-medium text-brand hover:underline">Editar</a>
                        </div>
                        <p id="user-address" class="mt-1 font-medium text-gray-900">Cra 5 # 10-20, Bogot√°</p>
                    </div>
                    <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-500">Documento</span>
                            <a href="#" class="text-sm font-medium text-brand hover:underline">Editar</a>
                        </div>
                        <p id="user-doc" class="mt-1 font-medium text-gray-900">CC 1061******</p>
                    </div>

                    <div class="space-y-3">
                        <!-- Nueva secci√≥n de notificaciones -->
                        <div id="datos-perfil-container" class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                            <h3 class="font-medium">Notificaciones Push</h3>
                            <p id="notification-status-text" class="hidden mt-2 text-sm text-gray-600"></p>
                            <button id="btn-activar-notificaciones" class="hidden w-full px-4 py-2 mt-3 font-medium text-white bg-brand rounded-lg hover:bg-brand-dark">
                                Activar Notificaciones
                            </button>
                        </div>
                        <a href="#" class="flex items-center justify-between w-full p-4 bg-white border border-gray-200 rounded-lg shadow-sm hover:bg-gray-50">
                            <span class="font-medium">Ayuda y Soporte</span>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                        </a>
                    </div>

                    <button id="btn-logout" class="w-full px-4 py-2 font-medium text-red-700 bg-red-100 rounded-lg hover:bg-red-200">
                        Cerrar Sesi√≥n
                    </button>
                </div>
            </section>

            <!-- --- INICIO: SECCI√ìN DE CHAT REDISE√ëADA --- -->
            <section id="page-chat" class="page hidden fixed inset-0 z-40 flex flex-col h-full bg-white" data-page="page-chat">

                <!-- Encabezado Fijo -->
                <div id="chat-header" class="flex items-center justify-between flex-shrink-0 px-4 bg-brand text-white shadow-sm pb-3">
                    <div class="flex items-center min-w-0">
                        <button class="nav-link p-2 -ml-2 text-white rounded-full hover:bg-white/20" data-page="page-canjes" aria-label="Volver a Mis Canjes">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        </button>
                        <img id="chat-item-image" src="https://placehold.co/40x40/E5E7EB/4B5563?text=?" alt="Art√≠culo" class="flex-shrink-0 object-cover w-10 h-10 ml-2 border-2 border-white rounded-full shadow-md">
                        <div class="min-w-0 ml-3">
                            <h3 id="chat-item-name" class="font-semibold truncate">Cargando...</h3>
                            <p id="chat-with-name" class="text-sm text-white/80 truncate">Hablando con: Cargando...</p>
                        </div>
                    </div>
                    <div class="relative">
                        <button id="chat-options-btn" class="p-2 text-white rounded-full hover:bg-white/20 flex-shrink-0" aria-label="M√°s opciones">
                            <i data-lucide="more-vertical" class="w-5 h-5"></i>
                        </button>
                        <!-- Dropdown Menu -->
                        <div id="chat-options-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-50 border border-gray-200">
                            <div class="py-1">
                                <a href="#" class="nav-link flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-page="page-canjes">
                                    <i data-lucide="arrow-left" class="w-4 h-4 mr-3"></i>
                                    Cerrar Chat
                                </a>
                                <button id="btn-delete-chat" class="flex items-center w-full px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                                    <i data-lucide="trash-2" class="w-4 h-4 mr-3"></i>
                                    Eliminar Canje
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- √Årea de Mensajes con Scroll -->
                <div id="chat-messages" class="flex-grow p-4 overflow-y-auto bg-gray-100">
                    <!-- Mensajes se insertan aqu√≠ din√°micamente -->
                </div>

                <!-- Pie Fijo para Escribir Mensaje -->
                <div id="chat-form-container" class="flex-shrink-0 px-4 py-3 bg-white border-t border-gray-200">
                    <form id="form-chat" class="flex items-center space-x-3">
                        <input type="file" id="chat-image-upload" class="hidden" accept="image/*">
                        <button type="button" id="btn-attach-image" class="flex-shrink-0 p-3 text-gray-600 transition-colors rounded-full hover:bg-gray-100" aria-label="Adjuntar imagen">
                            <i data-lucide="paperclip" class="w-5 h-5"></i>
                        </button>
                        <input type="text" id="chat-input" class="w-full px-4 py-2 bg-gray-100 border-transparent rounded-full shadow-sm focus:border-brand focus:ring-brand" placeholder="Escribe tu mensaje...">
                        <button type="submit" class="flex-shrink-0 p-3 text-white transition-colors rounded-full bg-brand hover:bg-brand-dark" aria-label="Enviar mensaje">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </form>
                </div>
            </section>
            <!-- --- FIN: SECCI√ìN DE CHAT REDISE√ëADA --- -->
        </main>

        <footer class="p-6 mt-10 bg-white border-t border-gray-200 md:p-10">
            <div class="grid max-w-6xl grid-cols-2 gap-8 mx-auto md:grid-cols-4 lg:grid-cols-5">
                <div class="col-span-2 md:col-span-4 lg:col-span-1">
                    <div class="flex items-center">
                        <i data-lucide="arrow-right-left" class="text-brand"></i>
                        <span class="ml-2 text-lg font-semibold">CanjeApp</span>
                    </div>
                    <p class="mt-2 text-sm text-gray-500">¬© 2025 CanjeApp Inc.</p>
                </div>
                <div>
                    <h5 class="font-semibold text-gray-800">Explorar</h5>
                    <ul class="mt-2 space-y-1">
                        <li><a href="#" class="text-sm text-gray-600 hover:text-brand">Categor√≠as</a></li>
                        <li><a href="#" class="text-sm text-gray-600 hover:text-brand">Novedades</a></li>
                        <li><a href="#" class="text-sm text-gray-600 hover:text-brand">Populares</a></li>
                    </ul>
                </div>
                <div>
                    <h5 class="font-semibold text-gray-800">Nosotros</h5>
                    <ul class="mt-2 space-y-1">
                        <li><a href="#" class="text-sm text-gray-600 hover:text-brand">Acerca de</a></li>
                        <li><a href="#" class="text-sm text-gray-600 hover:text-brand">Carreras</a></li>
                        <li><a href="#" class="text-sm text-gray-600 hover:text-brand">Prensa</a></li>
                    </ul>
                </div>
                <div>
                    <h5 class="font-semibold text-gray-800">Soporte</h5>
                    <ul class="mt-2 space-y-1">
                        <li><a href="#" class="text-sm text-gray-600 hover:text-brand">Ayuda</a></li>
                        <li><a href="#" class="text-sm text-gray-600 hover:text-brand">T√©rminos</a></li>
                        <li><a href="#" class="text-sm text-gray-600 hover:text-brand">Privacidad</a></li>
                    </ul>
                </div>
                <div class="col-span-2 md:col-span-1">
                    <h5 class="font-semibold text-gray-800">S√≠guenos</h5>
                    <div class="flex mt-2 space-x-3">
                        <a href="#" class="text-gray-500 hover:text-brand"><i data-lucide="facebook"></i></a>
                        <a href="#" class="text-gray-500 hover:text-brand"><i data-lucide="instagram"></i></a>
                        <a href="#" class="text-gray-500 hover:text-brand"><i data-lucide="twitter"></i></a>
                    </div>
                </div>
            </div>
        </footer>

    </div>

    <nav class="mobile-nav fixed bottom-0 left-0 z-20 w-full bg-white/95 border-t border-gray-200 shadow-[0_-12px_40px_-24px_rgba(15,23,42,0.45)] lg:hidden">
        <div class="mobile-nav-inner">
            <a href="#" class="nav-link nav-link-mobile mobile-nav-item active text-brand" data-page="page-explorar" aria-label="Explorar">
                <span class="mobile-nav-icon">
                    <i data-lucide="compass" class="w-5 h-5"></i>
                </span>
                <span class="mobile-nav-label">Explorar</span>
            </a>
            <a href="#" class="nav-link nav-link-mobile mobile-nav-item text-gray-600" data-page="page-vender" aria-label="Vender">
                <span class="mobile-nav-icon">
                    <i data-lucide="tag" class="w-5 h-5"></i>
                </span>
                <span class="mobile-nav-label">Vender</span>
            </a>
            <a href="#" class="nav-link nav-link-mobile mobile-nav-item mobile-nav-item--primary text-gray-600" data-page="page-canjes" aria-label="Mis canjes">
                <span class="mobile-nav-icon">
                    <i data-lucide="repeat" class="w-5 h-5"></i>
                </span>
                <span class="mobile-nav-label">Canjes</span>
            </a>
            <a href="#" class="nav-link nav-link-mobile mobile-nav-item text-gray-600" data-page="page-chats" aria-label="Chats">
                <span class="relative mobile-nav-icon">
                    <i data-lucide="message-square" class="w-5 h-5"></i>
                    <span id="chat-notification-bubble" class="absolute top-0 right-0 min-w-4 h-4 px-1 text-xs font-semibold text-white bg-red-600 rounded-full hidden flex items-center justify-center"></span>
                </span>
                <span class="mobile-nav-label">Chats</span>
            </a>
            <a href="#" class="nav-link nav-link-mobile mobile-nav-item text-gray-600" data-page="page-perfil" aria-label="Perfil">
                <span class="mobile-nav-icon">
                    <i data-lucide="user" class="w-5 h-5"></i>
                </span>
                <span class="mobile-nav-label">Perfil</span>
            </a>
        </div>
    </nav>

    <div id="product-detail-view" class="fixed inset-0 z-40 hidden">
        <div class="flex flex-col w-full h-full bg-[#F5F7FA]">
            <header class="sticky top-0 z-20 flex items-center justify-between px-4 text-white bg-brand shadow-sm sm:px-6 pb-3">
                <div class="flex items-center gap-2">
                    <button id="product-detail-close" class="p-2 text-white transition-colors bg-white/20 rounded-full hover:bg-white/30">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    </button>
                    <div class="flex flex-col leading-tight">
                        <span class="text-xs font-semibold tracking-wider text-white/80 uppercase">Detalle del art√≠culo</span>
                        <span id="product-detail-breadcrumb" class="text-sm font-medium text-white/90"></span>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button class="p-2 text-white transition-colors bg-white/20 rounded-full hover:bg-white/30" title="Compartir">
                        <i data-lucide="share-2" class="w-5 h-5"></i>
                    </button>
                    <button class="p-2 text-white transition-colors bg-white/20 rounded-full hover:bg-white/30" title="Guardar">
                        <i data-lucide="heart" class="w-5 h-5"></i>
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto">
                <div class="max-w-4xl px-4 py-8 mx-auto space-y-8 sm:px-6 lg:px-8">
                    <div class="grid gap-8 lg:grid-cols-5">
                        <div class="space-y-4 lg:col-span-3">
                            <div class="relative overflow-hidden bg-white rounded-3xl shadow-[0_25px_60px_-35px_rgba(0,0,0,0.35)] aspect-[4/5] sm:aspect-square">
                                <div id="product-detail-carousel-slider" class="flex h-full transition-transform duration-300 ease-in-out">
                                    <!-- Slides se insertar√°n aqu√≠ din√°micamente -->
                                </div>
                                <div id="product-detail-carousel-dots" class="absolute bottom-4 left-1/2 z-10 flex -translate-x-1/2 space-x-2">
                                    <!-- Dots se insertar√°n aqu√≠ din√°micamente -->
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col h-full space-y-6 lg:col-span-2">
                            <div class="space-y-2">
                                <span id="product-detail-status" class="inline-flex items-center px-3 py-1 text-xs font-semibold tracking-wider text-green-700 uppercase bg-green-100 rounded-full"></span>
                                <h1 id="product-detail-title" class="text-2xl font-semibold text-gray-900 sm:text-3xl"></h1>
                                <p id="product-detail-wants" class="text-sm text-gray-500"></p>
                            </div>

                            <div class="p-6 space-y-3 bg-white border border-yellow-100 rounded-3xl shadow-[0_22px_50px_-30px_rgba(0,0,0,0.45)]">
                                <div class="flex items-center gap-2 text-sm font-semibold text-green-600 uppercase">
                                    <span class="w-2.5 h-2.5 rounded-full bg-green-500 shadow-[0_0_0_3px_rgba(34,197,94,0.35)]"></span>
                                    <span>Oferta destacada</span>
                                </div>
                                <div>
                                    <p id="product-detail-price" class="text-3xl font-bold text-gray-900"></p>
                                    <p id="product-detail-installments" class="text-sm text-gray-600"></p>
                                    <button class="text-sm font-medium text-brand-dark hover:underline">Ver medios de pago</button>
                                </div>
                                <div class="pt-3 border-t border-gray-100">
                                    <p class="text-sm font-medium text-gray-700">Stock disponible</p>
                                    <p id="product-detail-stock" class="text-sm text-gray-500">Entrega pactada con el vendedor</p>
                                </div>
                            </div>

                            <div class="p-6 bg-white border border-gray-100 rounded-3xl shadow-sm">
                                <div class="flex items-start justify-between gap-4">
                                    <div>
                                        <p class="text-sm font-semibold text-gray-700 uppercase">Cantidad</p>
                                        <div class="flex items-center mt-2 overflow-hidden border border-gray-200 rounded-full">
                                            <button id="quantity-decrease" class="px-3 py-2 text-gray-600 transition-colors hover:bg-gray-100" type="button">-</button>
                                            <input id="product-detail-quantity" type="number" min="1" value="1" class="w-16 text-center border-0 focus:ring-0" />
                                            <button id="quantity-increase" class="px-3 py-2 text-gray-600 transition-colors hover:bg-gray-100" type="button">+</button>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-gray-700 uppercase">Vendedor</p>
                                        <p id="product-detail-owner" class="mt-2 text-sm text-gray-600"></p>
                                        <p id="product-detail-owner-email" class="text-xs text-gray-400"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <section class="p-6 bg-white border border-gray-100 rounded-3xl shadow-sm">
                            <h2 class="text-lg font-semibold text-gray-900">Descripci√≥n</h2>
                            <p id="product-detail-description" class="mt-3 text-sm leading-relaxed text-gray-600"></p>
                        </section>

                        <section class="p-6 bg-white border border-gray-100 rounded-3xl shadow-sm">
                            <div class="flex items-start justify-between gap-4">
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-900">Env√≠o y entrega</h2>
                                    <p class="mt-2 text-sm text-gray-600">Muy pronto podr√°s seleccionar opciones de env√≠o personalizadas para este art√≠culo.</p>
                                </div>
                                <span class="inline-flex items-center px-3 py-1 text-xs font-semibold tracking-wider text-yellow-800 uppercase bg-yellow-100 rounded-full">Pr√≥ximamente</span>
                            </div>
                        </section>
                    </div>
                </div>
            </div>

            <div class="sticky bottom-0 z-30 w-full px-4 py-4 bg-white border-t border-gray-200 shadow-[0_-10px_40px_-30px_rgba(0,0,0,0.45)] sm:px-6">
                <div class="max-w-4xl mx-auto flex flex-col gap-3 sm:flex-row sm:items-center">
                    <button id="product-detail-add-to-cart" class="flex items-center justify-center w-full px-5 py-3 text-sm font-semibold text-gray-800 transition-colors border border-gray-300 rounded-full hover:bg-gray-50" type="button">
                        <i data-lucide="shopping-cart" class="w-5 h-5 mr-2"></i>
                        Agregar al carrito
                    </button>
                    <button id="product-detail-proponer" class="flex items-center justify-center w-full px-5 py-3 text-sm font-semibold text-white transition-colors rounded-full bg-brand-dark hover:bg-[#1a5dcf]">
                        <i data-lucide="repeat" class="w-5 h-5 mr-2"></i>
                        Proponer canje ahora
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-proponer-canje" class="modal hidden fixed inset-0 z-30 flex items-center justify-center p-4">
        <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-50"></div>

        <div class="modal-content relative w-full max-w-lg p-6 bg-white rounded-lg shadow-xl">
            <button class="modal-close-btn absolute top-4 right-4 p-1 text-gray-500 rounded-full hover:bg-gray-100">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <h3 class="text-xl font-semibold text-gray-900">Proponer un Canje</h3>
            <p class="mt-1 text-sm text-gray-600">
                Est√°s proponiendo un canje por: <span id="modal-item-name" class="font-medium"></span>
            </p>
            <p class="text-sm text-gray-600">
                Valor estimado: <span id="modal-item-value" class="font-medium text-green-600"></span>
            </p>
            <form id="form-proponer-canje" class="mt-6 space-y-4">
                <div>
                    <label for="tu-articulo" class="block text-sm font-medium text-gray-700">Selecciona tu(s) art√≠culo(s) a ofrecer:</label>
                    
                    <div id="modal-user-items-list" class="mt-2 space-y-2 max-h-48 overflow-y-auto p-2 bg-gray-50 rounded-lg border">
                        <p class="text-sm text-gray-500 p-2">Cargando mis art√≠culos...</p>
                    </div>
                </div>
                
                <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                    <h4 class="font-medium">C√°lculo de Equivalencia</h4>
                    <div class="mt-2 space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Valor de tu(s) art√≠culo(s):</span>
                            <span id="tu-valor" class="font-medium text-gray-800">$0 COP</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Valor del art√≠culo deseado:</span>
                            <span id="deseado-valor" class="font-medium text-gray-800">$0 COP</span>
                        </div>
                        <div class="flex justify-between pt-2 mt-2 border-t">
                            <span class="font-semibold">Diferencia:</span>
                            <span id="diferencia-valor" class="font-semibold text-brand-dark">$0 COP</span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label for="agregar-dinero" class="block text-sm font-medium text-gray-700">Agregar diferencia en dinero (Opcional):</label>
                    <div class="relative mt-1">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">COP $</span>
                        <input type="number" id="agregar-dinero" class="w-full pl-12 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" placeholder="0">
                    </div>
                </div>

                <p id="modal-error-msg" class="hidden text-sm text-center text-red-600"></p>

                <div class="pt-4">
                    <button type="submit" class="w-full px-6 py-3 font-semibold text-white bg-brand rounded-lg shadow-sm hover:bg-brand-dark">
                        Enviar Propuesta de Canje
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-edit-timer" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-50"></div>
        <div class="modal-content relative w-full max-w-sm p-6 bg-white rounded-lg shadow-xl">
            <button class="modal-close-btn absolute top-4 right-4 p-1 text-gray-500 rounded-full hover:bg-gray-100">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <h3 class="text-xl font-semibold text-gray-900">Editar Temporizador</h3>
            <p class="mt-1 text-sm text-gray-600">Introduce la nueva fecha y hora de finalizaci√≥n.</p>
            <form id="form-edit-timer" class="mt-4 space-y-4">
                <div>
                    <label for="timer-datetime" class="block text-sm font-medium text-gray-700">Fecha y Hora (YYYY-MM-DDTHH:MM)</label>
                    <input type="datetime-local" id="timer-datetime" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" required>
                </div>
                <button type="submit" class="w-full px-4 py-2 font-medium text-white bg-brand rounded-lg hover:bg-brand-dark">
                    Guardar
                </button>
            </form>
        </div>
    </div>


    <div id="modal-terminos" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-60"></div>
        <div class="modal-content relative w-full max-w-2xl p-6 bg-white rounded-lg shadow-xl flex flex-col h-[90vh]">
            <div class="flex-shrink-0">
                <button class="modal-close-btn absolute top-4 right-4 p-1 text-gray-500 rounded-full hover:bg-gray-100">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
                <h3 class="text-xl font-semibold text-gray-900">T√©rminos y Condiciones del Canje</h3>
                <p class="mt-1 text-sm text-gray-600">
                    Por favor, lee y acepta los t√©rminos para continuar.
                </p>
            </div>
            <div class="mt-4 flex-grow overflow-y-auto pr-2">
                <h4 class="font-semibold mt-4">1. Acuerdo de Canje</h4>
                <p class="text-sm text-gray-600 mt-1">Al aceptar, te comprometes a un canje justo y a proporcionar informaci√≥n veraz sobre tu art√≠culo. Este acuerdo es vinculante.</p>
                <h4 class="font-semibold mt-4">2. Log√≠stica y Entrega</h4>
                <p class="text-sm text-gray-600 mt-1">La coordinaci√≥n de la entrega es tu responsabilidad. CanjeApp no se hace responsable por problemas durante el env√≠o.</p>
                <h4 class="font-semibold mt-4">3. Calidad del Producto</h4>
                <p class="text-sm text-gray-600 mt-1">Garantizas que tu art√≠culo coincide con la descripci√≥n y fotos. Cualquier discrepancia puede anular el canje.</p>
                <h4 class="font-semibold mt-4">4. Pol√≠tica de Devoluci√≥n</h4>
                <p class="text-sm text-gray-600 mt-1">No hay devoluciones. Una vez aceptado el canje, ambas partes deben cumplir con el acuerdo final.</p>
                 <h4 class="font-semibold mt-4">5. Seguridad en el Chat</h4>
                <p class="text-sm text-gray-600 mt-1">No compartas informaci√≥n personal sensible como contrase√±as o datos bancarios completos en el chat de log√≠stica. Utiliza el sentido com√∫n y mant√©n la conversaci√≥n centrada en la coordinaci√≥n de la entrega.</p>
                <h4 class="font-semibold mt-4">6. Disputas</h4>
                <p class="text-sm text-gray-600 mt-1">En caso de desacuerdo, contacta a soporte. CanjeApp mediar√°, pero la decisi√≥n final puede requerir acuerdo mutuo.</p>
            </div>
            <div class="mt-6 flex-shrink-0">
                <label class="flex items-center">
                    <input type="checkbox" id="checkbox-terminos" class="h-4 w-4 text-brand rounded focus:ring-brand">
                    <span class="ml-2 text-sm text-gray-700">He le√≠do y acepto los t√©rminos y condiciones.</span>
                </label>
                <button id="btn-continuar-chat" class="mt-4 w-full px-6 py-3 font-semibold text-white bg-brand rounded-lg shadow-sm hover:bg-brand-dark disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    Continuar al Chat
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAnalytics, isSupported as isAnalyticsSupported } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, deleteUser } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, query, where, serverTimestamp, deleteDoc, increment, orderBy, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
        import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBG035jZHTgsqZKIYCHGAUshwRukSccrjU",
            authDomain: "mercadocanje-ffca0.firebaseapp.com",
            projectId: "mercadocanje-ffca0",
            storageBucket: "mercadocanje-ffca0.firebasestorage.app",
            messagingSenderId: "1069590620221",
            appId: "1:1069590620221:web:ea68de5b49395ce42be254",
            measurementId: "G-9KEBKJ84CR"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const messaging = getMessaging(app);
        let analytics;

        // --- GESTI√ìN DE NOTIFICACIONES PUSH ---
        
        /**
         * Revisa el estado del permiso y actualiza la UI en la p√°gina de perfil.
         */
        function checkNotificationPermission() {
            const statusText = document.getElementById('notification-status-text');
            const activateButton = document.getElementById('btn-activar-notificaciones');
            if (!statusText || !activateButton) return;

            if (!('Notification' in window) || !('serviceWorker' in navigator)) {
                statusText.textContent = 'Este navegador no es compatible con las notificaciones push.';
                statusText.classList.remove('hidden');
                activateButton.classList.add('hidden');
                return;
            }

            switch (Notification.permission) {
                case 'granted':
                    statusText.textContent = 'Ya tienes las notificaciones activadas.';
                    statusText.classList.remove('hidden');
                    activateButton.classList.add('hidden');
                    break;
                case 'denied':
                    statusText.textContent = 'Las notificaciones est√°n bloqueadas. Debes activarlas en la configuraci√≥n de tu navegador.';
                    statusText.classList.remove('hidden');
                    activateButton.classList.add('hidden');
                    break;
                default: // 'default'
                    statusText.textContent = 'Recibe alertas sobre tus canjes y ofertas importantes.';
                    statusText.classList.remove('hidden');
                    activateButton.classList.remove('hidden');
                    break;
            }
        }

        /**
         * Inicia el proceso para solicitar permiso de notificaciones y guardar el token.
         */
        async function setupPushNotifications() {
            const userId = state.currentUser?.uid;
            if (!userId) {
                alert("Debes iniciar sesi√≥n para activar las notificaciones.");
                return;
            }

            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    await saveMessagingDeviceToken(userId);
                }
                // Actualizar la UI inmediatamente despu√©s de que el usuario elige
                checkNotificationPermission();
            } catch (err) {
                console.error('No se pudo obtener el permiso para notificar.', err);
                checkNotificationPermission();
            }
        }

        /**
         * Obtiene el token de FCM y lo guarda en el perfil del usuario en Firestore.
         */
        async function saveMessagingDeviceToken(userId) {
            try {
                const VAPID_KEY = 'BLBxM7CE6zgBH7XxaLlSOJdB0dRz4ZOV3PLyE7iDUmQDo2496Y8qT8OUtj3QUlxjxhtkHajiHfSXeqSI2xQSsFY';

                const registration = await navigator.serviceWorker.ready;
                const currentToken = await getToken(messaging, {
                    vapidKey: VAPID_KEY,
                    serviceWorkerRegistration: registration
                });

                if (currentToken) {
                    const userDocRef = doc(db, 'users', userId);
                    await setDoc(userDocRef, { fcmToken: currentToken }, { merge: true });
                    alert("¬°Notificaciones activadas con √©xito!");
                } else {
                     alert("No se pudo activar. Aseg√∫rate de haber concedido los permisos necesarios.");
                }
            } catch (err) {
                console.error('Error al obtener/guardar el token de FCM:', err);
                alert("Ocurri√≥ un error t√©cnico al activar las notificaciones.");
            }
        }


        document.addEventListener('DOMContentLoaded', async () => {
            try {
                if (await isAnalyticsSupported()) {
                    analytics = getAnalytics(app);
                    window.firebaseAnalytics = analytics;
                }
            } catch (analyticsError) {
                console.warn('Firebase Analytics no est√° disponible en este entorno:', analyticsError);
            }
            
            // --- CONSTANTES DE CATEGOR√çAS (MODIFICADO) ---
            const categories = [
                { name: 'Hogar', icon: 'home', id: 'hogar' },
                { name: 'Autom√≥viles', icon: 'car', id: 'automoviles' },
                { name: 'Inmuebles', icon: 'building', id: 'inmuebles' },
                { name: 'Salud', icon: 'heart-pulse', id: 'salud' },
                { name: 'Cosm√©ticos', icon: 'sparkles', id: 'cosmeticos' },
                { name: 'Servicios', icon: 'wrench', id: 'servicios' },
                { name: 'Tecnolog√≠a', icon: 'cpu', id: 'tecnologia' },
                { name: 'Moda', icon: 'shirt', id: 'moda' },
                { name: 'Celulares', icon: 'smartphone', id: 'celulares' },
                { name: 'Computaci√≥n', icon: 'laptop', id: 'computacion' },
                { name: 'Libros', icon: 'book-open', id: 'libros' },
                { name: 'Juegos', icon: 'gamepad-2', id: 'juegos' },
                { name: 'Deportes', icon: 'bike', id: 'deportes' }, // NUEVO
                { name: 'Otros', icon: 'box', id: 'otros' }
            ];

            const DEFAULT_PROFILE_PIC = 'https://placehold.co/100x100/E8F0FE/4285F4?text=U';
            const DEFAULT_PRODUCT_IMAGE = 'https://placehold.co/300x200/D1D5DB/111827?text=Sin+Imagen';

            // --- ESTADO DE LA APLICACI√ìN ---
            const state = {
                isLoggedIn: false,
                isAdmin: false,
                currentUser: {
                    uid: null,
                    name: '',
                    email: '',
                    address: '',
                    doc: '',
                    profilePic: DEFAULT_PROFILE_PIC,
                    profilePicPath: '',
                    items: [],
                    role: 'user',
                    stats: {
                        listedCount: 0,
                        completedTrades: 0,
                    },
                },
                viewedCategoryHistory: {},
                allProducts: [],
                banners: [],
                receivedOffers: [],
                itemToSwap: null,
                editingTimerSlide: null,
                productFiles: [],
                profilePicFile: null,
                isLoadingProducts: true,
                isLoadingBanners: true,
                currentProductDetail: null,
                cart: {
                    items: [],
                    totalQuantity: 0,
                    totalValue: 0,
                },
                activeOfferIdForChat: null,
                activeChatId: null,
                unsubscribeFromMessages: null,
                totalUnreadMessages: 0,
            };


            // --- UTILIDADES DE RENDIMIENTO ---
            const imagePreloadCache = new Map();
            const GRID_HIGH_PRIORITY_COUNT = 8;
            const POPULAR_HIGH_PRIORITY_COUNT = 4;
            const LAZY_IMAGE_PLACEHOLDER = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';

            function escapeHtml(value) {
                if (typeof value !== 'string') return value ?? '';
                const escapeMap = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;',
                    '`': '&#96;',
                };
                return value.replace(/[&<>"'`]/g, (char) => escapeMap[char] || char);
            }

            function createImageLoaderHTML({ src, alt, wrapperClass = '', imgClass = '', priority = 'auto' }) {
                const safeSrc = escapeHtml(src || DEFAULT_PRODUCT_IMAGE);
                const safeAlt = escapeHtml(alt || 'Imagen de art√≠culo');

                const loading = (priority === 'high') ? 'eager' : 'lazy';
                const fetchPriorityAttr = (priority === 'high') ? ` fetchpriority="high"` : '';

                const placeholder = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';

                return `
                    <div class="image-loader-wrapper ${wrapperClass}">
                        <img
                            src="${placeholder}"
                            data-src="${safeSrc}"
                            alt="${safeAlt}"
                            class="${imgClass}"
                            loading="${loading}"
                            decoding="async"
                            ${fetchPriorityAttr}
                        >
                    </div>
                `;
            }

            function hydrateImage(img) {
                if (!img || !img.dataset || !img.dataset.src) return;

                const wrapper = img.parentElement;

                img.src = img.dataset.src;

                img.onload = () => {
                    if (wrapper && wrapper.classList.contains('image-loader-wrapper')) {
                        wrapper.classList.add('is-loaded');
                    }
                };

                img.removeAttribute('data-src');
            }

            let lazyImageObserver = null;

            function getLazyImageObserver() {
                if (!('IntersectionObserver' in window)) return null;
                if (!lazyImageObserver) {
                    lazyImageObserver = new IntersectionObserver((entries, observer) => {
                        entries.forEach((entry) => {
                            if (!entry.isIntersecting) return;
                            const img = entry.target;
                            observer.unobserve(img);
                            hydrateImage(img); // Call the new hydration function
                        });
                    }, { rootMargin: '200px 0px', threshold: 0.01 });
                }
                return lazyImageObserver;
            }

            function registerLazyImages(root = document) {
                const scope = root && typeof root.querySelectorAll === 'function' ? root : document;
                const images = scope.querySelectorAll('img[data-src]');
                if (!images.length) return;
                const observer = getLazyImageObserver();
                images.forEach((img) => {
                    if (!img.dataset.src) return;
                    if (observer) {
                        observer.observe(img);
                    } else {
                        hydrateLazyImage(img);
                    }
                });
            }

            // --- GESTI√ìN DEL CARRITO ---
            const CART_STORAGE_KEY = 'canjeapp_cart_v1';
            const MAX_CART_QUANTITY = 99;
            let cartFeedbackTimeout = null;

            function clampCartQuantity(quantity) {
                const numeric = parseInt(quantity, 10);
                if (Number.isNaN(numeric)) return 1;
                return Math.min(MAX_CART_QUANTITY, Math.max(1, numeric));
            }

            function normalizeCartItem(payload) {
                if (!payload || !payload.id) return null;
                return {
                    id: payload.id,
                    name: payload.name || 'Art√≠culo sin nombre',
                    value: Number(payload.value) || 0,
                    quantity: clampCartQuantity(payload.quantity || 1),
                    categoryId: payload.categoryId || 'otros',
                    imageUrl: payload.imageUrl || DEFAULT_PRODUCT_IMAGE,
                    ownerName: payload.ownerName || '',
                    wants: payload.wants || '',
                };
            }

            function getStoredCartPayload() {
                if (typeof window === 'undefined' || !window.localStorage) return null;
                try {
                    const raw = window.localStorage.getItem(CART_STORAGE_KEY);
                    if (!raw) return null;
                    return JSON.parse(raw);
                } catch (error) {
                    console.warn('No se pudo leer el carrito almacenado:', error);
                    return null;
                }
            }

            function persistCartState() {
                if (typeof window === 'undefined' || !window.localStorage) return;
                try {
                    const payload = {
                        items: state.cart.items.map(item => ({
                            id: item.id,
                            name: item.name,
                            value: item.value,
                            quantity: item.quantity,
                            categoryId: item.categoryId,
                            imageUrl: item.imageUrl,
                            ownerName: item.ownerName,
                            wants: item.wants,
                        })),
                    };
                    window.localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(payload));
                } catch (error) {
                    console.warn('No se pudo guardar el estado del carrito:', error);
                }
            }

            function hydrateCartFromStorage() {
                const stored = getStoredCartPayload();
                if (stored && Array.isArray(stored.items)) {
                    state.cart.items = stored.items.map(normalizeCartItem).filter(Boolean);
                } else {
                    state.cart.items = [];
                }
                recalculateCartTotals();
            }

            function recalculateCartTotals() {
                let totalQuantity = 0;
                let totalValue = 0;
                state.cart.items = (state.cart.items || []).map(normalizeCartItem).filter(Boolean);
                state.cart.items.forEach(item => {
                    totalQuantity += item.quantity;
                    totalValue += item.value * item.quantity;
                });
                state.cart.totalQuantity = totalQuantity;
                state.cart.totalValue = totalValue;
            }

            function buildCartItemMarkup(item) {
                const productImage = createImageLoaderHTML({
                    src: item.imageUrl,
                    alt: item.name,
                    wrapperClass: 'w-12 h-12 rounded-lg flex-shrink-0 border border-gray-200',
                });

                const subtotal = item.value * item.quantity;
                return `
                    <div class="cart-item-entry flex items-center gap-3 p-3 bg-white border border-gray-200 rounded-lg shadow-sm" data-product-id="${escapeHtml(item.id)}">
                        ${productImage}
                        <div class="flex-1 min-w-0 space-y-1">
                            <p class="text-sm font-semibold text-gray-800 truncate">${escapeHtml(item.name)}</p>
                            <p class="text-xs text-gray-500">Valor unitario: ${formatCOP(item.value)}</p>
                            <p class="text-xs text-gray-500">Subtotal: ${formatCOP(subtotal)}</p>
                            <div class="flex flex-wrap items-center justify-between gap-2 pt-1">
                                <div class="flex items-center gap-2">
                                    <button class="cart-quantity-btn px-2 py-1 text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200" type="button" data-cart-action="decrease" data-product-id="${escapeHtml(item.id)}">-</button>
                                    <span class="text-sm font-semibold text-gray-700">${item.quantity}</span>
                                    <button class="cart-quantity-btn px-2 py-1 text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200" type="button" data-cart-action="increase" data-product-id="${escapeHtml(item.id)}">+</button>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button class="text-xs font-semibold text-brand hover:underline" type="button" data-cart-action="canje" data-product-id="${escapeHtml(item.id)}">Proponer canje</button>
                                    <button class="p-1 text-gray-500 transition-colors rounded-full hover:text-red-600" type="button" data-cart-action="remove" data-product-id="${escapeHtml(item.id)}">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            function buildCartPageItemMarkup(item) {
                const subtotal = item.value * item.quantity;
                const productImage = createImageLoaderHTML({
                    src: item.imageUrl,
                    alt: item.name,
                    wrapperClass: 'w-full h-full',
                });
                return `
                    <article class="cart-page-item grid grid-cols-[96px_1fr] gap-4 p-5 bg-white border border-gray-200 rounded-3xl shadow-[0_18px_45px_-30px_rgba(15,23,42,0.35)]" data-product-id="${escapeHtml(item.id)}">
                        <div class="overflow-hidden rounded-2xl aspect-square">
                            ${productImage}
                        </div>
                        <div class="flex flex-col gap-4">
                            <div class="flex flex-col gap-1">
                                <div class="flex items-start justify-between gap-3">
                                    <h3 class="text-base font-semibold text-gray-900">${escapeHtml(item.name)}</h3>
                                    <button class="p-2 text-gray-400 transition-colors rounded-full hover:text-red-500" type="button" data-cart-action="remove" data-product-id="${escapeHtml(item.id)}" aria-label="Eliminar del carrito">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <p class="text-xs font-medium tracking-wide text-gray-500 uppercase">${escapeHtml(getCategoryDisplayName(item.categoryId))}</p>
                            </div>
                            <div class="flex flex-wrap items-center justify-between gap-3">
                                <div class="flex items-center gap-3">
                                    <button class="cart-quantity-btn w-8 h-8 flex items-center justify-center text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200" type="button" data-cart-action="decrease" data-product-id="${escapeHtml(item.id)}" aria-label="Reducir cantidad">
                                        <i data-lucide="minus" class="w-4 h-4"></i>
                                    </button>
                                    <span class="text-sm font-semibold text-gray-800 min-w-[2ch] text-center">${item.quantity}</span>
                                    <button class="cart-quantity-btn w-8 h-8 flex items-center justify-center text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200" type="button" data-cart-action="increase" data-product-id="${escapeHtml(item.id)}" aria-label="Aumentar cantidad">
                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs font-medium text-gray-500">Valor unitario</p>
                                    <p class="text-sm font-semibold text-gray-900">${formatCOP(item.value)}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs font-medium text-gray-500">Subtotal</p>
                                    <p class="text-base font-semibold text-brand-dark">${formatCOP(subtotal)}</p>
                                </div>
                            </div>
                            <div class="flex items-center justify-end gap-2">
                                <button class="px-4 py-2 text-xs font-semibold text-brand transition-colors bg-brand-light rounded-full hover:bg-brand/30" type="button" data-cart-action="canje" data-product-id="${escapeHtml(item.id)}">
                                    Negociar canje
                                </button>
                            </div>
                        </div>
                    </article>
                `;
            }

            function updateCartClearButtonsState(hasItems) {
                if (sidebarCartClearBtn) {
                    sidebarCartClearBtn.disabled = !hasItems;
                    sidebarCartClearBtn.classList.toggle('opacity-50', !hasItems);
                    sidebarCartClearBtn.classList.toggle('cursor-not-allowed', !hasItems);
                }
                if (mobileCartClearBtn) {
                    mobileCartClearBtn.disabled = !hasItems;
                    mobileCartClearBtn.classList.toggle('opacity-50', !hasItems);
                    mobileCartClearBtn.classList.toggle('cursor-not-allowed', !hasItems);
                }
                if (cartPageClearBtn) {
                    cartPageClearBtn.disabled = !hasItems;
                    cartPageClearBtn.classList.toggle('opacity-50', !hasItems);
                    cartPageClearBtn.classList.toggle('cursor-not-allowed', !hasItems);
                }
            }

            function renderCart() {
                recalculateCartTotals();
                const hasItems = state.cart.items.length > 0;
                const sidebarMarkup = hasItems ? state.cart.items.map(buildCartItemMarkup).join('') : '<p class="text-sm text-gray-500">Tu carrito est√° vac√≠o.</p>';
                const mobileMarkup = hasItems ? state.cart.items.map(buildCartItemMarkup).join('') : '<p class="text-sm text-gray-500">Tu carrito est√° vac√≠o.</p>';
                const cartPageMarkup = hasItems ? state.cart.items.map(buildCartPageItemMarkup).join('') : '';

                if (sidebarCartItemsEl) {
                    sidebarCartItemsEl.innerHTML = sidebarMarkup;
                }
                if (mobileCartItemsEl) {
                    mobileCartItemsEl.innerHTML = mobileMarkup;
                }
                if (sidebarCartTotalEl) {
                    sidebarCartTotalEl.textContent = formatCOP(state.cart.totalValue);
                }
                if (mobileCartTotalEl) {
                    mobileCartTotalEl.textContent = formatCOP(state.cart.totalValue);
                }
                if (sidebarCartCountEl) {
                    sidebarCartCountEl.textContent = state.cart.totalQuantity.toString();
                }
                if (mobileCartCountEl) {
                    mobileCartCountEl.textContent = state.cart.totalQuantity.toString();
                }
                if (cartPageItemsEl) {
                    cartPageItemsEl.innerHTML = cartPageMarkup;
                }
                if (cartPageTotalEl) {
                    cartPageTotalEl.textContent = formatCOP(state.cart.totalValue);
                }
                if (cartPageQuantityEl) {
                    const quantityLabel = state.cart.totalQuantity === 1 ? '1 art√≠culo' : `${state.cart.totalQuantity} art√≠culos`;
                    cartPageQuantityEl.textContent = quantityLabel;
                }
                if (cartPageContentEl) {
                    cartPageContentEl.classList.toggle('hidden', !hasItems);
                }
                if (cartPageEmptyStateEl) {
                    cartPageEmptyStateEl.classList.toggle('hidden', hasItems);
                }

                updateCartClearButtonsState(hasItems);

                if (sidebarCartItemsEl) {
                    registerLazyImages(sidebarCartItemsEl);
                }
                if (mobileCartItemsEl) {
                    registerLazyImages(mobileCartItemsEl);
                }
                if (cartPageItemsEl) {
                    registerLazyImages(cartPageItemsEl);
                }
                if (typeof lucide !== 'undefined' && lucide?.createIcons) {
                    lucide.createIcons();
                }
            }

            function showCartFeedback(message, type = 'success') {
                const baseClasses = ['border', 'rounded-lg', 'py-2'];
                const successClasses = ['text-green-700', 'bg-green-50', 'border-green-200'];
                const errorClasses = ['text-red-600', 'bg-red-50', 'border-red-200'];
                const applyToElement = (element) => {
                    if (!element) return;
                    element.textContent = message;
                    element.classList.remove('hidden', ...successClasses, ...errorClasses);
                    element.classList.add(...baseClasses);
                    if (!element.classList.contains('px-4') && !element.classList.contains('px-5')) {
                        element.classList.add('px-3');
                    }
                    if (type === 'error') {
                        element.classList.add(...errorClasses);
                    } else {
                        element.classList.add(...successClasses);
                    }
                };
                [sidebarCartFeedbackEl, mobileCartFeedbackEl, cartPageFeedbackEl].forEach(applyToElement);

                if (cartFeedbackTimeout) {
                    clearTimeout(cartFeedbackTimeout);
                }
                cartFeedbackTimeout = setTimeout(() => {
                    [sidebarCartFeedbackEl, mobileCartFeedbackEl, cartPageFeedbackEl].forEach(element => {
                        if (!element) return;
                        element.classList.add('hidden');
                    });
                }, 3000);
            }

            function prepareAddToCartButton(button) {
                if (!button) return;
                if (!button.dataset.originalContent) {
                    button.dataset.originalContent = button.innerHTML;
                }
                if (!button.dataset.originalClasses) {
                    button.dataset.originalClasses = button.className;
                }
            }

            function flashAddToCartButtonState(button) {
                if (!button) return;

                prepareAddToCartButton(button);

                if (button._addToCartResetTimeout) {
                    clearTimeout(button._addToCartResetTimeout);
                }

                const classesToRemove = ['text-gray-700', 'text-gray-800', 'bg-gray-100', 'bg-gray-50', 'border-gray-200', 'border-gray-300', 'hover:bg-gray-200', 'hover:bg-gray-50'];
                button.classList.remove(...classesToRemove);
                button.classList.add('flex', 'items-center', 'justify-center', 'gap-2', 'bg-green-600', 'text-white', 'border', 'border-green-600', 'hover:bg-green-700');
                button.disabled = true;

                const iconSize = button.classList.contains('rounded-full') ? 'w-5 h-5' : 'w-4 h-4';
                button.innerHTML = `<span class="flex items-center justify-center gap-2"><i data-lucide="shopping-cart" class="${iconSize}"></i><span>Agregado al carrito</span></span>`;

                if (typeof lucide !== 'undefined' && lucide?.createIcons) {
                    lucide.createIcons();
                }

                button._addToCartResetTimeout = setTimeout(() => {
                    button.disabled = false;
                    if (button.dataset.originalClasses) {
                        button.className = button.dataset.originalClasses;
                    }
                    if (button.dataset.originalContent) {
                        button.innerHTML = button.dataset.originalContent;
                    }
                    if (typeof lucide !== 'undefined' && lucide?.createIcons) {
                        lucide.createIcons();
                    }
                    button._addToCartResetTimeout = null;
                }, 2000);
            }

            function addProductToCart(product, quantity = 1) {
                if (!product || !product.id) {
                    showCartFeedback('No se pudo agregar el art√≠culo seleccionado.', 'error');
                    return false;
                }
                const normalizedQuantity = clampCartQuantity(quantity);
                const existing = state.cart.items.find(item => item.id === product.id);
                if (existing) {
                    existing.quantity = clampCartQuantity(existing.quantity + normalizedQuantity);
                    existing.name = product.name || existing.name;
                    existing.value = Number(product.value) || existing.value;
                    existing.imageUrl = product.imageUrl || existing.imageUrl;
                    existing.categoryId = product.categoryId || existing.categoryId;
                    existing.ownerName = product.ownerName || existing.ownerName;
                    existing.wants = product.wants || existing.wants;
                } else {
                    const normalizedItem = normalizeCartItem({
                        id: product.id,
                        name: product.name,
                        value: product.value,
                        quantity: normalizedQuantity,
                        categoryId: product.categoryId,
                        imageUrl: Array.isArray(product.imageUrls) && product.imageUrls.length > 0 ? product.imageUrls[0] : (product.imageUrl || DEFAULT_PRODUCT_IMAGE),
                        ownerName: product.ownerName,
                        wants: product.wants,
                    });
                    if (!normalizedItem) {
                        showCartFeedback('No se pudo agregar el art√≠culo seleccionado.', 'error');
                        return false;
                    }
                    state.cart.items.push(normalizedItem);
                }
                persistCartState();
                renderCart();
                showCartFeedback(existing ? 'Cantidad actualizada en tu carrito.' : 'Art√≠culo agregado al carrito.');
                return true;
            }

            function removeProductFromCart(productId) {
                const initialLength = state.cart.items.length;
                state.cart.items = state.cart.items.filter(item => item.id !== productId);
                if (state.cart.items.length !== initialLength) {
                    persistCartState();
                    renderCart();
                    showCartFeedback('Art√≠culo eliminado del carrito.');
                }
            }

            function updateCartItemQuantity(productId, delta) {
                const item = state.cart.items.find(entry => entry.id === productId);
                if (!item) {
                    showCartFeedback('No se encontr√≥ el art√≠culo en el carrito.', 'error');
                    return;
                }
                const requestedQuantity = item.quantity + delta;
                if (requestedQuantity <= 0) {
                    removeProductFromCart(productId);
                    return;
                }
                item.quantity = clampCartQuantity(requestedQuantity);

                persistCartState();
                renderCart();
                showCartFeedback('Cantidad actualizada en tu carrito.');
            }

            function clearCart() {
                if (!state.cart.items.length) return;
                state.cart.items = [];
                persistCartState();
                renderCart();
                showCartFeedback('Se vaci√≥ el carrito correctamente.');
            }

            function handleCartActionFromClick(event) {
                const actionButton = event.target.closest('[data-cart-action]');
                if (!actionButton) return;
                event.preventDefault();
                event.stopPropagation();
                const action = actionButton.dataset.cartAction;
                const productId = actionButton.dataset.productId;

                switch (action) {
                    case 'increase':
                        updateCartItemQuantity(productId, 1);
                        break;
                    case 'decrease':
                        updateCartItemQuantity(productId, -1);
                        break;
                    case 'remove':
                        removeProductFromCart(productId);
                        break;
                    case 'canje': {
                        const cartItem = state.cart.items.find(entry => entry.id === productId);
                        if (!cartItem) {
                            showCartFeedback('No se encontr√≥ el art√≠culo seleccionado.', 'error');
                            return;
                        }
                        const desiredName = cartItem.quantity > 1 ? `${cartItem.name} (x${cartItem.quantity})` : cartItem.name;
                        const desiredValue = cartItem.value * cartItem.quantity;
                        prepareAndOpenCanjeModal({
                            itemId: cartItem.id,
                            itemName: desiredName,
                            itemValue: desiredValue,
                            categoryId: cartItem.categoryId,
                        });
                        if (typeof closeMobileMenu === 'function') {
                            closeMobileMenu();
                        }
                        break;
                    }
                    default:
                        break;
                }
            }

            function syncCartWithProducts() {
                if (!Array.isArray(state.cart.items) || !state.cart.items.length || !Array.isArray(state.allProducts) || !state.allProducts.length) {
                    renderCart();
                    return;
                }
                const productMap = new Map(state.allProducts.map(product => [product.id, product]));
                let hasChanges = false;
                let removedItems = false;
                state.cart.items = state.cart.items.map(item => {
                    const product = productMap.get(item.id);
                    if (!product) {
                        removedItems = true;
                        return null;
                    }
                    const normalized = normalizeCartItem({
                        ...item,
                        name: product.name || item.name,
                        value: product.value,
                        categoryId: product.categoryId || item.categoryId,
                        imageUrl: Array.isArray(product.imageUrls) && product.imageUrls.length > 0 ? product.imageUrls[0] : (product.imageUrl || item.imageUrl),
                        ownerName: product.ownerName || item.ownerName,
                        wants: product.wants || item.wants,
                    });
                    if (!normalized) {
                        hasChanges = true;
                        return null;
                    }
                    if (
                        normalized.name !== item.name ||
                        normalized.value !== item.value ||
                        normalized.categoryId !== item.categoryId ||
                        normalized.imageUrl !== item.imageUrl ||
                        normalized.wants !== item.wants
                    ) {
                        hasChanges = true;
                    }
                    normalized.quantity = item.quantity;
                    return normalized;
                }).filter(Boolean);

                if (removedItems) {
                    hasChanges = true;
                    showCartFeedback('Se eliminaron art√≠culos no disponibles de tu carrito.', 'error');
                }
                if (hasChanges) {
                    persistCartState();
                }
                renderCart();
            }

            function preloadImage(src, priority = 'auto') {
                if (!src) return Promise.resolve();
                if (imagePreloadCache.has(src)) {
                    return imagePreloadCache.get(src);
                }

                const preloadPromise = new Promise((resolve) => {
                    const img = new Image();
                    img.decoding = 'async';
                    if ('fetchPriority' in img) {
                        img.fetchPriority = priority;
                    }
                    img.onload = () => resolve(src);
                    img.onerror = () => resolve(src);
                    img.src = src;
                });

                imagePreloadCache.set(src, preloadPromise);
                return preloadPromise;
            }

            const idlePrefetchQueue = new Set();
            let idlePrefetchHandle = null;

            function scheduleIdlePrefetch() {
                if (!idlePrefetchQueue.size) return;

                if (typeof requestIdleCallback !== 'function') {
                    idlePrefetchQueue.forEach((url) => preloadImage(url, 'low'));
                    idlePrefetchQueue.clear();
                    return;
                }

                if (idlePrefetchHandle) return;

                idlePrefetchHandle = requestIdleCallback((deadline) => {
                    while ((deadline.timeRemaining() > 2 || deadline.didTimeout) && idlePrefetchQueue.size) {
                        const iterator = idlePrefetchQueue.values().next();
                        if (iterator.done) break;
                        const url = iterator.value;
                        idlePrefetchQueue.delete(url);
                        preloadImage(url, 'low');
                    }
                    idlePrefetchHandle = null;
                    if (idlePrefetchQueue.size) {
                        scheduleIdlePrefetch();
                    }
                }, { timeout: 2000 });
            }

            function queueIdlePrefetch(urls = []) {
                urls.forEach((url) => {
                    if (url) {
                        idlePrefetchQueue.add(url);
                    }
                });
                scheduleIdlePrefetch();
            }

            async function preloadImages(urls = [], { highPriorityCount = 0 } = {}) {
                const uniqueUrls = Array.from(new Set(urls.filter(Boolean)));
                if (!uniqueUrls.length) return;

                const highPriorityUrls = uniqueUrls.slice(0, highPriorityCount);
                if (highPriorityUrls.length) {
                    await Promise.all(highPriorityUrls.map((url) => preloadImage(url, 'high')));
                }

                const remainingUrls = uniqueUrls.slice(highPriorityUrls.length);
                if (remainingUrls.length) {
                    queueIdlePrefetch(remainingUrls);
                }
            }

            function buildBannerSlide(banner, index = 0) {
                const isHighPriority = index === 0;
                const title = escapeHtml(banner.title || '');
                const imageUrl = banner.imageUrl || '';
                const alt = title || 'Banner destacado';
                const imageMarkup = createImageLoaderHTML({
                    src: imageUrl,
                    alt,
                    wrapperClass: 'w-full h-full',
                    priority: isHighPriority ? 'high' : 'auto',
                });

                return `
                    <div class="relative flex-shrink-0 w-full h-full carousel-slide" data-end-time="${escapeHtml(banner.endTime || '')}" data-banner-id="${escapeHtml(banner.id)}" data-image-path="${escapeHtml(banner.imagePath || '')}">
                        ${imageMarkup}
                        <div class="promo-timer hidden absolute top-3 right-3 md:top-4 md:right-4 z-30" data-role="carousel-timer" aria-live="polite"></div>
                        <div class="absolute bottom-3 right-3 flex items-center gap-2 admin-only hidden md:bottom-4 md:right-4">
                            <button class="p-1 text-gray-800 bg-white/90 rounded-full shadow-sm hover:bg-white admin-edit-timer-btn" title="Editar temporizador">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                            <button class="p-1 text-white bg-red-600 rounded-full shadow-sm hover:bg-red-700 btn-delete-banner" title="Eliminar banner">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `;
            }

            function buildProductCard(product, index = 0, highPriorityLimit = GRID_HIGH_PRIORITY_COUNT) {
                const isHighPriority = index < highPriorityLimit;
                const imageMarkup = createImageLoaderHTML({
                    src: product.imageUrl,
                    alt: product.name,
                    wrapperClass: 'w-full h-40',
                    priority: isHighPriority ? 'high' : 'auto',
                });

                return `
                    <div class="product-card overflow-hidden bg-white border border-gray-200 rounded-lg shadow-sm cursor-pointer transition-transform hover:-translate-y-1" data-product-id="${escapeHtml(product.id)}">
                        ${imageMarkup}
                        <div class="p-4">
                            <h4 class="font-semibold text-gray-900 truncate">${escapeHtml(product.name)}</h4>
                            <p class="text-sm text-gray-500 truncate">Busca: ${escapeHtml(product.wants)}</p>
                            <p class="mt-2 text-sm font-medium text-gray-700">Equivalente a: <span class="text-green-600">${formatCOP(product.value)}</span></p>
                            <div class="mt-3 space-y-2">
                                <button class="btn-proponer-canje w-full px-4 py-2 text-sm font-medium text-white transition-colors bg-brand rounded-lg hover:bg-brand-dark" type="button" data-item-id="${escapeHtml(product.id)}" data-item-name="${escapeHtml(product.name)}" data-item-value="${product.value}" data-category-id="${escapeHtml(product.categoryId)}">
                                    Proponer Canje
                                </button>
                                <button class="btn-add-to-cart w-full px-4 py-2 text-sm font-medium text-gray-700 transition-colors bg-gray-100 rounded-lg hover:bg-gray-200" type="button" data-item-id="${escapeHtml(product.id)}">
                                    Agregar al carrito
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            function buildPopularCard(product, index = 0, highPriorityLimit = POPULAR_HIGH_PRIORITY_COUNT) {
                const isHighPriority = index < highPriorityLimit;
                const imageMarkup = createImageLoaderHTML({
                    src: product.imageUrl,
                    alt: product.name,
                    wrapperClass: 'w-full h-40',
                    priority: isHighPriority ? 'high' : 'auto',
                });

                return `
                    <div class="popular-card product-card flex-shrink-0 overflow-hidden bg-white border border-gray-200 rounded-lg shadow-sm cursor-pointer transition-transform hover:-translate-y-1" data-product-id="${escapeHtml(product.id)}">
                        ${imageMarkup}
                        <div class="p-4">
                            <h4 class="font-semibold text-gray-900 truncate">${escapeHtml(product.name)}</h4>
                            <p class="text-sm text-gray-500 truncate">Busca: ${escapeHtml(product.wants)}</p>
                            <p class="mt-2 text-sm font-medium text-gray-700">Equivalente a: <span class="text-green-600">${formatCOP(product.value)}</span></p>
                            <div class="mt-3 space-y-2">
                                <button class="btn-proponer-canje w-full px-4 py-2 text-sm font-medium text-white transition-colors bg-brand rounded-lg hover:bg-brand-dark" type="button" data-item-id="${escapeHtml(product.id)}" data-item-name="${escapeHtml(product.name)}" data-item-value="${product.value}" data-category-id="${escapeHtml(product.categoryId)}">
                                    Proponer Canje
                                </button>
                                <button class="btn-add-to-cart w-full px-4 py-2 text-sm font-medium text-gray-700 transition-colors bg-gray-100 rounded-lg hover:bg-gray-200" type="button" data-item-id="${escapeHtml(product.id)}">
                                    Agregar al carrito
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }


            // --- SELECTORES ---
            const DEFAULT_PAGE_ID = 'page-explorar';

            const pages = document.querySelectorAll('.page');
            const navLinks = document.querySelectorAll('.nav-link');
            const authTabs = document.querySelectorAll('.auth-tab-btn');
            const authTabContents = document.querySelectorAll('.auth-tab-content');
            const canjeTabs = document.querySelectorAll('.canje-tab-btn');
            const canjeTabContents = document.querySelectorAll('.canje-tab-content');
            const bodyEl = document.body;
            
            // Elementos de autenticaci√≥n
            const perfilAuthForm = document.getElementById('perfil-auth-form');
            const perfilLoggedIn = document.getElementById('perfil-logged-in');
            const canjesAuthRequired = document.getElementById('canjes-auth-required');
            const canjesContent = document.getElementById('canjes-content');
            const venderAuthRequired = document.getElementById('vender-auth-required');
            const venderContent = document.getElementById('vender-content');
            const btnLogout = document.getElementById('btn-logout');
            const formLogin = document.getElementById('auth-login');
            const formRegister = document.getElementById('auth-register');
            const loginErrorMsg = document.getElementById('login-error-msg');
            const registerErrorMsg = document.getElementById('register-error-msg');
            const userNameEl = document.getElementById('user-name');
            const userEmailEl = document.getElementById('user-email');
            const userAddressEl = document.getElementById('user-address');
            const userDocEl = document.getElementById('user-doc');
            const mainProfileImg = document.getElementById('main-profile-img');
            const headerProfileImg = document.getElementById('header-profile-img');
            const profilePicUpload = document.getElementById('profile-pic-upload');
            const profilePicPreview = document.getElementById('profile-pic-preview');
            const defaultProfilePreviewSrc = profilePicPreview ? profilePicPreview.src : DEFAULT_PROFILE_PIC;

            // Barra lateral
            const sidebar = document.getElementById('desktop-sidebar');
            const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
            const mainContentWrapper = document.getElementById('main-content-wrapper');
            
            // Modal de Canje (MODIFICADO)
            const modalProponerCanje = document.getElementById('modal-proponer-canje');
            const selectTuArticulo = document.getElementById('modal-user-items-list'); // MODIFICADO
            const formProponerCanje = document.getElementById('form-proponer-canje');
            const modalErrorMsg = document.getElementById('modal-error-msg');
            const modalItemNameEl = document.getElementById('modal-item-name');
            const modalItemValueEl = document.getElementById('modal-item-value');
            const deseadoValorEl = document.getElementById('deseado-valor');
            const tuValorEl = document.getElementById('tu-valor');
            const diferenciaValorEl = document.getElementById('diferencia-valor');
            const agregarDineroInput = document.getElementById('agregar-dinero');

            // Detalle de producto
            const productDetailView = document.getElementById('product-detail-view');
            const productDetailCloseBtn = document.getElementById('product-detail-close');
            const productDetailBreadcrumb = document.getElementById('product-detail-breadcrumb');
            const productDetailStatus = document.getElementById('product-detail-status');
            const productDetailTitle = document.getElementById('product-detail-title');
            const productDetailWants = document.getElementById('product-detail-wants');
            const productDetailPrice = document.getElementById('product-detail-price');
            const productDetailInstallments = document.getElementById('product-detail-installments');
            const productDetailDescription = document.getElementById('product-detail-description');
            const productDetailOwner = document.getElementById('product-detail-owner');
            const productDetailOwnerEmail = document.getElementById('product-detail-owner-email');
            const productDetailCarouselSlider = document.getElementById('product-detail-carousel-slider');
            const productDetailCarouselDots = document.getElementById('product-detail-carousel-dots');
            const productDetailProponerBtn = document.getElementById('product-detail-proponer');
            const productDetailQuantityInput = document.getElementById('product-detail-quantity');
            const productDetailQuantityDecrease = document.getElementById('quantity-decrease');
            const productDetailQuantityIncrease = document.getElementById('quantity-increase');
            const productDetailStock = document.getElementById('product-detail-stock');
            const productDetailAddToCartBtn = document.getElementById('product-detail-add-to-cart');

            // --- SELECTORES DEL CARRUSEL (ACTUALIZADOS) ---
            const promoCarousel = document.getElementById('promo-carousel');
            const carouselSlider = document.getElementById('carousel-slider');
            const carouselPrevBtn = document.getElementById('carousel-prev');
            const carouselNextBtn = document.getElementById('carousel-next');
            const carouselMeta = document.getElementById('carousel-meta');
            const carouselTitleEl = document.getElementById('carousel-title');
            const carouselSubtitleEl = document.getElementById('carousel-subtitle');
            const appPreloader = document.getElementById('app-preloader');
            let currentSlide = 0;
            let totalSlides = 0; // Se actualizar√° din√°micamente
            let carouselInterval;
            let carouselTimerInterval;
            let activeTimerEl = null;

            
            // --- NUEVOS SELECTORES ---
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileMenuPanel = document.getElementById('mobile-menu-panel');
            const mobileMenuBackdrop = document.getElementById('mobile-menu-backdrop');
            const mobileMenuLinks = document.querySelectorAll('.nav-link-mobile-menu');
            const adminBadge = document.getElementById('admin-badge');
            
            const uploadCoverBtn = document.getElementById('upload-cover-btn');
            const coverFileInput = document.getElementById('cover-file-input');
            
            const categoryListContainer = document.getElementById('category-list-container');
            const categorySelect = document.getElementById('categoria');

            const modalEditTimer = document.getElementById('modal-edit-timer');
            const formEditTimer = document.getElementById('form-edit-timer');

            // --- NUEVOS SELECTORES (Vender Fotos) ---
            const formVender = document.getElementById('form-vender');
            const productPhotoInput = document.getElementById('product-photo-upload');
            const photoUploadLabel = document.getElementById('photo-upload-label');
            const photoPreviewContainer = document.getElementById('photo-preview-container');
            const photoUploadText = document.getElementById('photo-upload-text');
            const photoUploadSummary = document.getElementById('photo-upload-summary');
            const photoCount = document.getElementById('photo-count');
            const photoErrorMsg = document.getElementById('photo-error-msg');
            const publicarErrorMsg = document.getElementById('publicar-error-msg');

            // --- NUEVOS SELECTORES (Renderizado Din√°mico) ---
            const explorarProductGrid = document.getElementById('explorar-product-grid');
            const tabOfertas = document.getElementById('tab-ofertas');
            const tabMisArticulos = document.getElementById('tab-mis-articulos');
            const ofertasCount = document.getElementById('ofertas-count');
            const misArticulosCount = document.getElementById('mis-articulos-count');
            const mostViewedContainer = document.getElementById('most-viewed-container');
            const sidebarCartItemsEl = document.getElementById('sidebar-cart-items');
            const modalTerminos = document.getElementById('modal-terminos');
            const checkboxTerminos = document.getElementById('checkbox-terminos');
            const btnContinuarChat = document.getElementById('btn-continuar-chat');
            const btnActivarNotificaciones = document.getElementById('btn-activar-notificaciones');
            const chatWithName = document.getElementById('chat-with-name');
            const chatItemName = document.getElementById('chat-item-name');
            const chatItemImage = document.getElementById('chat-item-image'); // Nuevo
            const chatMessages = document.getElementById('chat-messages');
            const formChat = document.getElementById('form-chat');
            const chatInput = document.getElementById('chat-input');
            const btnAttachImage = document.getElementById('btn-attach-image');
            const chatImageUpload = document.getElementById('chat-image-upload');
            const sidebarCartTotalEl = document.getElementById('sidebar-cart-total');
            const sidebarCartCountEl = document.getElementById('sidebar-cart-count');
            const sidebarCartFeedbackEl = document.getElementById('sidebar-cart-feedback');
            const sidebarCartClearBtn = document.getElementById('sidebar-cart-clear');
            const mobileCartItemsEl = document.getElementById('mobile-cart-items');
            const mobileCartTotalEl = document.getElementById('mobile-cart-total');
            const mobileCartCountEl = document.getElementById('mobile-cart-count');
            const mobileCartFeedbackEl = document.getElementById('mobile-cart-feedback');
            const mobileCartClearBtn = document.getElementById('mobile-cart-clear');
            const cartPageItemsEl = document.getElementById('cart-page-items');
            const cartPageContentEl = document.getElementById('cart-page-content');
            const cartPageEmptyStateEl = document.getElementById('cart-page-empty-state');
            const cartPageTotalEl = document.getElementById('cart-page-total');
            const cartPageQuantityEl = document.getElementById('cart-page-quantity');
            const cartPageClearBtn = document.getElementById('cart-page-clear');
            const cartPageFeedbackEl = document.getElementById('cart-page-feedback');
            const chatNotificationBubble = document.getElementById('chat-notification-bubble');

            // --- FUNCIONES ---

            /**
             * Muestra una p√°gina y oculta las dem√°s.
             */
            function showPage(pageId = DEFAULT_PAGE_ID) {
                const targetPageId = pageId || DEFAULT_PAGE_ID;
                pages.forEach(page => page.classList.add('hidden'));
                const activePage = document.getElementById(targetPageId);
                if (activePage) {
                    activePage.classList.remove('hidden');
                    window.scrollTo(0, 0);
                }
                updateActiveNav(targetPageId);

                if (targetPageId === 'page-perfil' && state.isLoggedIn) {
                    checkNotificationPermission();
                }

                if (targetPageId === 'page-chat') {
                    document.body.classList.add('chat-abierto');
                } else {
                    document.body.classList.remove('chat-abierto');
                }
            }

            /**
             * Actualiza el estado visual "activo" en los enlaces de navegaci√≥n.
             */
            function updateActiveNav(pageId) {
                navLinks.forEach(link => {
                    const isActive = link.dataset.page === pageId;
                    link.classList.toggle('active', isActive);
                    if (link.classList.contains('nav-link-mobile')) {
                        link.classList.toggle('text-brand', isActive);
                        link.classList.toggle('text-gray-600', !isActive);
                    }
                });
            }

            function hidePreloader() {
                if (!appPreloader) return;
                if (appPreloader.classList.contains('is-hidden')) return;
                appPreloader.classList.add('is-hidden');
                setTimeout(() => {
                    if (appPreloader && appPreloader.parentElement) {
                        appPreloader.parentElement.removeChild(appPreloader);
                    }
                }, 400);
            }

            /**
             * Actualiza la UI basada en el estado de autenticaci√≥n.
             */
            function updateAuthUI() {
                if (state.isLoggedIn) {
                    // Vista Perfil
                    perfilAuthForm.classList.add('hidden');
                    perfilLoggedIn.classList.remove('hidden');
                    const defaultPic = 'https://placehold.co/40x40/E8F0FE/4285F4?text=U';
                    const profilePic = state.currentUser.profilePic || defaultPic;
                    userNameEl.textContent = state.currentUser.name || 'Usuario';
                    userEmailEl.textContent = state.currentUser.email || '';
                    userAddressEl.textContent = state.currentUser.address || 'Sin direcci√≥n';
                    const docValue = state.currentUser.doc || '';
                    userDocEl.textContent = docValue ? docValue.replace(/(\d{4})\d+/, '$1******') : 'Sin documento';
                    mainProfileImg.src = profilePic;
                    headerProfileImg.src = profilePic;

                    // Vistas restringidas
                    canjesAuthRequired.classList.add('hidden');
                    canjesContent.classList.remove('hidden');
                    venderAuthRequired.classList.add('hidden');
                    venderContent.classList.remove('hidden');

                    // L√≥gica de Admin
                    const headerLogo = document.getElementById('header-logo');
                    if (state.isAdmin) {
                        adminBadge.classList.remove('hidden');
                        document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
                        if (headerLogo) headerLogo.classList.add('is-admin');
                    } else {
                        adminBadge.classList.add('hidden');
                        document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
                        if (headerLogo) headerLogo.classList.remove('is-admin');
                    }

                    // Actualizar contadores
                    ofertasCount.textContent = state.receivedOffers.length;
                    misArticulosCount.textContent = (state.currentUser.items || []).length;
                    // Renderizar contenido din√°mico del usuario
                    renderReceivedOffers();
                    renderMyItems();

                } else {
                    // Vista Perfil
                    perfilAuthForm.classList.remove('hidden');
                    perfilLoggedIn.classList.add('hidden');
                    const defaultPic = 'https://placehold.co/40x40/E8F0FE/4285F4?text=U';
                    mainProfileImg.src = defaultPic;
                    headerProfileImg.src = defaultPic;
                    if (profilePicPreview) {
                        profilePicPreview.src = defaultProfilePreviewSrc;
                    }

                    // Vistas restringidas
                    canjesAuthRequired.classList.remove('hidden');
                    canjesContent.classList.add('hidden');
                    venderAuthRequired.classList.remove('hidden');
                    venderContent.classList.add('hidden');

                    // Ocultar elementos de admin
                    adminBadge.classList.add('hidden');
                    document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));

                    // Limpiar contadores y contenido
                    ofertasCount.textContent = 0;
                    misArticulosCount.textContent = 0;
                    tabOfertas.innerHTML = '<p class="text-gray-500">Debes iniciar sesi√≥n para ver tus ofertas.</p>';
                    tabMisArticulos.innerHTML = '<p class="text-gray-500">Debes iniciar sesi√≥n para ver tus art√≠culos.</p>';
                }
            }
            
            /**
             * Formatea un n√∫mero como moneda COP.
             */
            function formatCOP(value) {
                return new Intl.NumberFormat('es-CO', {
                    style: 'currency',
                    currency: 'COP',
                    maximumFractionDigits: 0,
                    minimumFractionDigits: 0,
                }).format(value);
            }

            function getCategoryDisplayName(categoryId) {
                const category = categories.find(cat => cat.id === categoryId);
                return category ? category.name : 'Marketplace';
            }

            function formatInstallments(value, months = 3) {
                if (!value || value <= 0) {
                    return 'Intercambia por equivalencia y acuerda la entrega con el vendedor.';
                }
                const installmentValue = Math.ceil(value / months);
                return `${months} cuotas de ${formatCOP(installmentValue)} con 0% inter√©s`;
            }

            // --- NUEVA L√ìGICA DEL CARRUSEL DE DETALLE DE PRODUCTO ---
            let productDetailCurrentSlide = 0;
            let productDetailTotalSlides = 0;
            let productDetailStartX = 0;
            let productDetailCurrentX = 0;
            let productDetailIsDragging = false;

            function buildProductDetailCarousel(images, productName) {
                if (!productDetailCarouselSlider || !productDetailCarouselDots) return;

                const safeName = escapeHtml(productName || 'Art√≠culo');
                productDetailCarouselSlider.innerHTML = images.map((url, index) => `
                    <div class="product-detail-carousel-slide">
                        <img src="${escapeHtml(url)}" alt="${safeName} - Imagen ${index + 1}" loading="${index === 0 ? 'eager' : 'lazy'}">
                    </div>
                `).join('');

                productDetailCarouselDots.innerHTML = images.map((_, index) => `
                    <button class="carousel-dot ${index === 0 ? 'active' : ''}" data-slide-to="${index}"></button>
                `).join('');

                productDetailTotalSlides = images.length;
                productDetailCurrentSlide = 0;
                updateProductDetailCarousel();

                productDetailCarouselDots.querySelectorAll('.carousel-dot').forEach(dot => {
                    dot.addEventListener('click', (e) => {
                        const slideIndex = parseInt(e.currentTarget.dataset.slideTo, 10);
                        goToProductDetailSlide(slideIndex);
                    });
                });
            }

            function updateProductDetailCarousel() {
                if (productDetailTotalSlides > 0) {
                    productDetailCarouselSlider.style.transform = `translateX(-${productDetailCurrentSlide * 100}%)`;
                    productDetailCarouselDots.querySelectorAll('.carousel-dot').forEach((dot, index) => {
                        dot.classList.toggle('active', index === productDetailCurrentSlide);
                    });
                }
            }

            function goToProductDetailSlide(index) {
                productDetailCurrentSlide = index;
                updateProductDetailCarousel();
            }

            function setupProductDetailCarouselTouch() {
                const carouselContainer = productDetailCarouselSlider.parentElement;

                carouselContainer.addEventListener('touchstart', (e) => {
                    productDetailIsDragging = true;
                    productDetailStartX = e.touches[0].clientX;
                    productDetailCarouselSlider.style.transition = 'none';
                });

                carouselContainer.addEventListener('touchmove', (e) => {
                    if (!productDetailIsDragging) return;
                    productDetailCurrentX = e.touches[0].clientX;
                    const diff = productDetailCurrentX - productDetailStartX;
                    productDetailCarouselSlider.style.transform = `translateX(calc(-${productDetailCurrentSlide * 100}% + ${diff}px))`;
                });

                carouselContainer.addEventListener('touchend', () => {
                    if (!productDetailIsDragging) return;
                    productDetailIsDragging = false;
                    const diff = productDetailCurrentX - productDetailStartX;
                    productDetailCarouselSlider.style.transition = 'transform 0.3s ease-in-out';

                    if (Math.abs(diff) > 50) { // Umbral de deslizamiento
                        if (diff > 0 && productDetailCurrentSlide > 0) {
                            productDetailCurrentSlide--;
                        } else if (diff < 0 && productDetailCurrentSlide < productDetailTotalSlides - 1) {
                            productDetailCurrentSlide++;
                        }
                    }
                    updateProductDetailCarousel();
                });
            }

            function openProductDetail(product) {
                if (!productDetailView || !product) return;

                state.currentProductDetail = product;

                const productImages = Array.isArray(product.imageUrls) && product.imageUrls.length > 0
                    ? product.imageUrls
                    : (product.imageUrl ? [product.imageUrl] : [DEFAULT_PRODUCT_IMAGE]);

                buildProductDetailCarousel(productImages, product.name);

                if (productDetailBreadcrumb) {
                    productDetailBreadcrumb.textContent = `${getCategoryDisplayName(product.categoryId)} ‚Ä¢ ${product.ownerName || 'Vendedor verificado'}`;
                }
                if (productDetailStatus) {
                    productDetailStatus.textContent = 'Disponible para canje';
                }
                if (productDetailTitle) {
                    productDetailTitle.textContent = product.name;
                }
                if (productDetailWants) {
                    const wantsText = product.wants ? `Intercambia por: ${product.wants}` : 'Abierto a recibir propuestas de canje.';
                    productDetailWants.textContent = wantsText;
                }
                if (productDetailPrice) {
                    productDetailPrice.textContent = formatCOP(product.value);
                }
                if (productDetailInstallments) {
                    productDetailInstallments.textContent = formatInstallments(product.value);
                }
                if (productDetailDescription) {
                    productDetailDescription.textContent = product.description || 'Este art√≠culo a√∫n no tiene una descripci√≥n detallada.';
                }
                if (productDetailOwner) {
                    productDetailOwner.textContent = product.ownerName || 'Vendedor verificado';
                }
                if (productDetailOwnerEmail) {
                    productDetailOwnerEmail.textContent = product.ownerEmail || 'Contacto compartido tras iniciar el canje.';
                }
                if (productDetailStock) {
                    productDetailStock.textContent = 'Entrega pactada con el vendedor';
                }
                if (productDetailProponerBtn) {
                    productDetailProponerBtn.dataset.itemId = product.id;
                    productDetailProponerBtn.dataset.itemName = product.name;
                    productDetailProponerBtn.dataset.itemValue = product.value;
                    productDetailProponerBtn.dataset.categoryId = product.categoryId;
                }
                if (productDetailAddToCartBtn) {
                    productDetailAddToCartBtn.dataset.productId = product.id;
                }
                if (productDetailQuantityInput) {
                    productDetailQuantityInput.value = '1';
                }

                if (bodyEl) {
                    bodyEl.classList.add('overflow-hidden');
                }
                productDetailView.classList.remove('hidden');
                productDetailView.classList.add('open');
            }

            function closeProductDetail() {
                if (!productDetailView) return;
                productDetailView.classList.add('hidden');
                productDetailView.classList.remove('open');
                if (bodyEl) {
                    bodyEl.classList.remove('overflow-hidden');
                }
                state.currentProductDetail = null;
            }

            function adjustProductDetailQuantity(delta) {
                if (!productDetailQuantityInput) return;
                const current = parseInt(productDetailQuantityInput.value, 10) || 1;
                const nextValue = Math.max(1, current + delta);
                productDetailQuantityInput.value = nextValue;
            }

            function handleProductCardInteraction(event) {
                const card = event.target.closest('.product-card');
                if (!card) {
                    return;
                }
                if (event.target.closest('.btn-proponer-canje') || event.target.closest('.btn-add-to-cart')) {
                    return;
                }
                const productId = card.dataset.productId;
                if (!productId) return;
                const product = state.allProducts.find(item => item.id === productId);
                if (product) {
                    openProductDetail(product);
                }
            }

            /**
             * Normaliza un documento de producto proveniente de Firestore.
             */
            function mapProductDoc(docSnap) {
                const data = docSnap.data();
                if (!data) return null;

                const createdAt = data.createdAt && typeof data.createdAt.toMillis === 'function' ? data.createdAt.toMillis() : 0;
                return {
                    id: docSnap.id,
                    name: data.name || 'Art√≠culo sin t√≠tulo',
                    wants: data.wants || '',
                    value: Number(data.value) || 0,
                    description: data.description || '',
                    categoryId: data.categoryId || 'otros',
                    imageUrl: data.imageUrl || (Array.isArray(data.imageUrls) && data.imageUrls.length > 0 ? data.imageUrls[0] : DEFAULT_PRODUCT_IMAGE),
                    imageUrls: Array.isArray(data.imageUrls) ? data.imageUrls : (data.imageUrl ? [data.imageUrl] : []),
                    imagePaths: Array.isArray(data.imagePaths) ? data.imagePaths : [],
                    ownerId: data.ownerId || '',
                    ownerName: data.ownerName || '',
                    ownerEmail: data.ownerEmail || '',
                    createdAt,
                    updatedAt: data.updatedAt && typeof data.updatedAt.toMillis === 'function' ? data.updatedAt.toMillis() : createdAt,
                };
            }

            /**
             * Carga todos los productos publicados en Firestore.
             */
            async function loadAllProducts() {
                state.isLoadingProducts = true;
                renderProducts();
                renderMostViewedProducts();
                try {
                    const snapshot = await getDocs(collection(db, 'items'));
                    const products = [];
                    snapshot.forEach(docSnap => {
                        const mapped = mapProductDoc(docSnap);
                        if (mapped) {
                            products.push(mapped);
                        }
                    });
                    products.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    state.allProducts = products;
                    const primaryUrls = products.map(product => product.imageUrl);
                    const galleryUrls = products.reduce((acc, product) => {
                        if (Array.isArray(product.imageUrls)) {
                            acc.push(...product.imageUrls);
                        }
                        return acc;
                    }, []);
                    await preloadImages([...primaryUrls, ...galleryUrls], { highPriorityCount: GRID_HIGH_PRIORITY_COUNT });
                } catch (error) {
                    console.error('Error al cargar los productos:', error);
                } finally {
                    state.isLoadingProducts = false;
                    renderProducts();
                    renderMostViewedProducts();
                    syncCartWithProducts();
                }
            }

            /**
             * Carga los art√≠culos pertenecientes al usuario actual.
             */
            async function loadUserItems(uid) {
                if (!uid) {
                    state.currentUser.items = [];
                    misArticulosCount.textContent = 0;
                    renderMyItems();
                    return;
                }
                state.currentUser.items = null;
                renderMyItems();

                try {
                    const itemsQuery = query(collection(db, 'items'), where('ownerId', '==', uid));
                    const snapshot = await getDocs(itemsQuery);
                    const items = [];
                    snapshot.forEach(docSnap => {
                        const mapped = mapProductDoc(docSnap);
                        if (mapped) {
                            items.push(mapped);
                        }
                    });
                    items.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    state.currentUser.items = items;
                    state.currentUser.stats = state.currentUser.stats || { listedCount: 0, completedTrades: 0 };
                    state.currentUser.stats.listedCount = items.length;
                    misArticulosCount.textContent = items.length;
                    renderMyItems();
                } catch (error) {
                    console.error('Error al cargar los art√≠culos del usuario:', error);
                    misArticulosCount.textContent = (state.currentUser.items || []).length;
                }
            }

            /**
             * Carga las ofertas de canje recibidas por el usuario actual.
             */
            async function loadReceivedOffers(uid) {
                if (!uid) {
                    state.receivedOffers = [];
                    ofertasCount.textContent = 0;
                    renderReceivedOffers();
                    return;
                }

                state.receivedOffers = null;
                renderReceivedOffers();

                try {
                    const offersQuery = query(
                        collection(db, 'offers'), 
                        where('targetOwnerId', '==', uid),
                        where('status', '==', 'pending')
                    );

                    const snapshot = await getDocs(offersQuery);
                    const offers = [];

                    snapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        
                        // Calculamos los valores para renderizar f√°cilmente
                        const totalOfferedValue = data.offeredItems.reduce((sum, item) => sum + item.value, 0) + data.additionalCop;
                        const yourValue = data.targetItem.value;

                        offers.push({
                            id: docSnap.id,
                            fromUser: {
                                name: data.proposerName,
                                profilePic: data.proposerProfilePic,
                            },
                            forYourItem: data.targetItem,
                            theirItems: data.offeredItems,
                            additionalCop: data.additionalCop,
                            totalOfferedValue: totalOfferedValue,
                            difference: totalOfferedValue - yourValue
                        });
                    });
                    
                    offers.sort((a, b) => b.createdAt - a.createdAt); // Ordenar por fecha si es necesario
                    state.receivedOffers = offers;
                    ofertasCount.textContent = offers.length;
                    renderReceivedOffers();
                    
                } catch (error) {
                    console.error("Error al cargar ofertas recibidas:", error);
                    state.receivedOffers = [];
                    ofertasCount.textContent = 0;
                    renderReceivedOffers();
                }
            }
            
            /**
             * Crea o actualiza el documento de perfil del usuario autenticado y devuelve los datos consolidados.
             */
            async function ensureUserProfile(user, overrides = {}) {
                if (!user || !user.uid) return null;

                const userDocRef = doc(db, 'users', user.uid);
                const snapshot = await getDoc(userDocRef);
                const existingData = snapshot.exists() ? snapshot.data() : {};
                const hasStats = existingData && typeof existingData.stats === 'object';

                const finalStats = overrides.stats || (hasStats ? existingData.stats : {
                    listedCount: 0,
                    completedTrades: 0,
                });

                const payload = {
                    name: overrides.name ?? existingData.name ?? user.displayName ?? 'Usuario',
                    email: overrides.email ?? existingData.email ?? user.email ?? '',
                    address: overrides.address ?? existingData.address ?? '',
                    doc: overrides.doc ?? existingData.doc ?? '',
                    profilePic: overrides.profilePic ?? existingData.profilePic ?? user.photoURL ?? DEFAULT_PROFILE_PIC,
                    profilePicPath: overrides.profilePicPath ?? existingData.profilePicPath ?? '',
                    role: overrides.role ?? existingData.role ?? 'user',
                    updatedAt: serverTimestamp(),
                };

                if (!snapshot.exists()) {
                    payload.createdAt = serverTimestamp();
                    payload.stats = finalStats;
                } else if (!hasStats || overrides.stats) {
                    payload.stats = finalStats;
                }

                await setDoc(userDocRef, payload, { merge: true });

                return {
                    uid: user.uid,
                    name: payload.name,
                    email: payload.email,
                    address: payload.address,
                    doc: payload.doc,
                    profilePic: payload.profilePic,
                    profilePicPath: payload.profilePicPath,
                    role: payload.role,
                    stats: finalStats,
                };
            }

            /**
             * Garantiza que exista un documento de perfil para el usuario autenticado.
             */
            async function hydrateCurrentUser(user) {
                if (!user) return;

                try {
                    const profile = await ensureUserProfile(user);
                    if (!profile) return;

                    state.currentUser = {
                        uid: user.uid,
                        name: profile.name || user.displayName || 'Usuario',
                        email: profile.email || user.email || '',
                        address: profile.address || '',
                        doc: profile.doc || '',
                        profilePic: profile.profilePic || user.photoURL || DEFAULT_PROFILE_PIC,
                        profilePicPath: profile.profilePicPath || '',
                        items: [],
                        role: profile.role || 'user',
                        stats: profile.stats || {
                            listedCount: 0,
                            completedTrades: 0,
                        },
                    };

                    state.isAdmin = (state.currentUser.role === 'admin') || ((state.currentUser.email || '').toLowerCase() === 'admin@canje.app');
                } catch (error) {
                    console.error('Error al obtener el perfil del usuario:', error);
                }
            }

            /**
             * Elimina un art√≠culo del usuario actual, incluyendo sus archivos en Storage.
             */
            async function deleteUserItem(itemId) {
                if (!itemId) return;

                try {
                    const productRef = doc(db, 'items', itemId);
                    const productSnapshot = await getDoc(productRef);
                    if (productSnapshot.exists()) {
                        const productData = productSnapshot.data();
                        if (productData.ownerId && productData.ownerId !== state.currentUser.uid) {
                            console.warn('No puedes eliminar art√≠culos de otros usuarios.');
                            return;
                        }

                        let statsDecremented = false;
                        await deleteDoc(productRef);

                        try {
                            await deleteDoc(doc(db, 'users', state.currentUser.uid, 'items', itemId));
                        } catch (userItemDeleteError) {
                            console.warn('No se pudo eliminar el art√≠culo de la colecci√≥n del usuario:', userItemDeleteError);
                        }

                        try {
                            await setDoc(doc(db, 'users', state.currentUser.uid), {
                                'stats.listedCount': increment(-1),
                                updatedAt: serverTimestamp(),
                            }, { merge: true });
                            statsDecremented = true;
                        } catch (statsError) {
                            console.warn('No se pudo actualizar el contador de publicaciones del usuario:', statsError);
                        }

                        const imagePaths = Array.isArray(productData.imagePaths) ? productData.imagePaths : [];
                        if (imagePaths.length > 0) {
                            await Promise.allSettled(imagePaths.map(path => {
                                try {
                                    const fileRef = storageRef(storage, path);
                                    return deleteObject(fileRef);
                                } catch (storageError) {
                                    console.error('Error al preparar la eliminaci√≥n de una imagen:', storageError);
                                    return Promise.resolve();
                                }
                            }));
                        }

                        if (statsDecremented) {
                            state.currentUser.stats = state.currentUser.stats || { listedCount: 0, completedTrades: 0 };
                            state.currentUser.stats.listedCount = Math.max(0, (state.currentUser.stats.listedCount || 1) - 1);
                        }
                    }
                } catch (error) {
                    console.error('Error al eliminar el art√≠culo:', error);
                }

                state.currentUser.items = (state.currentUser.items || []).filter(item => item.id !== itemId);
                state.allProducts = state.allProducts.filter(item => item.id !== itemId);
                renderMyItems();
                renderProducts();
                renderMostViewedProducts();
                misArticulosCount.textContent = (state.currentUser.items || []).length;
            }

            /**
             * Traduce c√≥digos de error de Firebase Auth a mensajes legibles.
             */
            function getAuthErrorMessage(error) {
                if (!error) return 'Ocurri√≥ un error inesperado. Intenta nuevamente.';
                const errorCode = error.code || '';
                const messages = {
                    'auth/invalid-email': 'El correo electr√≥nico no es v√°lido.',
                    'auth/user-disabled': 'La cuenta ha sido deshabilitada.',
                    'auth/user-not-found': 'No encontramos una cuenta con este correo.',
                    'auth/wrong-password': 'La contrase√±a es incorrecta.',
                    'auth/email-already-in-use': 'Este correo ya est√° registrado.',
                    'auth/weak-password': 'La contrase√±a debe tener al menos 6 caracteres.',
                    'auth/too-many-requests': 'Demasiados intentos. Intenta m√°s tarde.',
                };
                return messages[errorCode] || error.message || 'Ocurri√≥ un error inesperado. Intenta nuevamente.';
            }
            
            /**
             * Previsualiza la imagen de perfil al seleccionarla.
             */
            function handleProfilePicUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        profilePicPreview.src = e.target.result;
                        // state.currentUser.profilePic se actualiza al registrarse
                    };
                    reader.readAsDataURL(file);
                    state.profilePicFile = file;
                } else {
                    state.profilePicFile = null;
                }
            }

            // --- NUEVAS FUNCIONES ---

            /**
             * Abre el men√∫ lateral m√≥vil.
             */
            function openMobileMenu() {
                mobileMenuPanel.classList.remove('-translate-x-full');
                mobileMenuBackdrop.classList.remove('hidden');
            }
            function openTerminosModal(userName, itemName, itemImage, offerId) {
                if (!offerId) {
                    console.error("Se intent√≥ abrir el modal de t√©rminos sin un ID de oferta.");
                    return;
                }
                state.activeOfferIdForChat = offerId;

                // Guardamos temporalmente los datos para abrir el chat despu√©s
                state.tempChatData = {
                    otherUserName: userName,
                    itemName: itemName,
                    itemImage: itemImage
                };

                modalTerminos.classList.remove('hidden');
                modalTerminos.classList.add('open');
            }

            function closeTerminosModal() {
                modalTerminos.classList.add('hidden');
                modalTerminos.classList.remove('open');
                if (checkboxTerminos) checkboxTerminos.checked = false;
                if (btnContinuarChat) btnContinuarChat.disabled = true;
            }

            /**
             * Cierra el men√∫ lateral m√≥vil.
             */
            function closeMobileMenu() {
                mobileMenuPanel.classList.add('-translate-x-full');
                mobileMenuBackdrop.classList.add('hidden');
            }
            
            /**
             * Carga la lista de categor√≠as en la secci√≥n Explorar. (MODIFICADO)
             */
            function populateCategoryList() {
                if (!categoryListContainer) return;
                categoryListContainer.innerHTML = '';
                categories.forEach(cat => {
                    const catHtml = `
                        <a href="#" class="flex flex-col items-center flex-shrink-0 w-24 space-y-2 group category-link" data-category-id="${cat.id}">
                            <div class="flex items-center justify-center w-16 h-16 bg-white border border-gray-200 rounded-full shadow-sm group-hover:bg-brand-light group-hover:border-brand category-item-icon">
                                <i data-lucide="${cat.icon}" class="w-8 h-8 text-gray-600 group-hover:text-brand-dark"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700">${cat.name}</span>
                        </a>
                    `;
                    categoryListContainer.insertAdjacentHTML('beforeend', catHtml);
                });

                // A√±adir listeners para rastrear vistas
                categoryListContainer.querySelectorAll('.category-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        logCategoryView(e.currentTarget.dataset.categoryId);
                    });
                });

                lucide.createIcons(); // Renderizar nuevos iconos
            }

            /**
             * Carga las categor√≠as en el <select> del formulario Vender.
             */
            function populateCategorySelect() {
                if (!categorySelect) return;
                categorySelect.innerHTML = '<option value="">Selecciona una categor√≠a</option>';
                categories.forEach(cat => {
                    const optionHtml = `<option value="${cat.id}">${cat.name}</option>`;
                    categorySelect.insertAdjacentHTML('beforeend', optionHtml);
                });
            }

            
            /**
             * Abre el modal de edici√≥n de tiempo (Admin).
             */
            function openTimerModal(slide) {
                if (!slide) return;

                state.editingTimerSlide = slide;
                const currentEndTime = slide.dataset.endTime;
                // Formatear para datetime-local input (requiere YYYY-MM-DDTHH:MM)
                try {
                    const inputDateTime = new Date(currentEndTime).toISOString().slice(0, 16);
                    document.getElementById('timer-datetime').value = inputDateTime;
                } catch (err) {
                    console.error("Fecha inv√°lida:", currentEndTime);
                }
                
                modalEditTimer.classList.remove('hidden');
                modalEditTimer.classList.add('open');
            }

            /**
             * Cierra el modal de edici√≥n de tiempo.
             */
            function closeTimerModal() {
                modalEditTimer.classList.add('hidden');
                modalEditTimer.classList.remove('open');
                state.editingTimerSlide = null;
            }
            
            // --- NUEVAS FUNCIONES (Renderizado Din√°mico) ---

            /**
             * Registra la vista de una categor√≠a y actualiza el carrusel de "m√°s vistos".
             */
            function logCategoryView(categoryId) {
                if (!categoryId) return;
                state.viewedCategoryHistory[categoryId] = (state.viewedCategoryHistory[categoryId] || 0) + 1;
                // console.log("Category views:", state.viewedCategoryHistory); // Para debugging
                
                // Actualizar la secci√≥n de "m√°s vistos" en tiempo real
                renderMostViewedProducts(); 
            }

            /**
             * Renderiza el carrusel de "Productos m√°s vistos".
             */
            function renderMostViewedProducts() {
                mostViewedContainer.innerHTML = '';
                if (state.isLoadingProducts) {
                    const skeletonCount = 4;
                    const skeletonCard = `
                        <div class="popular-card flex-shrink-0 overflow-hidden bg-white border border-gray-200 rounded-lg shadow-sm">
                            <div class="w-full h-40 skeleton"></div>
                            <div class="p-4 space-y-3">
                                <div class="w-3/4 h-4 skeleton rounded"></div>
                                <div class="w-2/3 h-3 skeleton rounded"></div>
                                <div class="w-1/2 h-3 skeleton rounded"></div>
                                <div class="space-y-2 pt-1">
                                    <div class="w-full h-9 skeleton rounded"></div>
                                    <div class="w-full h-9 skeleton rounded"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    mostViewedContainer.innerHTML = Array.from({ length: skeletonCount }, () => skeletonCard).join('');
                    return;
                }

                let productsToShow = [];
                let title = "Populares"; // T√≠tulo por defecto

                // 1. Encontrar la categor√≠a m√°s vista
                const viewedCategories = Object.entries(state.viewedCategoryHistory); // [['juegos', 2], ['deportes', 1]]
                
                if (viewedCategories.length > 0) {
                    // Ordenar por vistas, descendente
                    viewedCategories.sort((a, b) => b[1] - a[1]);
                    const mostViewedCategoryId = viewedCategories[0][0];
                    const categoryObj = categories.find(c => c.id === mostViewedCategoryId);
                    
                    if (categoryObj) {
                        title = `Relacionados con ${categoryObj.name}`;
                    }

                    // 2. Filtrar productos por esa categor√≠a
                    productsToShow = state.allProducts.filter(p => p.categoryId === mostViewedCategoryId);
                    
                    // 3. (Opcional) Si el filtro no da resultados, mostrar populares
                    if (productsToShow.length === 0) {
                        productsToShow = [...state.allProducts].sort(() => 0.5 - Math.random()).slice(0, 10); // 10 aleatorios
                        title = "Populares";
                    }

                } else {
                    // 4. Sin historial de vistas, mostrar "Populares" (p.ej. los 10 primeros)
                    productsToShow = state.allProducts.slice(0, 10);
                }

                // 5. Actualizar el t√≠tulo de la secci√≥n
                const titleElement = mostViewedContainer.previousElementSibling; // El H3
                if (titleElement && titleElement.tagName === 'H3') {
                    titleElement.textContent = title;
                }

                // 6. Renderizar las tarjetas del carrusel
                if (productsToShow.length === 0) {
                    mostViewedContainer.innerHTML = '<p class="text-gray-500 pl-2">No hay art√≠culos en esta secci√≥n.</p>';
                    return;
                }

                const cardsHtml = productsToShow.map((product, index) => buildPopularCard(product, index)).join('');
                mostViewedContainer.innerHTML = cardsHtml;

                // 7. Re-asignar listeners a los *nuevos* botones creados
                assignProponerCanjeListeners();
                assignAddToCartListeners();
                registerLazyImages(mostViewedContainer);
            }

            /**
             * Renderiza la grilla de productos en "Explorar".
             */
            function renderProducts() {
                explorarProductGrid.innerHTML = ''; // Limpiar grilla
                if (state.isLoadingProducts) {
                    const skeletonCount = 8;
                    const skeletonCard = `
                        <div class="overflow-hidden bg-white border border-gray-200 rounded-lg shadow-sm">
                            <div class="w-full h-40 skeleton"></div>
                            <div class="p-4 space-y-3">
                                <div class="w-3/4 h-4 skeleton rounded"></div>
                                <div class="w-2/3 h-3 skeleton rounded"></div>
                                <div class="w-1/2 h-3 skeleton rounded"></div>
                                <div class="space-y-2 pt-1">
                                    <div class="w-full h-9 skeleton rounded"></div>
                                    <div class="w-full h-9 skeleton rounded"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    explorarProductGrid.innerHTML = Array.from({ length: skeletonCount }, () => skeletonCard).join('');
                    return;
                }

                if (state.allProducts.length === 0) {
                    explorarProductGrid.innerHTML = '<p class="text-gray-500 col-span-full">No hay art√≠culos publicados por el momento.</p>';
                    return;
                }

                const productsHtml = state.allProducts.map((product, index) => buildProductCard(product, index)).join('');
                explorarProductGrid.innerHTML = productsHtml;

                // Volver a asignar listeners a los nuevos botones
                assignProponerCanjeListeners();
                assignAddToCartListeners();
                registerLazyImages(explorarProductGrid);
            }

            /**
             * Renderiza la lista de "Mis Art√≠culos" en "Mis Canjes".
             */
            function renderMyItems() {
                tabMisArticulos.innerHTML = ''; // Limpiar
                if (state.currentUser.items === null) {
                    const skeletonCount = 2;
                    const skeletonHtml = `
                        <div class="flex items-center p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                            <div class="w-16 h-16 rounded-lg skeleton"></div>
                            <div class="ml-4 flex-1 min-w-0 space-y-2">
                                <div class="w-3/4 h-4 skeleton rounded"></div>
                                <div class="w-1/2 h-3 skeleton rounded"></div>
                                <div class="w-2/3 h-3 skeleton rounded"></div>
                            </div>
                        </div>
                    `;
                    tabMisArticulos.innerHTML = Array.from({ length: skeletonCount }, () => skeletonHtml).join('');
                    return;
                }
                if (!state.currentUser.items || state.currentUser.items.length === 0) {
                    tabMisArticulos.innerHTML = '<p class="text-gray-500">No has publicado ning√∫n art√≠culo.</p>';
                    return;
                }

                state.currentUser.items.forEach(item => {
                    const itemImage = createImageLoaderHTML({
                        src: item.imageUrl,
                        alt: item.name,
                        wrapperClass: 'w-16 h-16 rounded-lg flex-shrink-0',
                    });
                    const itemHtml = `
                        <div class="flex items-center p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                            ${itemImage}
                            <div class="ml-4 flex-1 min-w-0">
                                <h4 class="font-semibold text-gray-900 truncate">${item.name}</h4>
                                <p class="text-sm text-gray-500">Valor: <span class="text-green-600">${formatCOP(item.value)}</span></p>
                                <p class="text-sm text-gray-500 truncate">Buscas: ${item.wants || 'No especificado'}</p>
                            </div>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 ml-2">
                                <button class="p-2 text-gray-500 rounded-lg hover:bg-gray-100 hover:text-brand" title="Editar">
                                    <i data-lucide="pencil" class="w-5 h-5"></i>
                                </button>
                                <button class="p-2 text-gray-500 rounded-lg hover:bg-gray-100 hover:text-red-600 btn-eliminar-item" data-item-id="${item.id}" title="Eliminar">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    tabMisArticulos.insertAdjacentHTML('beforeend', itemHtml);
                });
                lucide.createIcons();
                registerLazyImages(tabMisArticulos);
            }

            /**
             * Renderiza las "Ofertas Recibidas" en "Mis Canjes".
             */
            function renderReceivedOffers() {
                tabOfertas.innerHTML = ''; // Limpiar

                if (state.receivedOffers === null) {
                    const skeletonCount = 1;
                    const skeletonHtml = `
                        <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm space-y-4">
                            <div class="flex justify-between items-center">
                                <div class="w-1/2 h-4 skeleton rounded"></div>
                                <div class="w-10 h-10 skeleton rounded-full"></div>
                            </div>
                            <div class="w-full h-24 skeleton rounded-lg"></div>
                            <div class="w-full h-10 skeleton rounded-lg"></div>
                        </div>
                    `;
                    tabOfertas.innerHTML = Array.from({ length: skeletonCount }, () => skeletonHtml).join('');
                    return;
                }

                if (!state.receivedOffers || state.receivedOffers.length === 0) {
                    tabOfertas.innerHTML = '<p class="text-gray-500">No tienes ofertas recibidas.</p>';
                    return;
                }
                
                state.receivedOffers.forEach(offer => {
                    const fromUserAvatar = createImageLoaderHTML({
                        src: offer.fromUser.profilePic,
                        alt: offer.fromUser.name,
                        wrapperClass: 'w-10 h-10 rounded-full',
                    });

                    const offerHtml = `
                        <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                            <div class="flex items-center justify-between pb-3 border-b border-gray-200">
                                <div>
                                    <p class="text-sm text-gray-500">Oferta de: <span class="font-medium text-gray-900">${offer.fromUser.name}</span></p>
                                    <p class="text-sm text-gray-500">Quiere tu: <span class="font-medium text-brand-dark">${offer.forYourItem.name}</span></p>
                                </div>
                                ${fromUserAvatar}
                            </div>

                            <div class="flex flex-col md:flex-row items-center justify-between mt-4">
                                <div class="w-full md:w-2/5">
                                    <span class="text-sm font-semibold text-gray-700">Te ofrecen:</span>
                                    <div class="mt-2 space-y-2">
                                        ${offer.theirItems.map(item => `
                                            <div class="flex items-center p-2 bg-gray-50 rounded-md">
                                                ${createImageLoaderHTML({
                                                    src: item.imageUrl,
                                                    alt: item.name,
                                                    wrapperClass: 'w-10 h-10 rounded-md flex-shrink-0',
                                                })}
                                                <div class="ml-2 flex-1 min-w-0">
                                                    <p class="text-sm font-medium truncate">${item.name}</p>
                                                    <p class="text-sm text-green-600">${formatCOP(item.value)}</p>
                                                </div>
                                            </div>
                                        `).join('')}
                                        
                                        ${offer.additionalCop > 0 ? `
                                            <div class="flex items-center p-2 bg-gray-50 rounded-md">
                                                <div class="w-10 h-10 rounded-md flex-shrink-0 bg-green-100 flex items-center justify-center">
                                                    <i data-lucide="banknote" class="w-6 h-6 text-green-600"></i>
                                                </div>
                                                <div class="ml-2 flex-1 min-w-0">
                                                    <p class="text-sm font-medium truncate">Dinero Adicional</p>
                                                    <p class="text-sm text-green-600">${formatCOP(offer.additionalCop)}</p>
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                
                                <div class="text-gray-400 my-4 md:my-0">
                                    <i data-lucide="arrow-right-left" class="w-6 h-6"></i>
                                </div>

                                <div class="w-full md:w-2/5">
                                    <span class="text-sm font-semibold text-gray-700">A cambio de:</span>
                                    <div class="mt-2 space-y-2">
                                        <div class="flex items-center p-2 bg-gray-50 rounded-md">
                                            ${createImageLoaderHTML({
                                                src: offer.forYourItem.imageUrl,
                                                alt: offer.forYourItem.name,
                                                wrapperClass: 'w-10 h-10 rounded-md flex-shrink-0',
                                            })}
                                            <div class="ml-2 flex-1 min-w-0">
                                                <p class="text-sm font-medium truncate">${offer.forYourItem.name}</p>
                                                <p class="text-sm text-gray-700">${formatCOP(offer.forYourItem.value)}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="p-4 mt-4 bg-gray-50 border border-gray-200 rounded-lg">
                                <h4 class="font-medium text-center text-gray-800">Resumen de la Oferta</h4>
                                <div class="mt-2 space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Valor total ofrecido:</span>
                                        <span class="font-medium text-green-600">${formatCOP(offer.totalOfferedValue)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Tu valor:</span>
                                        <span class="font-medium text-gray-800">${formatCOP(offer.forYourItem.value)}</span>
                                    </div>
                                    <div class="flex justify-between pt-2 mt-2 border-t">
                                        <span class="font-semibold">Diferencia (a tu favor):</span>
                                        <span class="font-semibold ${offer.difference >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCOP(offer.difference)}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="flex flex-col mt-4 space-y-2 md:flex-row md:space-y-0 md:space-x-3">
                                <button class="btn-aceptar-canje flex-1 px-4 py-2 text-sm font-medium text-white transition-colors bg-green-600 rounded-lg hover:bg-green-700"
                                    data-offer-id="${offer.id}"
                                    data-user-name="${offer.fromUser.name}"
                                    data-item-name="${offer.forYourItem.name}"
                                    data-item-image="${offer.forYourItem.imageUrl}">
                                    Aceptar Canje
                                </button>
                                <button class="flex-1 btn-negociar px-4 py-2 text-sm font-medium text-white transition-colors bg-brand rounded-lg hover:bg-brand-dark">Negociar</button>
                                <button class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 transition-colors bg-gray-100 rounded-lg hover:bg-gray-200">Rechazar</button>
                            </div>

                            <div class="hidden p-4 mt-4 bg-gray-50 border border-gray-200 rounded-lg negotiation-form">
                                <h5 class="font-semibold">Negociar Canje</h5>
                                <p class="text-sm text-gray-600">Puedes proponer un art√≠culo diferente o pedir una diferencia en dinero.</p>
                                <div class="mt-3">
                                    <label for="contra-oferta-cop-${offer.id}" class="block text-sm font-medium text-gray-700">Pedir diferencia (COP):</label>
                                    <input type="number" id="contra-oferta-cop-${offer.id}" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:border-brand focus:ring-brand" placeholder="Ej: 50000">
                                </div>
                                <div class="mt-3">
                                    <button class="px-4 py-2 text-sm font-medium text-white bg-brand rounded-lg hover:bg-brand-dark">Enviar Contraoferta</button>
                                </div>
                            </div>
                        </div>
                    `;
                    tabOfertas.insertAdjacentHTML('beforeend', offerHtml);
                });
                lucide.createIcons();
                registerLazyImages(tabOfertas);
            }


            // --- NUEVAS FUNCIONES (Vender Fotos) ---

            /**
             * Muestra un mensaje de error en el formulario de fotos.
             */
            function showPhotoError(message) {
                photoErrorMsg.textContent = message;
                photoErrorMsg.classList.remove('hidden');
                // Ocultar el error despu√©s de 3 segundos
                setTimeout(() => {
                    photoErrorMsg.classList.add('hidden');
                }, 3000);
            }

            /**
             * Muestra un mensaje de error en el formulario de publicaci√≥n.
             */
            function showPublicarError(message, btn) {
                publicarErrorMsg.textContent = message;
                publicarErrorMsg.classList.remove('hidden');
                btn.textContent = 'Error al publicar';
                btn.classList.add('bg-red-600', 'hover:bg-red-700');

                setTimeout(() => {
                    publicarErrorMsg.classList.add('hidden');
                    btn.textContent = 'Publicar Art√≠culo';
                    btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    btn.disabled = false;
                }, 3000);
            }

            /**
             * Maneja los archivos seleccionados (click o drop) y los a√±ade al estado.
             */
            function handleFiles(files) {
                const newFiles = Array.from(files);
                let addedCount = 0;
                photoErrorMsg.classList.add('hidden'); // Limpiar errores antiguos

                if (state.productFiles.length + newFiles.length > 10) {
                    showPhotoError(`L√≠mite de 10 fotos. Solo puedes a√±adir ${10 - state.productFiles.length} m√°s.`);
                }

                for (const file of newFiles) {
                    if (state.productFiles.length >= 10) {
                        break; // L√≠mite alcanzado
                    }
                    if (file.type.startsWith('image/')) {
                        // Evitar duplicados (simple check por nombre y tama√±o)
                        const isDuplicate = state.productFiles.some(
                            f => f.file.name === file.name && f.file.size === file.size
                        );
                        if (!isDuplicate) {
                            // Leer el archivo para obtener DataURL para la vista previa
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                // Almacenar el objeto File Y su DataURL
                                state.productFiles.push({
                                    file: file,
                                    dataURL: e.target.result
                                });
                                addedCount++;
                                // Actualizar la vista previa *despu√©s* de que se carga el archivo
                                // Se llama aqu√≠ para asegurar que dataURL est√© listo
                                updatePhotoPreview(); 
                            };
                            reader.readAsDataURL(file);
                        }
                    } else {
                        showPhotoError(`Archivo "${file.name}" no es una imagen y fue omitido.`);
                    }
                }
            }

            /**
             * Actualiza el DOM para mostrar las vistas previas de las fotos.
             */
            function updatePhotoPreview() {
                photoPreviewContainer.innerHTML = ''; // Limpiar vistas previas

                // Actualizar el cuadro de "subir"
                if (state.productFiles.length === 0) {
                    photoUploadText.classList.remove('hidden');
                    photoUploadSummary.classList.add('hidden');
                } else {
                    photoUploadText.classList.add('hidden');
                    photoUploadSummary.classList.remove('hidden');
                    photoCount.textContent = state.productFiles.length;
                }

                // Renderizar cada vista previa desde el estado
                state.productFiles.forEach((fileData, index) => {
                    const previewHtml = `
                        <div class="photo-preview-item">
                            <img src="${fileData.dataURL}" alt="${fileData.file.name}" class="absolute top-0 left-0 w-full h-full object-cover">
                            <button type="button" class="btn-remove-photo" data-index="${index}" title="Quitar imagen">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `;
                    photoPreviewContainer.insertAdjacentHTML('beforeend', previewHtml);
                });
                
                // Esta llamada es crucial despu√©s de a√±adir iconos din√°micamente
                lucide.createIcons();   
                
                // Limpiar el valor del input para permitir volver a subir el mismo archivo si se borra
                productPhotoInput.value = null;
            }


            // --- L√ìGICA DE CARRUSEL Y TEMPORIZADOR (MODIFICADA PARA DINAMISMO) ---

            /**
             * Carga los banners desde Firestore y los renderiza en el carrusel.
             */
            async function loadAndRenderBanners() {
                state.isLoadingBanners = true;
                state.banners = [];
                carouselSlider.innerHTML = `<div class="w-full h-full skeleton"></div>`;

                try {
                    const bannersQuery = query(collection(db, "banners"), orderBy("createdAt", "desc"));
                    const snapshot = await getDocs(bannersQuery);

                    if (snapshot.empty) {
                        carouselSlider.innerHTML = '';
                        carouselSlider.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-100 text-gray-500">No hay banners para mostrar.</div>`;
                        totalSlides = 0;
                        updateCarouselMeta();
                        return;
                    }

                    const banners = [];
                    snapshot.forEach(docSnap => {
                        const banner = docSnap.data();
                        const endTime = banner.endTime && banner.endTime.toDate ? banner.endTime.toDate().toISOString() : '';
                        banners.push({
                            id: docSnap.id,
                            title: banner.title || '',
                            subtitle: banner.subtitle || '',
                            endTime,
                            imageUrl: banner.imageUrl || '',
                            imagePath: banner.imagePath || '',
                        });
                    });

                    state.banners = banners;
                    await preloadImages(banners.map((banner) => banner.imageUrl), { highPriorityCount: Math.min(2, banners.length) });

                    const slidesHtml = banners.map((banner, index) => buildBannerSlide(banner, index)).join('');
                    carouselSlider.innerHTML = slidesHtml;
                    registerLazyImages(carouselSlider);

                    resetCarousel();

                } catch (error) {
                    console.error("Error cargando los banners:", error);
                    carouselSlider.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-100 text-red-500">Error al cargar banners.</div>`;
                    updateCarouselMeta();
                } finally {
                    state.isLoadingBanners = false;
                }
            }

            /**
             * Reinicia el carrusel despu√©s de cargar contenido din√°mico.
             */
            function stopCarouselTimerInterval() {
                if (carouselTimerInterval) {
                    clearInterval(carouselTimerInterval);
                    carouselTimerInterval = null;
                }
            }

            function resetTimerElement(timerEl) {
                if (!timerEl) return;
                timerEl.textContent = '';
                timerEl.classList.add('hidden');
                timerEl.classList.remove('is-finished');
                timerEl.removeAttribute('aria-label');
            }

            function resetAllCarouselTimers() {
                if (!carouselSlider) return;
                const timers = carouselSlider.querySelectorAll('[data-role="carousel-timer"]');
                timers.forEach(resetTimerElement);
            }

            function clearCarouselTimer() {
                stopCarouselTimerInterval();
                if (activeTimerEl) {
                    resetTimerElement(activeTimerEl);
                    activeTimerEl = null;
                }
            }

            function getActiveSlideTimerEl() {
                if (!carouselSlider) return null;
                const slides = carouselSlider.querySelectorAll('.carousel-slide');
                if (!slides.length) return null;
                const slide = slides[currentSlide] || null;
                return slide ? slide.querySelector('[data-role="carousel-timer"]') : null;
            }

            function startActiveBannerTimer(endTime) {
                const timerEl = getActiveSlideTimerEl();

                if (!timerEl) {
                    clearCarouselTimer();
                    return;
                }

                stopCarouselTimerInterval();

                if (activeTimerEl && activeTimerEl !== timerEl) {
                    resetTimerElement(activeTimerEl);
                }

                const slide = timerEl.closest('.carousel-slide');
                if (slide && endTime) {
                    slide.dataset.endTime = endTime;
                }

                const rawEndTime = endTime || (slide ? slide.dataset.endTime : '');

                if (!rawEndTime) {
                    resetTimerElement(timerEl);
                    activeTimerEl = timerEl;
                    return;
                }

                const target = new Date(rawEndTime).getTime();
                if (Number.isNaN(target)) {
                    resetTimerElement(timerEl);
                    activeTimerEl = timerEl;
                    return;
                }

                activeTimerEl = timerEl;
                timerEl.classList.remove('hidden');

                const formatter = (value) => value.toString().padStart(2, '0');

                const render = () => {
                    if (!activeTimerEl) {
                        stopCarouselTimerInterval();
                        return;
                    }

                    const now = Date.now();
                    const distance = target - now;

                    if (distance <= 0) {
                        stopCarouselTimerInterval();
                        timerEl.classList.add('is-finished');
                        timerEl.innerHTML = `<span class="promo-timer-dot"></span><span>Expirado</span>`;
                        timerEl.setAttribute('aria-label', 'Promoci√≥n expirada');
                        return;
                    }

                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    const segments = [];
                    if (days > 0) {
                        segments.push(`${formatter(days)}d`);
                    }
                    segments.push(`${formatter(hours)}h`);
                    segments.push(`${formatter(minutes)}m`);
                    segments.push(`${formatter(seconds)}s`);

                    timerEl.classList.remove('is-finished');
                    timerEl.innerHTML = `<span class="promo-timer-dot"></span><span class="font-mono">${segments.join(' ¬∑ ')}</span>`;
                    timerEl.setAttribute('aria-label', `Tiempo restante ${segments.join(' ')}`);
                };

                render();
                carouselTimerInterval = setInterval(render, 1000);
            }

            function updateCarouselMeta() {
                if (!carouselMeta) return;

                if (!state.banners || state.banners.length === 0 || totalSlides === 0) {
                    carouselMeta.classList.add('hidden');
                    if (carouselTitleEl) carouselTitleEl.textContent = '';
                    if (carouselSubtitleEl) carouselSubtitleEl.textContent = '';
                    clearCarouselTimer();
                    resetAllCarouselTimers();
                    return;
                }

                if (currentSlide >= totalSlides) {
                    currentSlide = 0;
                }

                const activeBanner = state.banners[currentSlide];
                if (!activeBanner) {
                    carouselMeta.classList.add('hidden');
                    clearCarouselTimer();
                    resetAllCarouselTimers();
                    return;
                }

                carouselMeta.classList.remove('hidden');

                if (carouselTitleEl) {
                    carouselTitleEl.textContent = activeBanner.title || '';
                    carouselTitleEl.classList.toggle('hidden', !activeBanner.title);
                }

                if (carouselSubtitleEl) {
                    carouselSubtitleEl.textContent = activeBanner.subtitle || '';
                    carouselSubtitleEl.classList.toggle('hidden', !activeBanner.subtitle);
                }

                startActiveBannerTimer(activeBanner.endTime);
            }

            function resetCarousel() {
                const slides = carouselSlider ? carouselSlider.querySelectorAll('.carousel-slide') : [];
                totalSlides = slides.length;
                currentSlide = 0;
                updateCarousel();
                startCarouselAutoPlay();
                updateAuthUI(); // Asegura que los botones de admin se muestren/oculten
                lucide.createIcons(); // Vuelve a renderizar los iconos
            }


            function updateCarousel() {
                if (totalSlides > 0) {
                    carouselSlider.style.transform = `translateX(-${currentSlide * 100}%)`;
                }
                updateCarouselMeta();
            }

            function nextSlide() {
                if (totalSlides > 0) {
                    currentSlide = (currentSlide + 1) % totalSlides;
                    updateCarousel();
                }
            }

            function prevSlide() {
                if (totalSlides > 0) {
                    currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
                    updateCarousel();
                }
            }
            
            function startCarouselAutoPlay() {
                if (carouselInterval) clearInterval(carouselInterval);
                if (totalSlides > 1) { // Solo auto-play si hay m√°s de un slide
                    carouselInterval = setInterval(nextSlide, 5000);
                }
            }

            function stopCarouselAutoPlay() {
                clearInterval(carouselInterval);
            }

            // --- EVENT LISTENERS ---

            // Navegaci√≥n principal
            modalTerminos.querySelector('.modal-close-btn').addEventListener('click', closeTerminosModal);
            modalTerminos.querySelector('.modal-backdrop').addEventListener('click', closeTerminosModal);

            checkboxTerminos.addEventListener('change', () => {
                btnContinuarChat.disabled = !checkboxTerminos.checked;
            });

            btnContinuarChat.addEventListener('click', async () => {
                if (checkboxTerminos.checked && state.activeOfferIdForChat) {
                    await acceptOfferAndCreateChat(state.activeOfferIdForChat);
                } else {
                    alert("Por favor, acepta los t√©rminos y condiciones para continuar.");
                }
            });

            if (btnActivarNotificaciones) {
                btnActivarNotificaciones.addEventListener('click', setupPushNotifications);
            }
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = e.currentTarget.dataset.page || DEFAULT_PAGE_ID;
                    if ((pageId === 'page-canjes' || pageId === 'page-vender') && !state.isLoggedIn) {
                        showPage('page-perfil');
                    } else {
                        showPage(pageId);
                    }
                });
            });

            // Detalle de producto - eventos
            if (productDetailCloseBtn) {
                productDetailCloseBtn.addEventListener('click', closeProductDetail);
            }
            if (productDetailProponerBtn) {
                productDetailProponerBtn.addEventListener('click', () => {
                    const dataset = productDetailProponerBtn.dataset;
                    const fallback = state.currentProductDetail || {};
                    closeProductDetail();
                    prepareAndOpenCanjeModal({
                        itemId: dataset.itemId || fallback.id,
                        itemName: dataset.itemName || fallback.name,
                        itemValue: dataset.itemValue || fallback.value,
                        categoryId: dataset.categoryId || fallback.categoryId,
                    });
                });
            }
            if (productDetailQuantityDecrease) {
                productDetailQuantityDecrease.addEventListener('click', () => adjustProductDetailQuantity(-1));
            }
            if (productDetailQuantityIncrease) {
                productDetailQuantityIncrease.addEventListener('click', () => adjustProductDetailQuantity(1));
            }
            if (productDetailQuantityInput) {
                productDetailQuantityInput.addEventListener('change', () => {
                    let parsed = parseInt(productDetailQuantityInput.value, 10);
                    if (!parsed || parsed < 1) {
                        parsed = 1;
                    }
                    productDetailQuantityInput.value = parsed;
                });
            }
            if (productDetailAddToCartBtn) {
                prepareAddToCartButton(productDetailAddToCartBtn);
                productDetailAddToCartBtn.addEventListener('click', () => {
                    const product = state.currentProductDetail;
                    if (!product) {
                        showCartFeedback('Abre un art√≠culo para poder agregarlo al carrito.', 'error');
                        return;
                    }
                    const quantity = productDetailQuantityInput ? clampCartQuantity(productDetailQuantityInput.value) : 1;
                    if (addProductToCart(product, quantity)) {
                        flashAddToCartButtonState(productDetailAddToCartBtn);
                    }
                });
            }
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && productDetailView && !productDetailView.classList.contains('hidden')) {
                    closeProductDetail();
                }
            });

            if (explorarProductGrid) {
                explorarProductGrid.addEventListener('click', handleProductCardInteraction);
            }
            if (mostViewedContainer) {
                mostViewedContainer.addEventListener('click', handleProductCardInteraction);
            }

            if (sidebarCartItemsEl) {
                sidebarCartItemsEl.addEventListener('click', handleCartActionFromClick);
            }
            if (mobileCartItemsEl) {
                mobileCartItemsEl.addEventListener('click', handleCartActionFromClick);
            }
            if (cartPageItemsEl) {
                cartPageItemsEl.addEventListener('click', handleCartActionFromClick);
            }
            if (sidebarCartClearBtn) {
                sidebarCartClearBtn.addEventListener('click', () => clearCart());
            }
            if (mobileCartClearBtn) {
                mobileCartClearBtn.addEventListener('click', () => clearCart());
            }
            if (cartPageClearBtn) {
                cartPageClearBtn.addEventListener('click', () => clearCart());
            }
            
            // Men√∫ M√≥vil
            mobileMenuBtn.addEventListener('click', openMobileMenu);
            mobileMenuBackdrop.addEventListener('click', closeMobileMenu);
            mobileMenuLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = e.currentTarget.dataset.page || DEFAULT_PAGE_ID;
                    if ((pageId === 'page-canjes' || pageId === 'page-vender') && !state.isLoggedIn) {
                        showPage('page-perfil');
                    } else {
                        showPage(pageId);
                    }
                    closeMobileMenu();
                });
            });

            // Modal Admin Timer
            formEditTimer.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!state.editingTimerSlide) return;

                const bannerId = state.editingTimerSlide.dataset.bannerId;
                const newDateTime = document.getElementById('timer-datetime').value;

                if (!bannerId || !newDateTime) return;
                
                try {
                    const bannerRef = doc(db, "banners", bannerId);
                    // Firestore espera un objeto Date de JS para los Timestamps
                    await setDoc(bannerRef, { endTime: new Date(newDateTime) }, { merge: true });

                    // Actualizar el dataset localmente y reiniciar los timers
                    const updatedEndTime = new Date(newDateTime).toISOString();
                    state.editingTimerSlide.dataset.endTime = updatedEndTime;
                    const bannerIndex = state.banners.findIndex(b => b.id === bannerId);
                    if (bannerIndex !== -1) {
                        state.banners[bannerIndex].endTime = updatedEndTime;
                    }
                    updateCarouselMeta();
                    closeTimerModal();

                } catch (error) {
                    console.error("Error actualizando el temporizador del banner:", error);
                    alert("No se pudo actualizar el temporizador.");
                }
            });

            modalEditTimer.querySelector('.modal-backdrop').addEventListener('click', closeTimerModal);
            modalEditTimer.querySelector('.modal-close-btn').addEventListener('click', closeTimerModal);


            // Tabs de Autenticaci√≥n
            authTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.dataset.authTab;
                    authTabContents.forEach(content => content.classList.add('hidden'));
                    authTabs.forEach(t => {
                        t.classList.remove('text-brand', 'border-brand');
                        t.classList.add('text-gray-500', 'border-transparent');
                    });
                    document.getElementById(targetId).classList.remove('hidden');
                    e.currentTarget.classList.add('text-brand', 'border-brand');
                    e.currentTarget.classList.remove('text-gray-500', 'border-transparent');
                });
            });

            // Tabs de "Mis Canjes"
            canjeTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.dataset.tab;
                    canjeTabContents.forEach(content => content.classList.add('hidden'));
                    canjeTabs.forEach(t => {
                        t.classList.remove('text-brand', 'border-brand');
                        t.classList.add('text-gray-500', 'border-transparent');
                    });
                    document.getElementById(targetId).classList.remove('hidden');
                    e.currentTarget.classList.add('text-brand', 'border-brand');
                    e.currentTarget.classList.remove('text-gray-500', 'border-transparent');
                });
            });

            // Barra lateral
            sidebarToggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                mainContentWrapper.classList.toggle('sidebar-collapsed');
            });

            // Input de Foto de Perfil
            profilePicUpload.addEventListener('change', handleProfilePicUpload);


            // --- NUEVOS LISTENERS (Vender Fotos) ---

            // Input de Archivo (Click)
            productPhotoInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            // Drag & Drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                photoUploadLabel.addEventListener(eventName, e => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                photoUploadLabel.addEventListener(eventName, () => {
                    photoUploadLabel.classList.add('border-brand', 'bg-brand-light');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                photoUploadLabel.addEventListener(eventName, () => {
                    photoUploadLabel.classList.remove('border-brand', 'bg-brand-light');
                }, false);
            });

            photoUploadLabel.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            });

            // Delegaci√≥n de eventos para borrar fotos
            photoPreviewContainer.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.btn-remove-photo');
                if (removeBtn) {
                    e.preventDefault();
                    const indexToRemove = parseInt(removeBtn.dataset.index, 10);
                    if (!isNaN(indexToRemove)) {
                        state.productFiles.splice(indexToRemove, 1);
                        updatePhotoPreview();
                    }
                }
            });



            // --- L√ìGICA DE AUTENTICACI√ìN (Firebase) ---

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    state.isLoggedIn = true;
                    await hydrateCurrentUser(user);
                    await Promise.all([
                        loadUserItems(user.uid),
                        loadReceivedOffers(user.uid),
                        loadAndRenderActiveChats(user.uid),
                        loadAllProducts()
                    ]);
                    listenForUnreadMessages(user.uid);
                    updateAuthUI();
                    checkNotificationPermission();

                    const urlParams = new URLSearchParams(window.location.search);
                    const pageFromUrl = urlParams.get('page');
                    const chatIdFromUrl = urlParams.get('chatId');

                    if (pageFromUrl) {
                        if (pageFromUrl === 'page-chat' && chatIdFromUrl) {
                            setTimeout(() => openChatFromId(chatIdFromUrl), 100);
                        } else {
                            showPage(pageFromUrl);
                        }
                        history.replaceState(null, '', window.location.pathname);
                    }
                } else {
                    state.isLoggedIn = false;
                    state.isAdmin = false;
                    state.currentUser = {
                        uid: null,
                        name: '',
                        email: '',
                        address: '',
                        doc: '',
                        profilePic: DEFAULT_PROFILE_PIC,
                        profilePicPath: '',
                        items: [],
                        role: 'user',
                        stats: {
                            listedCount: 0,
                            completedTrades: 0,
                        },
                    };
                    state.profilePicFile = null;
                    updateAuthUI();
                    showPage(DEFAULT_PAGE_ID);
                }
            });

            formLogin.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = formLogin.querySelector('button[type="submit"]');
                const email = document.getElementById('email-login').value.trim().toLowerCase();
                const password = document.getElementById('pass-login').value;

                if (loginErrorMsg) {
                    loginErrorMsg.classList.add('hidden');
                }

                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Ingresando...';
                }

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    formLogin.reset();
                } catch (error) {
                    console.error('Error al iniciar sesi√≥n:', error);
                    if (loginErrorMsg) {
                        loginErrorMsg.textContent = getAuthErrorMessage(error);
                        loginErrorMsg.classList.remove('hidden');
                    }
                } finally {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Entrar';
                    }
                }
            });

            formRegister.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = formRegister.querySelector('button[type="submit"]');

                if (registerErrorMsg) {
                    registerErrorMsg.classList.add('hidden');
                }

                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Creando cuenta...';
                }

                const name = document.getElementById('nombre-reg').value.trim();
                const docNumber = document.getElementById('doc-reg').value.trim();
                const address = document.getElementById('dir-reg').value.trim();
                const email = document.getElementById('email-reg').value.trim().toLowerCase();
                const password = document.getElementById('pass-reg').value;

                let profilePicPath = '';
                let newUserUid = null;
                let newlyCreatedUser = null;

                try {
                    const credential = await createUserWithEmailAndPassword(auth, email, password);
                    const { user } = credential;
                    newUserUid = user.uid;
                    newlyCreatedUser = user;

                    let profilePicUrl = profilePicPreview ? profilePicPreview.src : DEFAULT_PROFILE_PIC;

                    if (state.profilePicFile) {
                        const file = state.profilePicFile;
                        const sanitizedName = file.name.replace(/\s+/g, '-');
                        const uniquePath = `profilePictures/${user.uid}/${Date.now()}-${sanitizedName}`;
                        const fileRef = storageRef(storage, uniquePath);
                        const uploadResult = await uploadBytes(fileRef, file);
                        profilePicUrl = await getDownloadURL(uploadResult.ref);
                        profilePicPath = uploadResult.metadata && uploadResult.metadata.fullPath ? uploadResult.metadata.fullPath : fileRef.fullPath;
                    }

                    try {
                        await updateProfile(user, {
                            displayName: name,
                            photoURL: profilePicUrl,
                        });
                    } catch (profileError) {
                        console.warn('No se pudo actualizar el perfil de Firebase Auth:', profileError);
                    }

                    const profileData = await ensureUserProfile(user, {
                        name,
                        email,
                        address,
                        doc: docNumber,
                        profilePic: profilePicUrl,
                        profilePicPath,
                    });

                    if (profileData) {
                        state.currentUser = {
                            ...state.currentUser,
                            ...profileData,
                            uid: user.uid,
                            items: [],
                        };
                        state.isAdmin = (state.currentUser.role === 'admin') || ((state.currentUser.email || '').toLowerCase() === 'admin@canje.app');
                        state.isLoggedIn = true;
                        updateAuthUI();
                        showPage('page-perfil');
                    }

                    formRegister.reset();
                    state.profilePicFile = null;
                    if (profilePicPreview) {
                        profilePicPreview.src = defaultProfilePreviewSrc;
                    }
                } catch (error) {
                    if (profilePicPath) {
                        try {
                            const fileRef = storageRef(storage, profilePicPath);
                            await deleteObject(fileRef);
                        } catch (storageError) {
                            console.warn('No se pudo limpiar la foto de perfil temporal:', storageError);
                        }
                    }
                    if (newUserUid && newlyCreatedUser) {
                        try {
                            await deleteUser(newlyCreatedUser);
                        } catch (deleteError) {
                            console.warn('No se pudo eliminar la cuenta creada tras un fallo de registro:', deleteError);
                        }
                    }
                    console.error('Error al registrar el usuario:', error);
                    if (registerErrorMsg) {
                        registerErrorMsg.textContent = getAuthErrorMessage(error);
                        registerErrorMsg.classList.remove('hidden');
                    }
                } finally {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Crear Cuenta';
                    }
                }
            });

            btnLogout.addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error('Error al cerrar sesi√≥n:', error);
                }
            });

            // --- L√ìGICA DE PUBLICAR (Firebase Storage + Firestore) ---

            formVender.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = e.currentTarget.querySelector('button[type="submit"]');

                publicarErrorMsg.classList.add('hidden');
                submitBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-green-600', 'hover:bg-green-700');
                submitBtn.textContent = 'Publicar Art√≠culo';
                submitBtn.disabled = false;

                if (!state.isLoggedIn || !state.currentUser.uid) {
                    showPublicarError('Debes iniciar sesi√≥n para publicar un art√≠culo.', submitBtn);
                    return;
                }

                if (state.productFiles.length < 2) {
                    showPublicarError('Debes subir un m√≠nimo de 2 fotos.', submitBtn);
                    return;
                }

                if (state.productFiles.length > 10) {
                    showPublicarError('Has excedido el l√≠mite de 10 fotos.', submitBtn);
                    return;
                }

                const categoryId = document.getElementById('categoria').value;
                if (!categoryId) {
                    showPublicarError('Debes seleccionar una categor√≠a.', submitBtn);
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'Publicando...';

                const imageUrls = [];
                const imagePaths = [];
                let productDocRef = null;
                let userItemDocCreated = false;
                let statsIncremented = false;

                try {
                    const firebaseUser = auth.currentUser;
                    if (firebaseUser) {
                        try {
                            const ensuredProfile = await ensureUserProfile(firebaseUser, {
                                name: state.currentUser.name,
                                email: state.currentUser.email,
                                profilePic: state.currentUser.profilePic,
                            });
                            if (ensuredProfile) {
                                state.currentUser = {
                                    ...state.currentUser,
                                    ...ensuredProfile,
                                    items: state.currentUser.items || [],
                                };
                            }
                        } catch (profileError) {
                            console.warn('No se pudo sincronizar el perfil del usuario antes de publicar:', profileError);
                        }
                    }

                    let index = 0;
                    for (const fileData of state.productFiles) {
                        const file = fileData.file;
                        const sanitizedName = file.name.replace(/\s+/g, '-');
                        const uniquePath = `productImages/${state.currentUser.uid}/${Date.now()}-${index}-${sanitizedName}`;
                        const fileRef = storageRef(storage, uniquePath);
                        const uploadResult = await uploadBytes(fileRef, file);
                        const downloadURL = await getDownloadURL(uploadResult.ref);
                        imageUrls.push(downloadURL);
                        imagePaths.push(uploadResult.metadata && uploadResult.metadata.fullPath ? uploadResult.metadata.fullPath : fileRef.fullPath);
                        index += 1;
                    }

                    const productPayload = {
                        name: document.getElementById('titulo').value,
                        wants: document.getElementById('busco').value,
                        value: Number(document.getElementById('valor-cop').value) || 0,
                        description: document.getElementById('descripcion').value || '',
                        categoryId,
                        imageUrl: imageUrls[0] || DEFAULT_PRODUCT_IMAGE,
                        imageUrls,
                        imagePaths,
                        ownerId: state.currentUser.uid,
                        ownerName: state.currentUser.name || '',
                        ownerEmail: state.currentUser.email || '',
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp(),
                    };

                    productDocRef = await addDoc(collection(db, 'items'), productPayload);

                    await setDoc(doc(db, 'users', state.currentUser.uid, 'items', productDocRef.id), {
                        productId: productDocRef.id,
                        productName: productPayload.name,
                        imageUrl: productPayload.imageUrl,
                        categoryId: productPayload.categoryId,
                        value: productPayload.value,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp(),
                    });
                    userItemDocCreated = true;

                    await setDoc(doc(db, 'users', state.currentUser.uid), {
                        'stats.listedCount': increment(1),
                        updatedAt: serverTimestamp(),
                    }, { merge: true });
                    statsIncremented = true;

                    state.currentUser.stats = state.currentUser.stats || { listedCount: 0, completedTrades: 0 };
                    state.currentUser.stats.listedCount = Math.max(0, (state.currentUser.stats.listedCount || 0) + 1);

                    await loadAllProducts();
                    await loadUserItems(state.currentUser.uid);

                    submitBtn.textContent = '¬°Publicado con √âxito!';
                    submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');

                    setTimeout(() => {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Publicar Art√≠culo';
                        submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    }, 2000);

                    e.target.reset();
                    state.productFiles = [];
                    updatePhotoPreview();
                    showPage('page-explorar');
                } catch (error) {
                    console.error('Error al publicar el art√≠culo:', error);
                    if (imagePaths.length > 0) {
                        await Promise.allSettled(imagePaths.map(path => {
                            try {
                                const fileRef = storageRef(storage, path);
                                return deleteObject(fileRef);
                            } catch (storageError) {
                                console.error('Error al preparar la eliminaci√≥n de imagenes fallidas:', storageError);
                                return Promise.resolve();
                            }
                        }));
                    }
                    if (productDocRef) {
                        try {
                            await deleteDoc(productDocRef);
                        } catch (productCleanupError) {
                            console.warn('No se pudo eliminar el producto incompleto:', productCleanupError);
                        }
                    }
                    if (userItemDocCreated && productDocRef) {
                        try {
                            await deleteDoc(doc(db, 'users', state.currentUser.uid, 'items', productDocRef.id));
                        } catch (userItemCleanupError) {
                            console.warn('No se pudo limpiar el registro del art√≠culo del usuario:', userItemCleanupError);
                        }
                    }
                    if (statsIncremented) {
                        try {
                            await setDoc(doc(db, 'users', state.currentUser.uid), {
                                'stats.listedCount': increment(-1),
                                updatedAt: serverTimestamp(),
                            }, { merge: true });
                            state.currentUser.stats = state.currentUser.stats || { listedCount: 0, completedTrades: 0 };
                            state.currentUser.stats.listedCount = Math.max(0, (state.currentUser.stats.listedCount || 1) - 1);
                        } catch (statsCleanupError) {
                            console.warn('No se pudo revertir el contador de publicaciones:', statsCleanupError);
                        }
                    }
                    showPublicarError('Ocurri√≥ un error al publicar tu art√≠culo. Intenta nuevamente.', submitBtn);
                }
            });


            // --- L√ìGICA DE CANJE (MODAL PROFESIONAL) ---

            /**
             * Asigna listeners a los botones "Proponer Canje" (debe llamarse despu√©s de renderProducts)
             */
            function prepareAndOpenCanjeModal({ itemId, itemName, itemValue, categoryId }) {
                if (!state.isLoggedIn) {
                    showPage('page-perfil');
                    return;
                }

                if (!itemId || !itemName) {
                    console.warn('No se pudo preparar el canje: faltan datos del art√≠culo.');
                    return;
                }

                if (categoryId) {
                    logCategoryView(categoryId);
                }

                const parsedValue = parseFloat(itemValue) || 0;
                state.itemToSwap = {
                    id: itemId,
                    name: itemName,
                    value: parsedValue,
                };

                const formattedValue = formatCOP(state.itemToSwap.value);
                if (modalItemNameEl) modalItemNameEl.textContent = state.itemToSwap.name;
                if (modalItemValueEl) modalItemValueEl.textContent = formattedValue;
                if (deseadoValorEl) deseadoValorEl.textContent = formattedValue;

                if (selectTuArticulo) {
                    selectTuArticulo.innerHTML = '';

                    if (!state.currentUser.items || state.currentUser.items.length === 0) {
                        selectTuArticulo.innerHTML = '<p class="text-sm text-gray-500 p-2">No tienes art√≠culos para canjear. Publica uno en la secci√≥n "Vender".</p>';
                    } else {
                        state.currentUser.items.forEach(item => {
                            const modalItemImage = createImageLoaderHTML({
                                src: item.imageUrl,
                                alt: item.name,
                                wrapperClass: 'w-10 h-10 rounded-md ml-3 border flex-shrink-0',
                            });
                            const itemHtml = `
                                <label class="flex items-center p-3 bg-white rounded-lg border border-gray-200 hover:bg-gray-100 cursor-pointer modal-item-checkbox-label">
                                    <input type="checkbox" class="modal-item-checkbox h-5 w-5 text-brand rounded focus:ring-brand" data-value="${item.value}" data-id="${item.id}">
                                    ${modalItemImage}
                                    <div class="ml-3 flex-1 min-w-0">
                                        <span class="font-medium text-gray-900 truncate">${item.name}</span>
                                        <span class="block text-sm text-green-600">${formatCOP(item.value)}</span>
                                    </div>
                                </label>
                            `;
                            selectTuArticulo.insertAdjacentHTML('beforeend', itemHtml);
                        });
                        registerLazyImages(selectTuArticulo);
                    }
                }

                updateCanjeCalculation();
                if (modalErrorMsg) modalErrorMsg.classList.add('hidden');
                if (agregarDineroInput) agregarDineroInput.value = '';

                modalProponerCanje.classList.remove('hidden');
                modalProponerCanje.classList.add('open');
            }

            function assignProponerCanjeListeners() {
                document.querySelectorAll('.btn-proponer-canje').forEach(btn => {
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);

                    newBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const itemData = e.currentTarget.dataset;
                        prepareAndOpenCanjeModal({
                            itemId: itemData.itemId,
                            itemName: itemData.itemName,
                            itemValue: itemData.itemValue,
                            categoryId: itemData.categoryId,
                        });
                    });
                });
            }

            function assignAddToCartListeners() {
                document.querySelectorAll('.btn-add-to-cart').forEach(btn => {
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);

                    prepareAddToCartButton(newBtn);

                    newBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const productId = e.currentTarget.dataset.itemId;
                        if (!productId) {
                            showCartFeedback('No se pudo identificar el art√≠culo seleccionado.', 'error');
                            return;
                        }
                        const product = state.allProducts.find(item => item.id === productId);
                        if (!product) {
                            showCartFeedback('El art√≠culo ya no est√° disponible.', 'error');
                            return;
                        }
                        if (addProductToCart(product, 1)) {
                            flashAddToCartButtonState(e.currentTarget);
                        }
                    });
                });
            }

            /**
             * Actualiza el c√°lculo en el modal de canje.
             */
            function updateCanjeCalculation() {
                let tuValorTotal = 0;
                const checkboxes = document.querySelectorAll('#modal-user-items-list .modal-item-checkbox:checked');
                
                checkboxes.forEach(cb => {
                    tuValorTotal += parseFloat(cb.dataset.value);
                });

                const deseadoValor = state.itemToSwap ? state.itemToSwap.value : 0;
                const diferencia = deseadoValor - tuValorTotal;
                
                if (tuValorEl) tuValorEl.textContent = formatCOP(tuValorTotal);
                if (diferenciaValorEl) diferenciaValorEl.textContent = formatCOP(diferencia);

                if (agregarDineroInput) {
                    if (diferencia > 0) {
                        agregarDineroInput.placeholder = `Sugerido: ${diferencia}`;
                    } else {
                        agregarDineroInput.placeholder = "0";
                    }
                }
            }

            // Listener para cambios en los checkboxes del modal
            modalProponerCanje.addEventListener('change', (e) => {
                if (e.target.classList.contains('modal-item-checkbox')) {
                    updateCanjeCalculation();
                }
            });


            function closeModal(modalElement) {
                modalElement.classList.add('hidden');
                modalElement.classList.remove('open');
            }
            
            // Asignar listeners para cerrar el modal de propuesta
            modalProponerCanje.querySelector('.modal-close-btn').addEventListener('click', () => closeModal(modalProponerCanje));
            modalProponerCanje.querySelector('.modal-backdrop').addEventListener('click', () => closeModal(modalProponerCanje));


            formProponerCanje.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = e.target.querySelector('button[type="submit"]');

                if (!state.isLoggedIn || !state.itemToSwap) {
                    modalErrorMsg.textContent = 'Error: No se ha seleccionado un art√≠culo o no has iniciado sesi√≥n.';
                    modalErrorMsg.classList.remove('hidden');
                    return;
                }

                const selectedItemsCheckboxes = document.querySelectorAll('#modal-user-items-list .modal-item-checkbox:checked');

                if (selectedItemsCheckboxes.length === 0 && state.currentUser.items.length > 0) {
                    modalErrorMsg.textContent = 'Debes seleccionar al menos un art√≠culo para ofrecer.';
                    modalErrorMsg.classList.remove('hidden');
                    setTimeout(() => modalErrorMsg.classList.add('hidden'), 3000);
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'Enviando...';
                modalErrorMsg.classList.add('hidden');

                try {
                    // 1. Obtener la informaci√≥n completa del art√≠culo deseado y su due√±o
                    const targetItemRef = doc(db, 'items', state.itemToSwap.id);
                    const targetItemSnap = await getDoc(targetItemRef);
                    if (!targetItemSnap.exists()) {
                        throw new Error("El art√≠culo que deseas ya no est√° disponible.");
                    }
                    const targetItemData = targetItemSnap.data();

                    // 2. Preparar los datos de los art√≠culos que ofreces
                    const offeredItemsData = [];
                    selectedItemsCheckboxes.forEach(cb => {
                        const itemId = cb.dataset.id;
                        const item = state.currentUser.items.find(i => i.id === itemId);
                        if (item) {
                            offeredItemsData.push({
                                id: item.id,
                                name: item.name,
                                value: item.value,
                                imageUrl: item.imageUrl
                            });
                        }
                    });

                    // 3. Crear el documento de la oferta
                    const offerPayload = {
                        proposerId: state.currentUser.uid,
                        proposerName: state.currentUser.name,
                        proposerProfilePic: state.currentUser.profilePic,
                        
                        targetOwnerId: targetItemData.ownerId, // ¬°ID del due√±o del art√≠culo!
                        
                        targetItem: {
                            id: state.itemToSwap.id,
                            name: targetItemData.name,
                            value: targetItemData.value,
                            imageUrl: targetItemData.imageUrl
                        },
                        
                        offeredItems: offeredItemsData,
                        additionalCop: Number(agregarDineroInput ? agregarDineroInput.value : 0) || 0,
                        
                        status: 'pending', // pending, accepted, rejected, negotiated
                        createdAt: serverTimestamp()
                    };

                    // 4. Guardar en una nueva colecci√≥n "offers"
                    await addDoc(collection(db, 'offers'), offerPayload);

                    // 5. Mostrar √©xito y cerrar
                    submitBtn.textContent = '¬°Propuesta Enviada!';
                    submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');

                    setTimeout(() => {
                        closeModal(modalProponerCanje);
                        submitBtn.textContent = 'Enviar Propuesta de Canje';
                        submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        submitBtn.disabled = false;
                        state.itemToSwap = null;
                    }, 2000);

                } catch (error) {
                    console.error("Error al proponer canje:", error);
                    modalErrorMsg.textContent = `Error: ${error.message}`;
                    modalErrorMsg.classList.remove('hidden');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Enviar Propuesta de Canje';
                }
            });

            /**
             * Maneja la subida de un nuevo banner por parte del admin.
             */

async function handleAdminBannerUpload(event) {
    console.log('Verificando UID del usuario actual:', auth.currentUser.uid); // <-- A√ëADE ESTA L√çNEA
    const file = event.target.files[0];
    if (!file || !state.isAdmin) return;

    // 1. Obtiene el nombre del √≠cono desde el ATRIBUTO del bot√≥n, no buscando la etiqueta <i>.
    //    Esta es la parte clave que evita el error.
    const originalIconName = uploadCoverBtn.dataset.iconName;

    // 2. Inicia el feedback visual: deshabilita el bot√≥n y lo VAC√çA por completo,
    //    reemplazando su contenido con el c√≥digo del spinner.
    uploadCoverBtn.disabled = true;
    uploadCoverBtn.innerHTML = `<svg class="animate-spin w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

    try {
        // --- El resto de esta secci√≥n (try/catch) es tu l√≥gica original, que ya era correcta ---
        const uniquePath = `banners/${Date.now()}-${file.name.replace(/\s+/g, '-')}`;
        const fileRef = storageRef(storage, uniquePath);
        const uploadResult = await uploadBytes(fileRef, file);
        const downloadURL = await getDownloadURL(uploadResult.ref);

        const oneWeekFromNow = new Date();
        oneWeekFromNow.setDate(oneWeekFromNow.getDate() + 7);

        const newBanner = {
            title: "Nuevo Banner (Editar)",
            subtitle: "Haz clic en el l√°piz para cambiar la fecha",
            imageUrl: downloadURL,
            imagePath: uploadResult.ref.fullPath,
            endTime: oneWeekFromNow,
            createdAt: serverTimestamp()
        };

        await addDoc(collection(db, 'banners'), newBanner);
        await loadAndRenderBanners();

    } catch (error) {
        console.error("Error al subir el nuevo banner:", error);
        alert(`‚ùå Error al subir la portada:\n\n${error.message}`);
    } finally {
        // 3. Este bloque 'finally' se ejecuta SIEMPRE, tanto si la subida fue exitosa como si fall√≥.
        //    Es perfecto para restaurar el estado del bot√≥n.
        uploadCoverBtn.disabled = false;
        
        // 4. Reconstruimos el contenido del bot√≥n desde cero usando el nombre del √≠cono que guardamos.
        uploadCoverBtn.innerHTML = `<i data-lucide="${originalIconName}" class="w-5 h-5 md:w-6 md:h-6"></i>`;
        
        // 5. ¬°CR√çTICO! Le decimos a la librer√≠a Lucide que busque nuevas etiquetas <i> para convertirlas en √≠conos.
        lucide.createIcons(); 
        
        coverFileInput.value = null; // Resetea el input para poder subir el mismo archivo otra vez
    }
}


            /**
             * Maneja la eliminaci√≥n de un banner por parte del admin.
             */
            async function handleDeleteBanner(bannerId, imagePath) {
                if (!state.isAdmin) return;

                if (confirm("¬øEst√°s seguro de que quieres eliminar este banner permanentemente?")) {
                    try {
                        // 1. Eliminar el documento de Firestore
                        await deleteDoc(doc(db, "banners", bannerId));
                        
                        // 2. Eliminar la imagen de Storage (si existe la ruta)
                        if (imagePath) {
                            const imageRef = storageRef(storage, imagePath);
                            await deleteObject(imageRef);
                        }
                        
                        // 3. Recargar los banners
                        await loadAndRenderBanners();

                    } catch (error) {
                        console.error("Error eliminando el banner:", error);
                        alert("No se pudo eliminar el banner. Revisa la consola.");
                    }
                }
            }


            /**
             * NUEVO: Listeners delegados para contenido din√°mico
             */
            function setupDelegatedListeners() {
                // Listener para el bot√≥n "Reintentar" en mensajes fallidos
                chatMessages.addEventListener('click', (e) => {
                    const retryBtn = e.target.closest('.btn-retry-message');
                    if (retryBtn) {
                        e.preventDefault();
                        const { tempId, text } = retryBtn.dataset;
                        if (!tempId || !text) return;

                        // Actualizar la UI del mensaje a 'sending' de nuevo
                        const failedMessage = chatMessages.querySelector(`[data-message-id="${tempId}"]`);
                        if (failedMessage) {
                            const statusEl = failedMessage.querySelector('.text-right');
                            if (statusEl) {
                                statusEl.innerHTML = `<span class="text-xs text-blue-100">Reenviando...</span>`;
                            }
                        }

                        // Reintentar el env√≠o
                        handleSendMessage(state.activeChatId, text, tempId);
                    }
                });

                 tabOfertas.addEventListener('click', (e) => {
                    const aceptarBtn = e.target.closest('.btn-aceptar-canje');
                    if (aceptarBtn) {
                        const { userName, itemName, itemImage, offerId } = aceptarBtn.dataset;
                        openTerminosModal(userName, itemName, itemImage, offerId);
                    }

                    const negociarBtn = e.target.closest('.btn-negociar');
                    if (negociarBtn) {
                        const form = negociarBtn.closest('.p-4').querySelector('.negotiation-form');
                        if (form) form.classList.toggle('hidden');
                    }
                });

                // Listener para botones "Eliminar" en "Mis Art√≠culos"
                tabMisArticulos.addEventListener('click', async (e) => {
                    const eliminarBtn = e.target.closest('.btn-eliminar-item');
                    if (eliminarBtn) {
                        e.preventDefault();
                        const itemId = eliminarBtn.dataset.itemId;
                        if (confirm("¬øSeguro que quieres eliminar este art√≠culo?")) {
                           await deleteUserItem(itemId);
                        }
                    }
                });

                // Listener para abrir un chat desde la lista de "Canjes Activos"
                document.getElementById('chats-activos-container').addEventListener('click', (e) => {
                    const chatCard = e.target.closest('.chat-card');
                    if (chatCard) {
                        const {
                            chatId,
                            otherUserId,
                            otherUserName,
                            otherUserPic,
                            itemId,
                            itemName,
                            itemImage
                        } = chatCard.dataset;

                        openChat(
                            chatId,
                            otherUserId,
                            { name: otherUserName, profilePic: otherUserPic },
                            { id: itemId, name: itemName, imageUrl: itemImage }
                        );
                    }
                });

                // Listener para botones de admin en el carrusel (editar timer, eliminar)
                promoCarousel.addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('.btn-delete-banner');
                    if (deleteBtn) {
                        e.stopPropagation();
                        const slide = deleteBtn.closest('.carousel-slide');
                        const bannerId = slide.dataset.bannerId;
                        const imagePath = slide.dataset.imagePath;
                        handleDeleteBanner(bannerId, imagePath);
                        return; // Evita que se abra el modal de editar
                    }

                    const editBtn = e.target.closest('.admin-edit-timer-btn');
                    if (editBtn) {
                        e.preventDefault();
                        e.stopPropagation();
                        const slide = editBtn.closest('.carousel-slide');
                        if (slide) {
                            openTimerModal(slide);
                        }
                    }
                });

                // Listener para el men√∫ de opciones del chat
                const chatOptionsBtn = document.getElementById('chat-options-btn');
                const chatOptionsMenu = document.getElementById('chat-options-menu');
                const btnDeleteChat = document.getElementById('btn-delete-chat');

                if (chatOptionsBtn && chatOptionsMenu) {
                    chatOptionsBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        chatOptionsMenu.classList.toggle('hidden');
                    });

                    btnDeleteChat.addEventListener('click', () => {
                        handleDeleteChat(state.activeChatId);
                        chatOptionsMenu.classList.add('hidden');
                    });

                    // Ocultar men√∫ si se hace clic fuera
                    document.addEventListener('click', (e) => {
                        if (!chatOptionsBtn.contains(e.target) && !chatOptionsMenu.contains(e.target)) {
                            chatOptionsMenu.classList.add('hidden');
                        }
                    });
                }
            }
            async function handleDeleteChat(chatId) {
                if (!chatId || !state.isLoggedIn) {
                    alert("No se puede eliminar el chat.");
                    return;
                }

                if (confirm("¬øEst√°s seguro de que quieres eliminar este canje? Esta acci√≥n es irreversible y borrar√° toda la conversaci√≥n.")) {
                    try {
                        // 1. Borrar todos los mensajes de la subcolecci√≥n
                        const messagesRef = collection(db, 'chats', chatId, 'messages');
                        const messagesSnap = await getDocs(messagesRef);
                        const deletePromises = messagesSnap.docs.map(docSnap => deleteDoc(docSnap.ref));
                        await Promise.all(deletePromises);

                        // 2. Borrar el documento principal del chat
                        await deleteDoc(doc(db, 'chats', chatId));

                        // 3. Actualizar la UI
                        state.activeChatId = null;
                        if (state.unsubscribeFromMessages) {
                            state.unsubscribeFromMessages();
                            state.unsubscribeFromMessages = null;
                        }

                        showPage('page-canjes');
                        await loadAndRenderActiveChats(state.currentUser.uid);

                    } catch (error) {
                        console.error("Error al eliminar el chat:", error);
                        alert("Ocurri√≥ un error al intentar eliminar el chat. Por favor, int√©ntalo de nuevo.");
                    }
                }
            }


            async function acceptOfferAndCreateChat(offerId) {
                if (!offerId || !state.isLoggedIn) return;

                const submitBtn = document.getElementById('btn-continuar-chat');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Procesando...';
                }

                try {
                    const offerRef = doc(db, 'offers', offerId);
                    const offerSnap = await getDoc(offerRef);

                    if (!offerSnap.exists()) {
                        throw new Error("La oferta ya no existe.");
                    }
                    const offerData = offerSnap.data();

                    await setDoc(offerRef, { status: 'accepted' }, { merge: true });

                    const chatRef = doc(db, 'chats', offerId);
                    const proposerId = offerData.proposerId;
                    const targetOwnerId = offerData.targetOwnerId;

                    await setDoc(chatRef, {
                        offerId: offerId,
                        participants: [proposerId, targetOwnerId],
                        participantInfo: {
                            [proposerId]: { name: offerData.proposerName, profilePic: offerData.proposerProfilePic },
                            [targetOwnerId]: { name: state.currentUser.name, profilePic: state.currentUser.profilePic }
                        },
                        itemInfo: {
                            id: offerData.targetItem.id,
                            name: offerData.targetItem.name,
                            imageUrl: offerData.targetItem.imageUrl
                        },
                        createdAt: serverTimestamp(),
                        lastMessage: null,
                        lastMessageTimestamp: null,
                        unreadCounts: {
                            [proposerId]: 0,
                            [targetOwnerId]: 0
                        }
                    });

                    closeTerminosModal();
                    await loadReceivedOffers(state.currentUser.uid);
                    await loadAndRenderActiveChats(state.currentUser.uid);

                    const otherUserId = offerData.proposerId;
                    const otherUserInfo = { name: offerData.proposerName, profilePic: offerData.proposerProfilePic };

                    // Usar la informaci√≥n del item guardada en state.tempChatData para asegurar consistencia.
                    const itemInfo = {
                        id: offerData.targetItem.id,
                        name: state.tempChatData.itemName || offerData.targetItem.name,
                        imageUrl: state.tempChatData.itemImage || offerData.targetItem.imageUrl
                    };

                    openChat(offerId, otherUserId, otherUserInfo, itemInfo);
                    state.tempChatData = null; // Limpiar datos temporales

                } catch (error) {
                    console.error("Error al aceptar el canje y crear chat:", error);
                    alert(`Error: ${error.message}`);
                } finally {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Continuar al Chat';
                    }
                }
            }

            async function loadAndRenderActiveChats(uid) {
                const chatsContainer = document.getElementById('chats-activos-container');
                if (!uid || !chatsContainer) return;

                try {
                    const chatsQuery = query(
                        collection(db, 'chats'),
                        where('participants', 'array-contains', uid)
                    );
                    const snapshot = await getDocs(chatsQuery);

                    if (snapshot.empty) {
                        chatsContainer.innerHTML = '<p class="text-gray-500">No tienes chats activos.</p>';
                        return;
                    }

                    const chatPromises = snapshot.docs.map(async (docSnap) => {
                        const chat = docSnap.data();
                        const chatId = docSnap.id;
                        const otherUserId = chat.participants.find(p => p !== uid);
                        const otherUserInfo = chat.participantInfo[otherUserId] || {};
                        const itemInfo = chat.itemInfo || {};

                        const lastMessage = chat.lastMessage ? escapeHtml(chat.lastMessage) : 'Inicia la conversaci√≥n...';
                        const lastMessageTime = chat.lastMessageTimestamp ?
                            new Date(chat.lastMessageTimestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

                        const userAvatar = createImageLoaderHTML({
                            src: otherUserInfo.profilePic ? otherUserInfo.profilePic : DEFAULT_PROFILE_PIC,
                            alt: otherUserInfo.name || 'Usuario',
                            wrapperClass: 'w-16 h-16 rounded-full border-4 border-white shadow-lg',
                        });

                        return `
                            <div class="chat-card flex flex-col sm:flex-row items-start p-4 bg-white border border-gray-200 rounded-xl shadow-sm cursor-pointer hover:bg-gray-50 transition-colors duration-200"
                                data-chat-id="${escapeHtml(chatId)}"
                                data-other-user-id="${escapeHtml(otherUserId)}"
                                data-other-user-name="${escapeHtml(otherUserInfo.name || 'Usuario')}"
                                data-other-user-pic="${escapeHtml(otherUserInfo.profilePic || DEFAULT_PROFILE_PIC)}"
                                data-item-id="${escapeHtml(itemInfo.id || '')}"
                                data-item-name="${escapeHtml(itemInfo.name || 'Art√≠culo')}"
                                data-item-image="${escapeHtml(itemInfo.imageUrl || DEFAULT_PRODUCT_IMAGE)}">

                                <div class="flex-shrink-0 mb-3 sm:mb-0 sm:mr-4">
                                    ${userAvatar}
                                </div>

                                <div class="flex-1 min-w-0 w-full">
                                    <div class="flex justify-between items-baseline mb-1">
                                        <h4 class="text-lg font-semibold text-gray-900">${escapeHtml(otherUserInfo.name || 'Usuario')}</h4>
                                        <span class="text-xs text-gray-500 flex-shrink-0">${lastMessageTime}</span>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-2 pb-2 border-b border-gray-100">
                                        <span class="font-medium">Art√≠culo:</span> ${escapeHtml(itemInfo.name || 'No especificado')}
                                    </p>
                                    <p class="text-sm text-gray-500 leading-relaxed">${lastMessage}</p>
                                </div>
                            </div>
                        `;
                    });

                    const chatHtmls = await Promise.all(chatPromises);
                    chatsContainer.innerHTML = chatHtmls.join('');

                } catch (error) {
                    console.error("Error al cargar chats activos:", error);
                    chatsContainer.innerHTML = '<p class="text-red-500">Error al cargar los chats.</p>';
                }
            }

            function openChat(chatId, otherUserId, otherUserInfo, itemInfo) {
                if (!chatId || !otherUserInfo || !itemInfo) return;

                state.activeChatId = chatId;

                // Reiniciar el contador de no le√≠dos para el usuario actual en este chat.
                const chatRef = doc(db, 'chats', chatId);
                updateDoc(chatRef, {
                    [`unreadCounts.${state.currentUser.uid}`]: 0
                }).catch(err => console.error("Error al reiniciar contador de no le√≠dos:", err));


                // Actualizar la UI de la cabecera del chat con el nuevo dise√±o
                if (chatItemName) chatItemName.textContent = itemInfo.name;
                if (chatWithName) chatWithName.textContent = `Hablando con: ${otherUserInfo.name}`;
                if (chatItemImage) chatItemImage.src = itemInfo.imageUrl || DEFAULT_PRODUCT_IMAGE;

                showPage('page-chat');
                loadAndRenderMessages(chatId);
            }

            function loadAndRenderMessages(chatId) {
                if (!chatId || !chatMessages) return;

                chatMessages.innerHTML = '<div class="text-center p-4 text-sm text-gray-500">Cargando mensajes...</div>';
                if (state.unsubscribeFromMessages) {
                    state.unsubscribeFromMessages();
                }

                const messagesRef = collection(db, 'chats', chatId, 'messages');
                const q = query(messagesRef, orderBy('timestamp'));

                state.unsubscribeFromMessages = onSnapshot(q, (snapshot) => {
                    if (snapshot.empty && chatMessages.children.length <= 1) {
                         chatMessages.innerHTML = '<div class="text-center p-4 text-sm text-gray-500">A√∫n no hay mensajes. ¬°Env√≠a el primero!</div>';
                         return;
                    }

                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            const messageData = change.doc.data();
                            const messageId = change.doc.id;
                            const isUser = messageData.senderId === state.currentUser.uid;
                            const tempId = messageData.tempId;
                            const existingMessage = tempId ? chatMessages.querySelector(`[data-message-id="${tempId}"]`) : null;

                            if (existingMessage) {
                                // It was an optimistic message, now it's confirmed.
                                existingMessage.dataset.messageId = messageId;
                                const contentWrapper = existingMessage.querySelector('.p-2.text-white');

                                if (contentWrapper) {
                                    // Re-render the content of the bubble
                                    const time = messageData.timestamp ? new Date(messageData.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                                    let newContent = '';
                                    if (messageData.type === 'image' && messageData.imageUrl) {
                                        newContent = `<img src="${escapeHtml(messageData.imageUrl)}" alt="Imagen del chat" class="rounded-lg max-w-full h-auto cursor-pointer" style="max-height: 300px;" onclick="window.open('${escapeHtml(messageData.imageUrl)}')">`;
                                    } else {
                                        newContent = `<p class="text-sm">${escapeHtml(messageData.text)}</p>`;
                                    }

                                    contentWrapper.innerHTML = `
                                        ${newContent}
                                        <div class="text-right px-2 pt-1">
                                            <span class="text-xs text-blue-100">${time}</span>
                                        </div>
                                    `;
                                }
                            } else {
                                // It's a new message from someone else.
                                const placeholder = chatMessages.querySelector('div.text-center');
                                if (placeholder) placeholder.remove();

                                renderSingleMessage({
                                    id: messageId,
                                    text: messageData.text,
                                    imageUrl: messageData.imageUrl,
                                    type: messageData.type,
                                    isUser: isUser,
                                    timestamp: messageData.timestamp,
                                    status: 'sent'
                                });
                            }
                        }
                    });

                    setTimeout(() => {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 50);
                }, (error) => {
                    console.error("Error al escuchar mensajes:", error);
                    chatMessages.innerHTML = '<div class="text-center p-4 text-sm text-red-500">No se pudieron cargar los mensajes.</div>';
                });
            }

            /**
             * Renderiza un √∫nico mensaje en el chat con su estado.
             * @param {object} message - El objeto del mensaje.
             * @param {string} message.id - ID √∫nico (temporal o de Firestore).
             * @param {string} message.text - Contenido del mensaje.
             * @param {boolean} message.isUser - Si el mensaje es del usuario actual.
             * @param {object} [message.timestamp] - Timestamp de Firebase (si est√° confirmado).
             * @param {string} message.status - 'sending', 'sent', o 'failed'.
             */
            function renderSingleMessage(message) {
                const { id, text, imageUrl, type = 'text', isUser, timestamp, status } = message;
                const time = timestamp ? new Date(timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                let statusIndicator = '';
                if (isUser) {
                    if (status === 'sending') {
                        statusIndicator = `<span class="text-xs text-blue-100">Enviando...</span>`;
                    } else if (status === 'failed') {
                        const retryData = type === 'image' ? `data-retry-type="image" data-temp-id="${id}"` : `data-retry-type="text" data-temp-id="${id}" data-text="${escapeHtml(text)}"`;
                        statusIndicator = `<button class="text-xs text-red-200 hover:underline btn-retry-message" ${retryData}>Error, reintentar</button>`;
                    } else { // 'sent'
                        statusIndicator = `<span class="text-xs ${isUser ? 'text-blue-100' : 'text-gray-200'}">${time}</span>`;
                    }
                } else {
                    statusIndicator = `<span class="text-xs text-gray-200">${time}</span>`;
                }

                let contentHtml = '';
                if (type === 'image') {
                    const src = (status === 'sending' || status === 'failed') ? imageUrl : escapeHtml(imageUrl);
                     contentHtml = `<img src="${src}" alt="Imagen del chat" class="rounded-lg max-w-full h-auto ${status !== 'sent' ? 'opacity-60' : 'cursor-pointer'}" style="max-height: 300px;" ${status === 'sent' ? `onclick="window.open('${escapeHtml(imageUrl)}')"`: ''}>`;
                } else {
                    contentHtml = `<p class="text-sm">${escapeHtml(text)}</p>`;
                }

                const messageHtml = `
                    <div class="flex ${isUser ? 'justify-end' : 'justify-start'} mb-4" data-message-id="${id}">
                        <div class="p-2 text-white ${isUser ? 'bg-brand' : 'bg-gray-400'} rounded-lg max-w-xs shadow-sm">
                            ${contentHtml}
                            <div class="text-right px-2 pt-1">
                                ${statusIndicator}
                            </div>
                        </div>
                    </div>
                `;
                chatMessages.insertAdjacentHTML('beforeend', messageHtml);
            }

            /**
             * Env√≠a un mensaje a Firestore, incluyendo un ID temporal para la UI optimista.
             * En caso de error, actualiza el estado del mensaje en la UI a 'failed'.
             * @param {string} chatId - El ID del chat.
             * @param {string} text - El contenido del mensaje.
             * @param {string} tempId - El ID temporal usado para renderizar el mensaje en la UI.
             */
            async function handleSendMessage(chatId, payload, tempId) {
                if (!chatId || !state.isLoggedIn) return;

                const messagesRef = collection(db, 'chats', chatId, 'messages');
                const chatRef = doc(db, 'chats', chatId);

                const finalPayload = {
                    ...payload,
                    senderId: state.currentUser.uid,
                    timestamp: serverTimestamp(),
                    tempId: tempId
                };

                try {
                    // Primero, obt√©n el estado actual del chat para saber qui√©n es el otro participante.
                    const chatSnap = await getDoc(chatRef);
                    if (!chatSnap.exists()) return; // El chat ya no existe
                    const chatData = chatSnap.data();
                    const otherUserId = chatData.participants.find(p => p !== state.currentUser.uid);

                    // Env√≠a el mensaje y actualiza el documento del chat en una sola operaci√≥n (o lo m√°s cerca posible).
                    await addDoc(messagesRef, finalPayload);

                    const lastMessageText = finalPayload.type === 'image' ? 'üì∑ Imagen' : finalPayload.text;
                    const updates = {
                        lastMessage: lastMessageText,
                        lastMessageTimestamp: serverTimestamp(),
                        lastMessageSenderId: state.currentUser.uid,
                    };

                    // Incrementa el contador del otro usuario.
                    if (otherUserId) {
                        updates[`unreadCounts.${otherUserId}`] = increment(1);
                    }
                     // Reinicia tu propio contador, ya que al enviar un mensaje, has "visto" la conversaci√≥n.
                    updates[`unreadCounts.${state.currentUser.uid}`] = 0;


                    await updateDoc(chatRef, updates);

                } catch (error) {
                    console.error("Error al enviar el mensaje:", error);
                    const failedMessage = chatMessages.querySelector(`[data-message-id="${tempId}"]`);
                    if (failedMessage) {
                        const statusEl = failedMessage.querySelector('.text-right');
                        if (statusEl) {
                            const retryType = finalPayload.type === 'image' ? 'image' : 'text';
                            const textData = retryType === 'text' ? `data-text="${escapeHtml(finalPayload.text)}"` : '';
                            statusEl.innerHTML = `<button class="text-xs text-red-200 hover:underline btn-retry-message" data-retry-type="${retryType}" data-temp-id="${tempId}" ${textData}>Error, reintentar</button>`;
                        }
                    }
                }
            }

            async function uploadChatImageAndSend(file) {
                if (!file || !state.activeChatId) return;

                const tempId = `temp_${Date.now()}`;
                const reader = new FileReader();

                reader.onload = (e) => {
                    renderSingleMessage({
                        id: tempId,
                        imageUrl: e.target.result,
                        type: 'image',
                        isUser: true,
                        status: 'sending'
                    });
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                };
                reader.readAsDataURL(file);

                // Store the file reference for retries
                if (!window.retryFiles) window.retryFiles = {};
                window.retryFiles[tempId] = file;

                try {
                    const uniquePath = `chat_images/${state.activeChatId}/${Date.now()}-${file.name.replace(/\s+/g, '-')}`;
                    const fileRef = storageRef(storage, uniquePath);
                    const uploadResult = await uploadBytes(fileRef, file);
                    const downloadURL = await getDownloadURL(uploadResult.ref);

                    const payload = {
                        type: 'image',
                        imageUrl: downloadURL,
                        imagePath: uploadResult.ref.fullPath
                    };
                    await handleSendMessage(state.activeChatId, payload, tempId);

                } catch (error) {
                    console.error("Error al subir imagen:", error);
                    const failedMessage = chatMessages.querySelector(`[data-message-id="${tempId}"]`);
                    if (failedMessage) {
                        const statusEl = failedMessage.querySelector('.text-right');
                        if (statusEl) {
                            statusEl.innerHTML = `<button class="text-xs text-red-200 hover:underline btn-retry-message" data-retry-type="image" data-temp-id="${tempId}">Error, reintentar</button>`;
                        }
                    }
                } finally {
                    // Clean up the stored file after processing
                    delete window.retryFiles[tempId];
                }
            }


            btnAttachImage.addEventListener('click', () => {
                chatImageUpload.click();
            });

            chatImageUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    uploadChatImageAndSend(file);
                }
                e.target.value = null; // Reset input
            });

            function listenForUnreadMessages(uid) {
                if (!uid) return;

                const chatsQuery = query(collection(db, 'chats'), where('participants', 'array-contains', uid));

                onSnapshot(chatsQuery, (snapshot) => {
                    let totalUnread = 0;
                    snapshot.forEach(docSnap => {
                        const chat = docSnap.data();
                        // Asegurarse de que unreadCounts exista y tenga un valor para el usuario actual.
                        if (chat.unreadCounts && chat.unreadCounts[uid]) {
                            totalUnread += chat.unreadCounts[uid];
                        }
                    });

                    state.totalUnreadMessages = totalUnread;
                    updateUnreadBubble();
                }, (error) => {
                    console.error("Error al escuchar chats para notificaciones:", error);
                });
            }

            function updateUnreadBubble() {
                const unreadCount = state.totalUnreadMessages;
                if (unreadCount > 0) {
                    chatNotificationBubble.textContent = unreadCount > 9 ? '9+' : unreadCount.toString();
                    chatNotificationBubble.classList.remove('hidden');
                } else {
                    chatNotificationBubble.classList.add('hidden');
                }
            }

            formChat.addEventListener('submit', (e) => {
                e.preventDefault();
                const text = chatInput.value.trim();
                if (!text || !state.activeChatId) return;

                const tempId = `temp_${Date.now()}`;
                chatInput.value = '';
                chatInput.focus();

                const placeholder = chatMessages.querySelector('div.text-center');
                if (placeholder) placeholder.remove();

                renderSingleMessage({
                    id: tempId,
                    text: text,
                    type: 'text',
                    isUser: true,
                    status: 'sending'
                });

                chatMessages.scrollTop = chatMessages.scrollHeight;

                const payload = { type: 'text', text: text };
                handleSendMessage(state.activeChatId, payload, tempId);
            });

            async function loadAppLogo() {
                const logoEl = document.getElementById('header-logo');
                if (!logoEl) return;

                try {
                    const configRef = doc(db, 'config', 'appSettings');
                    const configSnap = await getDoc(configRef);

                    if (configSnap.exists()) {
                        const configData = configSnap.data();
                        if (configData.logoUrl) {
                            logoEl.src = configData.logoUrl;
                        }
                    }
                } catch (error) {
                    console.error("Error al cargar el logo de la app:", error);
                }
            }
            // --- INICIALIZACI√ìN ---
            async function init() {

                // --- L√ìGICA DEL BANNER DE INSTALACI√ìN ---
                const installBanner = document.getElementById('install-banner');
                const btnInstall = document.getElementById('btn-install');
                const btnDismissInstall = document.getElementById('btn-dismiss-install');
                let deferredPrompt;

                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;

                    // Mostrar el banner solo si no ha sido descartado antes
                    if (localStorage.getItem('installBannerDismissed') !== 'true') {
                        installBanner.classList.remove('hidden');
                        installBanner.classList.remove('-translate-y-full');

                        // Calcular la altura del banner y aplicarla como variable CSS
                        const bannerHeight = installBanner.offsetHeight;
                        document.documentElement.style.setProperty('--install-banner-height', `${bannerHeight}px`);
                        document.body.classList.add('install-banner-visible');
                    }
                });

                btnInstall.addEventListener('click', (e) => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('El usuario acept√≥ instalar la PWA');
                            } else {
                                console.log('El usuario rechaz√≥ instalar la PWA');
                            }
                            deferredPrompt = null;
                            hideInstallBanner();
                        });
                    }
                });

                btnDismissInstall.addEventListener('click', () => {
                    localStorage.setItem('installBannerDismissed', 'true');
                    hideInstallBanner();
                });

                function hideInstallBanner() {
                    installBanner.classList.add('-translate-y-full');
                    document.body.classList.remove('install-banner-visible');
                    document.documentElement.style.setProperty('--install-banner-height', `0px`);
                    setTimeout(() => {
                        installBanner.classList.add('hidden');
                    }, 300); // Esperar a que la transici√≥n termine
                }

                // --- L√ìGICA DEL INDICADOR OFFLINE ---
                const offlineIndicator = document.getElementById('offline-indicator');

                function updateOnlineStatus() {
                    if (navigator.onLine) {
                        offlineIndicator.classList.add('hidden');
                    } else {
                        offlineIndicator.classList.remove('hidden');
                        lucide.createIcons(); // Asegurarse de que el √≠cono se renderice
                    }
                }

                window.addEventListener('online', updateOnlineStatus);
                window.addEventListener('offline', updateOnlineStatus);
                updateOnlineStatus(); // Comprobar el estado al cargar


                // --- NUEVO: Listener para el logo editable ---
                const headerLogo = document.getElementById('header-logo');
                const logoFileInput = document.getElementById('logo-file-input');
                if (headerLogo && logoFileInput) {
                    headerLogo.addEventListener('click', () => {
                        if (state.isAdmin) {
                            logoFileInput.click();
                        }
                    });

                    logoFileInput.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (!file || !state.isAdmin) return;

                        const originalSrc = headerLogo.src;
                        headerLogo.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; // transparent gif placeholder

                        try {
                            const uniquePath = `logos/main_logo_${Date.now()}`;
                            const fileRef = storageRef(storage, uniquePath);
                            const uploadResult = await uploadBytes(fileRef, file);
                            const downloadURL = await getDownloadURL(uploadResult.ref);

                            const configRef = doc(db, 'config', 'appSettings');
                            await setDoc(configRef, {
                                logoUrl: downloadURL,
                                logoPath: uploadResult.ref.fullPath,
                                updatedAt: serverTimestamp()
                            }, { merge: true });

                            headerLogo.src = downloadURL;

                        } catch (error) {
                            console.error("Error al subir el nuevo logo:", error);
                            alert("No se pudo subir el nuevo logo.");
                            headerLogo.src = originalSrc;
                        }
                    });
                }

                updateAuthUI();
                showPage(DEFAULT_PAGE_ID);
                hydrateCartFromStorage();
                renderCart();

                // Inicializar Carrusel
                carouselPrevBtn.addEventListener('click', () => {
                    prevSlide();
                    stopCarouselAutoPlay();
                    startCarouselAutoPlay();
                });
                carouselNextBtn.addEventListener('click', () => {
                    nextSlide();
                    stopCarouselAutoPlay();
                    startCarouselAutoPlay();
                });
                
                // Listener para subir banner
                uploadCoverBtn.addEventListener('click', () => coverFileInput.click());
                coverFileInput.addEventListener('change', handleAdminBannerUpload);

                // --- NUEVAS LLAMADAS DE INICIALIZACI√ìN ---
                populateCategoryList();
                populateCategorySelect();
                
                // Renderizar contenido din√°mico
                renderProducts(); // Renderiza los productos iniciales
                renderMostViewedProducts(); // Renderiza el carrusel inicial
                
                // Configurar listeners delegados para contenido din√°mico
                setupDelegatedListeners();

                // --- NUEVO: Inicializar eventos t√°ctiles del carrusel ---
                setupProductDetailCarouselTouch();

                async function openChatFromId(chatId) {
                    if (!chatId || !state.isLoggedIn) {
                        console.warn("No se puede abrir el chat: falta chatId o el usuario no ha iniciado sesi√≥n.");
                        showPage('page-chats'); // Fallback a la lista de chats
                        return;
                    }
                    try {
                        const chatDocRef = doc(db, 'chats', chatId);
                        const chatDoc = await getDoc(chatDocRef);

                        if (!chatDoc.exists()) {
                            console.error(`Chat con ID ${chatId} no encontrado.`);
                            showPage('page-chats');
                            return;
                        }

                        const chatData = chatDoc.data();
                        const otherUserId = chatData.participants.find(p => p !== state.currentUser.uid);
                        if (!otherUserId) {
                            console.error("No se pudo determinar el otro participante en el chat.");
                            showPage('page-chats');
                            return;
                        }

                        const otherUserInfo = chatData.participantInfo[otherUserId] || {};
                        const itemInfo = chatData.itemInfo || {};

                        openChat(
                            chatId,
                            otherUserId,
                            { name: otherUserInfo.name, profilePic: otherUserInfo.profilePic },
                            { id: itemInfo.id, name: itemInfo.name, imageUrl: itemInfo.imageUrl }
                        );
                    } catch (error) {
                        console.error("Error al abrir el chat desde la notificaci√≥n:", error);
                        showPage('page-chats');
                    }
                }

                // Listener para mensajes del Service Worker (navegaci√≥n por notificaci√≥n)
                navigator.serviceWorker.addEventListener('message', event => {
                    if (event.data && event.data.type === 'navigate') {
                        const { page, chatId } = event.data;
                        if (page === 'page-chat' && chatId) {
                           openChatFromId(chatId);
                        } else if (page) {
                            showPage(page);
                        }
                    }
                });


                // Inicializar iconos (MOVIDO AL FINAL)
                lucide.createIcons();
                registerLazyImages(document);

                hidePreloader();

                await Promise.all([
                    loadAndRenderBanners(),
                    loadAllProducts(),
                    loadAppLogo()
                ]);
                registerLazyImages(document);
            }

            // Arrancar la aplicaci√≥n
            init().catch(error => {
                console.error('Error al inicializar la aplicaci√≥n:', error);
                hidePreloader();
            });
        });

    // --- REGISTRO DEL SERVICE WORKER ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            // Ajusta la ruta para que sea relativa a la ubicaci√≥n del index.html
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('Service Worker registrado con √©xito:', registration.scope);
                })
                .catch(error => {
                    console.error('Error en el registro del Service Worker:', error);
                });
        });
    }
    </script>

    <!-- Indicador de Estado Offline -->
    <div id="offline-indicator" class="hidden fixed bottom-4 right-4 z-[100] bg-gray-800 text-white text-sm font-medium py-2 px-4 rounded-lg shadow-lg flex items-center">
        <i data-lucide="wifi-off" class="w-4 h-4 mr-2"></i>
        <span>Est√°s sin conexi√≥n</span>
    </div>

</body>
</html>
