rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Regla para Banners
    match /banners/{bannerId} {
      allow read: if true;
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Regla para la colección de Usuarios
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;

      // Permite que un usuario escriba en su propia sub-colección de 'items'.
      // Esto es necesario para guardar la referencia del producto que acaba de crear.
      match /items/{itemId} {
        allow write: if request.auth.uid == userId;
      }
    }

    // Regla para la colección principal de Artículos
    match /items/{itemId} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.ownerId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.ownerId;
    }

    // Reglas para Ofertas
    match /offers/{offerId} {
      allow read: if request.auth != null && (request.auth.uid == resource.data.proposerId || request.auth.uid == resource.data.targetOwnerId);
      allow create: if request.auth != null && request.auth.uid == request.resource.data.proposerId;
      // Se necesita `update` para cambiar el estado a 'accepted'
      allow update: if request.auth != null && (request.auth.uid == resource.data.proposerId || request.auth.uid == resource.data.targetOwnerId);
      allow delete: if false;
    }

    // --- REGLAS NUEVAS PARA EL CHAT ---
    // Estas reglas solucionan el error de "permisos insuficientes".
    match /chats/{chatId} {
      // Un usuario puede CREAR un chat si su UID está en la lista de `participants` del nuevo documento.
      // La lógica de la app asegura que esto solo ocurra cuando se acepta un canje.
      allow create: if request.auth != null && request.auth.uid in request.resource.data.participants;

      // Un usuario puede LEER o ACTUALIZAR (para el último mensaje) la información del chat si es un participante.
      allow read, update: if request.auth != null && request.auth.uid in resource.data.participants;

      // Un participante puede ELIMINAR el chat (y sus mensajes, según la regla anidada).
      allow delete: if request.auth != null && request.auth.uid in resource.data.participants;

      // REGLA CORREGIDA Y REFORZADA: Separar permisos de lectura y escritura para mayor claridad.
      match /messages/{messageId} {
        // Cualquiera de los participantes puede leer todos los mensajes del chat.
        allow read: if request.auth != null
                    && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;

        // Un usuario puede escribir (crear) un mensaje si es uno de los participantes.
        // Se añade una comprobación adicional para asegurar que el remitente es quien dice ser.
        allow write: if request.auth != null
                     && request.auth.uid == request.resource.data.senderId
                     && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;

        // Un participante puede ELIMINAR mensajes dentro del chat.
        allow delete: if request.auth != null
                      && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      }
    }
  }
}
